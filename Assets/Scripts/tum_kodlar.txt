using UnityEngine;
using UnityEngine.UI;


public class Animal : MonoBehaviour
{

    private Animator animator;
    private Vector2 lastMoveDir = Vector2.down; // idle yÃ¶nÃ¼ iÃ§in


    [Header("Animation Direction")]
    public float dirDeadzone = 0.15f;   // Ã§ok kÃ¼Ã§Ã¼k x/y titreÅŸimlerini yok say
    public float axisHysteresis = 0.10f; // eksenler arasÄ± geÃ§iÅŸte yapÄ±ÅŸkanlÄ±k (0.05-0.15 iyi)

    // Son seÃ§ilen animasyon yÃ¶nÃ¼nÃ¼ tut (saÄŸ/sol/yukarÄ±/aÅŸaÄŸÄ±)
    private Vector2 lastAnimDir = Vector2.down;

    public string animalType = "Geyik";
    public int maxHealth = 6;
    public float moveSpeed = 2f;
    public float roamRadius = 5f;
    public float baseDetectionRadius = 4f;
    public float nightDetectionFactor = 0.5f;
    public float fleeSpeedMultiplier = 1.5f;
    public float animalCount = 3;

    public GameObject meatPrefab;
    public GameObject hidePrefab;
    public GameObject hpBarPrefab;

    private int currentHealth;
    private GameObject hpBarInstance;
    private Image hpFillImage;

    private Vector2 roamTarget;
    private AnimalState currentState = AnimalState.Roaming;

    private Transform threatTarget;
    private float detectionRadius;

    private float nightBehaviorTimer;
    private bool isNight;
    

    [Header("Flee Tuning")]
    public float minScareCooldown = 0.5f; // spam Ã¶nlemek iÃ§in
    private float lastScareTime = -999f;

    private Vector2? fleeFromPoint = null;   // tehdit noktasÄ± (silah sesi/mermi)
    private float tempFleeMultiplier = 1f;
    private Coroutine fleeTimerCo;

    void Start()
    {

        animator = GetComponent<Animator>();
        if (animator == null) Debug.LogError("[Animal] Animator bileÅŸeni bulunamadÄ±!");
        currentHealth = maxHealth;
        detectionRadius = baseDetectionRadius;
        PickNewRoamTarget();

        //deneme

        if (hpBarPrefab != null)
        {
            hpBarInstance = Instantiate(hpBarPrefab, transform.position + Vector3.up * 1f, Quaternion.identity);
            hpBarInstance.transform.SetParent(transform, true);

            Transform fill = hpBarInstance.transform.Find("Background/Fill");
            if (fill != null)
                hpFillImage = fill.GetComponent<Image>();
        }

        // Gecelik davranÄ±ÅŸÄ± tetikleyici
        InvokeRepeating(nameof(UpdateNightBehavior), 0f, 10f);
    }

    void Update()
    {
        DetectThreats();

        switch (currentState)
        {
            case AnimalState.Roaming:
            case AnimalState.NightRoaming:
                Roam();
                break;

            case AnimalState.Fleeing:
                Flee();
                break;

            case AnimalState.Sleeping:
                // sadece uyurken idle'a zorla
                UpdateAnimator(Vector2.zero, 0f);
                break;
        }
    }

    void OnEnable()
    {
        AnimalSoundEmitter.OnSound += OnSoundHeard;
    }

    void OnDisable()
    {
        AnimalSoundEmitter.OnSound -= OnSoundHeard;
    }

    private void OnSoundHeard(SoundEvent s)
    {
        // Uzaksa veya uyuyor ve duymasÄ± istenmiyorsa (istersen burada Sleep'e istisna koyabilirsin)
        if (Vector2.Distance(transform.position, s.position) > s.radius) return;

        // Gece/gÃ¼ndÃ¼z fark etmeksizin panik
        Scare(s.position, s.fleeDuration, s.speedMultiplier);
    }

    private Vector2 GetAnimCardinalDir(Vector2 dir)
    {
        if (dir.sqrMagnitude < 0.0001f) return lastAnimDir;

        float ax = Mathf.Abs(dir.x);
        float ay = Mathf.Abs(dir.y);

        // eksen seÃ§imini biraz yapÄ±ÅŸkan yap
        bool preferX = ax > ay + axisHysteresis;
        bool preferY = ay > ax + axisHysteresis;

        Vector2 target;
        if (preferX || (!preferY && lastAnimDir.y != 0))
            target = new Vector2(dir.x >= 0f ? 1f : -1f, 0f);
        else if (preferY || (!preferX && lastAnimDir.x != 0))
            target = new Vector2(0f, dir.y >= 0f ? 1f : -1f);
        else
            target = (ax >= ay) ? new Vector2(dir.x >= 0f ? 1f : -1f, 0f)
                                : new Vector2(0f, dir.y >= 0f ? 1f : -1f);

        if (Mathf.Abs(dir.x) < dirDeadzone && lastAnimDir.x != 0f) target = lastAnimDir;
        if (Mathf.Abs(dir.y) < dirDeadzone && lastAnimDir.y != 0f) target = lastAnimDir;

        return target;
    }

    public void Scare(Vector2 fromPosition, float duration, float speedMult)
    {
        if (Time.time - lastScareTime < minScareCooldown) return;
        lastScareTime = Time.time;

        fleeFromPoint = fromPosition;
        tempFleeMultiplier = Mathf.Max(speedMult, 1f);
        currentState = AnimalState.Fleeing;

        if (fleeTimerCo != null) StopCoroutine(fleeTimerCo);
        fleeTimerCo = StartCoroutine(StopFleeAfter(duration));
    }

    private System.Collections.IEnumerator StopFleeAfter(float seconds)
    {
        yield return new WaitForSeconds(seconds);
        fleeFromPoint = null;
        tempFleeMultiplier = 1f;

        // Panik sonrasÄ± rutinine dÃ¶n
        if (isNight) EnterNightMode();
        else currentState = AnimalState.Roaming;

        PickNewRoamTarget();
        fleeTimerCo = null;
    }


    void DetectThreats()
    {
        if (currentState == AnimalState.Sleeping) return;

        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, detectionRadius);
        foreach (var hit in hits)
        {
            if (hit.CompareTag("Player") || hit.CompareTag("Enemy"))
            {
                currentState = AnimalState.Fleeing;
                threatTarget = hit.transform;
                return;
            }
        }

        if (currentState == AnimalState.Fleeing && threatTarget == null)
        {
            if (isNight)
                EnterNightMode(); // tekrar gece davranÄ±ÅŸÄ±na dÃ¶n
            else
                currentState = AnimalState.Roaming;

            PickNewRoamTarget();
        }
    }

    void Roam()
    {
        float distance = Vector2.Distance(transform.position, roamTarget);
        if (distance < 0.5f)
        {
            PickNewRoamTarget();
        }

        Vector2 dir = (roamTarget - (Vector2)transform.position).normalized;
        MoveWithAnim(dir, moveSpeed);
    }

    void Flee()
    {
        // Ã–ncelik: canlÄ± tehdit -> tehdit hedefi (Player/Enemy)
        // Yoksa: en son duyulan/gelinen tehdit noktasÄ±
        Vector2 source;

        if (threatTarget != null)
        {
            source = threatTarget.position;
        }
        else if (fleeFromPoint.HasValue)
        {
            source = fleeFromPoint.Value;
        }
        else
        {
            // GÃ¼venli geri dÃ¶nÃ¼ÅŸ
            if (isNight) { EnterNightMode(); } else { currentState = AnimalState.Roaming; }
            PickNewRoamTarget();
            UpdateAnimator(Vector2.zero, 0f); // gÃ¼venli
            return;
        }

        Vector2 dir = ((Vector2)transform.position - source).normalized;
        float speed = moveSpeed * fleeSpeedMultiplier * tempFleeMultiplier;
        MoveWithAnim(dir, speed);
    }

    private void MoveWithAnim(Vector2 dir, float speed)
    {
        if (dir.sqrMagnitude > 0.0001f)
            transform.Translate(dir * speed * Time.deltaTime);

        Vector2 animDir = GetAnimCardinalDir(dir);     // <-- kritik
        UpdateAnimator(animDir, speed);
    }

    private void UpdateAnimator(Vector2 animDir, float speed)
    {
        if (animator == null) return;

        bool isMovingNow = animDir.sqrMagnitude > 0.0001f && speed > 0.01f;
        animator.SetBool("isMoving", isMovingNow);

        if (isMovingNow)
        {
            animator.SetFloat("MoveX", animDir.x);  // -1,0,1
            animator.SetFloat("MoveY", animDir.y);  // -1,0,1
            lastMoveDir = animDir;
            lastAnimDir = animDir;
        }
        else
        {
            animator.SetFloat("MoveX", lastMoveDir.x);
            animator.SetFloat("MoveY", lastMoveDir.y);
        }
    }

    void PickNewRoamTarget()
    {
        Vector2 randomOffset = Random.insideUnitCircle * roamRadius;
        roamTarget = (Vector2)transform.position + randomOffset;
    }

    public void TakeDamage(int damage)
    {
        currentHealth -= damage;

        if (hpFillImage != null)
        {
            float fillValue = Mathf.Clamp01((float)currentHealth / maxHealth);
            hpFillImage.fillAmount = fillValue;
        }

        // â— Vurulduysa, saldÄ±rÄ± yÃ¶nÃ¼nÃ¼ bilmiyorsak bile rastgele uzaÄŸa kaÃ§
        if (!fleeFromPoint.HasValue && threatTarget == null)
        {
            // kÃ¼Ã§Ã¼k bir ofsetle bulunduÄŸu yerden ters yÃ¶ne hedef seÃ§
            Vector2 away = (Vector2)transform.position + Random.insideUnitCircle.normalized * 2f;
            Scare(away, 3f, 2.0f);
        }

        if (currentHealth <= 0)
        {
            DropLoot();
            if (hpBarInstance != null) Destroy(hpBarInstance);
            Destroy(gameObject);
        }
    }

    void DropLoot()
    {
        Instantiate(meatPrefab, transform.position, Quaternion.identity);
        Instantiate(hidePrefab, transform.position + Vector3.right * 0.5f, Quaternion.identity);
    }

    public void SetNight(bool night)
    {
        isNight = night;
        detectionRadius = baseDetectionRadius * (isNight ? nightDetectionFactor : 1f);
        EnterNightMode();
    }

    void EnterNightMode()
    {
        if (!isNight) return;

        // %50 ÅŸansla uyur, %50 gezer
        if (Random.value < 0.5f)
            currentState = AnimalState.Sleeping;
        else
            currentState = AnimalState.NightRoaming;

        PickNewRoamTarget();
    }

    void UpdateNightBehavior()
    {
        if (isNight)
            EnterNightMode(); // her 10 saniyede yeniden davranÄ±ÅŸ belirle
    }

    void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.yellow;
        Gizmos.DrawWireSphere(transform.position, detectionRadius);
    }
}
using System;
using UnityEngine;

public struct SoundEvent
{
    public Vector2 position;
    public float radius;
    public float fleeDuration;
    public float speedMultiplier;

    public SoundEvent(Vector2 pos, float rad, float dur = 2f, float mult = 1.5f)
    {
        position = pos;
        radius = rad;
        fleeDuration = dur;
        speedMultiplier = mult;
    }
}

public static class AnimalSoundEmitter
{
    public static event Action<SoundEvent> OnSound;

    // ğŸ”¹ 2 parametreli versiyon (default deÄŸerlerle)
    public static void EmitSound(Vector2 pos, float radius)
    {
        EmitSound(pos, radius, 2f, 1.5f);
    }

    // ğŸ”¹ 4 parametreli versiyon
    public static void EmitSound(Vector2 pos, float radius, float fleeDuration, float speedMultiplier)
    {
        OnSound?.Invoke(new SoundEvent(pos, radius, fleeDuration, speedMultiplier));
    }
}
public enum AnimalState
{
    Roaming,
    Fleeing,
    Sleeping,
    NightRoaming
}
// AudioManager.cs
using UnityEngine;
using UnityEngine.Audio;

public class AudioManager : MonoBehaviour
{
    public static AudioManager Instance { get; private set; }

    [Header("Mixer")]
    public AudioMixer mainMixer;            // MainMixer.asset
    public AudioMixerGroup musicGroup;      // Inspector: Music
    public AudioMixerGroup sfxGroup;        // Inspector: SFX

    [Tooltip("Exposed param adlarÄ±")]
    public string musicParam = "MusicVolume";
    public string sfxParam = "SFXVolume";
    public string masterParam = "MasterVolume";

    void Awake()
    {
        if (Instance == null) { Instance = this; DontDestroyOnLoad(gameObject); }
        else { Destroy(gameObject); return; }

        float master = PlayerPrefs.GetFloat("MasterVolume", 1f);
        float music = PlayerPrefs.GetFloat("MusicVolume", 1f);
        float sfx = PlayerPrefs.GetFloat("SFXVolume", 1f);
        SetMasterVolume(master);
        SetMusicVolume(music);
        SetSFXVolume(sfx);
    }

    float ToDecibels(float value) => (value <= 0.0001f) ? -80f : Mathf.Log10(value) * 20f;

    public void SetMasterVolume(float v)
    {
        mainMixer.SetFloat(masterParam, ToDecibels(v));
        PlayerPrefs.SetFloat("MasterVolume", v);
    }
    public void SetMusicVolume(float v)
    {
        mainMixer.SetFloat(musicParam, ToDecibels(v));
        PlayerPrefs.SetFloat("MusicVolume", v);
    }

    public void SetSFXVolume(float v)
    {
        mainMixer.SetFloat(sfxParam, ToDecibels(v));
        PlayerPrefs.SetFloat("SFXVolume", v);
    }

    // PlayClipAtPoint alternatifi: miksere baÄŸlÄ± tek-seferlik Ã§alma
    public void PlayOneShotAt(AudioClip clip, Vector3 pos, float volume = 1f)
    {
        if (clip == null || sfxGroup == null) return;
        var go = new GameObject("OneShotSFX");
        go.transform.position = pos;
        var src = go.AddComponent<AudioSource>();
        src.outputAudioMixerGroup = sfxGroup;
        src.spatialBlend = 0f; // 2D UI/SFX ise 0f, 3D istiyorsan 1fâ€™e Ã§ekebilirsin
        src.PlayOneShot(clip, volume);
        Destroy(go, clip.length + 0.1f);
    }

    // Bir AudioSourceâ€™u programatik olarak SFXâ€™e baÄŸlamak istersen:
    public void RouteToSFX(AudioSource src)
    {
        if (src != null && sfxGroup != null) src.outputAudioMixerGroup = sfxGroup;
    }

    public void RouteToMusic(AudioSource src)
    {
        if (src != null && musicGroup != null) src.outputAudioMixerGroup = musicGroup;
    }
}
// MusicManager.cs

using UnityEngine;
using System.Collections; // Coroutine iÃ§in
using System.Collections.Generic; // List iÃ§in

[RequireComponent(typeof(AudioSource))]
public class MusicManager : MonoBehaviour
{
    public static MusicManager Instance { get; private set; }

    [Header("Music Playlists")]
    public List<AudioClip> dayMusicPlaylist;
    public List<AudioClip> nightMusicPlaylist;

    [Header("Settings")]
    [Tooltip("ÅarkÄ±lar arasÄ±ndaki geÃ§iÅŸin yumuÅŸaklÄ±ÄŸÄ± (saniye).")]
    public float crossfadeDuration = 2.0f;

    private AudioSource audioSource;
    private bool isDay = true;
    private int currentTrackIndex = -1;

    private bool isAppPaused = false;
    private bool wasPausedByFocus = false;

    void Awake()
    {
        Debug.Log("ğŸµ MusicManager Awake Ã‡ALIÅTI! Playlist Day=" 
          + dayMusicPlaylist.Count 
          + " Night=" + nightMusicPlaylist.Count);

        // Singleton Pattern
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject); // Bu yÃ¶neticinin sahneler arasÄ± geÃ§iÅŸte kalmasÄ±nÄ± saÄŸlar.
        }
        else
        {
            Destroy(gameObject);
            return;
        }

        audioSource = GetComponent<AudioSource>();
        audioSource.loop = false; // ÅarkÄ± bitince Coroutine ile yenisini baÅŸlatacaÄŸÄ±z.
    }

    void Update()
    {
        // Uygulama odak dÄ±ÅŸÄ±ndayken/pauselayken asla parÃ§a deÄŸiÅŸtirme
        if (isAppPaused) return;

        // Sadece gerÃ§ekten ÅŸarkÄ± bitince yeni parÃ§aya geÃ§
        if (!audioSource.isPlaying && (isDay ? dayMusicPlaylist.Count > 0 : nightMusicPlaylist.Count > 0))
        {
            PlayNextTrack();
        }
    }
public void StopAll()
{
    if (audioSource != null)
    {
        audioSource.Stop();
        audioSource.clip = null;      // Clip temizlensin
        audioSource.time = 0f;        // ParÃ§a zamanÄ± reset
        // audioSource.enabled = false;  // âŒ KALDIRILDI!
    }

    currentTrackIndex = -1;
}




    // DayNightCycle bu fonksiyonu Ã§aÄŸÄ±rarak durumu bildirir.
    public void SetDay(bool isCurrentlyDay)
{
    // Durumu her zaman gÃ¼ncelle
    this.isDay = isCurrentlyDay;

    // MÃ¼zik Ã§almÄ±yorsa direkt baÅŸlat
    if (!audioSource.isPlaying || audioSource.clip == null)
    {
        PlayNextTrack();
        return;
    }

    // EÄŸer mÃ¼zik Ã§alÄ±yorsa crossfade yap
    StartCoroutine(CrossfadeToNextTrack());
}


    private void PlayNextTrack()
    {
        List<AudioClip> currentPlaylist = isDay ? dayMusicPlaylist : nightMusicPlaylist;
        if (currentPlaylist.Count == 0) return;

        // Rastgele bir sonraki ÅŸarkÄ± seÃ§ (aynÄ± ÅŸarkÄ±yÄ± tekrar Ã§almasÄ±n diye kontrol edebiliriz).
        int nextTrackIndex = Random.Range(0, currentPlaylist.Count);
        if (currentPlaylist.Count > 1 && nextTrackIndex == currentTrackIndex)
        {
            nextTrackIndex = (nextTrackIndex + 1) % currentPlaylist.Count;
        }
        currentTrackIndex = nextTrackIndex;

        audioSource.clip = currentPlaylist[currentTrackIndex];
        audioSource.Play();
    }

    private IEnumerator CrossfadeToNextTrack()
    {
        float startVolume = audioSource.volume;

        // Sesi yavaÅŸÃ§a kÄ±s
        while (audioSource.volume > 0)
        {
            audioSource.volume -= startVolume * Time.deltaTime / crossfadeDuration;
            yield return null;
        }

        audioSource.Stop();
        audioSource.volume = startVolume; // Sesi eski haline getir

        // Yeni duruma gÃ¶re bir sonraki ÅŸarkÄ±yÄ± Ã§al
        PlayNextTrack();
    }

    // Uygulama duraklatÄ±ldÄ±ÄŸÄ±nda/geri gelince Ã§aÄŸrÄ±lÄ±r
    void OnApplicationPause(bool pause)
    {
        isAppPaused = pause;
        if (audioSource == null) return;

        if (pause)
        {
            // Odak gidince o anki ÅŸarkÄ±yÄ± duraklat (clip ve time korunur)
            if (audioSource.isPlaying)
            {
                audioSource.Pause();
                wasPausedByFocus = true;
            }
        }
        else
        {
            // Geri dÃ¶nÃ¼nce aynen kaldÄ±ÄŸÄ± yerden devam et
            if (wasPausedByFocus)
            {
                audioSource.UnPause();
                wasPausedByFocus = false;
            }
        }
    }

    // BazÄ± platformlarda sadece focus tetiklenir; aynÄ± mantÄ±ÄŸÄ± yÃ¶nlendir
    void OnApplicationFocus(bool hasFocus)
    {
        OnApplicationPause(!hasFocus);
    }

    
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class CampfireCooking : MonoBehaviour
{
    [Header("Cooking")]
    public float cookTime = 5f;
    public GameObject cookedMeatPrefab;
    public Transform dropPoint;

    [SerializeField] private ItemData meatSO;
    [SerializeField] private ItemData cookedMeatSO;

    [Header("UI")]
    public GameObject progressCanvas;
    public Slider progressBar;

    private bool isPlayerNearby = false;
    private bool isCooking = false;
    private float holdTimer = 0f;

    void Start()
    {
        if (progressCanvas) progressCanvas.SetActive(false);
        if (progressBar) progressBar.value = 0f;
    }

    void Update()
    {
        if (!isPlayerNearby) return;

        bool hasMeat = Inventory.Instance.GetTotalCount(meatSO) > 0;

        if (hasMeat && Keyboard.current.cKey.isPressed)
        {
            if (!isCooking)
            {
                isCooking = true;
                if (progressCanvas) progressCanvas.SetActive(true);
            }

            holdTimer += Time.deltaTime;
            if (progressBar) progressBar.value = holdTimer / cookTime;

            if (holdTimer >= cookTime)
            {
                CookMeat();
                ResetCooking();
            }
        }
        else
        {
            if (isCooking)
                ResetCooking();
        }
    }

    private void CookMeat()
    {
        if (Inventory.Instance.TryConsume(meatSO, 1))
        {
            Vector3 pos = dropPoint ? dropPoint.position
                                    : transform.position + new Vector3(0.4f, 0f, 0f);

            Instantiate(cookedMeatPrefab, pos, Quaternion.identity);
        }
    }

    private void ResetCooking()
    {
        isCooking = false;
        holdTimer = 0f;

        if (progressBar) progressBar.value = 0f;
        if (progressCanvas) progressCanvas.SetActive(false);
    }

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player")) isPlayerNearby = true;
    }

    void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            ResetCooking();
        }
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;
using TMPro;

public class CampfireInteraction : MonoBehaviour
{
    [SerializeField] private ItemData meatSO;
    [SerializeField] private ItemData cookedMeatSO;

    [Header("Cooking")]
    public GameObject cookedMeatPrefab;
    public Transform dropPoint;
    public float cookDuration = 5f;
    public AudioSource sfx;
    public AudioClip sizzleClip;

    [Header("UI")]
    public GameObject cookPromptPanel;
    public TextMeshProUGUI cookPromptText;
    public Slider cookProgress;

    private bool isPlayerNearby = false;
    private bool isHolding = false;
    private float holdTimer = 0f;

    void Start()
    {
        if (cookPromptPanel != null) cookPromptPanel.SetActive(false);
        if (cookProgress != null) cookProgress.value = 0f;
    }

    void Update()
    {
        if (!isPlayerNearby)
        {
            HidePrompt();
            return;
        }

        bool hasMeat = Inventory.Instance.GetTotalCount(meatSO) > 0;

        if (cookPromptPanel) cookPromptPanel.SetActive(hasMeat);
        if (cookPromptText) cookPromptText.text = hasMeat ? "C'ye basÄ±lÄ± tut: Eti PiÅŸir" : "Et yok";

        if (!hasMeat)
        {
            ResetHold();
            return;
        }

        if (Keyboard.current.cKey.isPressed)
        {
            isHolding = true;
            holdTimer += Time.deltaTime;

            if (cookProgress != null)
                cookProgress.value = holdTimer / cookDuration;

            if (holdTimer >= cookDuration)
            {
                CookAndDrop();
                ResetHold();
            }
        }
        else
        {
            if (isHolding)
                ResetHold();
        }
    }

    private void CookAndDrop()
    {
        if (!Inventory.Instance.TryConsume(meatSO, 1))
        {
            Debug.Log("ğŸ¥© Et yok, piÅŸirme iptal.");
            return;
        }

        if (sfx && sizzleClip)
            sfx.PlayOneShot(sizzleClip);

        Vector3 pos = dropPoint
            ? dropPoint.position
            : transform.position + new Vector3(0.4f, 0, 0);

        Instantiate(cookedMeatPrefab, pos, Quaternion.identity);
    }

    private void ResetHold()
    {
        isHolding = false;
        holdTimer = 0f;

        if (cookProgress != null)
            cookProgress.value = 0f;
    }

    private void HidePrompt()
    {
        if (cookPromptPanel) cookPromptPanel.SetActive(false);
        ResetHold();
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player")) isPlayerNearby = true;
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            HidePrompt();
        }
    }
}
using UnityEngine;
using UnityEngine.UI;

public class CaravanHealth : MonoBehaviour
{
    public int maxHealth = 10;
    private int currentHealth;

    public Slider healthSlider;  // UI'dan baÄŸlanacak

    void Start()
    {
        currentHealth = maxHealth;
        UpdateUI();
    }

    public void TakeDamage(int damage)
    {
        currentHealth -= damage;
        UpdateUI();

        if (currentHealth <= 0)
        {
            Debug.Log("ğŸšï¸ Karavan yÄ±kÄ±ldÄ±! Oyun bitti.");
            GameManager.Instance.GameOver();
        }

    }

    void UpdateUI()
    {
        if (healthSlider != null)
            healthSlider.value = (float)currentHealth / maxHealth;
    }
}
using UnityEngine;
using UnityEngine.UI;

public class CaravanIndicator : MonoBehaviour
{
    public Transform player;
    public Transform caravan;
    public RectTransform canvasRect;
    public RectTransform indicator;

    private CanvasGroup canvasGroup;

    [Header("Animasyon AyarlarÄ±")]
    public float fadeSpeed = 5f;
    public float scaleSpeed = 5f;
    public float targetAlpha = 1f;
    public Vector3 visibleScale = Vector3.one;
    public Vector3 hiddenScale = Vector3.zero;

    void Start()
    {
        canvasGroup = indicator.GetComponent<CanvasGroup>();
        if (canvasGroup == null)
            Debug.LogError("âŒ CanvasGroup eksik! LÃ¼tfen CaravanIndicator objesine ekleyin.");

        // BaÅŸlangÄ±Ã§ durumu
        canvasGroup.alpha = 0f;
        indicator.localScale = hiddenScale;
    }

    void Update()
    {
        if (player == null || caravan == null || indicator == null || canvasRect == null) return;

        Vector3 direction = caravan.position - player.position;

        // Kamera gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ kontrolÃ¼
        Vector3 viewportPos = Camera.main.WorldToViewportPoint(caravan.position);
        bool isCaravanVisible = viewportPos.x >= 0f && viewportPos.x <= 1f &&
                               viewportPos.y >= 0f && viewportPos.y <= 1f &&
                               viewportPos.z > 0f;

        bool shouldShow = !isCaravanVisible;

        // Fade ve Scale animasyonu
        float target = shouldShow ? targetAlpha : 0f;
        canvasGroup.alpha = Mathf.Lerp(canvasGroup.alpha, target, Time.deltaTime * fadeSpeed);
        indicator.localScale = Vector3.Lerp(indicator.localScale, shouldShow ? visibleScale : hiddenScale, Time.deltaTime * scaleSpeed);

        if (!shouldShow) return;

        // YÃ¶n gÃ¶sterimi
        float angle = Mathf.Atan2(direction.y, direction.x) * Mathf.Rad2Deg;
        indicator.rotation = Quaternion.Euler(0, 0, angle - 90f);

        Vector3 screenPoint = Camera.main.WorldToViewportPoint(player.position + direction.normalized * 5f);
        screenPoint = new Vector3(Mathf.Clamp01(screenPoint.x), Mathf.Clamp01(screenPoint.y), 0);

        Vector2 canvasSize = canvasRect.sizeDelta;
        Vector2 uiPos = new Vector2(
            (screenPoint.x * canvasSize.x) - (canvasSize.x / 2),
            (screenPoint.y * canvasSize.y) - (canvasSize.y / 2)
        );

        indicator.anchoredPosition = uiPos;
    }
}
using UnityEngine;

public class CaravanInteraction : MonoBehaviour
{
    [Header("Ayarlar")]
    public float interactDistance = 2f;

    [Header("Durum")]
    public bool playerInRange = false;   // CraftInput burayÄ± kontrol edecek

    private Transform player;

    private void Start()
    {
        player = GameObject.FindWithTag("Player")?.transform;
    }

    private void Update()
    {
        if (player == null) return;

        float dist = Vector2.Distance(player.position, transform.position);

        // Oyuncu karavana yakÄ±n mÄ±?
        playerInRange = dist <= interactDistance;
    }
}
using System.Collections.Generic;
using UnityEngine;

public class CaravanInventory : MonoBehaviour
{
    public static CaravanInventory Instance;

    // WeaponType â†’ List<WeaponData>
    public Dictionary<WeaponType, List<WeaponData>> storedWeapons =
        new Dictionary<WeaponType, List<WeaponData>>();

    private void Awake()
    {
        Instance = this;

        foreach (WeaponType type in System.Enum.GetValues(typeof(WeaponType)))
        {
            storedWeapons[type] = new List<WeaponData>();
        }
    }


    // ============================================
    // 1) WeaponSlotManager tarafÄ±ndan Ã§aÄŸrÄ±lan sistem
    // ============================================
    public void AddItem(string itemID, int amount = 1)
    {
        ItemData data = ItemDatabase.Get(itemID);
        if (data == null)
        {
            Debug.LogError("CaravanInventory â†’ itemID bulunamadÄ±: " + itemID);
            return;
        }

        WeaponItemData wid = data as WeaponItemData;
        if (wid == null)
        {
            Debug.LogError("CaravanInventory.AddItem â†’ Bu item bir silah deÄŸil: " + itemID);
            return;
        }

        StoreWeapon(wid.weaponData);
    }


    // ============================================
    // 2) Silah depolama (WeaponData)
    // ============================================
    public void StoreWeapon(WeaponData data)
    {
        if (!storedWeapons.ContainsKey(data.weaponType))
            storedWeapons[data.weaponType] = new List<WeaponData>();

        storedWeapons[data.weaponType].Add(data);

        Debug.Log($"{data.weaponType} tÃ¼rÃ¼nde silah karavana eklendi: {data.itemName}");
    }


    // ============================================
    // 3) UI veya Swap iÃ§in Silah Ã‡ekme
    // ============================================
    public WeaponData TakeWeapon(WeaponType type, int index)
    {
        if (!storedWeapons.ContainsKey(type) || storedWeapons[type].Count == 0)
            return null;

        if (index < 0 || index >= storedWeapons[type].Count)
            return null;

        WeaponData w = storedWeapons[type][index];
        storedWeapons[type].RemoveAt(index);

        return w;
    }


    // ============================================
    // 4) Silah listesini dÃ¶ndÃ¼r (UI iÃ§in)
    // ============================================
    public List<WeaponData> GetWeapons(WeaponType type)
    {
        if (!storedWeapons.ContainsKey(type))
            storedWeapons[type] = new List<WeaponData>();

        return storedWeapons[type];
    }



    // ============================================
    // 5) SAVE SYSTEM
    // ============================================
    public CaravanSaveData GetSaveData()
    {
        CaravanSaveData save = new CaravanSaveData();

        foreach (var kvp in storedWeapons)
        {
            WeaponSaveEntry entry = new WeaponSaveEntry();
            entry.type = kvp.Key;
            entry.weaponIDs = new List<string>();

            foreach (var weapon in kvp.Value)
            {
                entry.weaponIDs.Add(weapon.itemID);
            }

            save.weaponEntries.Add(entry);
        }

        return save;
    }
    public bool HasWeapon(WeaponData weapon)
{
    if (!storedWeapons.ContainsKey(weapon.weaponType))
        return false;

    foreach (var w in storedWeapons[weapon.weaponType])
    {
        if (w.itemID == weapon.itemID)
            return true;
    }

    return false;
}

public void LoadFromData(CaravanSaveData save)
{
    // TÃ¼m silahlarÄ± temizle
    foreach (var key in storedWeapons.Keys)
        storedWeapons[key].Clear();

    // Save verisini geri yÃ¼kle
    foreach (var entry in save.weaponEntries)
    {
        if (!storedWeapons.ContainsKey(entry.type))
            storedWeapons[entry.type] = new List<WeaponData>();

        foreach (string id in entry.weaponIDs)
        {
            ItemData data = ItemDatabase.Get(id);

            if (data is WeaponItemData wid)
                storedWeapons[entry.type].Add(wid.weaponData);
        }
    }

    Debug.Log("CaravanInventory yÃ¼klendi.");
}



}
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CaravanWeaponUI : MonoBehaviour
{
    public Transform pistolRoot;
    public Transform rifleRoot;
    public Transform meleeRoot;

    public GameObject weaponButtonPrefab;

    private void OnEnable()
    {
        RefreshUI();
    }

    public void RefreshUI()
    {
        Clear(pistolRoot);
        Clear(rifleRoot);
        Clear(meleeRoot);

        // Pistols
        CreateButtons(WeaponType.Pistol, pistolRoot);

        // Rifles (MachineGun, Shotgun, Sniper, Bow hepsi Rifle slotunda)
        CreateButtons(WeaponType.MachineGun, rifleRoot);
        CreateButtons(WeaponType.Shotgun, rifleRoot);
        CreateButtons(WeaponType.Sniper, rifleRoot);
        CreateButtons(WeaponType.Bow, rifleRoot);

        // Melee weapons
        CreateButtons(WeaponType.MeeleSword, meleeRoot);
        CreateButtons(WeaponType.ThrowingSpear, meleeRoot);
    }

    private void Clear(Transform parent)
    {
        foreach (Transform child in parent)
            Destroy(child.gameObject);
    }

    private void CreateButtons(WeaponType type, Transform root)
    {
        List<WeaponData> list = CaravanInventory.Instance.GetWeapons(type);

        for (int i = 0; i < list.Count; i++)
        {
            WeaponData weapon = list[i];

            GameObject btnGO = Instantiate(weaponButtonPrefab, root);

            // UI text update
            TMP_Text txt = btnGO.GetComponentInChildren<TMP_Text>();
            if (txt != null)
                txt.text = weapon.itemName;

            Button btn = btnGO.GetComponent<Button>();

            int indexCopy = i;
            btn.onClick.AddListener(() =>
            {
                OnWeaponSelected(type, indexCopy);
            });
        }
    }

    private void OnWeaponSelected(WeaponType type, int index)
    {
        // 1) Karavandan silahÄ± Ã§ek
        WeaponData selected = CaravanInventory.Instance.TakeWeapon(type, index);

        if (selected == null)
        {
            Debug.LogError("Karavandan silah alÄ±namadÄ±!");
            return;
        }

        // 2) Bu silah hangi slotta kullanÄ±lacak?
        WeaponSlotType slotType = WeaponSlotManager.Instance.GetSlotForWeapon(selected);
        int slotIndex = (int)slotType;

        // 3) Oyuncunun Ã¼zerindeki aynÄ± slot silahÄ±nÄ± karavana gÃ¶nder
        WeaponData oldWeapon = WeaponSlotManager.Instance.slots[slotIndex];

        if (oldWeapon != null)
        {
            CaravanInventory.Instance.StoreWeapon(oldWeapon);
        }

        // 4) Yeni silahÄ± oyuncuya tak
        WeaponSlotManager.Instance.slots[slotIndex] = selected;

        WeaponSlotManager.Instance.clip[slotIndex] = selected.clipSize;
        WeaponSlotManager.Instance.reserve[slotIndex] = selected.maxAmmoCapacity;

        // 5) EÄŸer aktif slot ise handlerâ€™Ä± gÃ¼ncelle
        if (WeaponSlotManager.Instance.activeSlotIndex == slotIndex)
        {
            WeaponSlotManager.Instance.SwitchSlot(slotIndex);
        }

        Debug.Log($"ğŸ”„ Swap baÅŸarÄ±lÄ±! {selected.itemName} oyuncuya takÄ±ldÄ±.");

        // 6) UI yenile
        RefreshUI();
    }
}
using UnityEngine;
using TMPro;

public class GameClock : MonoBehaviour
{
    [Header("BaÄŸlantÄ±lar")]
    public DayNightCycle dayNightCycle;
    public TextMeshProUGUI timeText;
    public Transform player; // <<< AUTOSAVE Ä°Ã‡Ä°N EKLENDÄ°

    [Header("Zaman AyarlarÄ±")]
    public float dayStartHour = 6f;    // Oyun 06:00'da baÅŸlar
    public float nightStartHour = 19f; // AkÅŸam 19:00

    private float currentTime;   // 0â€“24 arasÄ± gerÃ§ek saat
    private float timeSpeed;     // GÃ¼ndÃ¼z hÄ±zÄ±
    private float nightSpeed;    // Gece hÄ±zÄ±

    // AUTOSAVE
    private bool savedThisMorning = false;
    private const int autoSaveHour = 8;   // 08:00'de kayÄ±t

    void Start()
    {
        if (dayNightCycle == null)
            dayNightCycle = FindObjectOfType<DayNightCycle>();

        // Saat baÅŸlangÄ±cÄ±
        currentTime = dayStartHour;

        // GÃ¼ndÃ¼z/gece hÄ±zlarÄ±
        timeSpeed = (nightStartHour - dayStartHour) / dayNightCycle.dayDuration;
        nightSpeed = ((24f - nightStartHour) + dayStartHour) / dayNightCycle.nightDuration;
    }

    private void Awake()
{
if (player == null)
{
    player = GameObject.FindWithTag("Player")?.transform;
    if (player == null) return;
}

}

    
    
    void Update()
    {
    

        // ---- ZAMAN Ä°LERLETME ----
        if (dayNightCycle.IsDay)
            currentTime += Time.deltaTime * timeSpeed;
        else
            currentTime += Time.deltaTime * nightSpeed;

        if (currentTime >= 24f)
        {
            currentTime -= 24f;
            savedThisMorning = false; // Yeni gÃ¼n baÅŸladÄ±
        }

        // ---- EKRANDA GÃ–STER ----
        int hour = Mathf.FloorToInt(currentTime);
        int minute = Mathf.FloorToInt((currentTime % 1f) * 60f);

        if (timeText != null)
            timeText.text = $"Saat: {hour:00}:{minute:00}";

        // ---- AUTOSAVE ----
        CheckAutoSave(hour, minute);
    }

    private void CheckAutoSave(int hour, int minute)
    {
        // EÄŸer tam 08:00'deysek ve daha Ã¶nce kaydetmediysek
        if (!savedThisMorning && hour == autoSaveHour && minute == 0)
        {
            if (player != null)
            {
                SaveSystem.SavePlayerAndInventory(
    player,
    Inventory.Instance,
    FindObjectOfType<PlayerStats>()
);


                Debug.Log("ğŸŸ¢ 08:00 â†’ Otomatik kayÄ±t alÄ±ndÄ±!");
            }
            else
            {
                Debug.LogWarning("âŒ GameClock: Player referansÄ± eksik, autosave yapÄ±lamadÄ±!");
            }

            savedThisMorning = true;
        }
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CraftCostUI : MonoBehaviour
{
    public Image icon;
    public TMP_Text amountText;

    public void Setup(ItemData item, int requiredAmount, int playerAmount)
    {
        if (icon != null && item != null)
            icon.sprite = item.icon;

        if (amountText != null)
        {
            amountText.text = $"{playerAmount}/{requiredAmount}";
            amountText.color = playerAmount >= requiredAmount ? Color.white : Color.red;
        }
    }
}
using System.Collections.Generic;
using UnityEngine;

public class CraftingSystem : MonoBehaviour
{
    public static CraftingSystem Instance { get; private set; }

    [Header("Tarifler (ScriptableObject WeaponCraftRecipe)")]
    public List<WeaponCraftRecipe> recipes = new();

    public CaravanInventory caravanInventory;

    // Craft edilip kalÄ±cÄ± aÃ§Ä±lan silahlar
    public HashSet<string> unlockedWeapons = new();

    private void Awake()
    {
        Instance = this;

        if (caravanInventory == null)
            caravanInventory = FindObjectOfType<CaravanInventory>();
    }

    // ------------------------------------------------------------
    // Tarife baÄŸlÄ± WeaponData'yÄ± al
    // ------------------------------------------------------------
    private WeaponData GetWeapon(WeaponCraftRecipe recipe)
    {
        return recipe?.resultWeapon;
    }

    private string GetKey(WeaponData weapon)
    {
        if (weapon == null) return "";

        if (!string.IsNullOrWhiteSpace(weapon.itemName))
            return weapon.itemName;

        return weapon.itemID;
    }

    public bool IsUnlocked(WeaponCraftRecipe recipe)
    {
        WeaponData w = GetWeapon(recipe);
        return unlockedWeapons.Contains(GetKey(w));
    }

    // ------------------------------------------------------------
    // Craft edilebilir mi?
    // ------------------------------------------------------------
    public bool CanCraft(WeaponCraftRecipe recipe)
    {
        if (recipe == null) return false;

        WeaponData weapon = GetWeapon(recipe);
        if (weapon == null) return false;

        if (IsUnlocked(recipe)) return false;

        foreach (var cost in recipe.costs)
        {
            if (!Inventory.Instance.HasEnough(cost.item, cost.amount))
                return false;
        }

        return true;
    }

    // ------------------------------------------------------------
    // Craft â†’ KARAVANA EKLE
    // ------------------------------------------------------------
    public bool TryCraft(WeaponCraftRecipe recipe)
{
    if (!CanCraft(recipe))
    {
        Debug.Log("Craft baÅŸarÄ±sÄ±z: Gereken koÅŸullar saÄŸlanmÄ±yor.");
        return false;
    }

    WeaponData weapon = GetWeapon(recipe);

    // 1) KaynaklarÄ± tÃ¼ket
    foreach (var cost in recipe.costs)
        Inventory.Instance.TryConsume(cost.item, cost.amount);

    // 2) SilahÄ± unlock et
    unlockedWeapons.Add(GetKey(weapon));

    // 3) Craft edilen silahÄ± OYUNCUYA TAK
    WeaponSlotManager.Instance.EquipCraftedWeapon(weapon);

    Debug.Log($"âœ” CRAFT BAÅARILI â†’ {weapon.itemName} oyuncuya takÄ±ldÄ±!");

    return true;
}

}
using UnityEngine;
using UnityEngine.InputSystem;

public class CraftInput : MonoBehaviour
{
    public CraftUIController craftUI;
    public GameObject inventoryPanel;

    public CaravanInteraction caravan;      // ZATEN VAR
    public GameObject caravanWeaponPanel;   // YENÄ°: silah swap paneli

    private PlayerControls controls;

    private void Awake()
    {
        controls = new PlayerControls();
    }

    private void OnEnable()
    {
        controls.Gameplay.Enable();
        controls.Gameplay.Craft.performed += OnCraftPressed;
        controls.Gameplay.CaravanWeapons.performed += OnCaravanWeaponsPressed; // YENÄ°
    }

    private void OnDisable()
    {
        controls.Gameplay.Craft.performed -= OnCraftPressed;
        controls.Gameplay.CaravanWeapons.performed -= OnCaravanWeaponsPressed; // YENÄ°
        controls.Gameplay.Disable();
    }

    // CRAFT TUÅU (eski)
    private void OnCraftPressed(InputAction.CallbackContext ctx)
    {
        if (craftUI == null) return;

        // Karavana yakÄ±n deÄŸilse craft aÃ§Ä±lmasÄ±n
        if (caravan != null && !caravan.playerInRange)
        {
            Debug.Log("Craft aÃ§Ä±lamadÄ± â†’ Karavana yakÄ±n deÄŸilsin.");
            return;
        }

        bool isOpen = craftUI.craftPanel.activeSelf;

        // Craft aÃ§Ä±lacaksa inventory kapat
        if (!isOpen && inventoryPanel != null && inventoryPanel.activeSelf)
            inventoryPanel.SetActive(false);

        // Craft aÃ§Ä±lÄ±rken karavan silah panelini de kapat
        if (!isOpen && caravanWeaponPanel != null && caravanWeaponPanel.activeSelf)
            caravanWeaponPanel.SetActive(false);

        if (isOpen)
            craftUI.Close();
        else
            craftUI.Open();
    }

    // KARAVAN SÄ°LAH PANEL TUÅU (yeni)
    private void OnCaravanWeaponsPressed(InputAction.CallbackContext ctx)
    {
        Debug.Log("V tuÅŸu algÄ±landÄ±!");
        if (caravan == null || !caravan.playerInRange)
        {
            Debug.Log("Karavan silah paneli aÃ§Ä±lamadÄ± â†’ Karavana yakÄ±n deÄŸilsin.");
            return;
        }

        if (caravanWeaponPanel == null)
        {
            Debug.LogWarning("CaravanWeaponPanel referansÄ± atanmadÄ±!");
            return;
        }

        bool isOpen = caravanWeaponPanel.activeSelf;

        if (!isOpen)
        {
            // AÃ§Ä±lÄ±rken diÄŸer UI'larÄ± kapat
            if (craftUI != null && craftUI.craftPanel.activeSelf)
                craftUI.Close();

            if (inventoryPanel != null && inventoryPanel.activeSelf)
                inventoryPanel.SetActive(false);
        }

        caravanWeaponPanel.SetActive(!isOpen);
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CraftSlotUI : MonoBehaviour
{
    public Image icon;
    public TMP_Text nameText;
    public Transform costRoot;
    public GameObject costEntryPrefab;

    private WeaponCraftRecipe recipe;

    public void Setup(WeaponCraftRecipe recipe, Sprite weaponIcon, string name)
    {
        this.recipe = recipe;

        icon.sprite = weaponIcon;
        nameText.text = name;

        RefreshCosts();
    }

    private void RefreshCosts()
    {
        // Eski maliyet entry'lerini temizle
        foreach (Transform t in costRoot)
            Destroy(t.gameObject);

        foreach (var cost in recipe.costs)
        {
            GameObject costGO = Instantiate(costEntryPrefab, costRoot);
            CraftCostUI ui = costGO.GetComponent<CraftCostUI>();

            int playerAmount = Inventory.Instance.GetItemCount(cost.item);

            ui.Setup(cost.item, cost.amount, playerAmount);
        }
    }

    // UI butonu iÃ§in
    public void OnSelectPressed()
    {
        CraftUIController.Instance.SelectRecipe(recipe);
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;



public class CraftUIController : MonoBehaviour
{
    [Header("UI")]
    public GameObject craftPanel;
    public Transform gridParent;
    public GameObject craftSlotPrefab;
    public Button craftButton;
    public TMP_Text craftButtonText;


    [Header("Logic")]
    public WeaponCraftRecipe selectedRecipe;

    public static CraftUIController Instance;

    private void Awake()
    {
        Instance = this;
    }

    private void Start()
    {
        PopulateRecipes();
        craftPanel.SetActive(false);
    }

    // ---------------------------------------------------------
    //  Tarif slotlarÄ±nÄ± oluÅŸtur
    // ---------------------------------------------------------
    public void PopulateRecipes()
    {
        // Grid Ã¼zerindeki eski slotlarÄ± sil
        foreach (Transform t in gridParent)
            Destroy(t.gameObject);

        if (CraftingSystem.Instance == null)
        {
            Debug.LogError("CraftingSystem.Instance bulunamadÄ±!");
            return;
        }

        // TÃ¼m WeaponCraftRecipe tariflerini slot olarak ekle
        foreach (var recipe in CraftingSystem.Instance.recipes)
        {
            GameObject slotGO = Instantiate(craftSlotPrefab, gridParent);

            CraftSlotUI slotUI = slotGO.GetComponent<CraftSlotUI>();
            if (slotUI == null)
            {
                Debug.LogError("CraftSlot prefabÄ±nda CraftSlotUI component yok!");
                continue;
            }

            // WeaponCraftRecipe â†’ WeaponData
            WeaponData weapon = recipe.resultWeapon;

            if (weapon == null)
            {
                Debug.LogError("Tarifte resultWeapon eksik!");
                continue;
            }

            // Slot UI setup
            slotUI.Setup(
                recipe,
                weapon.icon,     // WeaponData'daki icon
                weapon.itemName  // WeaponData'daki isim
            );
        }
    }

    // ---------------------------------------------------------
    //  Slot tÄ±klayÄ±nca tarif seÃ§ilir
    // ---------------------------------------------------------
    public void SelectRecipe(WeaponCraftRecipe recipe)
{
    selectedRecipe = recipe;

    WeaponData weapon = recipe.resultWeapon;

    bool existsInCaravan = CaravanInventory.Instance.HasWeapon(weapon);

    if (existsInCaravan)
    {
        craftButtonText.text = "Swap";      // Ã¼cretsiz deÄŸiÅŸim
    }
    else
    {
        craftButtonText.text = "Craft";     // malzeme gerektirir
    }
}


    // ---------------------------------------------------------
    //  Craft Butonu
    // ---------------------------------------------------------
    public void OnCraftButtonPressed()
{
    if (selectedRecipe == null)
    {
        Debug.Log("â— Tarif seÃ§ilmedi.");
        return;
    }

    WeaponData weapon = selectedRecipe.resultWeapon;

    bool existsInCaravan = CaravanInventory.Instance.HasWeapon(weapon);

    // ------------------------------------------------
    // 1) EÄER SÄ°LAH KARAVANDA VARSA â†’ SWAP
    // ------------------------------------------------
    if (existsInCaravan)
    {
        SwapWithCaravan(weapon);
        Debug.Log($"ğŸ”„ Swap â†’ {weapon.itemName} karavandan alÄ±ndÄ±.");
        
        Close();
        return;
    }

    // ------------------------------------------------
    // 2) DEÄÄ°LSE â†’ NORMAL CRAFT
    // ------------------------------------------------
    bool success = CraftingSystem.Instance.TryCraft(selectedRecipe);

    if (success)
    {
        Debug.Log($"âœ” Craft baÅŸarÄ±lÄ± â†’ {weapon.itemName} Ã¼retildi");
        PopulateRecipes();
        selectedRecipe = null;
        Close();
    }
    else
    {
        Debug.Log($"âŒ Craft baÅŸarÄ±sÄ±z â†’ {weapon.itemName}");
    }
}


private void SwapWithCaravan(WeaponData weapon)
{
    // Silah hangi slotta kullanÄ±lacak?
    WeaponSlotType slotType = WeaponSlotManager.Instance.GetSlotForWeapon(weapon);
    int slotIndex = (int)slotType;

    // Oyuncunun elindeki silah
    WeaponData currentWeapon = WeaponSlotManager.Instance.slots[slotIndex];

    // 1) Oyuncunun mevcut silahÄ±nÄ± karavana koy
    if (currentWeapon != null)
        CaravanInventory.Instance.StoreWeapon(currentWeapon);

    // 2) Karavandan bu silahÄ± al
    List<WeaponData> list = CaravanInventory.Instance.GetWeapons(weapon.weaponType);

    for (int i = 0; i < list.Count; i++)
    {
        if (list[i].itemID == weapon.itemID)
        {
            list.RemoveAt(i);
            break;
        }
    }

    // 3) Oyuncuya tak
    WeaponSlotManager.Instance.slots[slotIndex] = weapon;
    WeaponSlotManager.Instance.clip[slotIndex] = weapon.clipSize;
    WeaponSlotManager.Instance.reserve[slotIndex] = weapon.maxAmmoCapacity;

    WeaponSlotManager.Instance.SwitchSlot(slotIndex);
}



    // ---------------------------------------------------------
    //  Craft UI AÃ§ / Kapat
    // ---------------------------------------------------------
    public void Open()
    {
        PopulateRecipes(); 
        craftPanel.SetActive(true);
        Time.timeScale = 0f;
    }

    public void Close()
{
    craftPanel.SetActive(false);
    selectedRecipe = null;
    Time.timeScale = 1f;
}

}
using UnityEngine;
using UnityEngine.UI;
using System.Collections;
using System.Collections.Generic;
using Unity.VisualScripting;
using TMPro;

public class Enemy : MonoBehaviour
{

    [Header("Sun Burn (Daytime)")]
    public bool burnsInDay = true;
    public int burnDamagePerTick = 10;
    public float burnTickInterval = 1f;

    private Coroutine burnCo;
    private DayNightCycle dayNightCycle;


    public int maxHealth = 5;
    private int currentHealth;

    private bool isDaytimeCached = false;

    public TextMeshPro damageText;

    public GameObject hpBarPrefab; // Prefab atanacak

    public GameObject damagePopupPrefab;

    private Image hpFillImage; // STATIC KALDIRILDI
    private GameObject hpBarInstance;
    public GameObject goldPrefab; // Inspector'dan atanacak
    public GameObject[] blueprintPrefabs; // FarklÄ± blueprint objeleri atanabilir
    public EnemyType enemyType = EnemyType.Normal;
    public float moveSpeed = 2f;
    public int damageToCaravan = 1;
    private Animator animator;
    private AudioSource audioSource; // YENÄ°
    

    [SerializeField] private GameObject ammoMachineGunPrefab;
    [SerializeField] private GameObject ammoPistolPrefab;
    [SerializeField] private GameObject ammoShotgunPrefab;
    [SerializeField] private GameObject ammoSniperPrefab;


    [Header("Audio")]
    [Tooltip("DÃ¼ÅŸman doÄŸduÄŸunda veya belirli aralÄ±klarla Ã§alÄ±nacak sesler.")]
    public List<AudioClip> ambientSounds;
    [Tooltip("DÃ¼ÅŸman hasar aldÄ±ÄŸÄ±nda Ã§alÄ±nacak sesler.")]
    public List<AudioClip> hurtSounds;
    [Tooltip("DÃ¼ÅŸman Ã¶ldÃ¼ÄŸÃ¼nde Ã§alÄ±nacak ses.")]
    public AudioClip deathSound; // Genellikle tek bir Ã¶lÃ¼m sesi olur.

    [Tooltip("Rastgele ortam seslerinin Ã§alÄ±nma aralÄ±ÄŸÄ± (min ve max saniye).")]
    public Vector2 ambientSoundInterval = new Vector2(5f, 15f);

    [Header("Targets")]
    public Transform player;
    public Transform caravan; // Inspectorâ€™dan da atanabilir

    [Header("Armored Settings")]
    public float armoredDamageInterval = 1.0f;
    public int armoredCaravanDamage = 1;

    [Header("Exploder Settings")]
    public float explosionRadius = 2f;
    public int explosionDamageToPlayer = 2;
    public int explosionDamageToCaravan = 2;
    public LayerMask explosionHitMask;

    [Header("Knockback")]
    public bool canBeKnockedBack = true;
    public float knockbackRecoveryTime = 0.25f; // geri tepme sonrasÄ± hareketin toparlanma sÃ¼resi

    private Coroutine knockbackCoroutine;

    [Header("Contact Damage (Normal/Fast -> Player)")]
    public float contactDamageInterval = 1.0f;
    public int damageToPlayer = 1;

    [Header("Control")]
    public bool externalMovement = false; // sade varsayÄ±lan: false

    [Header("Attack Range Settings")]
    public float damageRangeToPlayer = 5f;
    public float damageRangeToCaravan = 5f;




    private bool isDamagingPlayer = false;
    private Coroutine caravanDamageCo;
    private Coroutine playerDamageCo;

    private Vector2 lastMoveDir = Vector2.down; // baÅŸlangÄ±Ã§ bakÄ±ÅŸ yÃ¶nÃ¼

    void Awake()
    {
        audioSource = GetComponent<AudioSource>();
        animator = GetComponent<Animator>();                // <-- ekle
        if (!animator) Debug.LogError("[Enemy] Animator eksik!");
        if (!audioSource) Debug.LogError("[Enemy] AudioSource eksik!");

    }


    void OnDisable()
    {
        DayNightCycle.OnDayNightChanged -= HandleDayNightChanged;
    }



    private void HandleDayNightChanged(bool isDay)
    {
        if (this == null || !gameObject) return; // ğŸ’¥ Koruma satÄ±rÄ±

        isDaytimeCached = isDay;

        if (!burnsInDay) return;

        if (isDay)
        {
            if (burnCo == null)
                burnCo = StartCoroutine(SunBurnRoutine());
        }
        else
        {
            if (burnCo != null)
            {
                StopCoroutine(burnCo);
                burnCo = null;
            }
        }
    }


    public Transform target;

    void Start()
    {
        // CanÄ± baÅŸlat
        currentHealth = maxHealth;

        if (hpBarPrefab != null)
        {
            hpBarInstance = Instantiate(hpBarPrefab, transform.position + Vector3.up * 1f, Quaternion.identity);
            hpBarInstance.transform.SetParent(transform); // dÃ¼ÅŸmanÄ± takip etsin
            Transform fill = hpBarInstance.transform.Find("Background/Fill");
            if (fill != null)
                hpFillImage = fill.GetComponent<Image>();
            else
                Debug.LogError("Fill Image bulunamadÄ±! Prefab hiyerarÅŸisini kontrol et.");

            hpFillImage.fillAmount = 1f; // baÅŸlangÄ±Ã§ta dolu

            DayNightCycle.OnDayNightChanged += HandleDayNightChanged;

            // EÄŸer oyun baÅŸladÄ±ÄŸÄ±nda gÃ¼ndÃ¼zse hemen yanma baÅŸlat
            if (burnsInDay && DayNightCycle.Instance != null && DayNightCycle.Instance.IsDay)
                HandleDayNightChanged(true);

        }


        // Hedefi tÃ¼re gÃ¶re ayarla
        if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
        {
            // Inspector'dan atanmadÄ±ysa tag ile bul
            if (player == null)
            {
                var go = GameObject.FindGameObjectWithTag("Player");
                if (go != null) player = go.transform;
            }
            target = player;
        }
        else if (enemyType == EnemyType.Armored)
        {
            if (caravan == null)
            {
                var go = GameObject.FindGameObjectWithTag("Caravan");
                if (go != null) caravan = go.transform;
            }
            target = caravan;
        }
        else if (enemyType == EnemyType.Exploder)
        {
            // Ä°stersen player'Ä± kovalasÄ±n:
            if (caravan == null)
            {
                var go = GameObject.FindGameObjectWithTag("Caravan");
                if (go != null) caravan = go.transform;
            }
            target = caravan;
        }

        // (Opsiyonel) ortam sesleri iÃ§in
        if (ambientSounds != null && ambientSounds.Count > 0 && audioSource != null)
            StartCoroutine(PlayAmbientSounds());

        // --- Mevcut Start iÃ§eriÄŸin (OverlapCircleAll vb.) devamÄ± ---
        /*Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, 0.5f);
        foreach (var hit in hits)
        {
            if (hit.CompareTag("Player"))
            {
                if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
                    StartPlayerDamage(hit.transform);
            }
            else if (hit.CompareTag("Caravan"))
            {
                if (enemyType == EnemyType.Armored)
                    StartCaravanDamage(hit.transform);
                else if (enemyType == EnemyType.Exploder)
                    Explode();
            }
        }*/

        GameObject cycleObj = GameObject.FindObjectOfType<DayNightCycle>()?.gameObject;
        if (cycleObj != null)
            dayNightCycle = cycleObj.GetComponent<DayNightCycle>();

        if (burnsInDay && dayNightCycle != null && IsDayTime())
        {
            burnCo = StartCoroutine(SunBurnRoutine());
        }

    }



    private bool IsDayTime()
    {
        return dayNightCycle != null &&
               dayNightCycle.GetType().GetField("isDay", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance).GetValue(dayNightCycle).Equals(true);
    }

    private IEnumerator SunBurnRoutine()
    {
        while (true)
        {
            TakeDamage(burnDamagePerTick);

            if (currentHealth <= 0) yield break; // dÃ¼ÅŸman Ã¶ldÃ¼yse Ã§Ä±k
            yield return new WaitForSeconds(burnTickInterval);
        }
    }


    void LateUpdate()
    {
        Vector3 scale = transform.localScale;
        scale.y = Mathf.Abs(scale.y); // her zaman pozitif olsun
        transform.localScale = scale;
    }


    public void ShowDamage(int amount)
    {
        damageText.text = $"-{amount}";
        damageText.color = Color.red;
        damageText.gameObject.SetActive(true);
        StartCoroutine(FadeOutText());
    }

    private System.Collections.IEnumerator FadeOutText()
    {
        float duration = 0.5f;
        float elapsed = 0f;
        Color c = damageText.color;

        while (elapsed < duration)
        {
            float t = elapsed / duration;
            damageText.color = Color.Lerp(Color.red, Color.white, t);
            elapsed += Time.deltaTime;
            yield return null;
        }

        damageText.gameObject.SetActive(false);
    }


    public void ApplyKnockback(Vector2 sourcePosition, float force, float duration)
    {
        if (!canBeKnockedBack) return;

        // EÄŸer zaten bir knockback coroutine Ã§alÄ±ÅŸÄ±yorsa tekrar baÅŸlatma
        if (knockbackCoroutine != null)
            return;

        Vector2 dir = ((Vector2)transform.position - sourcePosition).normalized;
        knockbackCoroutine = StartCoroutine(KnockbackRoutine(dir, force, duration));
    }

    private IEnumerator KnockbackRoutine(Vector2 direction, float force, float duration)
    {
        Rigidbody2D rb = GetComponent<Rigidbody2D>();
        float elapsed = 0f;

        if (rb != null)
        {
            bool wasKinematic = rb.isKinematic;
            if (wasKinematic) rb.isKinematic = false;

            // ğŸ”¹ Kuvvet uygula (Impulse)
            rb.AddForce(direction * force, ForceMode2D.Impulse);

            while (elapsed < duration)
            {
                elapsed += Time.deltaTime;
                yield return null;
            }

            // ğŸ”¹ Hareketi durdur
            rb.linearVelocity = Vector2.zero;

            if (wasKinematic) rb.isKinematic = true;
        }
        else
        {
            // Rigidbody yoksa transform hareketi uygula
            Vector2 startPos = transform.position;
            while (elapsed < duration)
            {
                transform.position = (Vector2)transform.position + direction * (force * Time.deltaTime);
                elapsed += Time.deltaTime;
                yield return null;
            }
        }

        // ğŸ”¹ KÃ¼Ã§Ã¼k bir toparlanma sÃ¼resi
        yield return new WaitForSeconds(knockbackRecoveryTime);

        knockbackCoroutine = null;
    }


    // Enemy.cs iÃ§ine
    public void OnSoundHeard(Vector2 soundPosition)
    {
        if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
        {
            // DÃ¼ÅŸman zaten hedefteyse ve Ã§ok yakÄ±nsa boÅŸver
            if (target != null && Vector2.Distance(transform.position, target.position) < 1f) return;

            // Yeni hedef pozisyona yÃ¶nel (Ã¶rneÄŸin geÃ§ici olarak bir boÅŸ hedef nokta olabilir)
            StartCoroutine(MoveToSoundPosition(soundPosition));
        }
    }

    private System.Collections.IEnumerator MoveToSoundPosition(Vector2 soundPosition)
    {
        float moveTime = 2f;
        float elapsed = 0f;

        while (elapsed < moveTime)
        {
            Vector2 dir = (soundPosition - (Vector2)transform.position).normalized;
            transform.position += (Vector3)(dir * moveSpeed * Time.deltaTime);

            // Ä°stersen burada animasyonlar da ayarla
            animator.SetFloat("MoveX", dir.x);
            animator.SetFloat("MoveY", dir.y);

            elapsed += Time.deltaTime;
            yield return null;
        }

        // Hareket sonrasÄ± tekrar oyuncuya dÃ¶n
        if (player != null)
            target = player;
    }


   void Update()
{
    if (target == null)
    {
        if ((enemyType == EnemyType.Normal || enemyType == EnemyType.Fast) && player != null)
            target = player;
        else if ((enemyType == EnemyType.Armored || enemyType == EnemyType.Exploder) && caravan != null)
            target = caravan;
    }

    if (!externalMovement && target != null)
    {
        float distanceToTarget = Vector2.Distance(transform.position, target.position);
        float stopDistance = (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
            ? damageRangeToPlayer
            : damageRangeToCaravan;

        Vector2 dir = (target.position - transform.position).normalized;

        if (!isAttacking) // ğŸ”¸ saldÄ±rÄ± modunda deÄŸilse
        {
            if (distanceToTarget > stopDistance)
            {
                // ğŸ§­ Hedefe doÄŸru ilerle
                transform.position += (Vector3)(dir * moveSpeed * Time.deltaTime);

                // ğŸ¬ YÃ¼rÃ¼me animasyonu
                if (!animator.GetBool("IsMoving"))
                    animator.SetBool("IsMoving", true);

                // ğŸ” 360Â° rotasyon
                float angle = Mathf.Atan2(dir.y, dir.x) * Mathf.Rad2Deg;
                transform.rotation = Quaternion.Euler(0f, 0f, angle - 90f);
            }
            else
            {
                // ğŸ”¸ hedefe ulaÅŸtÄ±ysa -> saldÄ±rÄ± baÅŸlat
                animator.SetBool("IsMoving", false);
                StartCoroutine(AttackPlayerRoutine());
            }
        }
    }
}


    public void TakeDamage(int amount)
    {

        Debug.Log($"ğŸ“¦ Hasar popup prefab pozisyonu: {transform.position + Vector3.up * 1f}");



        animator.SetTrigger("Hurt");
        currentHealth -= amount;

        PlayRandomSound(hurtSounds);
        // Debug iÃ§in
        Debug.Log($"Enemy took {amount} damage. Current health: {currentHealth}/{maxHealth}");

        if (hpFillImage != null)
        {
            float fillValue = Mathf.Clamp01((float)currentHealth / maxHealth);
            hpFillImage.fillAmount = fillValue;
            Debug.Log($"Fill amount set to: {fillValue}");
        }

        if (currentHealth <= 0)
        {
            if (enemyType == EnemyType.Exploder)
            {
                Explode();
                return;
            }

            animator.SetTrigger("Die");
            Debug.Log("Enemy should die now!");

            // ALTIN DÃœÅÃœRME %25 ÅANS
            if (goldPrefab != null && Random.value < 0.25f)
            {
                Instantiate(goldPrefab, transform.position, Quaternion.identity);
                Debug.Log("ğŸ’° DÃ¼ÅŸman altÄ±n bÄ±raktÄ±!");
            }

            if (damagePopupPrefab != null)
            {
                Debug.Log("âœ… Prefab atandÄ±, instantiate ediliyor.");
                GameObject popup = Instantiate(damagePopupPrefab, transform.position + Vector3.up * 1.0f, Quaternion.identity, transform);
                popup.GetComponent<DamagePopup>().Setup(amount);
            }
            else
            {
                Debug.LogWarning("âš ï¸ damagePopupPrefab atanmadÄ±!");
            }


            if (blueprintPrefabs.Length > 0 && Random.value < 0.75f)
            {
                int index = Random.Range(0, blueprintPrefabs.Length);
                Instantiate(blueprintPrefabs[index], transform.position, Quaternion.identity);
                Debug.Log("ğŸ“˜ DÃ¼ÅŸman blueprint dÃ¼ÅŸÃ¼rdÃ¼!");
            }


            if (hpBarInstance != null)
                Destroy(hpBarInstance);
            Destroy(gameObject);
            Die();
        }

        DamagePopupManager.Instance.SpawnPopup(transform.position, amount);



    }

public bool isAttacking = false;

public IEnumerator AttackPlayerRoutine()
{
    if (isAttacking) yield break;
    isAttacking = true;

    // ğŸ›‘ Hareketi durdur
    animator.SetBool("IsMoving", false);

    // ğŸ¬ SaldÄ±rÄ± animasyonu
    animator.SetTrigger("Attack");

    // â³ Animasyon bitene kadar bekle (Ã¶rneÄŸin 2 sn)
    yield return new WaitForSeconds(2f);

    // ğŸ” Tekrar hareket etmeye devam et
    isAttacking = false;
}

// ğŸ”¥ Animator Event tarafÄ±ndan Ã§aÄŸrÄ±lacak fonksiyon
public void DealDamageToPlayer()
{
    if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
    {
        if (player != null)
        {
            PlayerStats ps = player.GetComponent<PlayerStats>();
            if (ps != null)
            {
                ps.TakeDamage(damageToPlayer);
                Debug.Log("ğŸ’¥ DÃ¼ÅŸman saldÄ±rÄ± animasyonu sÄ±rasÄ±nda oyuncuya hasar verdi!");
            }
        }
    }
}


    /*void OnTriggerStay2D(Collider2D collision)
    {
        if (collision.CompareTag("Player"))
        {
            if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
            {
                StartPlayerDamage(collision.transform);
            }
        }
        else if (collision.CompareTag("Caravan"))
        {
            if (enemyType == EnemyType.Armored)
            {
                StartCaravanDamage(collision.transform);
            }
            else if (enemyType == EnemyType.Exploder)
            {
                Explode();
            }
        }
    }*/


    /* void OnTriggerEnter2D(Collider2D collision)
     {
         // Karavan ile temas
         if (collision.CompareTag("Caravan"))
         {
             if (enemyType == EnemyType.Armored)
             {
                 // Armored: Ã¶lme, karavana periyodik hasar vermeye baÅŸla
                 StartCaravanDamage(collision.transform);
                 return;
             }
             else if (enemyType == EnemyType.Exploder)
             {
                 // Exploder: patla ve alan hasarÄ± ver
                 Explode();
                 return;
             }
             else
             {
                 // Normal/Fast karavana ulaÅŸÄ±rsa istersen yok et veya gÃ¶rmezden gel
                 // Die(); // Ä°STEMÄ°YORSAN yoruma al
             }
         }

         // Oyuncu ile temas
         if (collision.CompareTag("Player"))
         {
             if (enemyType == EnemyType.Exploder)
             {
                 Explode();
                 return;
             }
             else if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
             {
                 StartPlayerDamage(collision.transform);
             }
         }

     }*/

    /*void OnTriggerExit2D(Collider2D collision)
    {
        if (collision.CompareTag("Caravan") && isDamagingCaravan)
        {
            StopCaravanDamage();
        }
        if (collision.CompareTag("Player") && isDamagingPlayer)
        {
            StopPlayerDamage();
        }
    }
    */
    public void StartCaravanDamage(Transform caravanTransform)
    {
        if (!isDamagingCaravan)
            caravanDamageCo = StartCoroutine(DamageCaravanOverTime(caravanTransform));
    }

    public void StopCaravanDamage()
    {
        isDamagingCaravan = false;
        if (caravanDamageCo != null) StopCoroutine(caravanDamageCo);
        caravanDamageCo = null;
    }

    private System.Collections.IEnumerator DamageCaravanOverTime(Transform caravanTransform)
    {
        isDamagingCaravan = true;
        var ch = caravanTransform.GetComponent<CaravanHealth>();

        while (isDamagingCaravan && ch != null)
        {
            ch.TakeDamage(armoredCaravanDamage);
            yield return new WaitForSeconds(armoredDamageInterval);
        }

        isDamagingCaravan = false;
        caravanDamageCo = null;
    }

   /* public void StartPlayerDamage(Transform playerTransform)
    {
        if (!isDamagingPlayer)
            playerDamageCo = StartCoroutine(DamagePlayerOverTime(playerTransform));
    }

    public void StopPlayerDamage()
    {
        isDamagingPlayer = false;
        if (playerDamageCo != null) StopCoroutine(playerDamageCo);
        playerDamageCo = null;
    }

    private System.Collections.IEnumerator DamagePlayerOverTime(Transform playerTransform)
    {
        isDamagingPlayer = true;
        var ps = playerTransform.GetComponent<PlayerStats>();

        while (isDamagingPlayer && ps != null)
        {
            ps.TakeDamage(damageToPlayer);
            yield return new WaitForSeconds(contactDamageInterval);
        }

        isDamagingPlayer = false;
        playerDamageCo = null;
    }

*/

    private bool isDamagingCaravan = false;




    public void Explode()
    {
        Debug.Log("ğŸ’¥ Exploder patladÄ±!");

        var hits = Physics2D.OverlapCircleAll(transform.position, explosionRadius);

        foreach (var hit in hits)
        {
            if (hit == null) continue;

            if (hit.CompareTag("Player"))
            {
                var ps = hit.GetComponent<PlayerStats>();
                if (ps != null) ps.TakeDamage(explosionDamageToPlayer);
            }
            else if (hit.CompareTag("Caravan"))
            {
                var ch = hit.GetComponent<CaravanHealth>();
                if (ch != null) ch.TakeDamage(explosionDamageToCaravan);
            }
        }

        // ğŸ“¢ Bu satÄ±rÄ± mutlaka ekle:
        Die();
    }


    private void Die()
    {
        Debug.Log("ğŸ’€ Die() Ã§aÄŸrÄ±ldÄ±!");

        // BileÅŸenleri devre dÄ±ÅŸÄ± bÄ±rak
        GetComponent<Collider2D>().enabled = false;
        this.enabled = false;

        // Ã–lÃ¼m animasyonu ve sesi
        if (deathSound != null)
            AudioSource.PlayClipAtPoint(deathSound, transform.position);
        animator.Play("Die");

        // ALTIN bÄ±rakma (%25 ÅŸans)
        if (goldPrefab != null && Random.value < 0.25f)
            Instantiate(goldPrefab, transform.position, Quaternion.identity);

        // BLUEPRINT bÄ±rakma (%75 ÅŸans)
        if (blueprintPrefabs.Length > 0 && Random.value < 0.75f)
        {
            int index = Random.Range(0, blueprintPrefabs.Length);
            Instantiate(blueprintPrefabs[index], transform.position, Quaternion.identity);
        }

        // --- ğŸ”« AMMO bÄ±rakma ---
        float dropChance = 0.4f; // %40 olasÄ±lÄ±kla mermi dÃ¼ÅŸsÃ¼n
        float roll = Random.value;
        Debug.Log($"ğŸ² Ammo drop roll: {roll}");

        if (roll < dropChance)
        {
            List<GameObject> possibleAmmo = new List<GameObject>();

            if (ammoMachineGunPrefab != null) possibleAmmo.Add(ammoMachineGunPrefab);
            if (ammoPistolPrefab != null) possibleAmmo.Add(ammoPistolPrefab);
            if (ammoShotgunPrefab != null) possibleAmmo.Add(ammoShotgunPrefab);
            if (ammoSniperPrefab != null) possibleAmmo.Add(ammoSniperPrefab);

            Debug.Log($"ğŸ¯ {possibleAmmo.Count} ammo tÃ¼rÃ¼ listede.");

            if (possibleAmmo.Count > 0)
            {
                GameObject selectedAmmo = possibleAmmo[Random.Range(0, possibleAmmo.Count)];
                Instantiate(selectedAmmo, transform.position, Quaternion.identity);
                Debug.Log($"ğŸ”« Rastgele mermi dÃ¼ÅŸtÃ¼: {selectedAmmo.name}");
            }
        }

        // HP bar'Ä± yok et
        if (hpBarInstance != null) Destroy(hpBarInstance, 2f);

        // Obje'yi yok et
        Destroy(gameObject);
    }




    // YENÄ°: Rastgele ortam sesi Ã§alan Coroutine
    private System.Collections.IEnumerator PlayAmbientSounds()
    {
        while (true) // Sonsuz dÃ¶ngÃ¼
        {
            // Rastgele bir sÃ¼re bekle
            yield return new WaitForSeconds(Random.Range(ambientSoundInterval.x, ambientSoundInterval.y));

            // Rastgele bir ortam sesi Ã§al
            PlayRandomSound(ambientSounds);
        }
    }

    // YENÄ°: Verilen listeden rastgele bir ses Ã§alan yardÄ±mcÄ± fonksiyon
    private void PlayRandomSound(List<AudioClip> clips)
    {
        if (clips != null && clips.Count > 0 && audioSource != null)
        {
            int index = Random.Range(0, clips.Count);
            audioSource.PlayOneShot(clips[index]);
        }
    }

}
using UnityEngine;

public class EnemyHitbox : MonoBehaviour
{
    private Enemy enemyParent;

    private void Awake()
    {
        enemyParent = GetComponentInParent<Enemy>();
        if (enemyParent == null)
            Debug.LogError("[EnemyHitbox] Parent'ta Enemy scripti yok!");

        // GÃ¼venlik: Collider trigger olmalÄ±
        var col = GetComponent<Collider2D>();
        if (col != null && !col.isTrigger)
            col.isTrigger = true;
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (enemyParent == null) return;

        if (other.CompareTag("Player"))
        {
            // Yeni sistem: temas ettiÄŸinde saldÄ±rÄ±yÄ± baÅŸlat
            if (enemyParent.enemyType == EnemyType.Normal || enemyParent.enemyType == EnemyType.Fast)
            {
                // DÃ¼ÅŸman oyuncuya deÄŸdiÄŸinde artÄ±k direkt saldÄ±rÄ± coroutine'i Ã§aÄŸrÄ±lÄ±yor
                if (!enemyParent.isAttacking)
                    enemyParent.StartCoroutine(enemyParent.AttackPlayerRoutine());
            }
        }
        else if (other.CompareTag("Caravan"))
        {
            if (enemyParent.enemyType == EnemyType.Armored)
                enemyParent.StartCaravanDamage(other.transform);
            else if (enemyParent.enemyType == EnemyType.Exploder)
                enemyParent.Explode(); // PatlayÄ±cÄ±ysa temasta patlat
        }
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (enemyParent == null) return;

        if (other.CompareTag("Caravan"))
            enemyParent.StopCaravanDamage();
    }

    // Ä°stersen sÃ¼rekli temas varken de saldÄ±rÄ± denemesi yapÄ±labilir:
    private void OnTriggerStay2D(Collider2D other)
    {
        if (enemyParent == null) return;

        if (other.CompareTag("Player"))
        {
            if ((enemyParent.enemyType == EnemyType.Normal || enemyParent.enemyType == EnemyType.Fast) && !enemyParent.isAttacking)
            {
                // Temas devam ederken hÃ¢lÃ¢ saldÄ±rmÄ±yorsa tekrar saldÄ±r
                enemyParent.StartCoroutine(enemyParent.AttackPlayerRoutine());
            }
        }
        else if (other.CompareTag("Caravan"))
        {
            if (enemyParent.enemyType == EnemyType.Armored)
                enemyParent.StartCaravanDamage(other.transform);
        }
    }
}
public enum EnemyType
{
    Normal,
    Armored,
    Exploder,
    Fast
}
using UnityEngine;

[RequireComponent(typeof(Enemy))]
public class EnemyWanderDriver : MonoBehaviour
{
    public WanderArea area;                 // Hangi bÃ¶lgede gezinecek?
    public float waypointTolerance = 0.15f; // Hedefe varmÄ±ÅŸ sayÄ±lacaÄŸÄ± mesafe
    public Vector2 idleTimeRange = new Vector2(0.2f, 1.0f); // Noktalar arasÄ±nda kÄ±sa bekleme

    private Enemy enemy;
    private Animator anim;
    private Transform waypoint;     // DÃœÅMANIN HEDEFÄ°
    private bool isIdling = false;
    private float idleTimer = 0f;

    void Awake()
    {
        enemy = GetComponent<Enemy>();
        anim  = GetComponent<Animator>();
    }

    void Start()
    {
        if (area == null)
        {
            Debug.LogWarning("[EnemyWanderDriver] Area atanmamÄ±ÅŸ, yakÄ±n Ã§evrede dolanacak.");
        }

        // Waypoint oluÅŸtur (area altÄ±nda konumlamak dÃ¼zen aÃ§Ä±sÄ±ndan iyidir)
        GameObject wp = new GameObject($"WanderWP_{name}");
        waypoint = wp.transform;
        waypoint.parent = area ? area.transform : null;

        // Ä°lk rastgele nokta ve hedef atamasÄ±
        waypoint.position = GetNextPoint();
        enemy.target = waypoint; // ğŸ”´ Kritik: Enemy artÄ±k bu noktaya yÃ¼rÃ¼yecek
    }

    void Update()
    {
        if (enemy == null || waypoint == null) return;

        if (isIdling)
        {
            idleTimer -= Time.deltaTime;
            if (idleTimer <= 0f)
            {
                isIdling = false;
                waypoint.position = GetNextPoint();
                // enemy.target zaten waypoint, null olmaz -> Enemy oyuncuya dÃ¶nmez
            }
            else
            {
                if (anim) anim.SetFloat("Speed", 0f);
            }
            return;
        }

        // Waypoint'e yeterince yaklaÅŸtÄ±ysak kÄ±sa bekle ve yeni nokta seÃ§
        float distSqr = ((Vector2)(transform.position - waypoint.position)).sqrMagnitude;
        if (distSqr <= waypointTolerance * waypointTolerance)
        {
            isIdling = true;
            idleTimer = Random.Range(idleTimeRange.x, idleTimeRange.y);
        }
        // Hareketi Enemy.cs zaten yapÄ±yor (target -> waypoint olduÄŸu iÃ§in)
    }

    public void Setup(WanderArea areaRef)
{
    if (enemy == null) enemy = GetComponent<Enemy>();
    area = areaRef;

    if (waypoint == null)
    {
        var wp = new GameObject($"WanderWP_{name}");
        waypoint = wp.transform;
        waypoint.parent = area ? area.transform : null;
    }

    waypoint.position = GetNextPoint();
    enemy.target = waypoint; // Hemen waypoint'e kilitlenir (oyuncuya dÃ¶nmez)
}


    private Vector2 GetNextPoint()
    {
        if (area != null) return area.GetRandomPoint();
        // Area yoksa: bulunduÄŸu nokta etrafÄ±nda kÃ¼Ã§Ã¼k daire
        return (Vector2)transform.position + Random.insideUnitCircle * 2f;
    }

    void OnDestroy()
    {
        if (waypoint != null) Destroy(waypoint.gameObject);
    }
}
// SoundEmitter.cs (yeni bir script)
using UnityEngine;

public static class SoundEmitter
{
    public static void EmitSound(Vector2 position, float radius)
    {
        Collider2D[] hits = Physics2D.OverlapCircleAll(position, radius);
        foreach (var hit in hits)
        {
            Enemy enemy = hit.GetComponent<Enemy>();
            if (enemy != null)
            {
                enemy.OnSoundHeard(position);
            }
        }
    }
}
using UnityEngine;

public class FuelPickup : MonoBehaviour
{
    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            GameManager.Instance.AddFuel(1);
            Destroy(gameObject);
        }
    }
}
using UnityEngine;

public class FuelSpawner : MonoBehaviour
{
    public GameObject fuelPrefab;
    public int fuelCount = 4;
    public Vector2 spawnMin = new Vector2(-10, -5);
    public Vector2 spawnMax = new Vector2(10, 5);

    //Deneme iÃ§in

    void Start()
    {
        for (int i = 0; i < fuelCount; i++)
        {
            Vector2 randomPos = new Vector2(
                Random.Range(spawnMin.x, spawnMax.x),
                Random.Range(spawnMin.y, spawnMax.y)
            );

            Instantiate(fuelPrefab, randomPos, Quaternion.identity);
        }
    }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Items/Resource Data")]
public class CraftResourceData : ItemData
{
    public int amountPerPickup = 1;
}
using UnityEngine;

[CreateAssetMenu(menuName = "Inventory/Generic Item")]
public class GenericItemData : ItemData
{
    [Header("Consumable Settings")]
    public bool isConsumable = false;   // Bandaj mÄ±, ilaÃ§ mÄ± vs.
    public int healAmount = 25;        // KaÃ§ can dolduruyor
    public float useDuration = 2f;     // Kullanma sÃ¼resi (anim / bekleme)
}
using System;
using System.Collections.Generic;
using UnityEngine;

public class Inventory : MonoBehaviour
{
    public static Inventory Instance { get; private set; }

    [Header("Config")]
    [Min(1)] public int capacity = 30;

    [Header("State")]
    public InventoryItem[] slots;

    // Blueprint kilitleri (turret / craft iÃ§in)
    private HashSet<string> unlockedBlueprints = new HashSet<string>();

    public event Action OnChanged;
    public void RaiseChanged() => OnChanged?.Invoke();

    // Yeni mermi depolama sistemi: ammoType(string) -> toplam mermi sayÄ±sÄ±
    public Dictionary<string, int> ammoStorage = new Dictionary<string, int>();

    void Awake()
    {
        if (Instance != null)
        {
            Destroy(gameObject);
            return;
        }

        Instance = this;

        slots = new InventoryItem[capacity];
        for (int i = 0; i < capacity; i++)
            slots[i] = new InventoryItem();
    }

    // ---------------- ADD ----------------
    public bool TryAdd(ItemData data, int amount = 1)
    {
        if (data == null || amount <= 0) return false;

        // âœ… EÄŸer AmmoItemData ise: slot'a koyma, direkt ammoStorage'a mermi ekle
        if (data is AmmoItemData ammoData)
        {
            int totalAmmo = ammoData.ammoAmount * amount;
            AddAmmo(ammoData.ammoType, totalAmmo);
            Debug.Log($"[Inventory] {ammoData.ammoType} iÃ§in +{totalAmmo} mermi eklendi.");
            // Slot kullanmadÄ±ÄŸÄ±mÄ±z iÃ§in RaiseChanged Ã§aÄŸÄ±rmaya gerek yok ama istersen ekleyebilirsin
            return true;
        }

        // Normal stacklenebilir item mantÄ±ÄŸÄ±
        if (data.stackable)
        {
            int remain = amount;

            // Var olan stack'leri doldur
            for (int i = 0; i < slots.Length && remain > 0; i++)
            {
                var s = slots[i];
                if (s.data == data && s.count < data.maxStack)
                {
                    int add = Mathf.Min(remain, data.maxStack - s.count);
                    s.count += add;
                    remain -= add;
                }
            }

            // BoÅŸ slotlara yeni stack aÃ§
            for (int i = 0; i < slots.Length && remain > 0; i++)
            {
                if (slots[i].data == null)
                {
                    int add = Mathf.Min(remain, data.maxStack);
                    slots[i] = new InventoryItem(data, add);
                    remain -= add;
                }
            }

            if (remain == 0)
            {
                RaiseChanged();
                return true;
            }

            return false;
        }
        else
        {
            // Stacklenmeyen item
            for (int i = 0; i < slots.Length; i++)
            {
                if (slots[i].data == null)
                {
                    slots[i] = new InventoryItem(data, 1);
                    RaiseChanged();
                    return true;
                }
            }
            return false;
        }
    }

    // --------- YARDIMCI SAYIM METOTLARI ---------

    public int GetTotalCount(ItemData data)
    {
        if (data == null) return 0;
        int total = 0;
        foreach (var s in slots)
            if (s.data == data)
                total += s.count;
        return total;
    }

    // Envanterde yeterince var mÄ±?
    public bool HasEnough(ItemData data, int amount)
    {
        if (data == null || amount <= 0) return false;
        return GetTotalCount(data) >= amount;
    }

    // Blueprint kilidi aÃ§
    public void UnlockBlueprint(string id)
    {
        if (!string.IsNullOrEmpty(id))
            unlockedBlueprints.Add(id);
    }

    // Blueprint var mÄ±?
    public bool HasBlueprint(string id)
    {
        if (string.IsNullOrEmpty(id)) return true; // id yoksa serbest
        return unlockedBlueprints.Contains(id);
    }

    // ---------------- CONSUME / REMOVE ----------------

    public bool TryConsume(ItemData data, int amount)
    {
        if (data == null || amount <= 0) return false;

        int total = GetTotalCount(data);
        if (total < amount) return false;

        int remain = amount;

        for (int i = 0; i < slots.Length && remain > 0; i++)
        {
            var s = slots[i];
            if (s.data == data)
            {
                int take = Mathf.Min(remain, s.count);
                s.count -= take;
                remain -= take;

                if (s.count <= 0)
                    slots[i] = new InventoryItem();
            }
        }

        RaiseChanged();
        return true;
    }

    public bool TryMoveOrMerge(int from, int to)
    {
        if (from == to ||
            from < 0 || from >= slots.Length ||
            to < 0 || to >= slots.Length)
            return false;

        var a = slots[from];
        var b = slots[to];

        if (a.data == null) return false;

        if (b.data == null)
        {
            slots[to] = a;
            slots[from] = new InventoryItem();
            RaiseChanged();
            return true;
        }

        if (a.data == b.data && a.data.stackable)
        {
            int move = Mathf.Min(a.count, a.data.maxStack - b.count);
            b.count += move;
            a.count -= move;

            if (a.count <= 0)
                slots[from] = new InventoryItem();

            RaiseChanged();
            return true;
        }

        // swap
        slots[to] = a;
        slots[from] = b;
        RaiseChanged();
        return true;
    }

    public void ClearInventory()
    {
        for (int i = 0; i < slots.Length; i++)
            slots[i] = new InventoryItem();
        RaiseChanged();
    }

    public int GetItemCount(ItemData item)
    {
        if (item == null) return 0;

        int total = 0;

        for (int i = 0; i < slots.Length; i++)
        {
            InventoryItem invItem = slots[i];
            if (invItem == null || invItem.data == null)
                continue;

            if (invItem.data == item)
                total += invItem.count;
        }

        return total;
    }

    // ---------------- AMMO SÄ°STEMÄ° ----------------

    // Ammo ekleme (pickup vs. burayÄ± kullanacak)
    public void AddAmmo(string ammoId, int amount)
{
    if (!ammoStorage.ContainsKey(ammoId))
        ammoStorage[ammoId] = 0;

    ammoStorage[ammoId] += amount;

    Debug.Log($"Ammo Added: {ammoId} -> {ammoStorage[ammoId]}");
}


    // Belirli ammo tipinden kaÃ§ adet var?
    public int GetAmmoAmount(string ammoType)
    {
        if (string.IsNullOrEmpty(ammoType)) return 0;
        return ammoStorage.TryGetValue(ammoType, out int value) ? value : 0;
    }

    // Ammo tÃ¼ket (ÅŸarjÃ¶r doldurma vb.)
    public bool TryUseAmmo(string ammoType, int amount)
    {
        if (string.IsNullOrEmpty(ammoType) || amount <= 0) return false;

        int current = GetAmmoAmount(ammoType);
        if (current < amount) return false;

        ammoStorage[ammoType] = current - amount;
        return true;
    }

    // ÅarjÃ¶re ammo yÃ¼kleme - ammoStorage'dan Ã§eker
    public void LoadAmmoIntoMag(MagazineItem mag, int amount)
    {
        if (mag == null)
        {
            Debug.LogWarning("LoadAmmoIntoMag: mag == null");
            return;
        }

        if (mag.IsFull)
        {
            Debug.Log("LoadAmmoIntoMag: ÅarjÃ¶r zaten dolu.");
            return;
        }

        string ammoType = mag.ammoType;
        if (string.IsNullOrEmpty(ammoType))
        {
            Debug.LogWarning("LoadAmmoIntoMag: ÅarjÃ¶rÃ¼n ammoType'Ä± tanÄ±mlÄ± deÄŸil!");
            return;
        }

        int available = GetAmmoAmount(ammoType);
        if (available <= 0)
        {
            Debug.Log($"LoadAmmoIntoMag: Envanterde {ammoType} mermisi yok.");
            return;
        }

        int space = mag.capacity - mag.currentAmmo;
        int loadAmount = Mathf.Min(space, amount, available);
        if (loadAmount <= 0)
        {
            Debug.Log("LoadAmmoIntoMag: YÃ¼klenecek mermi yok / yer yok.");
            return;
        }

        // Envanterden mermi dÃ¼ÅŸ
        if (!TryUseAmmo(ammoType, loadAmount))
        {
            Debug.LogWarning("LoadAmmoIntoMag: TryUseAmmo baÅŸarÄ±sÄ±z oldu, eÅŸzamanlÄ±lÄ±k sorunu olabilir.");
            return;
        }

        // ÅarjÃ¶rÃ¼ doldur
        mag.currentAmmo += loadAmount;

        Debug.Log($"ÅarjÃ¶r {mag.magName} mermi yÃ¼klendi: +{loadAmount} ({ammoType}), Envanterde kalan: {GetAmmoAmount(ammoType)}");
    }
}
using UnityEngine;
using UnityEngine.InputSystem;

public class InventoryInput : MonoBehaviour
{
    [Header("UI")]
    public GameObject inventoryPanel;
    public CraftUIController craftUI;   // Envanter aÃ§Ä±ldÄ±ÄŸÄ±nda craft kapanacak

    private PlayerControls controls;
    private bool inventoryOpen = false;

    private void Awake()
    {
        controls = new PlayerControls();
    }

    private void OnEnable()
    {
        controls.Gameplay.Enable();
        controls.Gameplay.Inventory.performed += OnInventoryPressed;
    }

    private void OnDisable()
    {
        controls.Gameplay.Inventory.performed -= OnInventoryPressed;
        controls.Gameplay.Disable();
    }

    private void OnInventoryPressed(InputAction.CallbackContext ctx)
{
    if (inventoryPanel == null) return;

    // EÄŸer craft aÃ§Ä±k ise Ã¶nce craft'Ä± kapat
    if (craftUI != null && craftUI.craftPanel.activeSelf)
        craftUI.Close();

    inventoryOpen = !inventoryOpen;
    inventoryPanel.SetActive(inventoryOpen);
}

}
using System;
using UnityEngine;

[Serializable]
public class InventoryItem
{
    public ItemData data;
    public int count = 1;

    [Serializable]
    public class WeaponInstancePayload
    {
        public string id;
        public int clip;
        public int reserve;
        public int durability;
    }

    public WeaponInstancePayload weapon; // silahlar iÃ§in payload

    public bool IsWeapon => weapon != null;

    public InventoryItem() 
    {
        data = null;
        count = 0;
    }

    public InventoryItem(ItemData data, int count = 1)
    {
        this.data = data;
        this.count = count;
    }
}
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.UI;
using TMPro;

public class InventorySlotUI : MonoBehaviour,
    IPointerClickHandler, IBeginDragHandler, IDragHandler, IEndDragHandler, IDropHandler
{
    [Header("UI")]
    public Image icon;
    public TMP_Text countText;
    public CanvasGroup canvasGroup;

    private int index;
    private InventoryUI owner;
    private InventoryItem cached;
    private RectTransform rt;
    private GameObject dragIcon;

    private void Awake()
    {
        if (canvasGroup == null)
            canvasGroup = gameObject.AddComponent<CanvasGroup>();

        rt = GetComponent<RectTransform>();
    }

    // InventoryUI tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
    public void Bind(int index, InventoryUI owner)
    {
        this.index = index;
        this.owner = owner;

        canvasGroup.alpha = 1f;
        canvasGroup.blocksRaycasts = true;
    }

    // Envanterdeki slot verisini UI'a basar
    public void Render(InventoryItem item)
    {
        cached = item;

        if (item == null || item.data == null)
        {
            icon.enabled = false;
            countText.text = "";
            return;
        }

        icon.enabled = true;
        icon.sprite = item.data.icon;
        icon.preserveAspect = true;

        // Ammo ise: item.count * ammoPerItem gÃ¶ster
        if (item.data is AmmoItemData ammoData)
        {
            int totalAmmo = item.count * ammoData.ammoAmount;
            countText.text = $"x{totalAmmo}";
        }
        else
        {
            countText.text = $"x{item.count}";
        }
    }

    // SaÄŸ tÄ±k / sol tÄ±k davranÄ±ÅŸÄ±
    public void OnPointerClick(PointerEventData eventData)
    {
        if (cached == null || cached.data == null)
            return;

        // Åimdilik: saÄŸ tÄ±kla hiÃ§bir Ã¶zel iÅŸlem yapmÄ±yoruz.
        // Ä°leride buraya "yemek ye / bandaj kullan / ammo yÃ¼kle" gibi davranÄ±ÅŸlar eklenebilir.
    }

    // ---- DRAG & DROP ----

    public void OnBeginDrag(PointerEventData eventData)
    {
        if (cached == null || cached.data == null) return;

        canvasGroup.blocksRaycasts = false;
        canvasGroup.alpha = 0.7f;

        dragIcon = new GameObject("DragIcon");
        dragIcon.transform.SetParent(owner.transform.root);
        dragIcon.transform.SetAsLastSibling();

        var img = dragIcon.AddComponent<Image>();
        img.sprite = icon.sprite;
        img.raycastTarget = false;
        img.preserveAspect = true;

        var drt = dragIcon.GetComponent<RectTransform>();
        drt.sizeDelta = rt.sizeDelta;
    }

    public void OnDrag(PointerEventData eventData)
    {
        if (dragIcon == null) return;
        dragIcon.transform.position = eventData.position;
    }

    public void OnEndDrag(PointerEventData eventData)
    {
        canvasGroup.blocksRaycasts = true;
        canvasGroup.alpha = 1f;

        if (dragIcon != null)
            Destroy(dragIcon);
    }

    public void OnDrop(PointerEventData eventData)
    {
        var src = eventData.pointerDrag ? eventData.pointerDrag.GetComponent<InventorySlotUI>() : null;
        if (src == null || src == this) return;

        owner.MoveOrMerge(src.index, this.index);
    }
}
using UnityEngine;
using UnityEngine.InputSystem; // Yeni sistem iÃ§in ÅŸart

public class InventoryToggle : MonoBehaviour
{
    public GameObject inventoryPanel;

    private Keyboard keyboard;

    void Awake()
    {
        keyboard = Keyboard.current;
    }

    void Update()
    {
        
    }
}
using UnityEngine;

public class InventoryUI : MonoBehaviour
{
    [Header("Refs")]
    public Inventory inventory;
    public Transform gridParent;        // 30 slotu bunun altÄ±na koy
    public GameObject slotPrefab;

    [Header("Visual")]
    public int slotCount = 30;

    private InventorySlotUI[] slots;

    void Awake()
    {
        if (inventory == null)
            inventory = Inventory.Instance;

        slots = new InventorySlotUI[slotCount];

        for (int i = 0; i < slotCount; i++)
        {
            GameObject go = Instantiate(slotPrefab, gridParent); // sadece bir kez oluÅŸtur
            InventorySlotUI slot = go.GetComponent<InventorySlotUI>();

            if (slot == null)
            {
                Debug.LogError("Slot prefab iÃ§inde InventorySlotUI component eksik!");
                continue;
            }

            slot.Bind(i, this);
            go.SetActive(false); // BaÅŸlangÄ±Ã§ta gizli
            slots[i] = slot;
            go.SetActive(false); // âœ… BaÅŸta gizle
        }
    
}



    void OnEnable()
    {
        if (inventory == null) inventory = Inventory.Instance;
        if (inventory != null) inventory.OnChanged += Refresh;
        Refresh();
    }

    void OnDisable()
    {
        if (inventory != null) inventory.OnChanged -= Refresh;
    }

    public void Refresh()
{
    if (inventory == null || slots == null) return;

    for (int i = 0; i < slots.Length; i++)
    {
        if (slots[i] == null || inventory.slots[i] == null) continue;

        // EÄŸer envanterde eÅŸya yoksa slotu gizle
        if (inventory.slots[i].data == null)
        {
            slots[i].gameObject.SetActive(false);
        }
        else
        {
            slots[i].gameObject.SetActive(true);
            slots[i].Render(inventory.slots[i]);
        }
    }
}


    public void MoveOrMerge(int fromIndex, int toIndex)
{
    Inventory.Instance.TryMoveOrMerge(fromIndex, toIndex);
    Refresh();
}

}
using UnityEngine;


public enum ItemCategory { Resource, Ammo, Weapon, Misc }
[CreateAssetMenu(menuName = "Items/Item Data")]
public abstract class ItemData : ScriptableObject
{

    [Header("Base")]
    public string itemName;
    public string itemID;
    public Sprite icon;
    public ItemCategory category;
    public bool stackable = true;
    [Min(1)] public int maxStack = 99;

    public bool showCountBadge => stackable;
}
using System.Collections.Generic;
using UnityEngine;

public static class ItemDatabase
{
    private static Dictionary<string, ItemData> dict;

    public static void RegisterAll(ItemData[] items)
    {
        dict = new Dictionary<string, ItemData>();

        foreach (var item in items)
        {
            if (string.IsNullOrWhiteSpace(item.itemID))
            {
                Debug.LogError($"âŒ Item '{item.name}' iÃ§in itemID atanmadÄ±!");
                continue;
            }

            if (dict.ContainsKey(item.itemID))
            {
                Debug.LogError($"âŒ Duplicate itemID bulundu: {item.itemID}");
                continue;
            }

            dict.Add(item.itemID, item);
        }

        Debug.Log($"ItemDatabase â†’ {dict.Count} item yÃ¼klendi.");
    }

    public static ItemData Get(string id)
    {
        if (dict == null)
        {
            Debug.LogError("âŒ ItemDatabase: RegisterAll daha Ã§aÄŸrÄ±lmadÄ±!");
            return null;
        }

        if (dict.TryGetValue(id, out var data))
            return data;

        Debug.LogError($"âŒ Item bulunamadÄ± â†’ ID = {id}");
        return null;
    }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Inventory/Item Registry")]
public class ItemRegistry : ScriptableObject
{
    public ItemData[] items;
}
public enum ItemType
{
    Resource,
    Weapon,
    Ammo,
    CraftMaterial
}
using UnityEngine;

[CreateAssetMenu(menuName = "Inventory/Part Item")]
public class PartItemData : ItemData
{
    public WeaponPartType partType;
}
using UnityEngine;

public class CloudShadowMover : MonoBehaviour
{
    public float speed = 1f;
    public float resetX = -20f;
    public float startX = 20f;

    void Update()
    {
        transform.Translate(Vector2.left * speed * Time.deltaTime);

        if (transform.position.x < resetX)
        {
            float randomY = Random.Range(2f, 5f);
            transform.position = new Vector3(startX, randomY, transform.position.z);
        }
    }
}
using UnityEngine;
using TMPro;

public class DamagePopup : MonoBehaviour
{
    public TextMeshProUGUI textMesh;
    private float floatSpeed = 25f;
    private float fadeDuration = 1.2f;
    private float elapsed = 0f;
    private Color startColor = Color.red;

    public void Setup(int damage)
    {
        if (textMesh == null)
            textMesh = GetComponent<TextMeshProUGUI>();

        if (textMesh == null)
        {
            Debug.LogError("âŒ TextMeshProUGUI bileÅŸeni yok!");
            return;
        }

        textMesh.text = damage.ToString();
        textMesh.color = startColor;
    }

    void Update()
    {
        transform.Translate(Vector3.up * floatSpeed * Time.deltaTime);
        elapsed += Time.deltaTime;

        if (textMesh != null)
        {
            float t = elapsed / fadeDuration;
            textMesh.color = Color.Lerp(startColor, Color.clear, t);
        }

        if (elapsed >= fadeDuration)
            Destroy(gameObject);
    }
}
using UnityEngine;
using TMPro;
using UnityEngine.EventSystems;

public class DamagePopupManager : MonoBehaviour
{
    public static DamagePopupManager Instance;

    public GameObject popupPrefab;
    public RectTransform popupParent; // MainCanvas
    public Camera mainCam;

    void Awake()
    {
        if (Instance == null) Instance = this;
        else Destroy(gameObject);

        if (mainCam == null) mainCam = Camera.main;
    }

    public void SpawnPopup(Vector3 worldPosition, int damageAmount)
    {
        if (popupPrefab == null || popupParent == null)
        {
            Debug.LogError("âŒ DamagePopupManager: Prefab veya parent eksik!");
            return;
        }

        // World position â†’ screen position
        Vector3 screenPos = mainCam.WorldToScreenPoint(worldPosition + Vector3.up * 1f);

        // Screen position â†’ local UI position
        Vector2 localPos;
        RectTransformUtility.ScreenPointToLocalPointInRectangle(popupParent, screenPos, mainCam, out localPos);

        GameObject popup = Instantiate(popupPrefab, popupParent);
        popup.GetComponent<RectTransform>().anchoredPosition = localPos;

        var damageScript = popup.GetComponent<DamagePopup>();
        if (damageScript != null)
            damageScript.Setup(damageAmount);
    }
}
// DayNightCycle.cs
using UnityEngine;
using System;
public class DayNightCycle : MonoBehaviour
{

public static DayNightCycle Instance { get; private set; }
public static event System.Action<bool> OnDayNightChanged; // true = day, false = night

public bool IsDay => isDay;



    public float dayDuration = 30f;
    public float nightDuration = 30f;
    private float timer = 0f;

    public LightController lightController;
    public ResourceSpawner spawner;
    public EnemyManager enemyManager;


    [Range(0f, 1f)]
    public float regenerationRatio = 0.5f;

    private bool isDay = true;

    // âœ… SAHNE HER AÃ‡ILDIÄINDA Ã‡AÄRILACAK
    void Awake()
    {
         Instance = this;
        ResetCycle();
    }

    // (Ä°stersen OnEnableâ€™da da gÃ¼venceye alabilirsin)
    void OnEnable()
    {
        // ResetCycle();  // Awake yetmiyorsa bunu da aÃ§
    }

    void Update()
{
    timer -= Time.deltaTime;

    if (timer <= 0f)
    {
        isDay = !isDay;
        timer = isDay ? dayDuration : nightDuration;

        OnDayNightChanged?.Invoke(isDay); // âœ… GÃœNDEMÄ°ZDE BU Ã‡OK Ã–NEMLÄ°

        if (isDay) HandleDayStart();
        else       HandleNightStart();
    }
}


    // âœ… YENÄ°: BaÅŸtan kurulum
    public void ResetCycle()
{
    Debug.Log("ğŸ”¥ ResetCycle Ã‡AÄRILDI! GÃœNDÃœZ BAÅLATILIYOR!");

    // ğŸ”¥ TÃ¼m gece/gÃ¼ndÃ¼z mÃ¼ziklerini sÄ±fÄ±rla
    if (MusicManager.Instance != null)
    {
        MusicManager.Instance.StopAll();  // â† Ekliyoruz
    }

    // ğŸ•’ Oyunun her yeni yÃ¼kleniÅŸi GÃœNDÃœZ baÅŸlayacaksa:
    isDay = true;
    timer = dayDuration;

    // EÄŸer ileride gece baÅŸlamasÄ±nÄ± istersen bunu false yaparsÄ±n.
    
    // ğŸ”† GÃ¼ndÃ¼z setup
    lightController?.SetDay(true);
    enemyManager?.ResetDayCount();
    spawner?.RegenerateResources(0f);
    SetAnimalsNightState(false);

    // ğŸµ Temiz gÃ¼ndÃ¼z mÃ¼ziÄŸi *tek baÅŸÄ±na* Ã§alsÄ±n
    MusicManager.Instance?.SetDay(true);
}


    void HandleDayStart()
    {
        spawner?.RegenerateResources(regenerationRatio);
        SetAnimalsNightState(false);
        lightController?.SetDay(true);
        MusicManager.Instance?.SetDay(true);
    }

    void HandleNightStart()
    {
        enemyManager?.SpawnEnemies();
        SetAnimalsNightState(true);
        lightController?.SetDay(false);
        MusicManager.Instance?.SetDay(false);
    }

    void SetAnimalsNightState(bool night)
    {
        foreach (var a in FindObjectsOfType<Animal>())
            a.SetNight(night);
    }
}
using UnityEngine;

public class EnemyManager : MonoBehaviour
{
    [Header("DÃ¼ÅŸman AyarlarÄ±")]
    public GameObject[] enemyPrefabs;
    public Transform[] spawnPoints;

    [Header("Gece BaÅŸÄ±na Ayarlar")]
    public int baseEnemyCount = 5;
    public float enemyCountIncreasePerDay = 2f;
    private int currentDay = 1;

    public SpawnZoneManager spawnZoneManager; // Inspectorâ€™dan sÃ¼rÃ¼kle bÄ±rak


    // ğŸ”¹ EK: Belirli bÃ¶lgelerde ekstra GEZGÄ°N (sadece Normal/Fast)
    [System.Serializable]
    public class ExtraWanderGroup
    {
        public WanderArea area;                 // BÃ¶lge
        public GameObject[] wanderPrefabs;      // Sadece EnemyType.Normal / EnemyType.Fast olan prefabler
        public int extraCount = 3;              // KaÃ§ tane
    }
    public ExtraWanderGroup[] extraWanderGroups;

    public void SpawnEnemies()
    {
        if (enemyPrefabs.Length == 0 || spawnPoints.Length == 0)
        {
            Debug.LogWarning("âŒ EnemyManager: Prefab veya spawn noktasÄ± eksik!");
            return;
        }

        int total = Mathf.RoundToInt(baseEnemyCount + (currentDay - 1) * enemyCountIncreasePerDay);
        Debug.Log($"ğŸŒ™ Gece {currentDay}. Toplam dÃ¼ÅŸman: {total}");

        // ğŸ”¸ 1) NORMAL spawnlar (kovalamaya devam eder)
        for (int i = 0; i < total; i++)
        {
            int enemyIndex = Random.Range(0, enemyPrefabs.Length);
            int spawnPointIndex = i % spawnPoints.Length;
            Instantiate(enemyPrefabs[enemyIndex], spawnPoints[spawnPointIndex].position, Quaternion.identity);
        }

        // ğŸ”¹ 2) EKSTRA gezginler (yalnÄ±zca Normal/Fast)
        SpawnExtraWanderers();

        currentDay++;

        if (spawnZoneManager != null)
    spawnZoneManager.SpawnAllZones();

    }

    private void SpawnExtraWanderers()
    {
        if (extraWanderGroups == null) return;

        foreach (var g in extraWanderGroups)
        {
            if (g == null || g.area == null || g.wanderPrefabs == null || g.wanderPrefabs.Length == 0) continue;

            for (int i = 0; i < g.extraCount; i++)
            {
                var prefab = g.wanderPrefabs[Random.Range(0, g.wanderPrefabs.Length)];
                Vector2 pos = g.area.GetRandomPoint();
                var go = Instantiate(prefab, pos, Quaternion.identity);

                // Tip kontrolÃ¼ (sadece Normal/Fast olmalÄ±)
                var e = go.GetComponent<Enemy>();
                if (e == null)
                {
                    Debug.LogWarning("[EnemyManager] Ekstra wander prefabÄ±nda Enemy component yok.");
                    continue;
                }
                if (e.enemyType != EnemyType.Normal && e.enemyType != EnemyType.Fast)
                {
                    Debug.LogWarning($"[EnemyManager] {go.name} enemyType={e.enemyType}. Ekstra wander iÃ§in Normal/Fast seÃ§in.");
                }

                // GEZGÄ°N sÃ¼rÃ¼cÃ¼yÃ¼ ekle ve alanÄ± baÄŸla
                var driver = go.GetComponent<EnemyWanderDriver>();
                if (!driver) driver = go.AddComponent<EnemyWanderDriver>();
                driver.area = g.area;
            }
        }
    }

    public void ResetDayCount() { currentDay = 1; }
}
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.InputSystem;

public class GameManager : MonoBehaviour
{
    public static GameManager Instance;

    public int requiredFuel = 4;
    private int currentFuel = 0;

    public GameObject gameOverPanel;

    private void Start()
{
    var player = GameObject.FindWithTag("Player");
    if (player != null)
    {
        var stats = player.GetComponent<PlayerStats>();
        if (stats != null)
        {
            stats.onDeath += GameOver;   // ğŸ”¥ Ã–lÃ¼nce GameOver tetikleniyor
            Debug.Log("âœ” Player death event GameManager'a baÄŸlandÄ±.");
        }
        else
        {
            Debug.LogError("âŒ PlayerStats component bulunamadÄ±!");
        }
    }
    else
    {
        Debug.LogError("âŒ 'Player' tag'Ä±na sahip obje bulunamadÄ±!");
    }
}

private void OnSceneLoaded(Scene scene, LoadSceneMode mode)
{
    if (scene.name == "MainMenu")
        return;

    // Yeni Sahne â†’ DayNightCycle var mÄ±?
    var cycle = FindObjectOfType<DayNightCycle>();
    if (cycle != null)
    {
        Debug.Log("ğŸ”¥ SceneLoaded â†’ ResetCycle() Ã§aÄŸrÄ±lÄ±yor!");
        cycle.ResetCycle();
    }
    else
    {
        Debug.LogError("âŒ DayNightCycle SAHNEDE YOK!");
    }
}


    private void Awake()
    {
        if (Instance == null)
            Instance = this;
        else
            Destroy(gameObject);
             SceneManager.sceneLoaded += OnSceneLoaded;

    }



    public void AddFuel(int amount)
    {
        currentFuel += amount;
        Debug.Log($"â›½ YakÄ±t toplandÄ±: {currentFuel}/{requiredFuel}");
    }

    public bool HasAllFuel()
    {
        return currentFuel >= requiredFuel;
    }

    public void LoadNextScene()
    {
        Debug.Log("ğŸšš TÃ¼m yakÄ±tlar toplandÄ±, sonraki sahneye geÃ§iliyor...");
        int currentIndex = SceneManager.GetActiveScene().buildIndex;

        // ğŸ§  Oyuncunun en son oynadÄ±ÄŸÄ± bÃ¶lÃ¼mÃ¼ hatÄ±rla
        PlayerPrefs.SetInt("LastLevel", currentIndex + 1);
        PlayerPrefs.Save();

        // ğŸ¬ Sonraki sahneye geÃ§
        SceneManager.LoadScene(currentIndex + 1);
    }

    public void GameOver()
    {
        if (gameOverPanel != null)
        {
            gameOverPanel.SetActive(true);
            Time.timeScale = 0f;

            GameStateManager.IsGameOver = true;

            // Oyuncu inputunu kapat
            var player = GameObject.FindWithTag("Player");
            if (player != null)
            {
                var input = player.GetComponent<PlayerInput>();
                if (input != null) input.enabled = false;

                var controller = player.GetComponent<PlayerMovement>();
                if (controller != null) controller.enabled = false;
            }
        }
    }


    public void RestartGame()
    {
        GameStateManager.IsGameOver = false;
        GameStateManager.ResetGameState();
        Time.timeScale = 1f;
        SceneManager.LoadScene(SceneManager.GetActiveScene().name);
    }

   public void ReturnToMainMenu()
{
    Debug.Log("ğŸ Ana menÃ¼ye dÃ¶nÃ¼lÃ¼yor...");

    // Oyun hÄ±zÄ±nÄ± sÄ±fÄ±rla
    Time.timeScale = 1f;

    // GameState reset
    GameStateManager.IsGameOver = false;
    GameStateManager.ResetGameState();

    // ğŸ”¥ SAHNEDEKÄ° TÃœM SESLERÄ° DURDUR (Bolum1 dahil)
    StopAllSceneAudio();

    // Ana MenÃ¼ sahnesine geÃ§
    SceneManager.LoadScene("MainMenu");
}

private void StopAllSceneAudio()
{
    AudioSource[] allAudioSources = FindObjectsOfType<AudioSource>();

    foreach (AudioSource audio in allAudioSources)
    {
        audio.Stop();
        audio.enabled = false;   // ğŸ”¥ MÃ¼zik tekrar baÅŸlamasÄ±n
    }

    Debug.Log("ğŸ”‡ Bolum1 iÃ§indeki TÃœM sesler durduruldu!");
}



}
// GameSceneBootstrap.cs (Ã¶rnek)
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.InputSystem;

public class GameSceneBootstrap : MonoBehaviour
{
    public bool hideCursorInGame = true;
    public CursorLockMode lockMode = CursorLockMode.Confined;

    void Awake()
    {
        // Oyun akÄ±ÅŸÄ± aÃ§Ä±k olsun
        Time.timeScale = 1f;

        // Cursor ayarÄ±
        Cursor.visible   = !hideCursorInGame;
        Cursor.lockState = lockMode;

        // ğŸ”§ HATA VEREN SATIRI SÄ°L:
        // PauseMenu.IsPaused = false;

        // âœ… Yerine ÅŸunu kullan:
        var pm = PauseMenu.Instance ?? FindObjectOfType<PauseMenu>();
        if (pm != null) pm.ResumeGame();

        // (Ä°steÄŸe baÄŸlÄ±) DiÄŸer panelleri de kapat
        if (NPCInteraction.Instance != null)       NPCInteraction.Instance.CloseTradePanel();

        // PlayerInput action map'i Gameplay'e zorla (kullanÄ±yorsan)
        foreach (var pi in FindObjectsOfType<PlayerInput>(includeInactive: true))
        {
            if (pi.actions != null && pi.actions.FindActionMap("Gameplay") != null)
                pi.SwitchCurrentActionMap("Gameplay");
        }

        // EventSystem Ã§akÄ±ÅŸmasÄ±nÄ± Ã¶nle
        var allEventSystems = FindObjectsOfType<EventSystem>();
        for (int i = 1; i < allEventSystems.Length; i++)
            Destroy(allEventSystems[i].gameObject);
    }
}
// Assets/Scripts/Managers/GameStateManager.cs
public static class GameStateManager
{
    public static bool IsGamePaused =>
        PauseMenu.IsPaused ||
        NPCInteraction.IsTradeOpen;
    public static bool IsGameOver = false;

    public static void ResetGameState()
    {
        IsGameOver = false;
    }


}
using UnityEngine;
using UnityEngine.Rendering.Universal;

public class LightController : MonoBehaviour
{
    [Header("Global Light")]
    public Light2D globalLight;

    [Header("Time Of Day")]
    [Range(0, 24)]
    public float timeOfDay = 8f;     // 0â€“24 arasÄ± saat
    public float daySpeed = 0.25f;   // GÃ¼nÃ¼n akÄ±ÅŸ hÄ±zÄ±

    [Header("Colors")]
    public Color morningColor = new Color(1f, 0.78f, 0.63f);   // Sabah
    public Color noonColor    = new Color(1f, 1f, 0.9f);       // Ã–ÄŸle
    public Color afternoonColor = new Color(1f, 0.86f, 0.7f);  // Ä°kindi
    public Color eveningColor = new Color(1f, 0.63f, 0.47f);   // AkÅŸam
    public Color nightColor   = new Color(0.16f, 0.23f, 0.47f); // Gece

    [Header("Intensity")]
    public float morningIntensity   = 0.8f;
    public float noonIntensity      = 1.0f;
    public float afternoonIntensity = 0.7f;
    public float eveningIntensity   = 0.5f;
    public float nightIntensity     = 0.25f;

    public float transitionSpeed = 2f;

    private Color targetColor;
    private float targetIntensity;

    // DayNightCycle burayÄ± kullanÄ±yor
    private bool isDay = true;

    private void Awake()
    {
        if (globalLight == null)
            globalLight = GetComponent<Light2D>();

        // GÃ¼venli baÅŸlangÄ±Ã§
        SetDay(true);
    }

    private void Update()
    {
        if (globalLight == null) return;

        if (isDay)
        {
            // Sadece gÃ¼ndÃ¼z vakti saat akÄ±yor
            timeOfDay += Time.deltaTime * daySpeed;

            // GÃ¼ndÃ¼z aralÄ±ÄŸÄ±: 06â€“21
            if (timeOfDay < 6f)  timeOfDay = 6f;
            if (timeOfDay > 21f) timeOfDay = 6f;

            // Sabah: 06â€“09
            if (timeOfDay >= 6f && timeOfDay < 9f)
            {
                targetColor = morningColor;
                targetIntensity = morningIntensity;
            }
            // Ã–ÄŸle: 09â€“15
            else if (timeOfDay >= 9f && timeOfDay < 15f)
            {
                targetColor = noonColor;
                targetIntensity = noonIntensity;
            }
            // Ä°kindi: 15â€“18
            else if (timeOfDay >= 15f && timeOfDay < 18f)
            {
                targetColor = afternoonColor;
                targetIntensity = afternoonIntensity;
            }
            // AkÅŸam: 18â€“21
            else if (timeOfDay >= 18f && timeOfDay < 21f)
            {
                targetColor = eveningColor;
                targetIntensity = eveningIntensity;
            }
        }
        else
        {
            // Gece modunda sabit deÄŸer
            targetColor = nightColor;
            targetIntensity = nightIntensity;
        }

        // YumuÅŸak geÃ§iÅŸ
        globalLight.color = Color.Lerp(globalLight.color, targetColor, Time.deltaTime * transitionSpeed);
        globalLight.intensity = Mathf.Lerp(globalLight.intensity, targetIntensity, Time.deltaTime * transitionSpeed);
    }

    /// <summary>
    /// DayNightCycle burayÄ± Ã§aÄŸÄ±rÄ±yor.
    /// true = gÃ¼ndÃ¼z, false = gece
    /// </summary>
    public void SetDay(bool day)
    {
        isDay = day;

        if (!isDay)
        {
            // Geceye geÃ§erken hedefleri direkt geceye Ã§ek
            targetColor = nightColor;
            targetIntensity = nightIntensity;
        }
        else
        {
            // GÃ¼ndÃ¼ze geÃ§erken zamanÄ± sabaha zorlayabilirsin
            if (timeOfDay < 6f || timeOfDay > 21f)
                timeOfDay = 6f; // sabah baÅŸlasÄ±n
        }
    }
}
using UnityEngine;

public class SettingsLoader : MonoBehaviour
{
    void Awake()
    {
        // Bu objeyi sahne deÄŸiÅŸse bile yok etme
        DontDestroyOnLoad(gameObject);

        // MÃ¼zik sesi
        AudioListener.volume = PlayerPrefs.GetFloat("MusicVolume", 1f);

        // Grafik kalitesi
        QualitySettings.SetQualityLevel(
            PlayerPrefs.GetInt("QualityLevel", QualitySettings.GetQualityLevel())
        );

        // Tam ekran
        Screen.fullScreen = PlayerPrefs.GetInt("Fullscreen", 1) == 1;
    }
}
using UnityEngine;

public class SpawnZoneManager : MonoBehaviour
{
    [System.Serializable]
    public class ZoneSpawn
    {
        public WanderArea area;
        public GameObject[] enemyPrefabs;
        public int count = 5;
        public bool addWanderer = true;  // ArtÄ±k EnemyWanderDriver anlamÄ±na geliyor
        public float spreadPadding = 0.2f;
    }

    public ZoneSpawn[] zones;

    [ContextMenu("Spawn All Zones")]
    public void SpawnAllZones()
    {
        foreach (var z in zones)
        {
            if (z.area == null || z.enemyPrefabs == null || z.enemyPrefabs.Length == 0) continue;

            for (int i = 0; i < z.count; i++)
            {
                var prefab = z.enemyPrefabs[Random.Range(0, z.enemyPrefabs.Length)];
                Vector2 p = z.area.GetRandomPoint() + Random.insideUnitCircle * z.spreadPadding;

                var go = Instantiate(prefab, p, Quaternion.identity);

                if (!z.addWanderer) continue;

                var enemy = go.GetComponent<Enemy>();
                if (!enemy)
                {
                    Debug.LogWarning("[SpawnZoneManager] Prefab'ta Enemy yok.");
                    continue;
                }

                // Sadece Normal / Fast olan ekstra dÃ¼ÅŸmanlarÄ± wander yap
                if (enemy.enemyType != EnemyType.Normal && enemy.enemyType != EnemyType.Fast)
                    continue;

                var driver = go.GetComponent<EnemyWanderDriver>();
                if (!driver) driver = go.AddComponent<EnemyWanderDriver>();

                // AlanÄ± baÄŸla ve waypoint'i hemen hedef yap
                driver.Setup(z.area); // â†“ aÅŸaÄŸÄ±daki kÃ¼Ã§Ã¼k metodu ekle
            }
        }
    }
}
using UnityEngine;

[RequireComponent(typeof(BoxCollider2D))]
public class WanderArea : MonoBehaviour
{
    private BoxCollider2D box;

    void Awake() { box = GetComponent<BoxCollider2D>(); }

    public Vector2 GetRandomPoint()
    {
        var center = (Vector2)transform.TransformPoint(box.offset);
        var size   = Vector2.Scale(box.size, (Vector2)transform.lossyScale);
        float rx = Random.Range(-size.x * 0.5f, size.x * 0.5f);
        float ry = Random.Range(-size.y * 0.5f, size.y * 0.5f);
        return center + new Vector2(rx, ry);
    }

#if UNITY_EDITOR
    void OnDrawGizmosSelected()
    {
        var b = GetComponent<BoxCollider2D>();
        if (!b) return;
        Gizmos.color = Color.cyan;
        var center = (Vector2)transform.TransformPoint(b.offset);
        var size   = Vector2.Scale(b.size, (Vector2)transform.lossyScale);
        Gizmos.DrawWireCube(center, size);
    }
#endif
}
using UnityEngine;
using UnityEngine.UI;

public static class CanvasScalerUpdater
{
    public static void UpdateAllCanvasScalers()
    {
        float x = PlayerPrefs.GetFloat("ResX", 1920);
        float y = PlayerPrefs.GetFloat("ResY", 1080);

        CanvasScaler[] scalers = Resources.FindObjectsOfTypeAll<CanvasScaler>();

        foreach (CanvasScaler scaler in scalers)
        {
            // Sadece sahnedeki CanvasScalerâ€™lara uygula (Prefab deÄŸil)
            if (scaler.gameObject.scene.isLoaded)
                scaler.referenceResolution = new Vector2(x, y);
        }
    }
}
using UnityEngine;

public class EscapeHandler : MonoBehaviour, PlayerControls.IGameplayActions
{
    private PlayerControls controls;

    public GameObject inventoryPanel;
    public GameObject craftPanel;
    public GameObject tradePanel;
    public GameObject pauseMenu;   // artÄ±k kullanÄ±lmayacak ama referansÄ± kalsÄ±n

    private bool AnyPanelOpen =>
        (inventoryPanel && inventoryPanel.activeSelf) ||
        (craftPanel && craftPanel.activeSelf) ||
        (tradePanel && tradePanel.activeSelf);

    private void Awake()
    {
        controls = new PlayerControls();
        controls.Gameplay.SetCallbacks(this);
    }

    private void OnEnable()
    {
        controls.Gameplay.Enable();
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

    public void OnEscape(UnityEngine.InputSystem.InputAction.CallbackContext ctx)
{
    if (!ctx.performed) return;

    HandleEscape();
}

    private void HandleEscape()
    {
        // 1) EÄŸer Inventory / Craft / Trade aÃ§Ä±k ise â†’ sadece onlarÄ± kapat
        if (AnyPanelOpen)
        {
            if (inventoryPanel) inventoryPanel.SetActive(false);
            if (craftPanel) craftPanel.SetActive(false);
            if (tradePanel) tradePanel.SetActive(false);

            Time.timeScale = 1f;
            return;
        }

        // âŒ 2) PauseMenu'yu artÄ±k EscapeHandler KESÄ°NLÄ°KLE YÃ–NETMÄ°YOR âŒ
        // PauseMenu tamamen PauseMenu.cs tarafÄ±ndan kontrol edilecek.
    }

    // kullanÄ±lmayan callbacks:
    public void OnMove(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnSprint(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnMap(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnInventory(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnCraft(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnReload(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnWeapon1(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnWeapon2(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnWeapon3(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnMelee(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnADS(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnShoot(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnCaravanWeapons(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
}
using UnityEngine;

public class PanelController : MonoBehaviour
{
    public void Open()
    {
        UIPanelSystem.Instance.OpenPanel(gameObject);
    }

    public void Close()
    {
        UIPanelSystem.Instance.CloseCurrentPanel();
    }
}
using UnityEngine;
using UnityEngine.InputSystem;

public class PlayerInputRouter : MonoBehaviour, PlayerControls.IGameplayActions
{
    private PlayerControls controls;

    [Header("Referans Paneller")]
    public GameObject inventoryPanel;
    public GameObject craftPanel;
    public GameObject tradePanel;
    public GameObject pauseMenuPanel;

    private void Awake()
    {
        controls = new PlayerControls();
        controls.Gameplay.SetCallbacks(this);
    }

    private void OnEnable() => controls.Gameplay.Enable();
    private void OnDisable() => controls.Gameplay.Disable();

    // ---------------- PANEL INPUT -------------------

    public void OnInventory(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;
        if (UIPanelSystem.Instance.IsPanelOpen()) return;

        UIPanelSystem.Instance.OpenPanel(inventoryPanel);
    }

    public void OnCraft(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;
        if (UIPanelSystem.Instance.IsPanelOpen()) return;

        UIPanelSystem.Instance.OpenPanel(craftPanel);
    }

    public void OnTrade(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;
        if (UIPanelSystem.Instance.IsPanelOpen()) return;

        UIPanelSystem.Instance.OpenPanel(tradePanel);
    }

    public void OnEscape(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;

        if (UIPanelSystem.Instance.IsPanelOpen())
        {
            UIPanelSystem.Instance.CloseCurrentPanel();
        }
        else
        {
            UIPanelSystem.Instance.OpenPanel(pauseMenuPanel);
        }
    }

    // ------------- ARAYÃœZ ZORUNLU FONKSIYONLAR --------------

    public void OnMove(InputAction.CallbackContext ctx) { }
    public void OnSprint(InputAction.CallbackContext ctx) { }
    public void OnMap(InputAction.CallbackContext ctx) { }
    public void OnReload(InputAction.CallbackContext ctx) { }
    public void OnWeapon1(InputAction.CallbackContext ctx) { }
    public void OnWeapon2(InputAction.CallbackContext ctx) { }
    public void OnWeapon3(InputAction.CallbackContext ctx) { }
    public void OnMelee(InputAction.CallbackContext ctx) { }
    public void OnADS(InputAction.CallbackContext ctx) { }
    public void OnCaravanWeapons(InputAction.CallbackContext ctx) { }
}
using UnityEngine;
using TMPro;

public class ResolutionChanger : MonoBehaviour
{
    public TMP_Dropdown resolutionDropdown;

    private readonly Vector2[] resolutions =
    {
        new Vector2(320,200),
        new Vector2(320,240),
        new Vector2(400,300),
        new Vector2(512,384),
        new Vector2(640,400),
        new Vector2(640,480),
        new Vector2(800,600),
        new Vector2(1024,768),
        new Vector2(1152,864),
        new Vector2(1280,600),
        new Vector2(1280,720),
        new Vector2(1280,768),
        new Vector2(1280,800),
        new Vector2(1280,960),
        new Vector2(1280,1024),
        new Vector2(1360,768),
        new Vector2(1366,768),
        new Vector2(1400,1050),
        new Vector2(1440,900),
        new Vector2(1600,900),
        new Vector2(1680,1050),
        new Vector2(1920,1080),
        
    };

    private void Start()
    {
        int saved = PlayerPrefs.GetInt("ResolutionIndex", 0);
        resolutionDropdown.value = saved;
        resolutionDropdown.onValueChanged.AddListener(SetResolution);
    }

    private void SetResolution(int index)
    {
        Vector2 res = resolutions[index];

        PlayerPrefs.SetFloat("ResX", res.x);
        PlayerPrefs.SetFloat("ResY", res.y);
        PlayerPrefs.SetInt("ResolutionIndex", index);
        PlayerPrefs.Save();

        CanvasScalerUpdater.UpdateAllCanvasScalers();
    }
}
using UnityEngine;
using System.Collections;

public class ResolutionInitializer : MonoBehaviour
{
    private void Start()
    {
        StartCoroutine(ApplyDelayed());
    }

    IEnumerator ApplyDelayed()
    {
        yield return null; // 1 frame gecikme
        CanvasScalerUpdater.UpdateAllCanvasScalers();
    }
}
using UnityEngine;
using System.Collections.Generic;

public class UIPanelSystem : MonoBehaviour
{
    public static UIPanelSystem Instance;

    [Header("Ana Canvas (Canvas kÃ¶k)")]
    public Canvas mainCanvas;

    [Header("TÃ¼m Paneller (Inspectorâ€™dan ekle)")]
    public List<GameObject> allPanels;

    private GameObject currentPanel;

    private void Awake()
    {
        Instance = this;
    }

    public bool IsPanelOpen() => currentPanel != null;

    // ------------------ PANEL AÃ‡MA ------------------

    public void OpenPanel(GameObject panel)
    {
        CloseAllPanels();             // Ã–nce hepsini kapat
        currentPanel = panel;

        panel.SetActive(true);

        HideEverythingExcept(panel);
        Time.timeScale = 0f;
    }

    // ------------------ PANEL KAPATMA ------------------

    public void CloseCurrentPanel()
    {
        if (currentPanel != null)
        {
            currentPanel.SetActive(false);
            currentPanel = null;
        }

        ShowEverything();
        Time.timeScale = 1f;
    }

    public void CloseAllPanels()
    {
        foreach (var p in allPanels)
            p.SetActive(false);

        currentPanel = null;
    }

    // ------------------ TÃœM UIâ€™YÄ° GÄ°ZLE / GÃ–STER ------------------

    private void HideEverythingExcept(GameObject panel)
    {
        foreach (Transform t in mainCanvas.transform)
        {
            if (t.gameObject != panel)
                t.gameObject.SetActive(false);
        }
    }

    private void ShowEverything()
    {
        foreach (Transform t in mainCanvas.transform)
            t.gameObject.SetActive(true);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class MapToggle : MonoBehaviour
{
    [Header("UI ReferanslarÄ±")]
    public GameObject mapPanel;
    public RectTransform mapRect;
    public RectTransform playerMarker;

    [Header("Oyuncu ve Ayarlar")]
    public Transform player;
    public float mapScale = 1f;

    private bool isMapVisible = false;
    private Vector3 mapBottomLeft;
    private PlayerControls controls; // Script kendi oluÅŸturacak

    private void Awake()
    {
        // PlayerControls Ã¶rneÄŸini oluÅŸtur
        controls = new PlayerControls();
    }

    private void OnEnable()
    {
        // Map tuÅŸuna basÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak eventâ€™leri baÄŸla
        controls.Gameplay.Map.performed += OnMapPressed;
        controls.Gameplay.Map.canceled += OnMapReleased;
        controls.Gameplay.Enable();

        if (mapPanel != null)
            mapPanel.SetActive(false);

        if (mapRect != null)
        {
            Vector3[] corners = new Vector3[4];
            mapRect.GetWorldCorners(corners);
            mapBottomLeft = corners[0];
        }
    }

    private void OnDisable()
    {
        controls.Gameplay.Map.performed -= OnMapPressed;
        controls.Gameplay.Map.canceled -= OnMapReleased;
        controls.Gameplay.Disable();
    }

    private void OnMapPressed(InputAction.CallbackContext context)
    {
        if (mapPanel == null) return;

        mapPanel.SetActive(true);
        isMapVisible = true;
        Debug.Log("ğŸ—ºï¸ Harita aÃ§Ä±ldÄ± (Tab basÄ±ldÄ±)");
    }

    private void OnMapReleased(InputAction.CallbackContext context)
    {
        if (mapPanel == null) return;

        mapPanel.SetActive(false);
        isMapVisible = false;
        Debug.Log("âŒ Harita kapandÄ± (Tab bÄ±rakÄ±ldÄ±)");
    }

    private void Update()
    {
        if (isMapVisible)
            UpdatePlayerMarker();
    }

    private void UpdatePlayerMarker()
    {
        if (player == null || playerMarker == null || mapRect == null) return;

        // 2D pozisyon hesaplama
        Vector3 worldOffset = player.position;
        Vector2 mapPos = new Vector2(worldOffset.x, worldOffset.y) * mapScale;

        Vector3[] corners = new Vector3[4];
        mapRect.GetWorldCorners(corners);
        mapBottomLeft = corners[0];

        Vector2 anchored = new Vector2(
            mapPos.x + (mapRect.rect.width / 2),
            mapPos.y + (mapRect.rect.height / 2)
        );

        playerMarker.anchoredPosition = anchored;
    }
}
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.Events;

public class CreditsAutoScroll : MonoBehaviour
{
    [Header("Refs")]
    public ScrollRect scrollRect;

    [Header("Ayarlar")]
    public float speed = 20f;      // px/sn
    public float topHold = 0.5f;   // baÅŸlamadan Ã¶nce bekleme
    public float bottomHold = 1f;  // en altta bekleme (kapanmadan Ã¶nce)

    [Header("BitiÅŸ DavranÄ±ÅŸÄ±")]
    public bool closePanelOnFinish = false;
    public GameObject panelToClose;             // credits paneli
    public UnityEvent onFinished;               // bittiÄŸinde tetiklenir

    private RectTransform contentRT;
    private RectTransform viewportRT;
    private bool running;

    void OnEnable()
    {
        if (scrollRect == null || scrollRect.content == null) return;

        // Viewport boÅŸ bÄ±rakÄ±lmÄ±ÅŸsa ilk Ã§ocuk olarak ayarla
        if (scrollRect.viewport == null)
            scrollRect.viewport = scrollRect.transform.GetChild(0).GetComponent<RectTransform>();

        contentRT  = scrollRect.content;
        viewportRT = scrollRect.viewport;

        StartCoroutine(ScrollRoutine());
    }

    System.Collections.IEnumerator ScrollRoutine()
    {
        running = true;

        // BaÅŸta en Ã¼ste getir
        scrollRect.verticalNormalizedPosition = 1f;

        // Layout otursun
        yield return new WaitForSeconds(topHold);
        yield return null; // 1 frame

        // Ä°Ã§erik gÃ¶rÃ¼nÃ¼r alandan kÄ±sa ise Ã§Ä±k
        float h = Mathf.Max(0f, contentRT.rect.height - viewportRT.rect.height);
        if (h <= 1f) { Finish(); yield break; }

        // AkÄ±ÅŸ: 1 -> 0
        while (running && contentRT != null)
        {
            // hÄ±z (px/sn) -> normalized adÄ±m
            float step = (speed * Time.unscaledDeltaTime) / h;
            scrollRect.verticalNormalizedPosition -= step;

            if (scrollRect.verticalNormalizedPosition <= 0f)
            {
                scrollRect.verticalNormalizedPosition = 0f;
                // En alta ulaÅŸtÄ±k => bekle ve bitir
                if (bottomHold > 0f) yield return new WaitForSeconds(bottomHold);
                Finish();
                yield break;
            }

            yield return null;
        }
    }

    void Finish()
    {
        running = false;
        onFinished?.Invoke();

        if (closePanelOnFinish && panelToClose != null)
            panelToClose.SetActive(false);
    }

    void OnDisable() { running = false; }
}
// CreditsBuilder.cs
using UnityEngine;
using TMPro;
using UnityEngine.UI;

public class CreditsBuilder : MonoBehaviour
{
    [System.Serializable]
    public class Section
    {
        public string title;
        [TextArea] public string[] lines;
    }

    public Transform content;           // Scroll View -> Viewport -> Content
    public TextMeshProUGUI sectionTitlePrefab;
    public TextMeshProUGUI linePrefab;

    public Section[] sections;

    void Start()
    {
        Build();
    }


    public void Build()
    {
        foreach (Transform child in content) Destroy(child.gameObject);

        foreach (var s in sections)
        {
            if (!string.IsNullOrEmpty(s.title))
            {
                var title = Instantiate(sectionTitlePrefab, content);
                title.text = $"<b>{s.title}</b>";
            }

            foreach (var line in s.lines)
            {
                var l = Instantiate(linePrefab, content);
                l.text = line;
            }

            var spacer = Instantiate(linePrefab, content);
            spacer.text = "\n";
        }

        // --- kritik: layoutâ€™Ä± hemen hesaplat ---
        LayoutRebuilder.ForceRebuildLayoutImmediate((RectTransform)content);

        // baÅŸtan baÅŸla
        ((RectTransform)content).anchoredPosition = Vector2.zero;
    }


}
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.InputSystem;

public class MainMenu : MonoBehaviour
{
    [Header("MÃ¼zik")]
    public AudioSource musicSource;
    public AudioClip menuMusic;

    [Header("UI Panelleri")]
    public GameObject mainPanel;
    public GameObject settingsPanel;
    public GameObject creditsPanel;
    public GameObject levelPanel;

    private bool isInSettings = false;
    private bool isInLevels = false;
    private bool isInCredits = false;

    private void Start()
    {
        // ğŸ”¥ Oyun sahnesinden gelen MusicManager varsa yok et
        if (MusicManager.Instance != null)
            Destroy(MusicManager.Instance.gameObject);

        // ğŸ”¥ TimeScale sÄ±fÄ±r kalmÄ±ÅŸ olabilir. MenÃ¼de kesinlikle 1 olsun.
        Time.timeScale = 1f;

        StartCoroutine(PlayMusicWithDelay(0.25f));  

        // Devam Et butonunu aktif/pasif yap
        var continueBtn = GameObject.Find("Continue Button")?.GetComponent<UnityEngine.UI.Button>();
        if (continueBtn != null)
            continueBtn.interactable = SaveSystem.HasSave();
    }

    private System.Collections.IEnumerator PlayMusicWithDelay(float delay)
    {
        yield return new WaitForSecondsRealtime(delay);

        if (musicSource != null && menuMusic != null)
        {
            musicSource.clip = menuMusic;
            musicSource.loop = true;
            musicSource.volume = 1f;

            // Mixer Ã§Ä±kÄ±ÅŸÄ±nÄ± bypass et â†’ test iÃ§in en temiz yÃ¶ntem
            musicSource.outputAudioMixerGroup = null;

            musicSource.Play();
            Debug.Log("ğŸµ Ana MenÃ¼ mÃ¼ziÄŸi BAÅLADI!");
        }
        else
        {
            Debug.LogError("âŒ musicSource veya menuMusic atanmadÄ±!");
        }
    }

    // -----------------------------------
    //           OYUN BAÅLATMA
    // -----------------------------------

    public void YeniOyunaBasla()
    {
        SaveSystem.DeleteSave();
        SaveBootstrap.ShouldLoadFromSave = false;
        SceneManager.LoadScene("Bolum1");
    }

    public void DevamEt()
    {
        if (!SaveSystem.HasSave())
            return;

        SaveBootstrap.ShouldLoadFromSave = true;
        SceneManager.LoadScene("Bolum1");
    }

    // -----------------------------------
    //           PANEL KONTROLÃœ
    // -----------------------------------
    public void OpenSettings()
    {
        mainPanel.SetActive(false);
        settingsPanel.SetActive(true);
        isInSettings = true;
    }

    public void CloseSettings()
    {
        settingsPanel.SetActive(false);
        mainPanel.SetActive(true);
        isInSettings = false;
    }

    public void OpenLevels()
    {
        mainPanel.SetActive(false);
        levelPanel.SetActive(true);
        isInLevels = true;
    }

    public void CloseLevels()
    {
        levelPanel.SetActive(false);
        mainPanel.SetActive(true);
        isInLevels = false;
    }

    public void OpenCredits()
    {
        mainPanel.SetActive(false);
        creditsPanel.SetActive(true);
        isInCredits = true;
    }

    public void CloseCredits()
    {
        creditsPanel.SetActive(false);
        mainPanel.SetActive(true);
        isInCredits = false;
    }

    public void QuitGame()
    {
        Application.Quit();
    }
}
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.InputSystem;

public class PauseMenu : MonoBehaviour
{
    public static PauseMenu Instance { get; private set; }

    public GameObject pausePanel;
    public GameObject settingsPanel;
    private bool justClosedSettings = false;


    public static bool IsPaused { get; private set; }

    private PlayerControls controls;

    private void Awake()
    {
        Instance = this;

        controls = new PlayerControls();
        controls.Gameplay.Escape.performed += ctx => OnEscapePressed();
    }

    private void OnEnable()
    {
        controls.Gameplay.Enable();
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

   private void OnEscapePressed()
{
    // ğŸ”¥ Game Over durumunda ESC hiÃ§bir ÅŸey yapamaz
    if (GameStateManager.IsGameOver)
        return;

    // ESC korumasÄ± (SettingsPanel yeni kapandÄ±ysa)
    if (justClosedSettings)
    {
        justClosedSettings = false; // Bir kere blokla
        return;
    }

    if (settingsPanel.activeSelf)
    {
        CloseSettings();
        return;
    }

    if (IsPaused)
        ResumeGame();
    else
        PauseGame();
}


    public void PauseGame()
    {
        IsPaused = true;
        pausePanel.SetActive(true);
        settingsPanel.SetActive(false);
        Time.timeScale = 0f;
    }

    public void ResumeGame()
    {
        IsPaused = false;
        pausePanel.SetActive(false);
        settingsPanel.SetActive(false);
        Time.timeScale = 1f;
    }

    public void OpenSettings()
    {
        // Settings aÃ§Ä±ldÄ±ÄŸÄ±nda PauseMenu gizlenir ama oyun duraklamaya devam eder
        IsPaused = true;
        pausePanel.SetActive(false);
        settingsPanel.SetActive(true);
    }

   public void CloseSettings()
{
    // Sadece SettingsPanel kapanÄ±r
    settingsPanel.SetActive(false);

    // PauseMenuPanel tekrar gÃ¶rÃ¼nÃ¼r olmalÄ±
    pausePanel.SetActive(true);

    // Oyun pause durumda kalmalÄ±
    IsPaused = true;
    Time.timeScale = 0f;

    // ESCâ€™nin hemen PauseMenuâ€™yu kapatmamasÄ± iÃ§in 0.2 sn koruma
    justClosedSettings = true;
    Invoke(nameof(ResetSettingsCloseFlag), 0.2f);
}


private void ResetSettingsCloseFlag()
{
    justClosedSettings = false;
}


}
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;

public class SettingsMenu : MonoBehaviour
{
    public GameObject panel;
    public Slider masterSlider;

    public Slider musicSlider;
    public Slider sfxSlider;
    public TMP_Dropdown qualityDropdown;
    public Toggle fullscreenToggle;
    public TMP_Dropdown resolutionDropdown;
    private Resolution[] resolutions;

    private void Start()
    {
        // AyarlarÄ± yÃ¼kle
        masterSlider.value = PlayerPrefs.GetFloat("MasterVolume", 1f);
        masterSlider.onValueChanged.AddListener(SetMasterVolume);

        musicSlider.value = PlayerPrefs.GetFloat("MusicVolume", 1f);
        sfxSlider.value = PlayerPrefs.GetFloat("SFXVolume", 1f);
        qualityDropdown.value = PlayerPrefs.GetInt("QualityLevel", QualitySettings.GetQualityLevel());
        fullscreenToggle.isOn = PlayerPrefs.GetInt("Fullscreen", 1) == 1;

        ApplySettings();

        resolutions = Screen.resolutions;
        resolutionDropdown.ClearOptions();

        int currentResolutionIndex = 0;
        List<string> options = new List<string>();

        for (int i = 0; i < resolutions.Length; i++)
        {
            string option = $"{resolutions[i].width} x {resolutions[i].height} ({resolutions[i].refreshRate}Hz)";
            options.Add(option);

            if (resolutions[i].width == Screen.currentResolution.width &&
                resolutions[i].height == Screen.currentResolution.height)
            {
                currentResolutionIndex = i;
            }
        }

        resolutionDropdown.AddOptions(options);
        resolutionDropdown.value = PlayerPrefs.GetInt("ResolutionIndex", currentResolutionIndex);
        resolutionDropdown.RefreshShownValue();

        resolutionDropdown.onValueChanged.AddListener(SetResolution);
        musicSlider.onValueChanged.AddListener(SetMusicVolume);
        sfxSlider.onValueChanged.AddListener(SetSFXVolume);
        qualityDropdown.onValueChanged.AddListener(SetQuality);
        fullscreenToggle.onValueChanged.AddListener(SetFullscreen);
    }

    public void OpenPanel()
    {
        panel.SetActive(true);
    }

    public void ClosePanel()
    {
        panel.SetActive(false);

        // EÄŸer ayarlar menÃ¼sÃ¼ pause menÃ¼sÃ¼nden aÃ§Ä±ldÄ±ysa, geri dÃ¶n
        if (PauseMenu.Instance != null && PauseMenu.IsPaused)
        {
            PauseMenu.Instance.CloseSettings();
        }
    }

    
    void SetResolution(int index)
    {
        Resolution res = resolutions[index];
        Screen.SetResolution(res.width, res.height, Screen.fullScreenMode);
        PlayerPrefs.SetInt("ResolutionIndex", index);
        Debug.Log($"ğŸ“º Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k deÄŸiÅŸti: {res.width}x{res.height}");
    }


    void SetMasterVolume(float value)
    {
        AudioManager.Instance?.SetMasterVolume(value);
    }


    void SetMusicVolume(float value)
    {
        AudioManager.Instance?.SetMusicVolume(value);
    }

    void SetSFXVolume(float value)
    {
        AudioManager.Instance?.SetSFXVolume(value);
    }

    void SetQuality(int index)
    {
        QualitySettings.SetQualityLevel(index);
        PlayerPrefs.SetInt("QualityLevel", index);
    }

    void SetFullscreen(bool isFullscreen)
    {
        Screen.fullScreen = isFullscreen;
        PlayerPrefs.SetInt("Fullscreen", isFullscreen ? 1 : 0);
    }

    void ApplySettings()
    {
        SetMusicVolume(musicSlider.value);
        SetSFXVolume(sfxSlider.value);
        SetQuality(qualityDropdown.value);
        SetFullscreen(fullscreenToggle.isOn);
    }
}
public enum SettingsMenuOrigin
{
    None,
    PauseMenu,
    MainMenu
}
using System.Collections;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.SceneManagement;

public class MultiImageIntroController : MonoBehaviour
{
    [System.Serializable]
    public class IntroStep
    {
        public Image image;             // GÃ¶rsel
        public AudioClip soundEffect;   // O anda Ã§alacak ses
    }

    public IntroStep[] steps;             // TÃ¼m adÄ±mlar
    public float fadeDuration = 1f;
    public float displayTime = 2f;
    public string nextSceneName = "MainMenu";

    public AudioSource audioSource;      // Ses oynatÄ±cÄ±

    private void Start()
    {
        StartCoroutine(PlayIntroSequence());
    }

    private IEnumerator PlayIntroSequence()
    {
        // BaÅŸta tÃ¼m gÃ¶rselleri kapat
        foreach (var step in steps)
        {
            step.image.gameObject.SetActive(false);
            SetAlpha(step.image, 0f);
        }

        foreach (var step in steps)
        {
            step.image.gameObject.SetActive(true);

            if (step.soundEffect != null && audioSource != null)
            {
                yield return new WaitForSeconds(1f); // 1 saniye bekle
                audioSource.clip = step.soundEffect;
                audioSource.Play();
            }


            yield return StartCoroutine(FadeImage(step.image, 0f, 1f));
            yield return new WaitForSeconds(displayTime);
            yield return StartCoroutine(FadeImage(step.image, 1f, 0f));

            step.image.gameObject.SetActive(false);
        }

        SceneManager.LoadScene(nextSceneName);
    }

    private IEnumerator FadeImage(Image img, float startAlpha, float endAlpha)
    {
        Color color = img.color;
        float elapsed = 0f;

        while (elapsed < fadeDuration)
        {
            float t = elapsed / fadeDuration;
            color.a = Mathf.Lerp(startAlpha, endAlpha, t);
            img.color = color;
            elapsed += Time.deltaTime;
            yield return null;
        }

        color.a = endAlpha;
        img.color = color;
    }

    private void SetAlpha(Image img, float alpha)
    {
        Color color = img.color;
        color.a = alpha;
        img.color = color;
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;                     // âœ… eklendi
using System.Collections.Generic;
using System.Linq;
using UnityEngine.EventSystems;

public class NPCInteraction : MonoBehaviour
{


    private readonly List<TradeOfferButton> spawned = new List<TradeOfferButton>();
    private bool layoutDone = false;

    [Header("Trade Data")]
    public List<TradeOffer> tradeOffers;

    [Header("Layout Settings (code-driven)")]
    public float rowSpacing = 8f;   // satÄ±rlar arasÄ±
    public float innerSpacing = 12f; // buton ile text arasÄ± (prefab iÃ§i HLG.spacing)

    [Header("Layout (manual)")]
    public float topPadding = 10f;
    public float bottomPadding = 10f;



    [Header("UI Refs")]
    public GameObject tradeUIPanel;
    public GameObject interactPromptUI;
    public Transform tradeOffersContainer;          // Content
    public GameObject tradeOfferButtonPrefab;       // iÃ§inde TradeOfferButton var
    public ScrollRect tradeScrollRect;              // âœ… Scroll Viewâ€™in Ã¼zerindeki ScrollRect

    private bool inertiaDefault = true;

    [Header("Auto Load (optional)")]
    public bool autoLoadFromResources = true;
    public string resourcesFolder = "Animals";

    private bool isPlayerNearby = false;
    private PlayerStats playerStats;

    public static NPCInteraction Instance { get; private set; }
    public static bool IsTradeOpen =>
        Instance != null && Instance.tradeUIPanel != null && Instance.tradeUIPanel.activeSelf;

    private void Awake() { Instance = this; }

    private void Start()
    {
        playerStats = FindObjectOfType<PlayerStats>();
        if (tradeUIPanel != null) tradeUIPanel.SetActive(false);
        if (interactPromptUI != null) interactPromptUI.SetActive(false);

        // (opsiyonel) Resourcesâ€™tan teklifleri yÃ¼kle
        if (autoLoadFromResources)
        {
            var loaded = Resources.LoadAll<TradeOffer>(resourcesFolder);
            if (loaded != null && loaded.Length > 0)
            {
                var set = new HashSet<TradeOffer>(tradeOffers);
                foreach (var t in loaded) if (!set.Contains(t)) tradeOffers.Add(t);
            }
        }

        // âœ… Content doÄŸru yapÄ±landÄ±rÄ±lmÄ±ÅŸ mÄ± emin ol (runtimeâ€™da gÃ¼venlik)

    }

    private System.Collections.IEnumerator OpenTradePanelStable()
    {
        // 1) UIâ€™Ä± kur
        PopulateTradeOffers();

        // 2) 1 frame bekle -> layout otursun
        yield return null;
        Canvas.ForceUpdateCanvases();

        // 3) Contentâ€™i tepeye Ã§ek
        var contentRT = (RectTransform)tradeOffersContainer;
        // YalnÄ±zca Yâ€™yi 0â€™la (pivot 0,1 olduÄŸunda tepe demek)
        contentRT.anchoredPosition = new Vector2(contentRT.anchoredPosition.x, 0f);

        // 4) Scrollâ€™u dondur ve tepeye al
        if (tradeScrollRect != null)
        {
            tradeScrollRect.StopMovement();
            tradeScrollRect.velocity = Vector2.zero;
            tradeScrollRect.verticalNormalizedPosition = 1f;
            tradeScrollRect.inertia = false; // ister kalÄ±cÄ± kapat
        }

        // 5) Otomatik seÃ§ili UI temizle
        EventSystem.current?.SetSelectedGameObject(null);
    }

    private void Update()
    {
        if (isPlayerNearby && Keyboard.current != null && Keyboard.current.eKey.wasPressedThisFrame)
            ToggleTradePanel();

        if (IsTradeOpen && Keyboard.current != null && Keyboard.current.escapeKey.wasPressedThisFrame)
            CloseTradePanel();
    }

    public void CloseTradePanel()
    {
        if (tradeUIPanel == null) return;
        tradeUIPanel.SetActive(false);
        Time.timeScale = 1f;
        if (isPlayerNearby && interactPromptUI != null) interactPromptUI.SetActive(true);
    }

    private System.Collections.IEnumerator AfterFirstFrameStabilize()
    {
        yield return null; // 1 frame bekle (layout bitsin)
        Canvas.ForceUpdateCanvases();

        if (tradeScrollRect != null)
        {
            tradeScrollRect.StopMovement();
            tradeScrollRect.velocity = Vector2.zero;                 // gÃ¼vence
            tradeScrollRect.verticalNormalizedPosition = 1f;         // tekrar tepe
            tradeScrollRect.inertia = inertiaDefault;                // eski ayara dÃ¶n
        }

        if (EventSystem.current != null)
            EventSystem.current.SetSelectedGameObject(null);         // oto-seÃ§imi temizle
    }


    private void ToggleTradePanel()
    {
        if (tradeUIPanel == null) return;

        bool shouldOpen = !tradeUIPanel.activeSelf;
        tradeUIPanel.SetActive(shouldOpen);

        if (shouldOpen)
        {
            StartCoroutine(OpenTradePanelStable());
            Time.timeScale = 0f;
            interactPromptUI?.SetActive(false);
        }
        else
        {
            Time.timeScale = 1f;
            if (isPlayerNearby) interactPromptUI?.SetActive(true);
        }
    }

    private void PopulateTradeOffers()
    {
        // Scroll pozisyonunu koru
        float prevScroll = tradeScrollRect ? tradeScrollRect.verticalNormalizedPosition : 1f;

        // Ä°LK KEZ: oluÅŸtur + konumlandÄ±r
        if (!layoutDone)
        {
            // Var olan Ã§ocuklarÄ± temizle (sadece 1 kere)
            for (int i = tradeOffersContainer.childCount - 1; i >= 0; i--)
                Destroy(tradeOffersContainer.GetChild(i).gameObject);

            float y = -topPadding;
            for (int i = 0; i < tradeOffers.Count; i++)
            {
                var go = Instantiate(tradeOfferButtonPrefab, tradeOffersContainer);
                var btn = go.GetComponent<TradeOfferButton>();

                // Anchor/pivot sabit
                var rt = (RectTransform)go.transform;
                rt.anchorMin = new Vector2(0f, 1f);
                rt.anchorMax = new Vector2(0f, 1f);
                rt.pivot = new Vector2(0f, 1f);

                // YERLEÅÄ°M YALNIZCA BURADA!
                float h = Mathf.Max(rt.sizeDelta.y, LayoutUtility.GetPreferredHeight(rt));
                rt.anchoredPosition = new Vector2(0f, y);
                y -= (h + rowSpacing);

                spawned.Add(btn);
            }

            // Content yÃ¼ksekliÄŸi
            var contentRT = (RectTransform)tradeOffersContainer;
            float needed = -y - rowSpacing + bottomPadding;
            if (needed < 0f) needed = 0f;
            var sz = contentRT.sizeDelta;
            contentRT.sizeDelta = new Vector2(sz.x, needed);

            layoutDone = true;
        }

        // HER SEFERÄ°NDE: sadece veri / interaktiflik gÃ¼ncelle
        for (int i = 0; i < spawned.Count && i < tradeOffers.Count; i++)
            spawned[i].Setup(tradeOffers[i]);


        // UI sabitle
        Canvas.ForceUpdateCanvases();
        if (tradeScrollRect)
        {
            tradeScrollRect.StopMovement();
            tradeScrollRect.velocity = Vector2.zero;
            tradeScrollRect.verticalNormalizedPosition = prevScroll; // kayma yok
        }
        EventSystem.current?.SetSelectedGameObject(null);
    }

    // --- Kaynak kontrol & dÃ¼ÅŸÃ¼m ---
    private bool HasEnoughResources(TradeOffer offer)
{
    if (playerStats == null || offer == null) return false;

    // 0 isteyenleri atla
    if (offer.requiredStone > 0 && !Inventory.Instance.HasEnough(offer.stoneSO, offer.requiredStone)) return false;
    if (offer.requiredWood > 0 && !Inventory.Instance.HasEnough(offer.woodSO, offer.requiredWood)) return false;
    if (offer.requiredScrapMetal > 0 && !Inventory.Instance.HasEnough(offer.scrapSO, offer.requiredScrapMetal)) return false;
    if (offer.requiredMeat > 0 && !Inventory.Instance.HasEnough(offer.meatSO, offer.requiredMeat)) return false;
    if (offer.requiredDeerHide > 0 && !Inventory.Instance.HasEnough(offer.deerHideSO, offer.requiredDeerHide)) return false;
    if (offer.requiredRabbitHide > 0 && !Inventory.Instance.HasEnough(offer.rabbitHideSO, offer.requiredRabbitHide)) return false;
    if (offer.requiredHerb > 0 && !Inventory.Instance.HasEnough(offer.herbSO, offer.requiredHerb)) return false;
    if (offer.requiredAmmo > 0 && !Inventory.Instance.HasEnough(offer.ammoSO, offer.requiredAmmo)) return false;

    return true;
}


    private void DeductResources(TradeOffer offer)
{
    if (offer == null) return;

    if (offer.requiredStone > 0) Inventory.Instance.TryConsume(offer.stoneSO, offer.requiredStone);
    if (offer.requiredWood > 0) Inventory.Instance.TryConsume(offer.woodSO, offer.requiredWood);
    if (offer.requiredScrapMetal > 0) Inventory.Instance.TryConsume(offer.scrapSO, offer.requiredScrapMetal);
    if (offer.requiredMeat > 0) Inventory.Instance.TryConsume(offer.meatSO, offer.requiredMeat);
    if (offer.requiredDeerHide > 0) Inventory.Instance.TryConsume(offer.deerHideSO, offer.requiredDeerHide);
    if (offer.requiredRabbitHide > 0) Inventory.Instance.TryConsume(offer.rabbitHideSO, offer.requiredRabbitHide);
    if (offer.requiredHerb > 0) Inventory.Instance.TryConsume(offer.herbSO, offer.requiredHerb);
    if (offer.requiredAmmo > 0) Inventory.Instance.TryConsume(offer.ammoSO, offer.requiredAmmo);
}

    // --- Takas iÅŸlemi ---
public void ExecuteTrade(TradeOffer offer)
{
    if (offer == null) return;

    // Yeterli kaynak var mÄ±?
    if (!HasEnoughResources(offer))
    {
        Debug.Log("Takas baÅŸarÄ±sÄ±z! Yeterli materyal yok.");
        return;
    }

    // KaynaklarÄ± dÃ¼ÅŸ
    DeductResources(offer);

    // Ã–dÃ¼l tipi: normal resource
    if (offer.rewardKind == RewardKind.Resource)
    {
        if (offer.rewardItemSO != null && offer.rewardAmount > 0)
        {
            Inventory.Instance.TryAdd(offer.rewardItemSO, offer.rewardAmount);
            Debug.Log($"Takas baÅŸarÄ±lÄ±! {offer.rewardAmount} x {offer.rewardItemSO.itemName} alÄ±ndÄ±.");
        }
    }
    // Ã–dÃ¼l tipi: silah parÃ§asÄ±
    else if (offer.rewardKind == RewardKind.WeaponPart)
    {
        if (offer.partToGive != null && offer.amountToGive > 0)
        {
            Inventory.Instance.TryAdd(offer.partToGive, offer.amountToGive);
            Debug.Log($"Takas baÅŸarÄ±lÄ±! {offer.amountToGive} x {offer.partToGive.itemName} alÄ±ndÄ±.");
        }
    }

    // UI yenile
    PopulateTradeOffers();
}



    // --- Trigger alanÄ± ---

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;

        isPlayerNearby = true;

        // Panel kapalÄ±ysa promptâ€™u gÃ¶ster
        if (!IsTradeOpen && interactPromptUI != null)
            interactPromptUI.SetActive(true);
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;

        isPlayerNearby = false;

        // Alandan Ã§Ä±kÄ±nca promptâ€™u gizle
        if (interactPromptUI != null)
            interactPromptUI.SetActive(false);

        // Ä°steÄŸe baÄŸlÄ±: Alandan Ã§Ä±kÄ±nca paneli kapat
        // CloseTradePanel();
    }

    [ContextMenu("Reload Trade Offers")]
    private void ReloadTradeOffersInEditor()
    {
        var loaded = Resources.LoadAll<TradeOffer>(resourcesFolder);
        tradeOffers = loaded.ToList();
#if UNITY_EDITOR
        UnityEditor.EditorUtility.SetDirty(this);
#endif
    }
}
using UnityEngine;

public enum RewardKind
{
    WeaponPart,
    Resource
}

[CreateAssetMenu(fileName = "New Trade Offer", menuName = "NPC/Trade Offer")]
public class TradeOffer : ScriptableObject
{
    [Header("Player Gives (Costs)")]
    public ItemData stoneSO;
    public int requiredStone = 0;

    public ItemData woodSO;
    public int requiredWood = 0;

    public ItemData scrapSO;
    public int requiredScrapMetal = 0;

    public ItemData ammoSO;
    public int requiredAmmo = 0;

    public ItemData meatSO;
    public int requiredMeat = 0;

    public ItemData deerHideSO;
    public int requiredDeerHide = 0;

    public ItemData rabbitHideSO;
    public int requiredRabbitHide = 0;

    public ItemData herbSO;
    public int requiredHerb = 0;

    [Header("Player Gets (Rewards)")]
    public RewardKind rewardKind = RewardKind.Resource;

    // âœ” WeaponPart Ã¶dÃ¼lÃ¼ iÃ§in (Yeni sistem)
    public PartItemData partToGive;
    public int amountToGive = 1;

    // Resource Ã¶dÃ¼lÃ¼ iÃ§in
    public ItemData rewardItemSO;
    public int rewardAmount = 0;
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;

public class TradeOfferButton : MonoBehaviour
{
    [Header("UI Prefabs")]
    [SerializeField] private GameObject offerTextPrefab;
    [SerializeField] private Button tradeButton;
    [SerializeField] private Image iconImage;

    [Header("Layout")]
    [SerializeField] private float gap = 10f;
    [SerializeField] private float textPosX = 490f;
    [SerializeField] private float textWidth = 1000f;
    [SerializeField] private float textHeight = 100f;

    [Header("Sprites (Optional)")]
    public Sprite fallbackSprite;

    private Dictionary<PartItemData, Sprite> partMap = new();
    private TradeOffer currentOffer;
    private NPCInteraction npc;

    [SerializeField] private TextMeshProUGUI offerTextSlot;
    private TextMeshProUGUI offerTextInstance;

    void Awake()
    {
        if (!iconImage && tradeButton)
            iconImage = tradeButton.GetComponent<Image>();

        EnsureOfferText();
    }

    private void EnsureOfferText()
    {
        if (offerTextInstance != null) return;

        if (offerTextSlot != null)
            offerTextInstance = offerTextSlot;
        else if (offerTextPrefab != null)
            offerTextInstance = Instantiate(offerTextPrefab, transform).GetComponent<TextMeshProUGUI>();
        else
            Debug.LogError("[TradeOfferButton] No text source assigned!");

        PositionAndSizeText();
    }

    public void Setup(TradeOffer offer)
    {
        currentOffer = offer;
        npc = NPCInteraction.Instance;

        if (!tradeButton || currentOffer == null)
            return;

        EnsureOfferText();
        ApplyIconForOffer(offer);

        string cost = BuildCostText(offer);

        string reward = offer.rewardKind == RewardKind.WeaponPart
            ? $"Verilen: {offer.amountToGive} x {offer.partToGive?.itemName}"
            : $"Verilen: {offer.rewardAmount} x {offer.rewardItemSO?.itemName}";

        offerTextInstance.text = $"{cost}\n{reward}";

        tradeButton.interactable = CanAfford(offer);
        tradeButton.onClick.RemoveAllListeners();
        tradeButton.onClick.AddListener(OnTradeClicked);
    }

    private bool CanAfford(TradeOffer o)
    {
        return
            Inventory.Instance.GetTotalCount(o.stoneSO) >= o.requiredStone &&
            Inventory.Instance.GetTotalCount(o.woodSO) >= o.requiredWood &&
            Inventory.Instance.GetTotalCount(o.scrapSO) >= o.requiredScrapMetal &&
            Inventory.Instance.GetTotalCount(o.meatSO) >= o.requiredMeat &&
            Inventory.Instance.GetTotalCount(o.deerHideSO) >= o.requiredDeerHide &&
            Inventory.Instance.GetTotalCount(o.rabbitHideSO) >= o.requiredRabbitHide &&
            Inventory.Instance.GetTotalCount(o.herbSO) >= o.requiredHerb &&
            Inventory.Instance.GetTotalCount(o.ammoSO) >= o.requiredAmmo;
    }

    private string BuildCostText(TradeOffer o)
    {
        List<string> parts = new();

        if (o.requiredWood > 0) parts.Add($"{o.requiredWood} Odun");
        if (o.requiredStone > 0) parts.Add($"{o.requiredStone} TaÅŸ");
        if (o.requiredScrapMetal > 0) parts.Add($"{o.requiredScrapMetal} Metal");
        if (o.requiredMeat > 0) parts.Add($"{o.requiredMeat} Et");
        if (o.requiredDeerHide > 0) parts.Add($"{o.requiredDeerHide} Geyik Derisi");
        if (o.requiredRabbitHide > 0) parts.Add($"{o.requiredRabbitHide} TavÅŸan Derisi");
        if (o.requiredHerb > 0) parts.Add($"{o.requiredHerb} Ot");
        if (o.requiredAmmo > 0) parts.Add($"{o.requiredAmmo} Mermi");

        return "Ä°stenen: " + string.Join(", ", parts);
    }

    private void PositionAndSizeText()
    {
        var rt = offerTextInstance.rectTransform;

        rt.anchorMin = new Vector2(0f, 0.5f);
        rt.anchorMax = new Vector2(0f, 0.5f);
        rt.pivot = new Vector2(0f, 0.5f);

        rt.anchoredPosition = new Vector2(textPosX, 0f);

        rt.SetSizeWithCurrentAnchors(RectTransform.Axis.Horizontal, textWidth);
        rt.SetSizeWithCurrentAnchors(RectTransform.Axis.Vertical, textHeight);

        var le = offerTextInstance.GetComponent<LayoutElement>();
        if (!le) le = offerTextInstance.gameObject.AddComponent<LayoutElement>();
        le.ignoreLayout = true;
    }

    private void ApplyIconForOffer(TradeOffer offer)
    {
        if (!iconImage) return;

        Sprite s = null;

        if (offer.rewardKind == RewardKind.WeaponPart)
        {
            if (offer.partToGive != null)
                s = offer.partToGive.icon;
        }
        else if (offer.rewardKind == RewardKind.Resource)
        {
            if (offer.rewardItemSO != null)
                s = offer.rewardItemSO.icon;
        }

        iconImage.sprite = s ? s : fallbackSprite;
        iconImage.enabled = iconImage.sprite != null;

        if (iconImage.enabled)
            iconImage.preserveAspect = true;
    }

    private void OnTradeClicked()
    {
        if (npc == null || currentOffer == null) return;

        npc.ExecuteTrade(currentOffer);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;

[DisallowMultipleComponent]
[RequireComponent(typeof(AudioSource))]
public class PlayerFootsteps : MonoBehaviour
{
    public enum Mode { DistanceBased, AnimationEvents }
    [Header("Mode")]
    public Mode mode = Mode.DistanceBased;

    [Header("Footstep Clips")]
    public AudioClip[] footstepClips;

    [Header("Step Settings")]
    public float walkStepDistance = 0.85f;  // yÃ¼rÃ¼rken adÄ±m mesafesi
    public float runStepDistance  = 0.55f;  // koÅŸarken daha kÄ±sa mesafe
    public float runThreshold     = 3.0f;   // koÅŸma hÄ±zÄ± eÅŸiÄŸi
    public float minMovementSpeed = 0.05f;  // durma eÅŸiÄŸi

    [Header("Sound Settings")]
    public float volume = 0.9f;
    public float minPitch = 0.95f;
    public float maxPitch = 1.05f;
    public float minStepGap = 0.12f; // iki adÄ±m arasÄ± min sÃ¼re
    private float nextStepAvailableTime = 0f;

    private AudioSource src;
    private Vector3 lastPosition;
    private float accumulatedDistance = 0f;
    private float lastStepTime = 0f;
    private int lastClipIndex = -1;

    void Awake()
    {
        src = GetComponent<AudioSource>();
        src.playOnAwake = false;
        src.spatialBlend = 0f; // 2D sound

        lastPosition = transform.position;
    }

    void Update()
    {
        if (mode == Mode.AnimationEvents)
        {
            lastPosition = transform.position;
            return;
        }

        if (footstepClips == null || footstepClips.Length == 0) return;
        if (Time.timeScale == 0f) return; // oyun durduysa ses yok

        Vector3 currentPos = transform.position;
        float frameDistance = Vector3.Distance(currentPos, lastPosition);
        lastPosition = currentPos;

        float speed = frameDistance / Mathf.Max(Time.deltaTime, 0.0001f);

        if (speed < minMovementSpeed)
        {
            accumulatedDistance = 0f;
            return;
        }

        accumulatedDistance += frameDistance;

        float targetStepDist = speed >= runThreshold ? runStepDistance : walkStepDistance;

        if (accumulatedDistance >= targetStepDist)
        {
            PlayStep();
            accumulatedDistance -= targetStepDist; // stable rhythm
        }
    }

    // Animation event iÃ§in
    public void AnimationFootstep()
    {
        if (mode == Mode.AnimationEvents)
            PlayStep();
    }

    private void PlayStep()
{
    // Ses uzunluÄŸu bitene kadar bekle
    if (Time.time < nextStepAvailableTime) return;

    // Debounce
    if (Time.time - lastStepTime < minStepGap) return;
    lastStepTime = Time.time;

    int idx = PickClipIndex();
    float len = footstepClips[idx].length;

    src.pitch = Random.Range(minPitch, maxPitch);
    src.PlayOneShot(footstepClips[idx], volume);

    // Ses sÃ¼resi boyunca yeni adÄ±m engelli
    nextStepAvailableTime = Time.time + len;
}

    private int PickClipIndex()
    {
        if (footstepClips.Length == 1) return 0;

        int i;
        do { i = Random.Range(0, footstepClips.Length); }
        while (i == lastClipIndex);
        lastClipIndex = i;

        return i;
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using System.Collections.Generic;

public class PlayerCollector : MonoBehaviour
{
    public float collectRange = 1.5f;
    private List<Resource> highlightedResources = new List<Resource>();

    void Update()
    {
        // Ã–nceki vurgularÄ± kaldÄ±r
        foreach (var res in highlightedResources)
        {
            if (res != null)
                res.Highlight(false);
        }
        highlightedResources.Clear();

        // Yeni yakÄ±ndaki kaynaklarÄ± bul
        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, collectRange);
        foreach (var hit in hits)
        {
            Resource res = hit.GetComponent<Resource>();
            if (res != null)
            {
                res.Highlight(true);
                highlightedResources.Add(res);
            }
        }

        // E tuÅŸu ile toplama
        if (Keyboard.current.eKey.wasPressedThisFrame)
        {
            Debug.Log("E tuÅŸuna basÄ±ldÄ±!");
            foreach (var res in highlightedResources)
            {
                if (res != null)
                {
                    res.Collect();
                    break;
                }
            }
        }
    }
}
using UnityEngine;
using UnityEngine.UI;

public class PlayerHealthUI : MonoBehaviour
{
    public Image fillImage;
    public PlayerStats playerStats;

    void Start()
    {
        if (playerStats != null)
        {
            playerStats.onHealthChanged += UpdateHealthBar;
        }
    }

    void OnDestroy()
    {
        if (playerStats != null)
        {
            playerStats.onHealthChanged -= UpdateHealthBar;
        }
    }

    void UpdateHealthBar(int current, int max)
    {
        fillImage.fillAmount = Mathf.Clamp01((float)current / max);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class PlayerMovement : MonoBehaviour
{
    [Header("Movement")]
    public float moveSpeed = 5f;
    public float sprintMultiplier = 1.7f; // KoÅŸarken hÄ±z artÄ±ÅŸÄ±
    private bool isSprinting = false;

    // --- BileÅŸen ReferanslarÄ± ---
    private Rigidbody2D rb;
    private PlayerStats stats;
    private Animator animator;
    private Camera mainCamera;

    // --- Input System ---
    private PlayerControls controls;
    private Vector2 moveInput;

    // --- Ek Ã–zellikler ---
    public static float FacingDirection { get; private set; } = 1f;
    public float soundRadius = 5f;

    private void Awake()
    {
        rb = GetComponent<Rigidbody2D>();
        animator = GetComponent<Animator>();
        controls = new PlayerControls();
        stats = GetComponent<PlayerStats>();
        mainCamera = Camera.main;
    }

    private void OnEnable()
    {
        controls.Gameplay.Move.performed += OnMovePerformed;
        controls.Gameplay.Move.canceled += OnMoveCanceled;
        controls.Gameplay.Sprint.performed += ctx => isSprinting = true;
        controls.Gameplay.Sprint.canceled += ctx => isSprinting = false;
        controls.Gameplay.Enable();
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

    private void OnMovePerformed(InputAction.CallbackContext context)
    {
        moveInput = context.ReadValue<Vector2>();
    }

    private void OnMoveCanceled(InputAction.CallbackContext context)
    {
        moveInput = Vector2.zero;
    }

    public void EmitFootstep()
    {
        SoundEmitter.EmitSound(transform.position, soundRadius);
    }

    private void FixedUpdate()
{
    float currentSpeed = moveSpeed;
    bool isMoving = moveInput.magnitude > 0.1f;

    // PlayerStats'a koÅŸu/yÃ¼rÃ¼me bilgisini HER FRAME gÃ¶nder
    stats.SetMovementState(isMoving, isSprinting);

    if (isSprinting && stats.HasStamina() && isMoving)
        currentSpeed *= sprintMultiplier;
    else
        isSprinting = false;

    Vector2 moveDelta = moveInput * currentSpeed * Time.fixedDeltaTime;
    rb.MovePosition(rb.position + moveDelta);
}


    void Update()
    {
        if (GameStateManager.IsGamePaused) return;

        UpdateRotationAndAnimation();

    }



    // --- 360Â° Fareye DÃ¶nÃ¼k Animasyon ve Rotasyon ---
    private void UpdateRotationAndAnimation()
    {
        if (animator == null || mainCamera == null) return;

        // ğŸ§­ Fare konumunu al ve yÃ¶nÃ¼ hesapla
        Vector2 mouseScreenPos = Mouse.current.position.ReadValue();
        Vector3 mouseWorldPos = mainCamera.ScreenToWorldPoint(mouseScreenPos);
        Vector2 aimDirection = (mouseWorldPos - transform.position).normalized;

        // ğŸŒ€ Karakteri fareye Ã§evir (360Â°)
        float angle = Mathf.Atan2(aimDirection.y, aimDirection.x) * Mathf.Rad2Deg;
        transform.rotation = Quaternion.Euler(0f, 0f, angle - 90f); // Sprite yukarÄ± bakÄ±yorsa -90f uygundur

        // ğŸ Animasyon durumu
        bool isMoving = moveInput.magnitude > 0.1f;
        animator.SetBool("IsMoving", isMoving);

        // ğŸ” FacingDirection flip kontrolÃ¼ (silah veya atÄ±ÅŸ yÃ¶nÃ¼ iÃ§in)
        FacingDirection = aimDirection.x >= 0 ? 1f : -1f;
    }
}
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.InputSystem;
using TMPro;
using UnityEngine.UI;

public class PlayerStats : MonoBehaviour
{
    // ------------------------------
    //   STAMINA (AÃ§lÄ±ÄŸa BaÄŸlÄ±)
    // ------------------------------
    [Header("Stamina AyarlarÄ±")]
    public float maxStamina = 100f;            // ARTIK: maxHunger ile eÅŸitlenecek
    [SerializeField] private float currentStamina;
    public float staminaDrainRate = 15f;       // koÅŸarken azalÄ±r
    public float staminaRegenIdle = 18f;       // dururken artar

    private bool isRunning = false;            // Movement scriptinden baÄŸlanacak (setter fonk ekledim)
    private bool isMoving = false;

    public float GetStamina() => currentStamina;
    public float GetMaxStamina() => maxStamina;

    public void ModifyStamina(float amount)
    {
        currentStamina = Mathf.Clamp(currentStamina + amount, 0, maxStamina);
        UpdateStaminaUI();
    }

    public void ResetStamina() => currentStamina = maxStamina;
    public bool HasStamina() => currentStamina > 0;

    [Header("AÃ§lÄ±k KoÅŸu Ã‡arpanÄ±")]
    public float runningHungerMultiplier = 1.5f; // koÅŸarken aÃ§lÄ±k 2 hÄ±zlÄ± azalÄ±r
    [Header("Stamina UI")]
    public Slider staminaSlider;




    // ------------------------------
    //            SAÄLIK
    // ------------------------------
    [Header("SaÄŸlÄ±k")]
    public int maxHealth = 100;
    public int currentHealth;
    public float damageCooldown = 0.5f;
    private float lastDamageTime = -999f;

    public delegate void OnDeath();
    public event OnDeath onDeath;

    [Header("UI")]
    [SerializeField] private PlayerHealthUI healthUI;
    public delegate void OnHealthChanged(int current, int max);
    public event OnHealthChanged onHealthChanged;


    // ------------------------------
    //     HAREKET / ENVANTER
    // ------------------------------
    [Header("Hareket/Envanter")]
    public float moveSpeed = 5f;
    public int gold = 10;


    // ------------------------------
    //            AÃ‡LIK
    // ------------------------------
    [Header("AÃ§lÄ±k")]
    public int maxHunger = 100;
    public int currentHunger;
    public float hungerDecreaseInterval = 5f;
    public int hungerDecreaseAmount = 1;
    private float hungerTimer;

    [Header("AÃ§lÄ±k UI")]
    public TextMeshProUGUI hungerText;

    public int hungerOnRawMeatUse = 10;
    public int hungerOnCookedMeatUse = 30;
    public int hungerOnHerbUse = 0;


    // ------------------------------
    //   AÃ‡LIK â†’ SAÄLIK/YORGUNLUK
    // ------------------------------
    [Header("AÃ§lÄ±k BazlÄ± SaÄŸlÄ±k Sistemi")]
    public float highHungerThresholdPercent = 0.70f;   // %70 Ã¼stÃ¼ can yeniler
    public float lowHungerThresholdPercent = 0.10f;    // %10 altÄ± can dÃ¼ÅŸer

    public float healthRegenRate = 1f;         // saniyede +1
    public float healthRegenInterval = 1f;
    private float healthRegenTimer;

    private float starvationTickInterval = 1.5f;   // aÃ§lÄ±k bitince can azalmasÄ±
    private float starvationTimer;



    // ------------------------------
    //        SES
    // ------------------------------
    [Header("Ses")]
    public AudioClip hurtClip;
    private AudioSource audioSource;


    // ------------------------------
    // ITEM REFERANSLARI
    // ------------------------------
    [Header("Item References")]
    public ItemData cookedMeatSO;
    public ItemData rawMeatSO;
    public ItemData herbSO;
    public float staminaRegenWalk = 8f;



    void Awake()
    {
        audioSource = GetComponent<AudioSource>();
        if (audioSource == null)
            audioSource = gameObject.AddComponent<AudioSource>();

        AudioManager.Instance?.RouteToSFX(audioSource);
    }

    void Start()
    {
        currentHunger = maxHunger;
        hungerTimer = hungerDecreaseInterval;

        currentStamina = maxHunger;      // baÅŸlangÄ±Ã§ta max stamina = aÃ§lÄ±k
        maxStamina = maxHunger;

        currentHealth = maxHealth;
        onHealthChanged?.Invoke(currentHealth, maxHealth);

        if (staminaSlider != null)
{
    staminaSlider.maxValue = maxStamina;
    staminaSlider.value = currentStamina;
}

    }

    void Update()
    {
        HandleHungerSystem();
        UpdateStaminaByHunger();
        UpdateStaminaRegen();
        UpdateHealthByHunger();
        

        if (Keyboard.current != null && Keyboard.current.fKey.wasPressedThisFrame)
            TryConsumeFood();

        UpdateHungerUI();
        UpdateStaminaUI();

    }

    private void UpdateStaminaUI()
{
    if (staminaSlider == null) return;

    // Full ise gizle
    if (currentStamina >= maxStamina)
    {
        staminaSlider.gameObject.SetActive(false);
    }
    else
    {
        staminaSlider.gameObject.SetActive(true);
        staminaSlider.maxValue = maxStamina;
        staminaSlider.value = currentStamina;
    }
}




    // ============================================================
    //                 HUNGER SYSTEM
    // ============================================================

    void HandleHungerSystem()
{
    float interval = hungerDecreaseInterval;

    // KoÅŸuyorsa aÃ§lÄ±k daha hÄ±zlÄ± azalÄ±r
    if (isRunning)
        interval /= runningHungerMultiplier;

    hungerTimer -= Time.deltaTime;

    if (hungerTimer <= 0f)
    {
        currentHunger = Mathf.Max(0, currentHunger - hungerDecreaseAmount);
        hungerTimer = interval;
    }
}




    // ============================================================
    //     MAX STAMINA = CURRENT HUNGER  (PEAK SISTEMI)
    // ============================================================

    void UpdateStaminaByHunger()
    {
        maxStamina = currentHunger;

        // currentStamina fazla kaldÄ±ysa otomatik dÃ¼ÅŸÃ¼r
        if (currentStamina > maxStamina)
            currentStamina = maxStamina;
    }



    // ============================================================
    //       STAMINA REGEN RATE = HUNGER LEVEL
    // ============================================================

    void UpdateStaminaRegen()
{
    float hungerPercent = (float)currentHunger / maxHunger;

    // AÃ§lÄ±k â†’ regen katsayÄ±sÄ±
    float hungerMult;
    if (hungerPercent >= 0.70f)
        hungerMult = 1.5f;   // tok â†’ hÄ±zlÄ± regen
    else if (hungerPercent >= 0.40f)
        hungerMult = 1f;     // normal
    else if (hungerPercent >= 0.20f)
        hungerMult = 0.5f;   // yorgun
    else
        hungerMult = 0.2f;   // bitkin

    // KOÅARKEN â†’ sadece STAMINA AZALIR
    if (isRunning && isMoving)
    {
        ModifyStamina(-staminaDrainRate * Time.deltaTime);
        return;
    }

    // YÃœRÃœRKEN â†’ az regen
    if (isMoving)
    {
        float regen = staminaRegenWalk * hungerMult;
        ModifyStamina(regen * Time.deltaTime);
    }
    // HÄ°Ã‡ HAREKET ETMEZKEN â†’ daha fazla regen
    else
    {
        float regen = staminaRegenIdle * hungerMult;
        ModifyStamina(regen * Time.deltaTime);
    }
}




    // ============================================================
    //       HEALTH = HUNGER STATE
    // ============================================================

    void UpdateHealthByHunger()
    {
        if (currentHealth <= 0) return;

        float hungerPercent = (float)currentHunger / maxHunger;

        // Tok â†’ Can yenilenir
        if (hungerPercent >= highHungerThresholdPercent)
        {
            healthRegenTimer += Time.deltaTime;

            if (healthRegenTimer >= healthRegenInterval && currentHealth < maxHealth)
            {
                Heal(Mathf.RoundToInt(healthRegenRate));
                healthRegenTimer = 0f;
            }

            return;
        }


        // Ã‡ok aÃ§ â†’ Can dÃ¼ÅŸer
        if (hungerPercent <= lowHungerThresholdPercent)
        {
            starvationTimer += Time.deltaTime;

            if (starvationTimer >= starvationTickInterval)
            {
                TakeDamage(1);
                starvationTimer = 0f;
            }
        }
        else
        {
            starvationTimer = 0f; // gÃ¼venli reset
        }
    }




    // ============================================================
    //                   FOOD CONSUME
    // ============================================================

    private void TryConsumeFood()
    {
        if (Inventory.Instance.HasEnough(cookedMeatSO, 1))
        {
            Inventory.Instance.TryConsume(cookedMeatSO, 1);
            GainHunger(hungerOnCookedMeatUse);
            return;
        }

        if (Inventory.Instance.HasEnough(rawMeatSO, 1))
        {
            Inventory.Instance.TryConsume(rawMeatSO, 1);
            GainHunger(hungerOnRawMeatUse);
            return;
        }

        if (Inventory.Instance.HasEnough(herbSO, 1))
        {
            Inventory.Instance.TryConsume(herbSO, 1);
            GainHunger(hungerOnHerbUse);
            return;
        }
    }

    private void GainHunger(int amount)
    {
        if (amount > 0)
            currentHunger = Mathf.Clamp(currentHunger + amount, 0, maxHunger);
    }



    // ============================================================
    //                      UI UPDATE
    // ============================================================

    void UpdateHungerUI()
    {
        if (hungerText == null) return;

        hungerText.text = $"AÃ§lÄ±k: {currentHunger}/{maxHunger}";

        if (currentHunger > 60) hungerText.color = Color.green;
        else if (currentHunger > 30) hungerText.color = Color.yellow;
        else hungerText.color = Color.red;
    }


    // ============================================================
    //          SAÄLIK FONKSÄ°YONLARI
    // ============================================================

    public bool IsAlive() => currentHealth > 0;

    public void TakeDamage(int amount)
    {
        if (!IsAlive()) return;
        if (Time.time - lastDamageTime < damageCooldown) return;

        lastDamageTime = Time.time;
        currentHealth = Mathf.Max(0, currentHealth - amount);

        onHealthChanged?.Invoke(currentHealth, maxHealth);

        if (hurtClip != null)
            audioSource?.PlayOneShot(hurtClip);

        if (currentHealth <= 0)
            Die();

        DamagePopupManager.Instance?.SpawnPopup(transform.position, amount);
    }

    public void Heal(int amount)
    {
        if (!IsAlive() || amount <= 0) return;
        currentHealth = Mathf.Min(maxHealth, currentHealth + amount);
        onHealthChanged?.Invoke(currentHealth, maxHealth);
    }

    private void Die()
    {
        Debug.Log("ğŸ’€ Player died");
        onDeath?.Invoke();
    }


    // ============================================================
    //      DÄ±ÅŸ Scriptlerden Hareket Bilgisi Alma
    // ============================================================

    public void SetMovementState(bool moving, bool running)
    {
        isMoving = moving;
        isRunning = running;
    }


    public void RefreshHealthUI()
    {
        onHealthChanged?.Invoke(currentHealth, maxHealth);
    }

}
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.Rendering.Universal;

[RequireComponent(typeof(AudioSource))]
public class PlayerWeapon : MonoBehaviour
{
    // References
    private GameObject currentModel;
    private AudioSource audioSource;
    private Animator animator;

    private WeaponSlotManager slotManager;

    [Header("Weapon Configuration")]
    public WeaponData weaponData;

    [Header("Components")]
    public Transform firePoint;
    public GameObject bulletPrefab;
    public LayerMask enemyLayer;

    [Header("Muzzle Flash")]
    public Light2D muzzleFlash;
    public float muzzleFlashDuration = 0.05f;
    public float muzzleFlashIntensity = 3f;
    private Coroutine muzzleFlashCo;

    [Header("Audio")]
    public AudioClip shootSound;
    public AudioClip reloadSound;
    public AudioClip emptyClipSound;

    // Input System
    private PlayerControls controls;

    // State
    private bool isReloading = false;
    private bool isAiming = false;

    private float lastAutoFireTime = 0f;

    // NEW MAGAZINE SYSTEM
    public MagazineItem currentMagazine;                 // Takılı şarjör
    public List<MagazineItem> inventoryMags = new();     // Yedek şarjörler

    // Reload Hold Detection
    private float reloadPressTime;
    public float reloadHoldThreshold = 0.4f;

    private void Awake()
    {
        audioSource = GetComponent<AudioSource>();
        animator = GetComponentInChildren<Animator>();

        controls = new PlayerControls();

        if (muzzleFlash != null)
            muzzleFlash.enabled = false;
    }

    private void Start()
    {
        slotManager = WeaponSlotManager.Instance;

        if (slotManager != null)
            LoadFromSlot(slotManager.activeSlotIndex);
        else
            Debug.LogError("[PlayerWeapon] Slot Manager null!");
    }

    // ============================
    // INPUT SYSTEM ONENABLE / OFF
    // ============================
    private void OnEnable()
    {
        controls.Gameplay.Enable();

        // Slot Switching
        controls.Gameplay.Weapon1.performed += ctx => SwitchToSlot(0);
        controls.Gameplay.Weapon2.performed += ctx => SwitchToSlot(1);
        controls.Gameplay.Weapon3.performed += ctx => SwitchToSlot(2);

        // ADS
        controls.Gameplay.ADS.started += ctx => StartADS();
        controls.Gameplay.ADS.canceled += ctx => StopADS();

        // Reload Hold Detection
        controls.Gameplay.Reload.started += ctx =>
        {
            reloadPressTime = Time.time;
        };

        controls.Gameplay.Reload.canceled += ctx =>
        {
            float held = Time.time - reloadPressTime;

            if (held >= reloadHoldThreshold)
                StartCoroutine(MagCheck());
            else
                StartCoroutine(ReloadRoutine());
        };
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

    private void SwitchToSlot(int slot)
    {
        WeaponSlotManager.Instance.SwitchSlot(slot);
    }

    // ============================
    // SHOOT (NEW INPUT SYSTEM)
    // ============================

    private void HandleShootStart()
    {

        if (!weaponData.isAutomatic)
            Shoot();
    }


    private void Update()
{
    if (PauseMenu.IsPaused || weaponData == null || isReloading)
        return;

    // 🔫 Tekli atış (semi-auto)
    if (!weaponData.isAutomatic)
    {
        if (Input.GetMouseButtonDown(0))
            Shoot();
    }

    // 🔥 Otomatik atış (auto)
    if (weaponData.isAutomatic)
    {
        if (Input.GetMouseButton(0))
            AutoFire();
    }
}


    private void AutoFire()
    {
        float fireDelay = 1f / weaponData.fireRate;

        if (Time.time - lastAutoFireTime >= fireDelay)
        {
            lastAutoFireTime = Time.time;
            Shoot();
        }
    }

    // ============================
    // ACTUAL SHOOT LOGIC
    // ============================
    public void Shoot()
    {
        if (isReloading) return;

        if (currentMagazine == null || currentMagazine.currentAmmo <= 0)
        {
            PlayEmptyClipSound();
            Debug.Log("Boş! Ateş yok.");
            return;
        }

        currentMagazine.currentAmmo--;

        RangedAttack();
        Debug.Log($"Ateş edildi! Şarjör: {currentMagazine.currentAmmo}/{currentMagazine.capacity}");
    }

    private void RangedAttack()
    {
        if (shootSound != null)
            audioSource.PlayOneShot(shootSound);

        animator?.SetTrigger("Shoot");

        if (weaponData.isShotgun)
            FireShotgunPellets();
        else
            FireSingleBullet();

        TryMuzzleFlash();
    }

    private void FireSingleBullet()
    {
        var bullet = Instantiate(bulletPrefab, firePoint.position, firePoint.rotation);

        if (bullet.TryGetComponent(out WeaponBullet b))
        {
            b.damage = weaponData.damage;
            b.owner = transform;
            b.weaponType = weaponData.weaponType;
            b.knockbackForce = weaponData.knockbackForce;
            b.knockbackDuration = weaponData.knockbackDuration;
        }
    }

    private void FireShotgunPellets()
    {
        int pellets = Mathf.Max(weaponData.pelletsPerShot, 1);
        float spread = weaponData.pelletSpreadAngle;

        for (int i = 0; i < pellets; i++)
        {
            float t = pellets == 1 ? 0f : (float)i / (pellets - 1);
            float angle = Mathf.Lerp(-spread, spread, t);
            Quaternion rot = firePoint.rotation * Quaternion.Euler(0, 0, angle);

            var bullet = Instantiate(bulletPrefab, firePoint.position, rot);

            if (bullet.TryGetComponent(out WeaponBullet b))
            {
                b.damage = weaponData.damage;
                b.owner = transform;
                b.weaponType = weaponData.weaponType;
                b.knockbackForce = weaponData.knockbackForce;
                b.knockbackDuration = weaponData.knockbackDuration;
            }
        }
    }

    // ============================
    // ADS
    // ============================
    private void StartADS()
    {
        isAiming = true;
        animator?.SetBool("ADS", true);
    }

    private void StopADS()
    {
        isAiming = false;
        animator?.SetBool("ADS", false);
    }

    // ============================
    // RELOAD (SHORT OR LONG HOLD)
    // ============================
    private IEnumerator ReloadRoutine()
    {
        if (isReloading) yield break;

        if (inventoryMags.Count == 0)
        {
            Debug.Log("Yedek şarjör yok.");
            yield break;
        }

        isReloading = true;

        audioSource.PlayOneShot(reloadSound);
        yield return new WaitForSeconds(weaponData.reloadTime);

        // Eski şarjörü geri koy
        if (currentMagazine != null)
            inventoryMags.Add(currentMagazine);

        // En dolu şarjörü bul
        var nextMag = inventoryMags.OrderByDescending(m => m.currentAmmo).FirstOrDefault();
        if (nextMag == null)
        {
            Debug.Log("Takılabilir şarjör yok!");
            isReloading = false;
            yield break;
        }

        inventoryMags.Remove(nextMag);
        currentMagazine = nextMag;

        Debug.Log($"Yeni şarjör → {currentMagazine.currentAmmo}/{currentMagazine.capacity}");

        isReloading = false;
    }

    // ============================
    // MAGAZINE CHECK (HOLD R)
    // ============================
    IEnumerator MagCheck()
    {
        if (currentMagazine == null)
        {
            Debug.Log("Şarjör takılı değil.");
            yield break;
        }

        yield return new WaitForSeconds(0.3f);

        float ratio = (float)currentMagazine.currentAmmo / currentMagazine.capacity;

        if (ratio == 1f) Debug.Log("Tam dolu.");
        else if (ratio >= 0.7f) Debug.Log("Neredeyse dolu.");
        else if (ratio >= 0.4f) Debug.Log("Yarısı dolu.");
        else if (ratio > 0) Debug.Log("Az mermi kaldı.");
        else Debug.Log("Tamamen boş.");
    }

    // ============================
    // MUZZLE FLASH
    // ============================
    private void TryMuzzleFlash()
    {
        if (muzzleFlash == null) return;

        muzzleFlash.transform.position = firePoint.position;

        if (muzzleFlashCo != null)
            StopCoroutine(muzzleFlashCo);

        muzzleFlashCo = StartCoroutine(MuzzleFlashRoutine());
    }

    private IEnumerator MuzzleFlashRoutine()
    {
        float original = muzzleFlash.intensity;
        muzzleFlash.enabled = true;
        muzzleFlash.intensity = muzzleFlashIntensity;

        yield return new WaitForSeconds(muzzleFlashDuration);

        muzzleFlash.intensity = original;
        muzzleFlash.enabled = false;
    }

    public void PlayEmptyClipSound()
    {
        if (emptyClipSound != null)
            audioSource.PlayOneShot(emptyClipSound);
    }

    // ============================
    // SLOT / WEAPON LOAD
    // ============================
    public void LoadFromSlot(int slot)
    {
        var data = slotManager.GetEquippedWeapon(slot);
        if (data == null) return;

        weaponData = data;
        lastAutoFireTime = 0f;
        isReloading = false;

        if (currentModel != null)
            Destroy(currentModel);

        if (weaponData.prefab != null)
        {
            currentModel = Instantiate(weaponData.prefab, transform);
            Transform fp = currentModel.transform.Find("FirePoint");
            if (fp != null)
                firePoint = fp;
        }
    }

    public void SetWeapon(WeaponData data)
{
    if (data == null)
        return;

    weaponData = data;

    // Mevcut modeli sil
    if (currentModel != null)
        Destroy(currentModel);

    // Yeni modeli oluştur
    if (weaponData.prefab != null)
    {
        currentModel = Instantiate(weaponData.prefab, transform);
        currentModel.transform.localPosition = Vector3.zero;
        currentModel.transform.localRotation = Quaternion.identity;

        // FirePoint'i bul
        Transform fp = currentModel.transform.Find("FirePoint");
        if (fp != null)
            firePoint = fp;
    }

    // Şarjör sistemini sıfırla
    currentMagazine = null;
    inventoryMags.Clear();

    Debug.Log($"[PlayerWeapon] Yeni silah takıldı → {weaponData.name}. Şarjörler sıfırlandı.");
}

}
using UnityEngine;

public class BandagePickup : MonoBehaviour
{
    public GenericItemData bandageSO;
    public int amount = 1;

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player"))
            return;

        PlayerStats stats = other.GetComponent<PlayerStats>();
        if (stats == null)
            return;

        Debug.Log("ğŸ©¹ Bandaj toplandÄ± +" + amount);

        // Envantere ekle
        Inventory.Instance.TryAdd(bandageSO, amount);


        // Prefab'Ä± yok et
        Destroy(gameObject);
    }
}
using UnityEngine;

public class BlueprintPickup : MonoBehaviour
{
    [Header("Blueprint Item")]
    public ItemData blueprintSO;   // âœ… ArtÄ±k string id yerine direkt ItemData

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            if (blueprintSO != null)
            {
                Inventory.Instance.TryAdd(blueprintSO, 1);
                Debug.Log($"ğŸ“œ Blueprint eklendi: {blueprintSO.itemName}");
            }
            else
            {
                Debug.LogError("[BlueprintPickup] blueprintSO atanmadÄ±!");
            }

            Destroy(gameObject);
        }
    }
}
using UnityEngine;

public class GoldPickup : MonoBehaviour
{
    public int amount = 1;

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            PlayerStats stats = other.GetComponent<PlayerStats>();
            if (stats != null)
            {
                stats.gold += amount;
                Debug.Log($"ğŸ’° AltÄ±n alÄ±ndÄ±! Yeni bakiye: {stats.gold}");
            }

            Destroy(gameObject);
        }
    }
}
using UnityEngine;

public class Resource : MonoBehaviour
{

    public ItemData itemData;       // Yeni sistemdeki ScriptableObject

    [Header("Resource Settings")]
    public ResourceType type;
    public int amount = 1;

    [Header("Collection Mechanics")]
    [Tooltip("Bu kaynaÄŸÄ± toplamak iÃ§in kaÃ§ kez 'E'ye basÄ±lmasÄ± gerekiyor.")]
    public int hitsRequired = 3;

    [Tooltip("Ä°ki 'E' basÄ±ÅŸÄ± arasÄ±ndaki minimum bekleme sÃ¼resi (saniye).")]
    public float hitCooldown = 1.0f;

    // --- AMMO PICKUP AYARLARI ---
    [Header("Ammo Pickup")]
    [Tooltip("Mermiyi aktif silaha mÄ± ekleyelim? (false ise hedef slota ekler)")]
    public bool ammoToActiveSlot = true;

    [Tooltip("aktif deÄŸilse, bu slota ekle")]
    public int ammoTargetSlotIndex = 0;

    [Tooltip("MiktarÄ± 'maxAmmoCapacity' yÃ¼zdesi olarak mÄ± hesaplayalÄ±m?")]
    public bool ammoAmountAsPercentOfMax = true;

    [Range(0f, 1f)] public float ammoPercentOfMax = 0.25f; // Ã¶rn. %25
    public int ammoFixedAmount = 12;                      // yÃ¼zdelik kapalÄ±ysa sabit ek
    [Tooltip("Rezerv mermiyi weaponData.maxAmmoCapacity Ã¼stÃ¼ne taÅŸmayacak ÅŸekilde sÄ±nÄ±rla")]
    public bool clampToMaxCapacity = true;


    // --- Sistem DeÄŸiÅŸkenleri ---
    private int currentHits = 0;
    private bool canBeHit = true; // Cooldown kontrolÃ¼ iÃ§in

    public Sprite normalSprite;
    public Sprite highlightedSprite;
    private SpriteRenderer sr;

    void Start()
    {
        sr = GetComponent<SpriteRenderer>();
        if (sr != null && normalSprite != null)
            sr.sprite = normalSprite;
    }


    public void Collect()
{
    if (itemData == null)
    {
        Debug.LogError($"[Resource] itemData null! '{gameObject.name}' Ã¼zerinde itemData atanmamÄ±ÅŸ.");
        return;
    }

    if (Inventory.Instance == null)
    {
        Debug.LogError("[Resource] Inventory.Instance bulunamadÄ±.");
        return;
    }

    // Item'Ä± envantere ekle
    Inventory.Instance.TryAdd(itemData, amount);

    // Eski PlayerInventory sistemine baÄŸlÄ± satÄ±r SÄ°LÄ°NDÄ°
    // Ã‡Ã¼nkÃ¼ yeni sistemde gerek yok.

    Destroy(gameObject);
}


    public void HitResource()
    {
        // EÄŸer bekleme sÃ¼resi aktifse, hiÃ§bir ÅŸey yapma.
        if (!canBeHit)
        {
            Debug.Log("BEKLE! Ã‡ok hÄ±zlÄ± basÄ±yorsun.");
            return;
        }

        currentHits++;
        Debug.Log($"{type} vuruldu! ({currentHits} / {hitsRequired})");

        // Ä°steÄŸe baÄŸlÄ±: Her vuruÅŸta bir ses Ã§al veya gÃ¶rsel efekt gÃ¶ster.
        // EffectManager.Instance.PlayHitEffect(transform.position);

        // Yeterli vuruÅŸ sayÄ±sÄ±na ulaÅŸÄ±ldÄ± mÄ±?
        if (currentHits >= hitsRequired)
        {
            Collect();
        }
        else
        {
            // HenÃ¼z toplanmadÄ±ysa, bekleme sÃ¼resini baÅŸlat.
            StartCoroutine(HitCooldown());
        }
    }

    private System.Collections.IEnumerator HitCooldown()
    {
        canBeHit = false;
        yield return new WaitForSeconds(hitCooldown);
        canBeHit = true;
    }

    public void Highlight(bool state)
    {
        if (sr == null) sr = GetComponent<SpriteRenderer>();

        if (state && highlightedSprite != null)
            sr.sprite = highlightedSprite;
        else if (normalSprite != null)
            sr.sprite = normalSprite;
    }


}
using UnityEngine;

public class ResourceSpawner : MonoBehaviour
{
    public GameObject stonePrefab;
    public GameObject woodPrefab;
    public GameObject scrapMetalPrefab;

    public int stoneCount = 5;
    public int woodCount = 3;
    public int scrapMetalCount = 2;

    public Vector2 spawnAreaMin = new Vector2(-10, -5);
    public Vector2 spawnAreaMax = new Vector2(10, 5);

    private Transform resourceParent;

    void Start()
    {
        // Resources adlÄ± GameObject'i bul
        GameObject container = GameObject.Find("Resources(Silme)");
        if (container != null)
        {
            resourceParent = container.transform;
        }
        else
        {
            Debug.LogWarning("Resources GameObject bulunamadÄ±! KÃ¶k objeye ekleniyor.");
        }

        SpawnResources(stonePrefab, stoneCount);
        SpawnResources(woodPrefab, woodCount);
        SpawnResources(scrapMetalPrefab, scrapMetalCount);
    }

    void SpawnResources(GameObject prefab, int count)
    {
        for (int i = 0; i < count; i++)
        {
            Vector2 randomPos = new Vector2(
                Random.Range(spawnAreaMin.x, spawnAreaMax.x),
                Random.Range(spawnAreaMin.y, spawnAreaMax.y)
            );

            // Parent olarak Resources objesini ata
            GameObject spawned = Instantiate(prefab, randomPos, Quaternion.identity);
            if (resourceParent != null)
                spawned.transform.parent = resourceParent;
        }
    }
    public void RegenerateResources(float ratio)
    {
        int newStones = Mathf.RoundToInt(stoneCount * ratio);
        int newWoods = Mathf.RoundToInt(woodCount * ratio);
        int newMeteors = Mathf.RoundToInt(scrapMetalCount * ratio);

        SpawnResources(stonePrefab, newStones);
        SpawnResources(woodPrefab, newWoods);
        SpawnResources(scrapMetalPrefab, newMeteors);
    }

}
public enum ResourceType
{
    Stone,
    Wood,
    scrapMetal,
    Meat,
    DeerHide,
    RabbitHide,
    CookedMeat,
    AmmoMachineGun,
    AmmoPistol,
    AmmoShotgun,
    AmmoSniper,
    Spear,
    Herb,
    Ammo,
    Blueprint,
    Molotov,
    Bandage// âœ… yeni eklenen

}
using UnityEngine;

public class ScrapPile : MonoBehaviour
{
    public GameObject[] partPrefabs; // Inspector'a ekleyeceğiz

    public void OnCollected()
    {
        if (Random.value < 0.2f)
        {
            int index = Random.Range(0, partPrefabs.Length);
            Instantiate(partPrefabs[index], transform.position + Vector3.up * 0.5f, Quaternion.identity);
            Debug.Log("🔧 Silah parçası düştü!");
        }

        Destroy(gameObject);
    }
}
using System;
using System.Collections.Generic;  // ğŸ”´ EKLE
using UnityEngine;    

[System.Serializable]
public class CaravanSaveData
{
    public List<WeaponSaveEntry> weaponEntries = new();
}

[System.Serializable]
public class WeaponSaveEntry
{
    public WeaponType type;
    public List<string> weaponIDs;
}
using UnityEngine;

public class GameInitializer : MonoBehaviour
{
    [Header("Referanslar")]
    public Transform player;       // Player Transform
    public ItemRegistry registry;  // TÃ¼m item SO'larÄ±
    public Inventory inventory;    // Player Ã¼zerindeki Inventory
    public PlayerStats stats;      // PlayerStats

    [Header("Yeni Oyun Spawn NoktasÄ±")]
    public Transform defaultSpawnPoint;   // Inspectorâ€™dan bir boÅŸ obje ver (spawn noktasÄ±)
    public Vector3 fallbackSpawnPosition; // Ä°stersen elle de girebilirsin

    private void Awake()
    {
        if (registry != null && registry.items != null && registry.items.Length > 0)
        {
            ItemDatabase.RegisterAll(registry.items);
        }
        else
        {
            Debug.LogError("ItemDatabase boooÅŸ! registry veya registry.items atanmadÄ±!");
        }

    }

    private void Start()
{
    Debug.Log("GameInitializer: ShouldLoad = " + SaveBootstrap.ShouldLoadFromSave);
    Debug.Log("GameInitializer: HasSave = " + SaveSystem.HasSave());

    // 1) Save yÃ¼kleme...
    if (SaveBootstrap.ShouldLoadFromSave && SaveSystem.HasSave())
    {
        SaveSystem.LoadPlayerAndInventory(player, inventory, stats);
        SaveBootstrap.ShouldLoadFromSave = false;
        return;
    }

    // 2) Yeni oyun â†’ default spawn
    Vector3 spawnPos = player.position;

    if (defaultSpawnPoint != null)
        spawnPos = defaultSpawnPoint.position;
    else if (fallbackSpawnPosition != Vector3.zero)
        spawnPos = fallbackSpawnPosition;

    player.position = spawnPos;


    // 3) BAÅLANGIÃ‡ PÄ°STOL
    ItemData pistolItem = ItemDatabase.Get("weapon_pistol");
    if (pistolItem != null)
    {
        WeaponSlotManager.Instance.EquipWeapon(pistolItem);
        Debug.Log("â–¶ Yeni oyun â†’ BaÅŸlangÄ±Ã§ silahÄ± verildi: Pistol");
    }


   
    // Aktif slot pistol olsun
    WeaponSlotManager.Instance.activeSlotIndex = 0;
}


}
    public static class SaveBootstrap
{
    public static bool ShouldLoadFromSave = false;
}
using System.Collections.Generic;

[System.Serializable]
public class SaveData
{
    public float posX, posY, posZ;

    public int currentHealth;
    public int maxHealth;

    public float currentStamina;
    public float maxStamina;

    public int currentHunger;
    public int maxHunger;

    public int gold;

    public List<InventoryItemData> inventory = new();
    public List<string> unlockedWeaponIDs = new();

    public string[] equippedWeaponIDs = new string[3];
    public int[] slotClip = new int[3];
    public int[] slotReserve = new int[3];
    public int activeSlotIndex;

    // ğŸ”¥ Karavan silahlarÄ±
    public CaravanSaveData caravanSave;
}

[System.Serializable]
public class InventoryItemData
{
    public string itemID;
    public int amount;
}
using System.IO;
using UnityEngine;
using System.Collections.Generic;

public static class SaveSystem
{
    private static string savePath = Path.Combine(Application.persistentDataPath, "save.json");

    public static bool HasSave() => File.Exists(savePath);

    public static void DeleteSave()
    {
        if (HasSave())
            File.Delete(savePath);
    }

    // ============================================================
    //                          SAVE
    // ============================================================

    public static void SavePlayerAndInventory(
        Transform player,
        Inventory inventory,
        PlayerStats stats)
    {
        if (player == null || inventory == null || stats == null)
        {
            Debug.LogWarning("SavePlayerAndInventory: Eksik referans!");
            return;
        }

        SaveData data = new SaveData();

        // ---- Pozisyon ----
        data.posX = player.position.x;
        data.posY = player.position.y;
        data.posZ = player.position.z;

        // ---- Statlar ----
        data.currentHealth = stats.currentHealth;
        data.maxHealth = stats.maxHealth;

        data.currentStamina = stats.GetStamina();
        data.maxStamina = stats.GetMaxStamina();

        data.currentHunger = stats.currentHunger;
        data.maxHunger = stats.maxHunger;

        data.gold = stats.gold;

        // ---- Envanter ----
        data.inventory.Clear();
        foreach (var slot in inventory.slots)
        {
            if (slot.data == null) continue;

            var saved = new InventoryItemData
            {
                itemID = slot.data.itemID,
                amount = slot.count
            };

            data.inventory.Add(saved);
        }

        // ---- Craft ile aÃ§Ä±lmÄ±ÅŸ silahlar ----
        data.unlockedWeaponIDs.Clear();
        if (CraftingSystem.Instance != null)
        {
            foreach (var id in CraftingSystem.Instance.unlockedWeapons)
                data.unlockedWeaponIDs.Add(id);
        }

        // ---- Ekipman Silah SlotlarÄ± (WeaponSlotManager) ----
        WeaponSlotManager wsm = WeaponSlotManager.Instance;
        if (wsm != null)
        {
            for (int i = 0; i < 3; i++)
            {
                WeaponData wd = wsm.slots[i];

                if (wd != null)
                    data.equippedWeaponIDs[i] = wd.itemID;
                else
                    data.equippedWeaponIDs[i] = "";

                var ammo = wsm.GetAmmo(i);
                data.slotClip[i] = ammo.clip;
                data.slotReserve[i] = ammo.reserve;
            }

            data.activeSlotIndex = wsm.activeSlotIndex;
        }

        // ---- Karavan Envanteri ----
        if (CaravanInventory.Instance != null)
            data.caravanSave = CaravanInventory.Instance.GetSaveData();

        // ---- JSON Yaz ----
        string json = JsonUtility.ToJson(data, true);
        File.WriteAllText(savePath, json);

        Debug.Log("ğŸ’¾ SAVE â†’ TÃ¼m veriler kaydedildi.");
    }

    // ============================================================
    //                          LOAD
    // ============================================================

    public static void LoadPlayerAndInventory(
        Transform player,
        Inventory inventory,
        PlayerStats stats)
    {
        if (player == null || inventory == null || stats == null)
        {
            Debug.LogWarning("LoadPlayerAndInventory: Eksik referans!");
            return;
        }

        if (!HasSave())
        {
            Debug.LogWarning("LoadPlayerAndInventory: KayÄ±t bulunamadÄ±.");
            return;
        }

        string json = File.ReadAllText(savePath);
        SaveData data = JsonUtility.FromJson<SaveData>(json);

        // ---- Pozisyon ----
        Vector3 loadedPos = new Vector3(data.posX, data.posY, data.posZ);
        if (loadedPos.y < 1f) loadedPos.y = 1f;  // yere gÃ¶mÃ¼lme Ã¶nlemi
        player.position = loadedPos;

        // ---- Statlar ----
        stats.maxHealth = data.maxHealth;
        stats.currentHealth = data.currentHealth;
        stats.RefreshHealthUI();

        stats.maxStamina = data.maxStamina;
        stats.ResetStamina();
        stats.ModifyStamina(data.currentStamina - stats.GetStamina());

        stats.maxHunger = data.maxHunger;
        stats.currentHunger = data.currentHunger;

        stats.gold = data.gold;

        // ---- Envanter ----
        inventory.ClearInventory();
        foreach (var item in data.inventory)
        {
            if (string.IsNullOrEmpty(item.itemID) || item.amount <= 0) continue;

            ItemData so = ItemDatabase.Get(item.itemID);
            if (so == null) continue;

            inventory.TryAdd(so, item.amount);
        }

        // ---- Craft ile aÃ§Ä±lmÄ±ÅŸ silahlar ----
        if (CraftingSystem.Instance != null)
        {
            CraftingSystem.Instance.unlockedWeapons.Clear();
            foreach (var id in data.unlockedWeaponIDs)
                CraftingSystem.Instance.unlockedWeapons.Add(id);
        }

        // ---- WeaponSlotManager yÃ¼kleme ----
        WeaponSlotManager wsm = WeaponSlotManager.Instance;
        if (wsm != null)
        {
            for (int i = 0; i < 3; i++)
            {
                string id = data.equippedWeaponIDs[i];

                if (!string.IsNullOrEmpty(id))
                {
                    ItemData so = ItemDatabase.Get(id);
                    if (so is WeaponItemData wid)
                    {
                        wsm.slots[i] = wid.weaponData;
                        wsm.clip[i] = data.slotClip[i];
                        wsm.reserve[i] = data.slotReserve[i];
                    }
                    else
                    {
                        wsm.slots[i] = null;
                        wsm.clip[i] = 0;
                        wsm.reserve[i] = 0;
                    }
                }
                else
                {
                    wsm.slots[i] = null;
                    wsm.clip[i] = 0;
                    wsm.reserve[i] = 0;
                }
            }

            // Aktif slotu uygula
            wsm.activeSlotIndex = Mathf.Clamp(data.activeSlotIndex, 0, 2);
            wsm.SwitchSlot(wsm.activeSlotIndex);
        }

        // ---- Karavan YÃ¼kleme ----
        if (data.caravanSave != null && CaravanInventory.Instance != null)
        {
            CaravanInventory.Instance.LoadFromData(data.caravanSave);
        }

        Debug.Log("ğŸ“¥ LOAD â†’ TÃ¼m veriler geri yÃ¼klendi.");
    }
}
using System;

[Serializable]
public class WeaponSlotSaveData
{
    public string[] equippedWeaponIDs = new string[3];
    public int[] clip = new int[3];
    public int[] reserve = new int[3];
    public int activeSlotIndex;
}
using UnityEngine;
using TMPro;

public class NoteTrigger : MonoBehaviour
{
    public GameObject notePanel;
    public TextMeshProUGUI noteTextUI;
    public AudioSource audioSource;

    private bool isPlayerNearby = false;
    private StoryNote currentNote;
    private int currentIndex = 0; // sÄ±rayla ya da rastgele

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            currentNote = GetComponent<StoryNote>();
            isPlayerNearby = true;

            if (notePanel != null && currentNote != null && currentNote.noteTexts.Length > 0)
            {
                notePanel.SetActive(true);

                // Ä°stersen sÄ±rayla:
                string text = currentNote.noteTexts[currentIndex];
                noteTextUI.text = text;

                if (currentNote.radioClips != null && currentNote.radioClips.Length > currentIndex && audioSource != null)
                {
                    audioSource.clip = currentNote.radioClips[currentIndex];
                    audioSource.Play();
                }

                // sÄ±radakine geÃ§ (loop)
                currentIndex = (currentIndex + 1) % currentNote.noteTexts.Length;
            }
        }
    }

    void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            notePanel.SetActive(false);
            if (audioSource != null) audioSource.Stop();
        }
    }
}
using UnityEngine;

public class StoryNote : MonoBehaviour
{
    [TextArea]
    public string[] noteTexts;   // Birden fazla metin
    public AudioClip[] radioClips; // Her metne karÅŸÄ±lÄ±k ses (opsiyonel)
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class BuildSpot : MonoBehaviour
{
    [Header("Taret Seviyeleri")]
    public TurretLevelData[] levels;

    [Header("Ä°nÅŸa UI")]
    public float buildTime = 2f;
    public Slider progressBar;
    public GameObject progressCanvas;

    private bool isPlayerNearby = false;
    private float holdTimer = 0f;
    private bool isBuilding = false;

    private int currentLevel = 0;
    private GameObject currentTurret;

    private PlayerStats playerStats;

    private void Start()
    {
        if (progressCanvas != null)
            progressCanvas.SetActive(false);

        GameObject player = GameObject.FindWithTag("Player");
        if (player != null)
            playerStats = player.GetComponent<PlayerStats>();
    }

    void Update()
    {
        if (!isPlayerNearby || playerStats == null) return;

        if (Keyboard.current.eKey.isPressed)
        {
            if (currentLevel >= levels.Length)
            {
                Debug.Log("âš ï¸ Zaten maksimum seviyede.");
                return;
            }

            if (!HasEnoughResources())
            {
                Debug.Log("ğŸš« Yetersiz kaynak!");
                return;
            }

            if (!isBuilding)
            {
                isBuilding = true;
                if (progressCanvas != null)
                    progressCanvas.SetActive(true);
            }

            holdTimer += Time.deltaTime;
            if (progressBar != null)
                progressBar.value = holdTimer / buildTime;

            if (holdTimer >= buildTime)
                BuildOrUpgradeTurret();
        }
        else if (isBuilding)
        {
            ResetBuild();
        }
    }

    void BuildOrUpgradeTurret()
{
    if (currentLevel >= levels.Length) return;
    TurretLevelData levelData = levels[currentLevel];

    // Kaynak dÃ¼ÅŸÃ¼r
    if (!Inventory.Instance.TryConsume(levelData.stoneSO, levelData.requiredStone) ||
        !Inventory.Instance.TryConsume(levelData.woodSO, levelData.requiredWood))
    {
        Debug.Log("ğŸš« Kaynak eksik!");
        return;
    }

    if (currentTurret != null)
        Destroy(currentTurret);

    Vector3 spawnPos = new Vector3(transform.position.x, transform.position.y, -1f);
    currentTurret = Instantiate(levelData.prefab, spawnPos, Quaternion.identity);
    currentLevel++;

    ResetBuild();
    Debug.Log($"âœ… Kule seviyesi {currentLevel} oldu!");
}


    void ResetBuild()
    {
        isBuilding = false;
        holdTimer = 0f;

        if (progressBar != null)
            progressBar.value = 0f;

        if (progressCanvas != null)
            progressCanvas.SetActive(false);
    }

    void OnTriggerEnter2D(Collider2D collision)
    {
        if (collision.CompareTag("Player"))
            isPlayerNearby = true;
    }

    void OnTriggerExit2D(Collider2D collision)
    {
        if (collision.CompareTag("Player"))
        {
            isPlayerNearby = false;
            ResetBuild();
        }
    }

    bool HasEnoughResources()
{
    if (currentLevel >= levels.Length || playerStats == null) return false;

    TurretLevelData levelData = levels[currentLevel];

    bool hasResources =
        Inventory.Instance.HasEnough(levelData.stoneSO, levelData.requiredStone) &&
        Inventory.Instance.HasEnough(levelData.woodSO, levelData.requiredWood);

    // EÄŸer blueprint sistemi Inventoryâ€™ye baÄŸlandÄ±ysa:
    bool hasBlueprint = string.IsNullOrEmpty(levelData.requiredBlueprintId)
        || Inventory.Instance.HasBlueprint(levelData.requiredBlueprintId);

    if (!hasBlueprint)
        Debug.Log($"ğŸš« Gerekli taslak yok: {levelData.requiredBlueprintId}");

    return hasResources && hasBlueprint;
}


}
using UnityEngine;

public class Turret : MonoBehaviour
{
    public float attackRange = 5f;
    public float fireRate = 1f;
    public GameObject bulletPrefab;
    public float bulletSpeed = 10f;

    private float fireTimer = 0f;

    void Update()
    {
        fireTimer -= Time.deltaTime;

        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, attackRange);
        foreach (var hit in hits)
        {
            Enemy enemy = hit.GetComponent<Enemy>();
            if (enemy != null && fireTimer <= 0)
            {
                Shoot(enemy.transform.position);
                fireTimer = 1f / fireRate;
                break; // Ä°lk dÃ¼ÅŸmanÄ± vur, Ã§Ä±k
            }
        }
    }

void Shoot(Vector3 targetPosition)
{
    Vector3 direction = (targetPosition - transform.position).normalized;

    // YÃ¶n doÄŸrultusunda bir rotasyon hesapla (X yÃ¶nÃ¼ne gÃ¶re dÃ¶ndÃ¼r)
    float angle = Mathf.Atan2(direction.y, direction.x) * Mathf.Rad2Deg;
    Quaternion rotation = Quaternion.Euler(0, 0, angle); // â¬…ï¸ sadece bu Ã¶nemli

    // Mermiyi doÄŸru rotasyonla oluÅŸtur
    GameObject bullet = Instantiate(bulletPrefab, transform.position, rotation);
}




    void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.red;
        Gizmos.DrawWireSphere(transform.position, attackRange);
    }
}
using UnityEngine;

[RequireComponent(typeof(Rigidbody2D))]
public class TurretBullet : MonoBehaviour
{
    public float speed = 15f;
    public int damage = 5;

    private Rigidbody2D rb;

    void Awake()
    {
        rb = GetComponent<Rigidbody2D>();
    }

    void Start()
    {
        // Mermiyi yÃ¶nÃ¼ne gÃ¶re fÄ±rlat
        rb.linearVelocity = transform.right * speed;

        // 3 saniye sonra yok olsun
        Destroy(gameObject, 3f);
    }

    private void OnTriggerEnter2D(Collider2D collision)
    {
        // Oyuncuya veya baÅŸka mermiye Ã§arpmasÄ±n
        if (collision.CompareTag("Player") || collision.CompareTag("Bullet"))
            return;

        Enemy enemy = collision.GetComponent<Enemy>();
        if (enemy != null)
        {
            enemy.TakeDamage(damage);
        }

        Destroy(gameObject);
    }
}
using UnityEngine;

[System.Serializable]
public class TurretLevelData
{
    public GameObject prefab;
    public int requiredStone;
    public int requiredWood;
    public string requiredBlueprintId;
     [Header("Sample Items")]
    public ItemData stoneSO;
    public ItemData woodSO;



}
using UnityEngine;
using System.Collections;

public class BurnZone : MonoBehaviour
{
    public int damagePerSecond = 5;
    public float duration = 5f;

    private float tickTimer;

private void OnTriggerStay2D(Collider2D other)
{
    if (other.CompareTag("Enemy"))
    {
        tickTimer += Time.deltaTime;
        if (tickTimer >= 1f)
        {
            tickTimer = 0f;
            Enemy enemy = other.GetComponent<Enemy>();
            if (enemy != null)
                enemy.TakeDamage(damagePerSecond);
        }
    }
}

}
using System.Collections;
using UnityEngine;

public class MolotovProjectile : MonoBehaviour
{
    [Header("Explosion Settings")]
    public GameObject fireEffectPrefab;
    public float explosionRadius = 2.5f;
    public int impactDamage = 20;
    public int burnDamagePerSecond = 5;
    public float fireDuration = 5f;

    private bool hasExploded = false;

   private void OnTriggerEnter2D(Collider2D other)
{
    Debug.Log($"ğŸ”¥ Trigger tetiklendi: {other.name} (Layer: {LayerMask.LayerToName(other.gameObject.layer)})");

    if (hasExploded) return;

    // ğŸ’¡ Sadece zemine Ã§arpÄ±nca patla
    if (other.gameObject.layer == LayerMask.NameToLayer("GroundTrigger"))
    {
        hasExploded = true;
        Debug.Log("ğŸ’¥ Molotov yere Ã§arptÄ±, patlÄ±yor!");
        Explode();
    }
    else
    {
        // DiÄŸer layer'lar (Animal, Build vs.) tamamen gÃ¶rmezden gel
        Debug.Log($"â­ {other.name} yoksayÄ±ldÄ± (Layer: {LayerMask.LayerToName(other.gameObject.layer)})");
    }
}



    private void Explode()
    {
        Debug.Log("ğŸ’¥ Molotov yere Ã§arptÄ±, patlÄ±yor!");

        // ğŸ”¥ 1. Fire effect oluÅŸtur
        if (fireEffectPrefab != null)
        {
            GameObject fire = Instantiate(fireEffectPrefab, transform.position, Quaternion.identity);
            Destroy(fire, fireDuration);
            Debug.Log("ğŸ”¥ Fire effect oluÅŸturuldu!");
        }

        // ğŸ’¢ 2. Ä°lk patlama hasarÄ±
        ApplyDamage(impactDamage);

        // ğŸ”¥ 3. Yanma alanÄ± oluÅŸtur
        StartCoroutine(CreateBurnZone());

        // ğŸ§¨ 4. Molotov objesini sahneden kaldÄ±r (gÃ¶rÃ¼nmez yap)
        GetComponent<SpriteRenderer>().enabled = false;
        GetComponent<Collider2D>().enabled = false;
        GetComponent<Rigidbody2D>().isKinematic = true;
    }

private void ApplyDamage(int damage)
{
    Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, explosionRadius);
    foreach (var hit in hits)
    {
        if (hit.CompareTag("Enemy"))
        {
            Enemy enemy = hit.GetComponent<Enemy>();
            if (enemy != null)
            {
                enemy.TakeDamage(damage);
                Debug.Log($"ğŸ’¥ Patlama hasarÄ±: {damage} verildi -> {enemy.name}");
            }
        }
    }
}

    private IEnumerator CreateBurnZone()
    {
        Debug.Log("ğŸ”¥ Yanma alanÄ± oluÅŸturuldu!");
        float elapsed = 0f;

        // GeÃ§ici alan objesi oluÅŸtur
        GameObject burnZone = new GameObject("BurnZone");
        burnZone.transform.position = transform.position;
        CircleCollider2D col = burnZone.AddComponent<CircleCollider2D>();
        col.isTrigger = true;
        col.radius = explosionRadius;

        // 2D rigidbody (Trigger Ã§alÄ±ÅŸmasÄ± iÃ§in ÅŸart)
        Rigidbody2D rb = burnZone.AddComponent<Rigidbody2D>();
        rb.isKinematic = true;

        // Hasar scriptâ€™i ekle
        BurnZone zone = burnZone.AddComponent<BurnZone>();
        zone.damagePerSecond = burnDamagePerSecond;
        zone.duration = fireDuration;

        // Fire bitince alanÄ± kaldÄ±r
        Destroy(burnZone, fireDuration);

        yield return null;
    }


    private IEnumerator BurnDamageOverTime()
    {
        float elapsed = 0f;
        while (elapsed < fireDuration)
        {
            Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, explosionRadius);
            foreach (var hit in hits)
            {
                if (hit.CompareTag("Enemy"))
                {
                    var enemy = hit.GetComponent<Enemy>();
                    if (enemy != null) enemy.TakeDamage(burnDamagePerSecond);
                }
            }
            yield return new WaitForSeconds(1f);
            elapsed += 1f;
        }
    }
}
using System.Collections;
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;


public class MolotovThrower : MonoBehaviour
{
    [Header("Molotov Settings")]
    public GameObject molotovPrefab;
    public Transform throwPoint;
    public float maxThrowForce = 12f;
    public float minThrowForce = 4f;
    public float chargeSpeed = 4f;
    public float cooldown = 1.5f;

    private float currentForce;
    private bool isCharging;
    private float chargeStartTime;
    private float lastThrowTime;

    private bool justEnabled;

    [Header("UI")]
    public Slider chargeBar; // ÅŸarj dolum gÃ¶stergesi


    private void Start()
    {
        if (chargeBar == null)
        {
            chargeBar = GameObject.FindObjectOfType<Slider>(true);
            if (chargeBar != null)
                Debug.Log("âœ… ChargeBar sahnede otomatik bulundu!");
            else
                Debug.LogWarning("âš ï¸ ChargeBar sahnede bulunamadÄ±!");
        }
    }

    void Awake()
    {
        AutoWireThrowPoint();
    }

    void Update()
    {

        if (justEnabled)
        {
            // ğŸ”’ Bu frame'de hiÃ§bir input iÅŸleme
            justEnabled = false;
            return;
        }



        // --- FÄ±rlatma kilidi: cooldown bitmeden atÄ±ÅŸ olmasÄ±n
        if (Time.time < lastThrowTime + cooldown)
            return;

        // --- BasÄ±lÄ± tutma sÃ¼resine gÃ¶re ÅŸarj et
        if (Mouse.current.leftButton.wasPressedThisFrame)
        {
            isCharging = true;
            chargeStartTime = Time.time;
            currentForce = minThrowForce;
            Debug.Log("ğŸ”¥ Molotov ÅŸarj ediliyor...");

            if (chargeBar != null)
            {
                chargeBar.gameObject.SetActive(true);
                chargeBar.value = 0f;
            }
        }

        if (isCharging && Mouse.current.leftButton.isPressed)
        {
            float elapsed = Time.time - chargeStartTime;
            float t = Mathf.Clamp01(elapsed / 3f); // 3 saniyede tam ÅŸarj
            currentForce = Mathf.Lerp(minThrowForce, maxThrowForce, t);

            // ğŸ”¹ Bar'Ä± gÃ¼ncelle
            if (chargeBar != null)
                chargeBar.value = t;
        }

        // --- Mouse bÄ±rakÄ±ldÄ±ÄŸÄ±nda fÄ±rlat
        if (isCharging && Mouse.current.leftButton.wasReleasedThisFrame)
        {
            ThrowMolotov();
            isCharging = false;

            if (chargeBar != null)
            {
                chargeBar.value = 0f;
                chargeBar.gameObject.SetActive(false);
            }
        }

    }

    void OnEnable()
    {
        justEnabled = true; // aktif edildiÄŸi frame
    }




    private void AutoWireThrowPoint()
    {
        if (throwPoint != null) return;

        // Ã–nce playerâ€™Ä±n FirePointâ€™ini bul
        var playerWeapon = GetComponentInParent<PlayerWeapon>();
        if (playerWeapon != null && playerWeapon.firePoint != null)
        {
            throwPoint = playerWeapon.firePoint;
            Debug.Log($"MolotovThrower â†’ FirePoint otomatik atandÄ±: {throwPoint.name}");
            return;
        }

        // Sahne iÃ§inde â€œFirePointâ€ isminde bir child varsa onu kullan
        var found = transform.Find("FirePoint");
        if (found != null)
        {
            throwPoint = found;
            Debug.Log($"MolotovThrower â†’ FirePoint bulundu: {throwPoint.name}");
        }
    }

    // MolotovThrower.cs - deÄŸiÅŸiklikler
    private void ThrowMolotov()
    {
        if (molotovPrefab == null || throwPoint == null)
        {
            Debug.LogWarning("âš ï¸ MolotovPrefab veya ThrowPoint atanmadÄ±!");
            return;
        }

        Vector3 mouseWorldPos = Camera.main.ScreenToWorldPoint(Mouse.current.position.ReadValue());
        Vector2 direction = (mouseWorldPos - throwPoint.position).normalized;

        Vector3 spawnPos = throwPoint.position + (Vector3)direction * 0.5f;
        GameObject molotov = Instantiate(molotovPrefab, spawnPos, Quaternion.identity);

        Debug.Log($"ğŸ§¨ Molotov oluÅŸturuldu: {molotov.name} @ {spawnPos}");

        Rigidbody2D rb = molotov.GetComponent<Rigidbody2D>();
        if (rb != null)
        {
            rb.gravityScale = 1f;
            rb.AddForce(direction * currentForce, ForceMode2D.Impulse);
            Debug.Log($"ğŸ’£ Kuvvet uygulandÄ±: {direction * currentForce}");
        }
        else
        {
            Debug.LogWarning("âš ï¸ Rigidbody2D bulunamadÄ±!");
        }

        lastThrowTime = Time.time;

    }




}
using UnityEngine;

public class MolotovWeapon : PlayerWeapon
{
    [Header("Molotov Settings")]
    public GameObject molotovProjectilePrefab;
    public Transform throwPoint;
    public float throwForce = 10f;

    public void Shoot()
    {
        if (molotovProjectilePrefab == null || throwPoint == null)
            return;

        GameObject molotov = Instantiate(molotovProjectilePrefab, throwPoint.position, throwPoint.rotation);
        Rigidbody2D rb = molotov.GetComponent<Rigidbody2D>();
        if (rb != null)
            rb.AddForce(throwPoint.up * throwForce, ForceMode2D.Impulse);

        Debug.Log("Molotov fÄ±rlatÄ±ldÄ±!");

        // DayanÄ±klÄ±lÄ±k gideri
        base.Shoot();
    }
}
using UnityEngine;

[System.Serializable]
public class PartRequirement
{
    public PartItemData partType;
    public int amount = 1;
}
// RequirementLineUI.cs (TEK TEXT'LÄ° VERSÄ°YON)

using UnityEngine;
using TMPro;

public class RequirementLineUI : MonoBehaviour
{
    // ArtÄ±k sadece tek bir text elemanÄ±na ihtiyacÄ±mÄ±z var.
    public TextMeshProUGUI requirementText;

    // Bu fonksiyon, satÄ±rÄ± doÄŸru bilgilerle doldurur ve renklendirir.
    public void Setup(string name, int currentAmount, int requiredAmount)
    {
        if (requirementText == null) return;

        // Yeterli malzememiz var mÄ±?
        bool hasEnough = (currentAmount >= requiredAmount);

        // Metnin rengini belirle.
        // Yeterliyse yeÅŸil, deÄŸilse kÄ±rmÄ±zÄ±.
        // ColorUtility.ToHtmlStringRGB ile renk kodlarÄ±nÄ± string iÃ§ine gÃ¶mebiliriz.
        string colorHex = hasEnough ? "green" : "red";

        // BiÃ§imlendirilmiÅŸ metni oluÅŸtur: "Barrel: <color=red>0 / 3</color>"
        requirementText.text = $"{name}: <color={colorHex}>{currentAmount} / {requiredAmount}</color>";
    }
}
using UnityEngine;

public class UIController : MonoBehaviour
{
    public static UIController Instance;
    public GameObject craftMessage;

    void Awake()
    {
        if (Instance == null) Instance = this;
        else Destroy(gameObject);
    }

    public void ShowCraftMessage()
    {
        if (craftMessage != null)
            craftMessage.SetActive(true);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.Rendering.Universal;

public class WeaponAim : MonoBehaviour
{
    [Header("Components")]
    [Tooltip("SilahÄ±n ve altÄ±ndaki her ÅŸeyin dÃ¶neceÄŸi ana pivot. Genellikle silahÄ±n kendisidir.")]
    public Transform weaponPivot;

    [Tooltip("Bu silaha ait Light 2D objesi.")]
    public Light2D flashlight;

    [Tooltip("Merminin Ã§Ä±kacaÄŸÄ± namlu ucu transformu.")]
    public Transform firePoint;

    private SpriteRenderer weaponSpriteRenderer;

    // FirePoint'in baÅŸlangÄ±Ã§ lokal pozisyonu
    private Vector3 firePointDefaultLocalPos;

    private void Awake()
    {
        if (weaponPivot != null)
            weaponSpriteRenderer = weaponPivot.GetComponentInChildren<SpriteRenderer>();

        if (firePoint != null)
            firePointDefaultLocalPos = firePoint.localPosition; // Ã¶rn: (0.05, 0.01, 0)
    }

    private void OnDisable()
    {
        if (flashlight != null) flashlight.gameObject.SetActive(false);
    }

    private void OnEnable()
    {
        if (flashlight != null) flashlight.gameObject.SetActive(true);
    }

    private void LateUpdate()
    {
        if (GameStateManager.IsGamePaused ||GameStateManager.IsGameOver) return;
        if (Camera.main == null || weaponPivot == null) return;

        // Fare hedefi
        Vector3 mousePosition = Mouse.current.position.ReadValue();
        Vector3 worldPosition = Camera.main.ScreenToWorldPoint(mousePosition);
        Vector3 aimDirection = (worldPosition - weaponPivot.position).normalized;
        float angle = Mathf.Atan2(aimDirection.y, aimDirection.x) * Mathf.Rad2Deg;

        // SilahÄ± dÃ¶ndÃ¼r
        weaponPivot.rotation = Quaternion.Euler(0f, 0f, angle);

        // Sprite flip (senin mantÄ±ÄŸÄ±n)
        float facingDirection = PlayerMovement.FacingDirection;
        bool flip = (facingDirection < 0);

        if (weaponSpriteRenderer != null)
        {
            // Hem X hem Y flip
            weaponSpriteRenderer.flipX = flip;
            weaponSpriteRenderer.flipY = flip;
        }

        // Fener yÃ¶nÃ¼
        if (flashlight != null)
            flashlight.transform.rotation = Quaternion.Euler(0f, 0f, angle - 90f);

        // FirePoint pozisyonu ve yÃ¶nÃ¼
        if (firePoint != null)
        {
            // Hem X hem Y iÅŸaretini facing'e gÃ¶re deÄŸiÅŸtir
            float sx = flip ? -1f : 1f;
            float sy = flip ? -1f : 1f;

            firePoint.localPosition = new Vector3(
                firePointDefaultLocalPos.x * sx,
                firePointDefaultLocalPos.y * sy,
                firePointDefaultLocalPos.z
            );

            // Rotasyonu pivot'tan miras alsÄ±n
            firePoint.localRotation = Quaternion.identity;
        }
    }
}
using UnityEngine;

[RequireComponent(typeof(Rigidbody2D))]
public class WeaponBullet : MonoBehaviour
{
    [Header("Bullet Settings")]
    public float speed = 20f;
    public int damage = 10;
    private Rigidbody2D rb;

    [Header("References")]
    public Transform owner;            // PlayerWeapon atar
    public WeaponType weaponType;      // 📌 Hangi silah türünden atıldığı buraya atanacak

    [Header("Animal Scare")]
    public float fleeOnHitDuration = 3.5f;
    public float fleeOnHitMultiplier = 2.2f;

     [Header("Knockback (applied always)")]
    public float knockbackForce = 6f;      // atanacak kuvvet (bullet'e atanır)
    public float knockbackDuration = 0.18f; // kuvvet uygulanma süresi

     private int enemiesHit = 0;
    private const int maxPenetration = 2; // 2 düşmandan sonra yok olur

    void Awake()
    {
        rb = GetComponent<Rigidbody2D>();
    }

    void Start()
    {
        rb.linearVelocity = transform.right * speed;
        Destroy(gameObject, 3f);
    }

    private void OnTriggerEnter2D(Collider2D collision)
    {
        if (collision.CompareTag("Player") || collision.CompareTag("Bullet")) return;

        // 🎯 Düşmana çarptıysa hasar ver ve knockback kontrolü yap
         Enemy enemy = collision.GetComponent<Enemy>();
        if (enemy != null)
        {
            enemiesHit++;

            int appliedDamage = damage;
            if (weaponType == WeaponType.Sniper && enemiesHit > 1)
                appliedDamage = Mathf.RoundToInt(damage * 0.5f); // ikinci hedefe yarı hasar

            enemy.TakeDamage(appliedDamage);

            // Knockback uygula (her zaman)
            if (weaponType == WeaponType.Shotgun || weaponType == WeaponType.Sniper)
            {
                Vector2 sourcePos = transform.position;
                enemy.ApplyKnockback(sourcePos, knockbackForce, knockbackDuration);
            }

            // 🔹 Eğer sniper mermisi 2 düşmana çarpmışsa yok ol
            if (weaponType == WeaponType.Sniper && enemiesHit >= maxPenetration)
            {
                Destroy(gameObject);
                return;
            }
            // 🔹 Diğer silahlar hemen yok olur
            else if (weaponType != WeaponType.Sniper)
            {
                Destroy(gameObject);
                return;
            }
        }

        // 🐺 Hayvanlara korku efekti
        Animal animal = collision.GetComponent<Animal>();
        if (animal != null)
        {
            Vector2 threatPos = (owner != null) ? (Vector2)owner.position : (Vector2)transform.position;
            animal.Scare(threatPos, fleeOnHitDuration, fleeOnHitMultiplier);
            animal.TakeDamage(damage);
        }

        if (!collision.isTrigger)
        Destroy(gameObject);
    }
}
using System;
using System.Collections.Generic;
using UnityEngine;

[CreateAssetMenu(fileName = "New Weapon Craft Recipe", menuName = "Crafting/Weapon Craft Recipe")]
public class WeaponCraftRecipe : ScriptableObject
{
    [Header("Ãœretilecek Silah")]
    public WeaponData resultWeapon;

    [Header("Craft AÃ§Ä±klamasÄ± (Opsiyonel)")]
    [TextArea]
    public string description;

    [Header("Gerekli Kaynaklar")]
    public List<ResourceCost> costs = new List<ResourceCost>();
}

[Serializable]
public class ResourceCost
{
    public ItemData item;
    public int amount = 1;
}
using UnityEngine;

[CreateAssetMenu(fileName = "New Weapon Data", menuName = "Weapons/Weapon Data")]
public class WeaponData : ItemData
{
    public GameObject prefab;
    public WeaponType weaponType;

    public float knockbackForce = 6f;
    public float knockbackDuration = 0.18f;

    public bool isAutomatic;
    public float fireRate = 2f;
    public int damage;

    public int clipSize;
    public int maxAmmoCapacity;
    public float reloadTime = 1.5f;

    public float attackRange = 1.5f;

    public bool isShotgun = false;
    public int pelletsPerShot = 3;
    public float pelletSpreadAngle = 8f;
    public float shotgunCooldown = 2.5f;

    public bool isSniper = false;
    public float sniperCooldown = 3.0f;
    public int sniperPenetrationCount = 2;

    public ResourceType ammoType;

    public bool isMolotov;
    public GameObject fireEffectPrefab;
    public float explosionRadius = 2.5f;
    public int burnDamage = 1;
    public float burnDuration = 5f;
    public float tickInterval = 1f;
}
using UnityEngine;

public class WeaponDataHolder : MonoBehaviour
{
    public WeaponData weaponData;
}
using UnityEngine;

public class WeaponHolder : MonoBehaviour
{
    public WeaponData weaponData;
}
// WeaponInventory.cs (DÜZELTİLMİŞ VE DOĞRU HALİ)

using UnityEngine;
using UnityEngine.UI;
using System.Collections.Generic;

public class WeaponInventory : MonoBehaviour
{
    // Bu referans artık doğrudan silahları yönetmek için değil,
    // yeni silahın verilerini merkezi ateş etme sistemine bildirmek için kullanılacak.
    public PlayerWeapon playerWeapon;
    public GameObject[] weaponPrefabs; // 0: Makineli, 1: Tabanca, 2: Yakın dövüş
    public Transform weaponHolder; // Silahların oluşturulacağı yer (firePoint yerine bu daha mantıklı)

    // Aktif silah objelerini bu dizide tutacağız.
    private GameObject[] weaponInstances;
    private int currentSlot = 1; // Başlangıç slotu

    // ... (crafting ile ilgili değişkenleriniz aynı kalabilir) ...
    public Text craftHintText;
    private HashSet<string> collectedParts = new HashSet<string>();
    private string[] requiredParts = new string[] {
        "Barrel", "Magazine", "Foregrip", "Grip", "Trigger", "TriggerGuard"
    };

    void Start()
    {
        // weaponInstances dizisini başlat
        weaponInstances = new GameObject[weaponPrefabs.Length];
        EquipSlot(currentSlot);

        if (craftHintText != null)
            craftHintText.gameObject.SetActive(false);
    }

    void Update()
    {
        // ... (Update içeriğiniz aynı kalabilir) ...
        if (Input.GetKeyDown(KeyCode.Alpha1)) EquipSlot(0);
        if (Input.GetKeyDown(KeyCode.Alpha2)) EquipSlot(1);
        if (Input.GetKeyDown(KeyCode.Alpha3)) EquipSlot(2);

        if (Input.GetKeyDown(KeyCode.C) && HasAllParts())
        {
            CraftNewWeapon();
        }
    }

    private void EquipSlot(int slotIndex)
    {
        // Geçersiz slot veya zaten o slot seçiliyse işlem yapma
        if (slotIndex < 0 || slotIndex >= weaponPrefabs.Length || slotIndex == currentSlot) return;

        // 1. Mevcut aktif silahı yok et (eğer varsa)
        if (weaponInstances[currentSlot] != null)
        {
            Destroy(weaponInstances[currentSlot]);
        }

        // 2. Yeni silahın prefab'ını al ve oluştur
        GameObject weaponPrefabToInstantiate = weaponPrefabs[slotIndex];
        if (weaponPrefabToInstantiate == null)
        {
            Debug.LogError($"Slot {slotIndex} için silah prefab'ı atanmamış!");
            return;
        }

        // Yeni silahı weaponHolder'ın altında oluştur
        GameObject newWeaponInstance = Instantiate(weaponPrefabToInstantiate, weaponHolder.position, weaponHolder.rotation, weaponHolder);

        // 3. Oluşturulan yeni silahı dizide sakla
        weaponInstances[slotIndex] = newWeaponInstance;
        currentSlot = slotIndex; // Mevcut slotu güncelle

        // 4. Merkezi ateş etme sistemini (PlayerWeapon) yeni silahın verileriyle yapılandır.
        // Bu satır sizin kodunuzda vardı, çok doğru bir yaklaşım.
        WeaponDataHolder dataHolder = newWeaponInstance.GetComponent<WeaponDataHolder>();
        if (dataHolder != null && playerWeapon != null)
        {
            // PlayerWeapon'ın weaponData'sını yeni silahınkiyle değiştiriyoruz.
            playerWeapon.weaponData = dataHolder.weaponData;
            // Not: Mermi ve şarjör mekaniği için burada PlayerWeapon'daki mermi sayısını da güncellemeniz gerekecek.
            // Bu kısım WeaponSlotManager'daki mantığa benziyor.
        }
    }

    // ... (Crafting fonksiyonlarınız aynı kalabilir) ...
    public void CollectPart(string partName) { /* ... */ }
    private bool HasAllParts() { /* ... */ return true; }
    private void CraftNewWeapon() { /* ... */ }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Inventory/Weapon Item")]
public class WeaponItemData : ItemData
{
    [Header("Weapon Link")]
    public WeaponType weaponType;   // Pistol / Rifle / Melee
    public WeaponData weaponData;   // AteÅŸ etme davranÄ±ÅŸlarÄ±

    private void OnValidate()
    {
        category = ItemCategory.Weapon;
        stackable = false;
        maxStack = 1;
    }
}
using UnityEngine;

public class WeaponPart : MonoBehaviour
{
    public WeaponPartType partType;
}
public enum WeaponPartType
{
    Barrel,
    Magazine,
    Handguard,
    Grip,
    Trigger,
    TriggerGuard,
    Stone,
    Wood,
    ScrapMetal
}
using UnityEngine;

public enum WeaponSlotType
{
    Pistol = 0,
    Rifle = 1,
    Melee = 2
}

public class WeaponSlotManager : MonoBehaviour
{
    public static WeaponSlotManager Instance;

    [Header("Player Weapon Handlers")]
    public PlayerWeapon pistolHandler;
    public PlayerWeapon rifleHandler;
    public PlayerWeapon meleeHandler;

    [Header("Equipped Weapons (WeaponData)")]
    public WeaponData[] slots = new WeaponData[3];

    // Mermi durumu (clip + reserve)
    [Header("Ammo State per Slot")]
    public int[] clip = new int[3];
    public int[] reserve = new int[3];

    [Header("Active Slot")]
    public int activeSlotIndex = 0;



    void Awake()
    {
        if (Instance != null) { Destroy(gameObject); return; }
        Instance = this;

        // Mermileri 0 baÅŸlat
        for (int i = 0; i < 3; i++)
        {
            clip[i] = 0;
            reserve[i] = 0;
        }
    }



    // -------------------------------
    // Silah tipine gÃ¶re slot belirle
    // -------------------------------
    public WeaponSlotType GetSlotForWeapon(WeaponData weapon)
    {
        if (weapon == null)
            return WeaponSlotType.Rifle; // default

        switch (weapon.weaponType)
        {
            // TABANCA SLOTU (0)
            case WeaponType.Pistol:
                return WeaponSlotType.Pistol;

            // TÃœFEK / UZUN MENZÄ°L SLOTU (1)
            case WeaponType.MachineGun:
            case WeaponType.Shotgun:
            case WeaponType.Sniper:
            case WeaponType.Bow:
                return WeaponSlotType.Rifle;

            // YAKIN DÃ–VÃœÅ SLOTU (2)
            case WeaponType.ThrowingSpear:
            case WeaponType.MeeleSword:
                return WeaponSlotType.Melee;

            // TanÄ±nmayanlar varsayÄ±lan: tÃ¼fek slotu
            default:
                return WeaponSlotType.Rifle;
        }
    }


    // -------------------------------
    // Silah kuÅŸan
    // -------------------------------
    public void EquipWeapon(ItemData item)
    {
        WeaponItemData wid = item as WeaponItemData;
        if (wid == null)
        {
            Debug.LogError("EquipWeapon â†’ Bu item bir WeaponItemData deÄŸil!");
            return;
        }

        WeaponData weapon = wid.weaponData;
        if (weapon == null)
        {
            Debug.LogError("EquipWeapon â†’ WeaponItemData.weaponData boÅŸ!");
            return;
        }

        int slot = (int)GetSlotForWeapon(weapon);
        slots[slot] = weapon;

        clip[slot] = weapon.clipSize;
        reserve[slot] = weapon.maxAmmoCapacity;

        ApplyToHandler(slot);

        Debug.Log($"[WeaponSlotManager] {item.itemName} (WeaponData: {weapon.name}) slot {slot} iÃ§ine takÄ±ldÄ±.");
    }


    // -------------------------------
    // Aktif slota geÃ§iÅŸ
    // -------------------------------
    public void SwitchSlot(int newSlot)
    {
        if (newSlot < 0 || newSlot > 2) return;

        activeSlotIndex = newSlot;
        ApplyToHandler(newSlot);
    }

    // -------------------------------
    // PlayerWeapon'a silahÄ± aktar
    // -------------------------------
    private void ApplyToHandler(int slot)
{
    // TÃ¼m handlerâ€™larÄ± kapat
    pistolHandler.gameObject.SetActive(false);
    rifleHandler.gameObject.SetActive(false);
    meleeHandler.gameObject.SetActive(false);

    // Yeni handler
    PlayerWeapon handler = GetHandler(slot);
    if (handler == null)
    {
        Debug.LogError("Handler bulunamadÄ±! Slot: " + slot);
        return;
    }

    // Handlerâ€™Ä± aktif et
    handler.gameObject.SetActive(true);

    // SilahÄ± yÃ¼kle
    WeaponData weapon = slots[slot];
    if (weapon != null)
    {
        handler.SetWeapon(weapon);

        Debug.Log("Handler aÃ§Ä±ldÄ± ve silah verildi: " + weapon.name);
    }
    else
    {
        Debug.LogWarning("Slot boÅŸ ama handler aktif edildi: " + slot);
    }
}



    private PlayerWeapon GetHandler(int slot)
    {
        switch ((WeaponSlotType)slot)
        {
            case WeaponSlotType.Pistol: return pistolHandler;
            case WeaponSlotType.Rifle: return rifleHandler;
            case WeaponSlotType.Melee: return meleeHandler;
        }
        return null;
    }

    // -------------------------------
    // Ammo state
    // -------------------------------
    public (int clip, int reserve) GetAmmo(int slot)
    {
        return (clip[slot], reserve[slot]);
    }

    public void SetAmmo(int slot, int newClip, int newReserve)
    {
        clip[slot] = newClip;
        reserve[slot] = newReserve;

        // aktif slot ise PlayerWeaponâ€™Ä± gÃ¼ncelle
        if (slot == activeSlotIndex)
        {
            ApplyToHandler(slot);
        }
    }

    // -------------------------------
    // Save/Load iÃ§in Getter
    // -------------------------------
    public WeaponData GetEquippedWeapon(int slot)
    {
        return slots[slot];
    }

    public void EquipCraftedWeapon(WeaponData newWeapon)
{
    int slot = (int)GetSlotForWeapon(newWeapon);

    Debug.Log($"[EquipCraftedWeapon] Yeni silah: {newWeapon.itemName}, Slot: {slot}");

    // 1) Eski silahÄ± karavana gÃ¶nder
    WeaponData oldWeapon = slots[slot];
    if (oldWeapon != null)
    {
        CaravanInventory.Instance.StoreWeapon(oldWeapon);
        Debug.Log("Eski silah karavana gÃ¶nderildi: " + oldWeapon.itemName);
    }

    // 2) Yeni silah slota ekle
    slots[slot] = newWeapon;

    // 3) Mermi bilgilerini sÄ±fÄ±rla
    clip[slot] = newWeapon.clipSize;
    reserve[slot] = newWeapon.maxAmmoCapacity;

    // 4) EÄŸer aktif slot buysa hemen gÃ¼ncelle
    if (activeSlotIndex == slot)
    {
        ApplyToHandler(slot);
    }
    else
    {
        // Craft edilen silaha otomatik geÃ§mek istiyorsan:
        activeSlotIndex = slot;
        ApplyToHandler(slot);
    }

    Debug.Log("Yeni silah oyuncuya takÄ±ldÄ±: " + newWeapon.itemName);
}

// ----------------------------------------------------
//  SAVE
// ----------------------------------------------------
public WeaponSlotSaveData GetSaveData()
{
    WeaponSlotSaveData data = new WeaponSlotSaveData();

    for (int i = 0; i < 3; i++)
    {
        if (slots[i] != null)
            data.equippedWeaponIDs[i] = slots[i].itemID;
        else
            data.equippedWeaponIDs[i] = "";

        data.clip[i] = clip[i];
        data.reserve[i] = reserve[i];
    }

    data.activeSlotIndex = activeSlotIndex;

    return data;
}


// ----------------------------------------------------
//  LOAD
// ----------------------------------------------------
public void LoadData(WeaponSlotSaveData data)
{
    for (int i = 0; i < 3; i++)
    {
        string id = data.equippedWeaponIDs[i];

        if (!string.IsNullOrEmpty(id))
        {
            ItemData item = ItemDatabase.Get(id);
            if (item is WeaponItemData wid)
            {
                slots[i] = wid.weaponData;
                clip[i] = data.clip[i];
                reserve[i] = data.reserve[i];
            }
            else
            {
                slots[i] = null;
                clip[i] = 0;
                reserve[i] = 0;
            }
        }
        else
        {
            slots[i] = null;
            clip[i] = 0;
            reserve[i] = 0;
        }
    }

    activeSlotIndex = Mathf.Clamp(data.activeSlotIndex, 0, 2);

    // handler'Ä± gÃ¼ncelle
    SwitchSlot(activeSlotIndex);
}



}
public enum WeaponType
{
    Pistol,
    MachineGun,
    Shotgun,
    Sniper,
    Molotov,
    ThrowingSpear,
    Bow,
    MeeleSword
}

using UnityEngine;

[CreateAssetMenu(menuName = "Items/Ammo Data")]
public class AmmoItemData : ItemData
{
    [Header("Ammo Settings")]
    public string ammoType;          // 9mm, 5.56, 7.62
    public int ammoAmount = 10;      // Bir kutudan gelen toplam mermi miktarÄ±
}




[CreateAssetMenu(menuName = "Items/Ammo Type")]
public class AmmoType : ScriptableObject
{
    public string ammoId;     // dictionary iÃ§in benzersiz ID
    public string ammoName;
    public Sprite icon;
}


using UnityEngine;

public class AmmoPickup : MonoBehaviour
{
    public AmmoType ammoType;
    public int amount = 15;

    private Transform player;

    void Start()
    {
        player = GameObject.FindGameObjectWithTag("Player")?.transform;
    }

    void Update()
    {
        if (!player) return;

        if (Vector3.Distance(player.position, transform.position) < 1.5f)
        {
            Inventory.Instance.AddAmmo(ammoType.ammoId, amount);
            Destroy(gameObject);
        }
    }
}
public interface IAmmoProvider
{
    void SetAmmo(int clip, int reserve);
    void GetAmmo(out int clip, out int reserve);
}
using UnityEngine;

[CreateAssetMenu(menuName = "Items/Magazine Item")]
public class MagazineItem : ScriptableObject
{
    public string magName;
    public Sprite icon;

    public string ammoType;   // â† Ã–NEMLÄ°: string olmalÄ±!
    public int capacity = 12;
    public int currentAmmo = 0;

    public bool IsFull => currentAmmo >= capacity;
    public bool IsEmpty => currentAmmo <= 0;
}
using UnityEditor;
using UnityEngine;

[CustomEditor(typeof(WeaponData))]
public class WeaponDataEditor : Editor
{
    SerializedProperty prefab;
    SerializedProperty weaponType;

    SerializedProperty knockbackForce;
    SerializedProperty knockbackDuration;

    SerializedProperty isAutomatic;
    SerializedProperty fireRate;
    SerializedProperty damage;

    SerializedProperty clipSize;
    SerializedProperty maxAmmoCapacity;
    SerializedProperty reloadTime;

    SerializedProperty attackRange;

    SerializedProperty pelletsPerShot;
    SerializedProperty pelletSpreadAngle;
    SerializedProperty shotgunCooldown;

    SerializedProperty sniperCooldown;
    SerializedProperty sniperPenetrationCount;

    SerializedProperty ammoType;

    SerializedProperty fireEffectPrefab;
    SerializedProperty explosionRadius;
    SerializedProperty burnDamage;
    SerializedProperty burnDuration;
    SerializedProperty tickInterval;

    SerializedProperty isMolotov;

    void OnEnable()
    {
        prefab = serializedObject.FindProperty("prefab");
        weaponType = serializedObject.FindProperty("weaponType");

        knockbackForce = serializedObject.FindProperty("knockbackForce");
        knockbackDuration = serializedObject.FindProperty("knockbackDuration");

        isAutomatic = serializedObject.FindProperty("isAutomatic");
        fireRate = serializedObject.FindProperty("fireRate");
        damage = serializedObject.FindProperty("damage");

        clipSize = serializedObject.FindProperty("clipSize");
        maxAmmoCapacity = serializedObject.FindProperty("maxAmmoCapacity");
        reloadTime = serializedObject.FindProperty("reloadTime");

        attackRange = serializedObject.FindProperty("attackRange");

        pelletsPerShot = serializedObject.FindProperty("pelletsPerShot");
        pelletSpreadAngle = serializedObject.FindProperty("pelletSpreadAngle");
        shotgunCooldown = serializedObject.FindProperty("shotgunCooldown");

        sniperCooldown = serializedObject.FindProperty("sniperCooldown");
        sniperPenetrationCount = serializedObject.FindProperty("sniperPenetrationCount");

        ammoType = serializedObject.FindProperty("ammoType");

        fireEffectPrefab = serializedObject.FindProperty("fireEffectPrefab");
        explosionRadius = serializedObject.FindProperty("explosionRadius");
        burnDamage = serializedObject.FindProperty("burnDamage");
        burnDuration = serializedObject.FindProperty("burnDuration");
        tickInterval = serializedObject.FindProperty("tickInterval");

        isMolotov = serializedObject.FindProperty("isMolotov");
    }

    public override void OnInspectorGUI()
    {
        serializedObject.Update();

        EditorGUILayout.PropertyField(prefab);
        EditorGUILayout.PropertyField(weaponType);

        WeaponType wt = (WeaponType)weaponType.enumValueIndex;

        EditorGUILayout.Space(5);
        EditorGUILayout.LabelField("Stats", EditorStyles.boldLabel);

        EditorGUILayout.PropertyField(knockbackForce);
        EditorGUILayout.PropertyField(knockbackDuration);

        EditorGUILayout.PropertyField(fireRate);
        EditorGUILayout.PropertyField(damage);
        EditorGUILayout.PropertyField(clipSize);
        EditorGUILayout.PropertyField(maxAmmoCapacity);
        EditorGUILayout.PropertyField(reloadTime);
        EditorGUILayout.PropertyField(attackRange);

        // ---- Normal / Pistol / Rifle / MG vb. (Shotgun, Sniper, Molotov HARÄ°Ã‡ hepsi) ----
        if (wt != WeaponType.Shotgun && wt != WeaponType.Sniper && wt != WeaponType.Molotov)
        {
            EditorGUILayout.PropertyField(isAutomatic);
        }

        // ---- Shotgun ----
        if (wt == WeaponType.Shotgun)
        {
            EditorGUILayout.Space(5);
            EditorGUILayout.LabelField("Shotgun Settings", EditorStyles.boldLabel);
            EditorGUILayout.PropertyField(pelletsPerShot);
            EditorGUILayout.PropertyField(pelletSpreadAngle);
            EditorGUILayout.PropertyField(shotgunCooldown);
        }

        // ---- Sniper ----
        if (wt == WeaponType.Sniper)
        {
            EditorGUILayout.Space(5);
            EditorGUILayout.LabelField("Sniper Settings", EditorStyles.boldLabel);
            EditorGUILayout.PropertyField(sniperCooldown);
            EditorGUILayout.PropertyField(sniperPenetrationCount);
        }

        // ---- Molotov ----
        if (wt == WeaponType.Molotov)
        {
            // Ä°stersen runtime iÃ§in boolâ€™u da senkron tut:
            isMolotov.boolValue = true;

            EditorGUILayout.Space(5);
            EditorGUILayout.LabelField("Molotov Settings", EditorStyles.boldLabel);

            EditorGUILayout.PropertyField(fireEffectPrefab);
            EditorGUILayout.PropertyField(explosionRadius);
            EditorGUILayout.PropertyField(burnDamage);
            EditorGUILayout.PropertyField(burnDuration);
            EditorGUILayout.PropertyField(tickInterval);
        }
        else
        {
            // DiÄŸer tÃ¼m silahlarda false
            isMolotov.boolValue = false;
        }

        EditorGUILayout.Space(10);
        EditorGUILayout.PropertyField(ammoType);

        serializedObject.ApplyModifiedProperties();
    }
}

using UnityEngine;
using UnityEngine.UI;


public class Animal : MonoBehaviour
{

    private Animator animator;
    private Vector2 lastMoveDir = Vector2.down; // idle yÃ¶nÃ¼ iÃ§in


    [Header("Animation Direction")]
    public float dirDeadzone = 0.15f;   // Ã§ok kÃ¼Ã§Ã¼k x/y titreÅŸimlerini yok say
    public float axisHysteresis = 0.10f; // eksenler arasÄ± geÃ§iÅŸte yapÄ±ÅŸkanlÄ±k (0.05-0.15 iyi)

    // Son seÃ§ilen animasyon yÃ¶nÃ¼nÃ¼ tut (saÄŸ/sol/yukarÄ±/aÅŸaÄŸÄ±)
    private Vector2 lastAnimDir = Vector2.down;

    public string animalType = "Geyik";
    public int maxHealth = 6;
    public float moveSpeed = 2f;
    public float roamRadius = 5f;
    public float baseDetectionRadius = 4f;
    public float nightDetectionFactor = 0.5f;
    public float fleeSpeedMultiplier = 1.5f;
    public float animalCount = 3;

    public GameObject meatPrefab;
    public GameObject hidePrefab;
    public GameObject hpBarPrefab;

    private int currentHealth;
    private GameObject hpBarInstance;
    private Image hpFillImage;

    private Vector2 roamTarget;
    private AnimalState currentState = AnimalState.Roaming;

    private Transform threatTarget;
    private float detectionRadius;

    private float nightBehaviorTimer;
    private bool isNight;
    

    [Header("Flee Tuning")]
    public float minScareCooldown = 0.5f; // spam Ã¶nlemek iÃ§in
    private float lastScareTime = -999f;

    private Vector2? fleeFromPoint = null;   // tehdit noktasÄ± (silah sesi/mermi)
    private float tempFleeMultiplier = 1f;
    private Coroutine fleeTimerCo;

    void Start()
    {

        animator = GetComponent<Animator>();
        if (animator == null) Debug.LogError("[Animal] Animator bileÅŸeni bulunamadÄ±!");
        currentHealth = maxHealth;
        detectionRadius = baseDetectionRadius;
        PickNewRoamTarget();

        //deneme

        if (hpBarPrefab != null)
        {
            hpBarInstance = Instantiate(hpBarPrefab, transform.position + Vector3.up * 1f, Quaternion.identity);
            hpBarInstance.transform.SetParent(transform, true);

            Transform fill = hpBarInstance.transform.Find("Background/Fill");
            if (fill != null)
                hpFillImage = fill.GetComponent<Image>();
        }

        // Gecelik davranÄ±ÅŸÄ± tetikleyici
        InvokeRepeating(nameof(UpdateNightBehavior), 0f, 10f);
    }

    void Update()
    {
        DetectThreats();

        switch (currentState)
        {
            case AnimalState.Roaming:
            case AnimalState.NightRoaming:
                Roam();
                break;

            case AnimalState.Fleeing:
                Flee();
                break;

            case AnimalState.Sleeping:
                // sadece uyurken idle'a zorla
                UpdateAnimator(Vector2.zero, 0f);
                break;
        }
    }

    void OnEnable()
    {
        AnimalSoundEmitter.OnSound += OnSoundHeard;
    }

    void OnDisable()
    {
        AnimalSoundEmitter.OnSound -= OnSoundHeard;
    }

    private void OnSoundHeard(SoundEvent s)
    {
        // Uzaksa veya uyuyor ve duymasÄ± istenmiyorsa (istersen burada Sleep'e istisna koyabilirsin)
        if (Vector2.Distance(transform.position, s.position) > s.radius) return;

        // Gece/gÃ¼ndÃ¼z fark etmeksizin panik
        Scare(s.position, s.fleeDuration, s.speedMultiplier);
    }

    private Vector2 GetAnimCardinalDir(Vector2 dir)
    {
        if (dir.sqrMagnitude < 0.0001f) return lastAnimDir;

        float ax = Mathf.Abs(dir.x);
        float ay = Mathf.Abs(dir.y);

        // eksen seÃ§imini biraz yapÄ±ÅŸkan yap
        bool preferX = ax > ay + axisHysteresis;
        bool preferY = ay > ax + axisHysteresis;

        Vector2 target;
        if (preferX || (!preferY && lastAnimDir.y != 0))
            target = new Vector2(dir.x >= 0f ? 1f : -1f, 0f);
        else if (preferY || (!preferX && lastAnimDir.x != 0))
            target = new Vector2(0f, dir.y >= 0f ? 1f : -1f);
        else
            target = (ax >= ay) ? new Vector2(dir.x >= 0f ? 1f : -1f, 0f)
                                : new Vector2(0f, dir.y >= 0f ? 1f : -1f);

        if (Mathf.Abs(dir.x) < dirDeadzone && lastAnimDir.x != 0f) target = lastAnimDir;
        if (Mathf.Abs(dir.y) < dirDeadzone && lastAnimDir.y != 0f) target = lastAnimDir;

        return target;
    }

    public void Scare(Vector2 fromPosition, float duration, float speedMult)
    {
        if (Time.time - lastScareTime < minScareCooldown) return;
        lastScareTime = Time.time;

        fleeFromPoint = fromPosition;
        tempFleeMultiplier = Mathf.Max(speedMult, 1f);
        currentState = AnimalState.Fleeing;

        if (fleeTimerCo != null) StopCoroutine(fleeTimerCo);
        fleeTimerCo = StartCoroutine(StopFleeAfter(duration));
    }

    private System.Collections.IEnumerator StopFleeAfter(float seconds)
    {
        yield return new WaitForSeconds(seconds);
        fleeFromPoint = null;
        tempFleeMultiplier = 1f;

        // Panik sonrasÄ± rutinine dÃ¶n
        if (isNight) EnterNightMode();
        else currentState = AnimalState.Roaming;

        PickNewRoamTarget();
        fleeTimerCo = null;
    }


    void DetectThreats()
    {
        if (currentState == AnimalState.Sleeping) return;

        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, detectionRadius);
        foreach (var hit in hits)
        {
            if (hit.CompareTag("Player") || hit.CompareTag("Enemy"))
            {
                currentState = AnimalState.Fleeing;
                threatTarget = hit.transform;
                return;
            }
        }

        if (currentState == AnimalState.Fleeing && threatTarget == null)
        {
            if (isNight)
                EnterNightMode(); // tekrar gece davranÄ±ÅŸÄ±na dÃ¶n
            else
                currentState = AnimalState.Roaming;

            PickNewRoamTarget();
        }
    }

    void Roam()
    {
        float distance = Vector2.Distance(transform.position, roamTarget);
        if (distance < 0.5f)
        {
            PickNewRoamTarget();
        }

        Vector2 dir = (roamTarget - (Vector2)transform.position).normalized;
        MoveWithAnim(dir, moveSpeed);
    }

    void Flee()
    {
        // Ã–ncelik: canlÄ± tehdit -> tehdit hedefi (Player/Enemy)
        // Yoksa: en son duyulan/gelinen tehdit noktasÄ±
        Vector2 source;

        if (threatTarget != null)
        {
            source = threatTarget.position;
        }
        else if (fleeFromPoint.HasValue)
        {
            source = fleeFromPoint.Value;
        }
        else
        {
            // GÃ¼venli geri dÃ¶nÃ¼ÅŸ
            if (isNight) { EnterNightMode(); } else { currentState = AnimalState.Roaming; }
            PickNewRoamTarget();
            UpdateAnimator(Vector2.zero, 0f); // gÃ¼venli
            return;
        }

        Vector2 dir = ((Vector2)transform.position - source).normalized;
        float speed = moveSpeed * fleeSpeedMultiplier * tempFleeMultiplier;
        MoveWithAnim(dir, speed);
    }

    private void MoveWithAnim(Vector2 dir, float speed)
    {
        if (dir.sqrMagnitude > 0.0001f)
            transform.Translate(dir * speed * Time.deltaTime);

        Vector2 animDir = GetAnimCardinalDir(dir);     // <-- kritik
        UpdateAnimator(animDir, speed);
    }

    private void UpdateAnimator(Vector2 animDir, float speed)
    {
        if (animator == null) return;

        bool isMovingNow = animDir.sqrMagnitude > 0.0001f && speed > 0.01f;
        animator.SetBool("isMoving", isMovingNow);

        if (isMovingNow)
        {
            animator.SetFloat("MoveX", animDir.x);  // -1,0,1
            animator.SetFloat("MoveY", animDir.y);  // -1,0,1
            lastMoveDir = animDir;
            lastAnimDir = animDir;
        }
        else
        {
            animator.SetFloat("MoveX", lastMoveDir.x);
            animator.SetFloat("MoveY", lastMoveDir.y);
        }
    }

    void PickNewRoamTarget()
    {
        Vector2 randomOffset = Random.insideUnitCircle * roamRadius;
        roamTarget = (Vector2)transform.position + randomOffset;
    }

    public void TakeDamage(int damage)
    {
        currentHealth -= damage;

        if (hpFillImage != null)
        {
            float fillValue = Mathf.Clamp01((float)currentHealth / maxHealth);
            hpFillImage.fillAmount = fillValue;
        }

        // â— Vurulduysa, saldÄ±rÄ± yÃ¶nÃ¼nÃ¼ bilmiyorsak bile rastgele uzaÄŸa kaÃ§
        if (!fleeFromPoint.HasValue && threatTarget == null)
        {
            // kÃ¼Ã§Ã¼k bir ofsetle bulunduÄŸu yerden ters yÃ¶ne hedef seÃ§
            Vector2 away = (Vector2)transform.position + Random.insideUnitCircle.normalized * 2f;
            Scare(away, 3f, 2.0f);
        }

        if (currentHealth <= 0)
        {
            DropLoot();
            if (hpBarInstance != null) Destroy(hpBarInstance);
            Destroy(gameObject);
        }
    }

    void DropLoot()
    {
        Instantiate(meatPrefab, transform.position, Quaternion.identity);
        Instantiate(hidePrefab, transform.position + Vector3.right * 0.5f, Quaternion.identity);
    }

    public void SetNight(bool night)
    {
        isNight = night;
        detectionRadius = baseDetectionRadius * (isNight ? nightDetectionFactor : 1f);
        EnterNightMode();
    }

    void EnterNightMode()
    {
        if (!isNight) return;

        // %50 ÅŸansla uyur, %50 gezer
        if (Random.value < 0.5f)
            currentState = AnimalState.Sleeping;
        else
            currentState = AnimalState.NightRoaming;

        PickNewRoamTarget();
    }

    void UpdateNightBehavior()
    {
        if (isNight)
            EnterNightMode(); // her 10 saniyede yeniden davranÄ±ÅŸ belirle
    }

    void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.yellow;
        Gizmos.DrawWireSphere(transform.position, detectionRadius);
    }
}
using System;
using UnityEngine;

public struct SoundEvent
{
    public Vector2 position;
    public float radius;
    public float fleeDuration;
    public float speedMultiplier;

    public SoundEvent(Vector2 pos, float rad, float dur = 2f, float mult = 1.5f)
    {
        position = pos;
        radius = rad;
        fleeDuration = dur;
        speedMultiplier = mult;
    }
}

public static class AnimalSoundEmitter
{
    public static event Action<SoundEvent> OnSound;

    // ğŸ”¹ 2 parametreli versiyon (default deÄŸerlerle)
    public static void EmitSound(Vector2 pos, float radius)
    {
        EmitSound(pos, radius, 2f, 1.5f);
    }

    // ğŸ”¹ 4 parametreli versiyon
    public static void EmitSound(Vector2 pos, float radius, float fleeDuration, float speedMultiplier)
    {
        OnSound?.Invoke(new SoundEvent(pos, radius, fleeDuration, speedMultiplier));
    }
}
public enum AnimalState
{
    Roaming,
    Fleeing,
    Sleeping,
    NightRoaming
}
// AudioManager.cs
using UnityEngine;
using UnityEngine.Audio;

public class AudioManager : MonoBehaviour
{
    public static AudioManager Instance { get; private set; }

    [Header("Mixer")]
    public AudioMixer mainMixer;            // MainMixer.asset
    public AudioMixerGroup musicGroup;      // Inspector: Music
    public AudioMixerGroup sfxGroup;        // Inspector: SFX

    [Tooltip("Exposed param adlarÄ±")]
    public string musicParam = "MusicVolume";
    public string sfxParam = "SFXVolume";
    public string masterParam = "MasterVolume";

    void Awake()
    {
        if (Instance == null) { Instance = this; DontDestroyOnLoad(gameObject); }
        else { Destroy(gameObject); return; }

        float master = PlayerPrefs.GetFloat("MasterVolume", 1f);
        float music = PlayerPrefs.GetFloat("MusicVolume", 1f);
        float sfx = PlayerPrefs.GetFloat("SFXVolume", 1f);
        SetMasterVolume(master);
        SetMusicVolume(music);
        SetSFXVolume(sfx);
    }

    float ToDecibels(float value) => (value <= 0.0001f) ? -80f : Mathf.Log10(value) * 20f;

    public void SetMasterVolume(float v)
    {
        mainMixer.SetFloat(masterParam, ToDecibels(v));
        PlayerPrefs.SetFloat("MasterVolume", v);
    }
    public void SetMusicVolume(float v)
    {
        mainMixer.SetFloat(musicParam, ToDecibels(v));
        PlayerPrefs.SetFloat("MusicVolume", v);
    }

    public void SetSFXVolume(float v)
    {
        mainMixer.SetFloat(sfxParam, ToDecibels(v));
        PlayerPrefs.SetFloat("SFXVolume", v);
    }

    // PlayClipAtPoint alternatifi: miksere baÄŸlÄ± tek-seferlik Ã§alma
    public void PlayOneShotAt(AudioClip clip, Vector3 pos, float volume = 1f)
    {
        if (clip == null || sfxGroup == null) return;
        var go = new GameObject("OneShotSFX");
        go.transform.position = pos;
        var src = go.AddComponent<AudioSource>();
        src.outputAudioMixerGroup = sfxGroup;
        src.spatialBlend = 0f; // 2D UI/SFX ise 0f, 3D istiyorsan 1fâ€™e Ã§ekebilirsin
        src.PlayOneShot(clip, volume);
        Destroy(go, clip.length + 0.1f);
    }

    // Bir AudioSourceâ€™u programatik olarak SFXâ€™e baÄŸlamak istersen:
    public void RouteToSFX(AudioSource src)
    {
        if (src != null && sfxGroup != null) src.outputAudioMixerGroup = sfxGroup;
    }

    public void RouteToMusic(AudioSource src)
    {
        if (src != null && musicGroup != null) src.outputAudioMixerGroup = musicGroup;
    }
}
// MusicManager.cs

using UnityEngine;
using System.Collections; // Coroutine iÃ§in
using System.Collections.Generic; // List iÃ§in

[RequireComponent(typeof(AudioSource))]
public class MusicManager : MonoBehaviour
{
    public static MusicManager Instance { get; private set; }

    [Header("Music Playlists")]
    public List<AudioClip> dayMusicPlaylist;
    public List<AudioClip> nightMusicPlaylist;

    [Header("Settings")]
    [Tooltip("ÅarkÄ±lar arasÄ±ndaki geÃ§iÅŸin yumuÅŸaklÄ±ÄŸÄ± (saniye).")]
    public float crossfadeDuration = 2.0f;

    private AudioSource audioSource;
    private bool isDay = true;
    private int currentTrackIndex = -1;

    private bool isAppPaused = false;
    private bool wasPausedByFocus = false;

    void Awake()
    {
        Debug.Log("ğŸµ MusicManager Awake Ã‡ALIÅTI! Playlist Day=" 
          + dayMusicPlaylist.Count 
          + " Night=" + nightMusicPlaylist.Count);

        // Singleton Pattern
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject); // Bu yÃ¶neticinin sahneler arasÄ± geÃ§iÅŸte kalmasÄ±nÄ± saÄŸlar.
        }
        else
        {
            Destroy(gameObject);
            return;
        }

        audioSource = GetComponent<AudioSource>();
        audioSource.loop = false; // ÅarkÄ± bitince Coroutine ile yenisini baÅŸlatacaÄŸÄ±z.
    }

    void Update()
    {
        // Uygulama odak dÄ±ÅŸÄ±ndayken/pauselayken asla parÃ§a deÄŸiÅŸtirme
        if (isAppPaused) return;

        // Sadece gerÃ§ekten ÅŸarkÄ± bitince yeni parÃ§aya geÃ§
        if (!audioSource.isPlaying && (isDay ? dayMusicPlaylist.Count > 0 : nightMusicPlaylist.Count > 0))
        {
            PlayNextTrack();
        }
    }
public void StopAll()
{
    if (audioSource != null)
    {
        audioSource.Stop();
        audioSource.clip = null;      // Clip temizlensin
        audioSource.time = 0f;        // ParÃ§a zamanÄ± reset
        // audioSource.enabled = false;  // âŒ KALDIRILDI!
    }

    currentTrackIndex = -1;
}




    // DayNightCycle bu fonksiyonu Ã§aÄŸÄ±rarak durumu bildirir.
    public void SetDay(bool isCurrentlyDay)
{
    // Durumu her zaman gÃ¼ncelle
    this.isDay = isCurrentlyDay;

    // MÃ¼zik Ã§almÄ±yorsa direkt baÅŸlat
    if (!audioSource.isPlaying || audioSource.clip == null)
    {
        PlayNextTrack();
        return;
    }

    // EÄŸer mÃ¼zik Ã§alÄ±yorsa crossfade yap
    StartCoroutine(CrossfadeToNextTrack());
}


    private void PlayNextTrack()
    {
        List<AudioClip> currentPlaylist = isDay ? dayMusicPlaylist : nightMusicPlaylist;
        if (currentPlaylist.Count == 0) return;

        // Rastgele bir sonraki ÅŸarkÄ± seÃ§ (aynÄ± ÅŸarkÄ±yÄ± tekrar Ã§almasÄ±n diye kontrol edebiliriz).
        int nextTrackIndex = Random.Range(0, currentPlaylist.Count);
        if (currentPlaylist.Count > 1 && nextTrackIndex == currentTrackIndex)
        {
            nextTrackIndex = (nextTrackIndex + 1) % currentPlaylist.Count;
        }
        currentTrackIndex = nextTrackIndex;

        audioSource.clip = currentPlaylist[currentTrackIndex];
        audioSource.Play();
    }

    private IEnumerator CrossfadeToNextTrack()
    {
        float startVolume = audioSource.volume;

        // Sesi yavaÅŸÃ§a kÄ±s
        while (audioSource.volume > 0)
        {
            audioSource.volume -= startVolume * Time.deltaTime / crossfadeDuration;
            yield return null;
        }

        audioSource.Stop();
        audioSource.volume = startVolume; // Sesi eski haline getir

        // Yeni duruma gÃ¶re bir sonraki ÅŸarkÄ±yÄ± Ã§al
        PlayNextTrack();
    }

    // Uygulama duraklatÄ±ldÄ±ÄŸÄ±nda/geri gelince Ã§aÄŸrÄ±lÄ±r
    void OnApplicationPause(bool pause)
    {
        isAppPaused = pause;
        if (audioSource == null) return;

        if (pause)
        {
            // Odak gidince o anki ÅŸarkÄ±yÄ± duraklat (clip ve time korunur)
            if (audioSource.isPlaying)
            {
                audioSource.Pause();
                wasPausedByFocus = true;
            }
        }
        else
        {
            // Geri dÃ¶nÃ¼nce aynen kaldÄ±ÄŸÄ± yerden devam et
            if (wasPausedByFocus)
            {
                audioSource.UnPause();
                wasPausedByFocus = false;
            }
        }
    }

    // BazÄ± platformlarda sadece focus tetiklenir; aynÄ± mantÄ±ÄŸÄ± yÃ¶nlendir
    void OnApplicationFocus(bool hasFocus)
    {
        OnApplicationPause(!hasFocus);
    }

    
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class CampfireCooking : MonoBehaviour
{
    [Header("Cooking")]
    public float cookTime = 5f;
    public GameObject cookedMeatPrefab;
    public Transform dropPoint;

    [SerializeField] private ItemData meatSO;
    [SerializeField] private ItemData cookedMeatSO;

    [Header("UI")]
    public GameObject progressCanvas;
    public Slider progressBar;

    private bool isPlayerNearby = false;
    private bool isCooking = false;
    private float holdTimer = 0f;

    void Start()
    {
        if (progressCanvas) progressCanvas.SetActive(false);
        if (progressBar) progressBar.value = 0f;
    }

    void Update()
    {
        if (!isPlayerNearby) return;

        bool hasMeat = Inventory.Instance.GetTotalCount(meatSO) > 0;

        if (hasMeat && Keyboard.current.cKey.isPressed)
        {
            if (!isCooking)
            {
                isCooking = true;
                if (progressCanvas) progressCanvas.SetActive(true);
            }

            holdTimer += Time.deltaTime;
            if (progressBar) progressBar.value = holdTimer / cookTime;

            if (holdTimer >= cookTime)
            {
                CookMeat();
                ResetCooking();
            }
        }
        else
        {
            if (isCooking)
                ResetCooking();
        }
    }

    private void CookMeat()
    {
        if (Inventory.Instance.TryConsume(meatSO, 1))
        {
            Vector3 pos = dropPoint ? dropPoint.position
                                    : transform.position + new Vector3(0.4f, 0f, 0f);

            Instantiate(cookedMeatPrefab, pos, Quaternion.identity);
        }
    }

    private void ResetCooking()
    {
        isCooking = false;
        holdTimer = 0f;

        if (progressBar) progressBar.value = 0f;
        if (progressCanvas) progressCanvas.SetActive(false);
    }

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player")) isPlayerNearby = true;
    }

    void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            ResetCooking();
        }
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;
using TMPro;

public class CampfireInteraction : MonoBehaviour
{
    [SerializeField] private ItemData meatSO;
    [SerializeField] private ItemData cookedMeatSO;

    [Header("Cooking")]
    public GameObject cookedMeatPrefab;
    public Transform dropPoint;
    public float cookDuration = 5f;
    public AudioSource sfx;
    public AudioClip sizzleClip;

    [Header("UI")]
    public GameObject cookPromptPanel;
    public TextMeshProUGUI cookPromptText;
    public Slider cookProgress;

    private bool isPlayerNearby = false;
    private bool isHolding = false;
    private float holdTimer = 0f;

    void Start()
    {
        if (cookPromptPanel != null) cookPromptPanel.SetActive(false);
        if (cookProgress != null) cookProgress.value = 0f;
    }

    void Update()
    {
        if (!isPlayerNearby)
        {
            HidePrompt();
            return;
        }

        bool hasMeat = Inventory.Instance.GetTotalCount(meatSO) > 0;

        if (cookPromptPanel) cookPromptPanel.SetActive(hasMeat);
        if (cookPromptText) cookPromptText.text = hasMeat ? "C'ye basÄ±lÄ± tut: Eti PiÅŸir" : "Et yok";

        if (!hasMeat)
        {
            ResetHold();
            return;
        }

        if (Keyboard.current.cKey.isPressed)
        {
            isHolding = true;
            holdTimer += Time.deltaTime;

            if (cookProgress != null)
                cookProgress.value = holdTimer / cookDuration;

            if (holdTimer >= cookDuration)
            {
                CookAndDrop();
                ResetHold();
            }
        }
        else
        {
            if (isHolding)
                ResetHold();
        }
    }

    private void CookAndDrop()
    {
        if (!Inventory.Instance.TryConsume(meatSO, 1))
        {
            Debug.Log("ğŸ¥© Et yok, piÅŸirme iptal.");
            return;
        }

        if (sfx && sizzleClip)
            sfx.PlayOneShot(sizzleClip);

        Vector3 pos = dropPoint
            ? dropPoint.position
            : transform.position + new Vector3(0.4f, 0, 0);

        Instantiate(cookedMeatPrefab, pos, Quaternion.identity);
    }

    private void ResetHold()
    {
        isHolding = false;
        holdTimer = 0f;

        if (cookProgress != null)
            cookProgress.value = 0f;
    }

    private void HidePrompt()
    {
        if (cookPromptPanel) cookPromptPanel.SetActive(false);
        ResetHold();
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player")) isPlayerNearby = true;
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            HidePrompt();
        }
    }
}
using UnityEngine;
using UnityEngine.UI;

public class CaravanHealth : MonoBehaviour
{
    public int maxHealth = 10;
    private int currentHealth;

    public Slider healthSlider;  // UI'dan baÄŸlanacak

    void Start()
    {
        currentHealth = maxHealth;
        UpdateUI();
    }

    public void TakeDamage(int damage)
    {
        currentHealth -= damage;
        UpdateUI();

        if (currentHealth <= 0)
        {
            Debug.Log("ğŸšï¸ Karavan yÄ±kÄ±ldÄ±! Oyun bitti.");
            GameManager.Instance.GameOver();
        }

    }

    void UpdateUI()
    {
        if (healthSlider != null)
            healthSlider.value = (float)currentHealth / maxHealth;
    }
}
using UnityEngine;
using UnityEngine.UI;

public class CaravanIndicator : MonoBehaviour
{
    public Transform player;
    public Transform caravan;
    public RectTransform canvasRect;
    public RectTransform indicator;

    private CanvasGroup canvasGroup;

    [Header("Animasyon AyarlarÄ±")]
    public float fadeSpeed = 5f;
    public float scaleSpeed = 5f;
    public float targetAlpha = 1f;
    public Vector3 visibleScale = Vector3.one;
    public Vector3 hiddenScale = Vector3.zero;

    void Start()
    {
        canvasGroup = indicator.GetComponent<CanvasGroup>();
        if (canvasGroup == null)
            Debug.LogError("âŒ CanvasGroup eksik! LÃ¼tfen CaravanIndicator objesine ekleyin.");

        // BaÅŸlangÄ±Ã§ durumu
        canvasGroup.alpha = 0f;
        indicator.localScale = hiddenScale;
    }

    void Update()
    {
        if (player == null || caravan == null || indicator == null || canvasRect == null) return;

        Vector3 direction = caravan.position - player.position;

        // Kamera gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ kontrolÃ¼
        Vector3 viewportPos = Camera.main.WorldToViewportPoint(caravan.position);
        bool isCaravanVisible = viewportPos.x >= 0f && viewportPos.x <= 1f &&
                               viewportPos.y >= 0f && viewportPos.y <= 1f &&
                               viewportPos.z > 0f;

        bool shouldShow = !isCaravanVisible;

        // Fade ve Scale animasyonu
        float target = shouldShow ? targetAlpha : 0f;
        canvasGroup.alpha = Mathf.Lerp(canvasGroup.alpha, target, Time.deltaTime * fadeSpeed);
        indicator.localScale = Vector3.Lerp(indicator.localScale, shouldShow ? visibleScale : hiddenScale, Time.deltaTime * scaleSpeed);

        if (!shouldShow) return;

        // YÃ¶n gÃ¶sterimi
        float angle = Mathf.Atan2(direction.y, direction.x) * Mathf.Rad2Deg;
        indicator.rotation = Quaternion.Euler(0, 0, angle - 90f);

        Vector3 screenPoint = Camera.main.WorldToViewportPoint(player.position + direction.normalized * 5f);
        screenPoint = new Vector3(Mathf.Clamp01(screenPoint.x), Mathf.Clamp01(screenPoint.y), 0);

        Vector2 canvasSize = canvasRect.sizeDelta;
        Vector2 uiPos = new Vector2(
            (screenPoint.x * canvasSize.x) - (canvasSize.x / 2),
            (screenPoint.y * canvasSize.y) - (canvasSize.y / 2)
        );

        indicator.anchoredPosition = uiPos;
    }
}
using UnityEngine;

public class CaravanInteraction : MonoBehaviour
{
    [Header("Ayarlar")]
    public float interactDistance = 2f;

    [Header("Durum")]
    public bool playerInRange = false;   // CraftInput burayÄ± kontrol edecek

    private Transform player;

    private void Start()
    {
        player = GameObject.FindWithTag("Player")?.transform;
    }

    private void Update()
    {
        if (player == null) return;

        float dist = Vector2.Distance(player.position, transform.position);

        // Oyuncu karavana yakÄ±n mÄ±?
        playerInRange = dist <= interactDistance;
    }
}
using System.Collections.Generic;
using UnityEngine;

public class CaravanInventory : MonoBehaviour
{
    public static CaravanInventory Instance;

    // WeaponType â†’ List<WeaponData>
    public Dictionary<WeaponType, List<WeaponData>> storedWeapons =
        new Dictionary<WeaponType, List<WeaponData>>();

    private void Awake()
    {
        Instance = this;

        foreach (WeaponType type in System.Enum.GetValues(typeof(WeaponType)))
        {
            storedWeapons[type] = new List<WeaponData>();
        }
    }


    // ============================================
    // 1) WeaponSlotManager tarafÄ±ndan Ã§aÄŸrÄ±lan sistem
    // ============================================
    public void AddItem(string itemID, int amount = 1)
    {
        ItemData data = ItemDatabase.Get(itemID);
        if (data == null)
        {
            Debug.LogError("CaravanInventory â†’ itemID bulunamadÄ±: " + itemID);
            return;
        }

        WeaponItemData wid = data as WeaponItemData;
        if (wid == null)
        {
            Debug.LogError("CaravanInventory.AddItem â†’ Bu item bir silah deÄŸil: " + itemID);
            return;
        }

        StoreWeapon(wid.weaponData);
    }


    // ============================================
    // 2) Silah depolama (WeaponData)
    // ============================================
    public void StoreWeapon(WeaponData data)
    {
        if (!storedWeapons.ContainsKey(data.weaponType))
            storedWeapons[data.weaponType] = new List<WeaponData>();

        storedWeapons[data.weaponType].Add(data);

        Debug.Log($"{data.weaponType} tÃ¼rÃ¼nde silah karavana eklendi: {data.itemName}");
    }


    // ============================================
    // 3) UI veya Swap iÃ§in Silah Ã‡ekme
    // ============================================
    public WeaponData TakeWeapon(WeaponType type, int index)
    {
        if (!storedWeapons.ContainsKey(type) || storedWeapons[type].Count == 0)
            return null;

        if (index < 0 || index >= storedWeapons[type].Count)
            return null;

        WeaponData w = storedWeapons[type][index];
        storedWeapons[type].RemoveAt(index);

        return w;
    }


    // ============================================
    // 4) Silah listesini dÃ¶ndÃ¼r (UI iÃ§in)
    // ============================================
    public List<WeaponData> GetWeapons(WeaponType type)
    {
        if (!storedWeapons.ContainsKey(type))
            storedWeapons[type] = new List<WeaponData>();

        return storedWeapons[type];
    }



    // ============================================
    // 5) SAVE SYSTEM
    // ============================================
    public CaravanSaveData GetSaveData()
    {
        CaravanSaveData save = new CaravanSaveData();

        foreach (var kvp in storedWeapons)
        {
            WeaponSaveEntry entry = new WeaponSaveEntry();
            entry.type = kvp.Key;
            entry.weaponIDs = new List<string>();

            foreach (var weapon in kvp.Value)
            {
                entry.weaponIDs.Add(weapon.itemID);
            }

            save.weaponEntries.Add(entry);
        }

        return save;
    }
    public bool HasWeapon(WeaponData weapon)
{
    if (!storedWeapons.ContainsKey(weapon.weaponType))
        return false;

    foreach (var w in storedWeapons[weapon.weaponType])
    {
        if (w.itemID == weapon.itemID)
            return true;
    }

    return false;
}

public void LoadFromData(CaravanSaveData save)
{
    // TÃ¼m silahlarÄ± temizle
    foreach (var key in storedWeapons.Keys)
        storedWeapons[key].Clear();

    // Save verisini geri yÃ¼kle
    foreach (var entry in save.weaponEntries)
    {
        if (!storedWeapons.ContainsKey(entry.type))
            storedWeapons[entry.type] = new List<WeaponData>();

        foreach (string id in entry.weaponIDs)
        {
            ItemData data = ItemDatabase.Get(id);

            if (data is WeaponItemData wid)
                storedWeapons[entry.type].Add(wid.weaponData);
        }
    }

    Debug.Log("CaravanInventory yÃ¼klendi.");
}



}
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CaravanWeaponUI : MonoBehaviour
{
    public Transform pistolRoot;
    public Transform rifleRoot;
    public Transform meleeRoot;

    public GameObject weaponButtonPrefab;

    private void OnEnable()
    {
        RefreshUI();
    }

    public void RefreshUI()
    {
        Clear(pistolRoot);
        Clear(rifleRoot);
        Clear(meleeRoot);

        // Pistols
        CreateButtons(WeaponType.Pistol, pistolRoot);

        // Rifles (MachineGun, Shotgun, Sniper, Bow hepsi Rifle slotunda)
        CreateButtons(WeaponType.MachineGun, rifleRoot);
        CreateButtons(WeaponType.Shotgun, rifleRoot);
        CreateButtons(WeaponType.Sniper, rifleRoot);
        CreateButtons(WeaponType.Bow, rifleRoot);

        // Melee weapons
        CreateButtons(WeaponType.MeeleSword, meleeRoot);
        CreateButtons(WeaponType.ThrowingSpear, meleeRoot);
    }

    private void Clear(Transform parent)
    {
        foreach (Transform child in parent)
            Destroy(child.gameObject);
    }

    private void CreateButtons(WeaponType type, Transform root)
    {
        List<WeaponData> list = CaravanInventory.Instance.GetWeapons(type);

        for (int i = 0; i < list.Count; i++)
        {
            WeaponData weapon = list[i];

            GameObject btnGO = Instantiate(weaponButtonPrefab, root);

            // UI text update
            TMP_Text txt = btnGO.GetComponentInChildren<TMP_Text>();
            if (txt != null)
                txt.text = weapon.itemName;

            Button btn = btnGO.GetComponent<Button>();

            int indexCopy = i;
            btn.onClick.AddListener(() =>
            {
                OnWeaponSelected(type, indexCopy);
            });
        }
    }

    private void OnWeaponSelected(WeaponType type, int index)
    {
        // 1) Karavandan silahÄ± Ã§ek
        WeaponData selected = CaravanInventory.Instance.TakeWeapon(type, index);

        if (selected == null)
        {
            Debug.LogError("Karavandan silah alÄ±namadÄ±!");
            return;
        }

        // 2) Bu silah hangi slotta kullanÄ±lacak?
        WeaponSlotType slotType = WeaponSlotManager.Instance.GetSlotForWeapon(selected);
        int slotIndex = (int)slotType;

        // 3) Oyuncunun Ã¼zerindeki aynÄ± slot silahÄ±nÄ± karavana gÃ¶nder
        WeaponData oldWeapon = WeaponSlotManager.Instance.slots[slotIndex];

        if (oldWeapon != null)
        {
            CaravanInventory.Instance.StoreWeapon(oldWeapon);
        }

        // 4) Yeni silahÄ± oyuncuya tak
        WeaponSlotManager.Instance.slots[slotIndex] = selected;

        WeaponSlotManager.Instance.clip[slotIndex] = selected.clipSize;
        WeaponSlotManager.Instance.reserve[slotIndex] = selected.maxAmmoCapacity;

        // 5) EÄŸer aktif slot ise handlerâ€™Ä± gÃ¼ncelle
        if (WeaponSlotManager.Instance.activeSlotIndex == slotIndex)
        {
            WeaponSlotManager.Instance.SwitchSlot(slotIndex);
        }

        Debug.Log($"ğŸ”„ Swap baÅŸarÄ±lÄ±! {selected.itemName} oyuncuya takÄ±ldÄ±.");

        // 6) UI yenile
        RefreshUI();
    }
}
using UnityEngine;
using TMPro;

public class GameClock : MonoBehaviour
{
    [Header("BaÄŸlantÄ±lar")]
    public DayNightCycle dayNightCycle;
    public TextMeshProUGUI timeText;
    public Transform player; // <<< AUTOSAVE Ä°Ã‡Ä°N EKLENDÄ°

    [Header("Zaman AyarlarÄ±")]
    public float dayStartHour = 6f;    // Oyun 06:00'da baÅŸlar
    public float nightStartHour = 19f; // AkÅŸam 19:00

    private float currentTime;   // 0â€“24 arasÄ± gerÃ§ek saat
    private float timeSpeed;     // GÃ¼ndÃ¼z hÄ±zÄ±
    private float nightSpeed;    // Gece hÄ±zÄ±

    // AUTOSAVE
    private bool savedThisMorning = false;
    private const int autoSaveHour = 8;   // 08:00'de kayÄ±t

    void Start()
    {
        if (dayNightCycle == null)
            dayNightCycle = FindObjectOfType<DayNightCycle>();

        // Saat baÅŸlangÄ±cÄ±
        currentTime = dayStartHour;

        // GÃ¼ndÃ¼z/gece hÄ±zlarÄ±
        timeSpeed = (nightStartHour - dayStartHour) / dayNightCycle.dayDuration;
        nightSpeed = ((24f - nightStartHour) + dayStartHour) / dayNightCycle.nightDuration;
    }

    private void Awake()
{
if (player == null)
{
    player = GameObject.FindWithTag("Player")?.transform;
    if (player == null) return;
}

}

    
    
    void Update()
    {
    

        // ---- ZAMAN Ä°LERLETME ----
        if (dayNightCycle.IsDay)
            currentTime += Time.deltaTime * timeSpeed;
        else
            currentTime += Time.deltaTime * nightSpeed;

        if (currentTime >= 24f)
        {
            currentTime -= 24f;
            savedThisMorning = false; // Yeni gÃ¼n baÅŸladÄ±
        }

        // ---- EKRANDA GÃ–STER ----
        int hour = Mathf.FloorToInt(currentTime);
        int minute = Mathf.FloorToInt((currentTime % 1f) * 60f);

        if (timeText != null)
            timeText.text = $"Saat: {hour:00}:{minute:00}";

        // ---- AUTOSAVE ----
        CheckAutoSave(hour, minute);
    }

    private void CheckAutoSave(int hour, int minute)
    {
        // EÄŸer tam 08:00'deysek ve daha Ã¶nce kaydetmediysek
        if (!savedThisMorning && hour == autoSaveHour && minute == 0)
        {
            if (player != null)
            {
                SaveSystem.SavePlayerAndInventory(
    player,
    Inventory.Instance,
    FindObjectOfType<PlayerStats>()
);


                Debug.Log("ğŸŸ¢ 08:00 â†’ Otomatik kayÄ±t alÄ±ndÄ±!");
            }
            else
            {
                Debug.LogWarning("âŒ GameClock: Player referansÄ± eksik, autosave yapÄ±lamadÄ±!");
            }

            savedThisMorning = true;
        }
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CraftCostUI : MonoBehaviour
{
    public Image icon;
    public TMP_Text amountText;

    public void Setup(ItemData item, int requiredAmount, int playerAmount)
    {
        if (icon != null && item != null)
            icon.sprite = item.icon;

        if (amountText != null)
        {
            amountText.text = $"{playerAmount}/{requiredAmount}";
            amountText.color = playerAmount >= requiredAmount ? Color.white : Color.red;
        }
    }
}
using System.Collections.Generic;
using UnityEngine;

public class CraftingSystem : MonoBehaviour
{
    public static CraftingSystem Instance { get; private set; }

    [Header("Tarifler (ScriptableObject WeaponCraftRecipe)")]
    public List<WeaponCraftRecipe> recipes = new();

    public CaravanInventory caravanInventory;

    // Craft edilip kalÄ±cÄ± aÃ§Ä±lan silahlar
    public HashSet<string> unlockedWeapons = new();

    private void Awake()
    {
        Instance = this;

        if (caravanInventory == null)
            caravanInventory = FindObjectOfType<CaravanInventory>();
    }

    // ------------------------------------------------------------
    // Tarife baÄŸlÄ± WeaponData'yÄ± al
    // ------------------------------------------------------------
    private WeaponData GetWeapon(WeaponCraftRecipe recipe)
    {
        return recipe?.resultWeapon;
    }

    private string GetKey(WeaponData weapon)
    {
        if (weapon == null) return "";

        if (!string.IsNullOrWhiteSpace(weapon.itemName))
            return weapon.itemName;

        return weapon.itemID;
    }

    public bool IsUnlocked(WeaponCraftRecipe recipe)
    {
        WeaponData w = GetWeapon(recipe);
        return unlockedWeapons.Contains(GetKey(w));
    }

    // ------------------------------------------------------------
    // Craft edilebilir mi?
    // ------------------------------------------------------------
    public bool CanCraft(WeaponCraftRecipe recipe)
    {
        if (recipe == null) return false;

        WeaponData weapon = GetWeapon(recipe);
        if (weapon == null) return false;

        if (IsUnlocked(recipe)) return false;

        foreach (var cost in recipe.costs)
        {
            if (!Inventory.Instance.HasEnough(cost.item, cost.amount))
                return false;
        }

        return true;
    }

    // ------------------------------------------------------------
    // Craft â†’ KARAVANA EKLE
    // ------------------------------------------------------------
    public bool TryCraft(WeaponCraftRecipe recipe)
{
    if (!CanCraft(recipe))
    {
        Debug.Log("Craft baÅŸarÄ±sÄ±z: Gereken koÅŸullar saÄŸlanmÄ±yor.");
        return false;
    }

    WeaponData weapon = GetWeapon(recipe);

    // 1) KaynaklarÄ± tÃ¼ket
    foreach (var cost in recipe.costs)
        Inventory.Instance.TryConsume(cost.item, cost.amount);

    // 2) SilahÄ± unlock et
    unlockedWeapons.Add(GetKey(weapon));

    // 3) Craft edilen silahÄ± OYUNCUYA TAK
    WeaponSlotManager.Instance.EquipCraftedWeapon(weapon);

    Debug.Log($"âœ” CRAFT BAÅARILI â†’ {weapon.itemName} oyuncuya takÄ±ldÄ±!");

    return true;
}

}
using UnityEngine;
using UnityEngine.InputSystem;

public class CraftInput : MonoBehaviour
{
    public CraftUIController craftUI;
    public GameObject inventoryPanel;

    public CaravanInteraction caravan;      // ZATEN VAR
    public GameObject caravanWeaponPanel;   // YENÄ°: silah swap paneli

    private PlayerControls controls;

    private void Awake()
    {
        controls = new PlayerControls();
    }

    private void OnEnable()
    {
        controls.Gameplay.Enable();
        controls.Gameplay.Craft.performed += OnCraftPressed;
        controls.Gameplay.CaravanWeapons.performed += OnCaravanWeaponsPressed; // YENÄ°
    }

    private void OnDisable()
    {
        controls.Gameplay.Craft.performed -= OnCraftPressed;
        controls.Gameplay.CaravanWeapons.performed -= OnCaravanWeaponsPressed; // YENÄ°
        controls.Gameplay.Disable();
    }

    // CRAFT TUÅU (eski)
    private void OnCraftPressed(InputAction.CallbackContext ctx)
    {
        if (craftUI == null) return;

        // Karavana yakÄ±n deÄŸilse craft aÃ§Ä±lmasÄ±n
        if (caravan != null && !caravan.playerInRange)
        {
            Debug.Log("Craft aÃ§Ä±lamadÄ± â†’ Karavana yakÄ±n deÄŸilsin.");
            return;
        }

        bool isOpen = craftUI.craftPanel.activeSelf;

        // Craft aÃ§Ä±lacaksa inventory kapat
        if (!isOpen && inventoryPanel != null && inventoryPanel.activeSelf)
            inventoryPanel.SetActive(false);

        // Craft aÃ§Ä±lÄ±rken karavan silah panelini de kapat
        if (!isOpen && caravanWeaponPanel != null && caravanWeaponPanel.activeSelf)
            caravanWeaponPanel.SetActive(false);

        if (isOpen)
            craftUI.Close();
        else
            craftUI.Open();
    }

    // KARAVAN SÄ°LAH PANEL TUÅU (yeni)
    private void OnCaravanWeaponsPressed(InputAction.CallbackContext ctx)
    {
        Debug.Log("V tuÅŸu algÄ±landÄ±!");
        if (caravan == null || !caravan.playerInRange)
        {
            Debug.Log("Karavan silah paneli aÃ§Ä±lamadÄ± â†’ Karavana yakÄ±n deÄŸilsin.");
            return;
        }

        if (caravanWeaponPanel == null)
        {
            Debug.LogWarning("CaravanWeaponPanel referansÄ± atanmadÄ±!");
            return;
        }

        bool isOpen = caravanWeaponPanel.activeSelf;

        if (!isOpen)
        {
            // AÃ§Ä±lÄ±rken diÄŸer UI'larÄ± kapat
            if (craftUI != null && craftUI.craftPanel.activeSelf)
                craftUI.Close();

            if (inventoryPanel != null && inventoryPanel.activeSelf)
                inventoryPanel.SetActive(false);
        }

        caravanWeaponPanel.SetActive(!isOpen);
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CraftSlotUI : MonoBehaviour
{
    public Image icon;
    public TMP_Text nameText;
    public Transform costRoot;
    public GameObject costEntryPrefab;

    private WeaponCraftRecipe recipe;

    public void Setup(WeaponCraftRecipe recipe, Sprite weaponIcon, string name)
    {
        this.recipe = recipe;

        icon.sprite = weaponIcon;
        nameText.text = name;

        RefreshCosts();
    }

    private void RefreshCosts()
    {
        // Eski maliyet entry'lerini temizle
        foreach (Transform t in costRoot)
            Destroy(t.gameObject);

        foreach (var cost in recipe.costs)
        {
            GameObject costGO = Instantiate(costEntryPrefab, costRoot);
            CraftCostUI ui = costGO.GetComponent<CraftCostUI>();

            int playerAmount = Inventory.Instance.GetItemCount(cost.item);

            ui.Setup(cost.item, cost.amount, playerAmount);
        }
    }

    // UI butonu iÃ§in
    public void OnSelectPressed()
    {
        CraftUIController.Instance.SelectRecipe(recipe);
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;



public class CraftUIController : MonoBehaviour
{
    [Header("UI")]
    public GameObject craftPanel;
    public Transform gridParent;
    public GameObject craftSlotPrefab;
    public Button craftButton;
    public TMP_Text craftButtonText;


    [Header("Logic")]
    public WeaponCraftRecipe selectedRecipe;

    public static CraftUIController Instance;

    private void Awake()
    {
        Instance = this;
    }

    private void Start()
    {
        PopulateRecipes();
        craftPanel.SetActive(false);
    }

    // ---------------------------------------------------------
    //  Tarif slotlarÄ±nÄ± oluÅŸtur
    // ---------------------------------------------------------
    public void PopulateRecipes()
    {
        // Grid Ã¼zerindeki eski slotlarÄ± sil
        foreach (Transform t in gridParent)
            Destroy(t.gameObject);

        if (CraftingSystem.Instance == null)
        {
            Debug.LogError("CraftingSystem.Instance bulunamadÄ±!");
            return;
        }

        // TÃ¼m WeaponCraftRecipe tariflerini slot olarak ekle
        foreach (var recipe in CraftingSystem.Instance.recipes)
        {
            GameObject slotGO = Instantiate(craftSlotPrefab, gridParent);

            CraftSlotUI slotUI = slotGO.GetComponent<CraftSlotUI>();
            if (slotUI == null)
            {
                Debug.LogError("CraftSlot prefabÄ±nda CraftSlotUI component yok!");
                continue;
            }

            // WeaponCraftRecipe â†’ WeaponData
            WeaponData weapon = recipe.resultWeapon;

            if (weapon == null)
            {
                Debug.LogError("Tarifte resultWeapon eksik!");
                continue;
            }

            // Slot UI setup
            slotUI.Setup(
                recipe,
                weapon.icon,     // WeaponData'daki icon
                weapon.itemName  // WeaponData'daki isim
            );
        }
    }

    // ---------------------------------------------------------
    //  Slot tÄ±klayÄ±nca tarif seÃ§ilir
    // ---------------------------------------------------------
    public void SelectRecipe(WeaponCraftRecipe recipe)
{
    selectedRecipe = recipe;

    WeaponData weapon = recipe.resultWeapon;

    bool existsInCaravan = CaravanInventory.Instance.HasWeapon(weapon);

    if (existsInCaravan)
    {
        craftButtonText.text = "Swap";      // Ã¼cretsiz deÄŸiÅŸim
    }
    else
    {
        craftButtonText.text = "Craft";     // malzeme gerektirir
    }
}


    // ---------------------------------------------------------
    //  Craft Butonu
    // ---------------------------------------------------------
    public void OnCraftButtonPressed()
{
    if (selectedRecipe == null)
    {
        Debug.Log("â— Tarif seÃ§ilmedi.");
        return;
    }

    WeaponData weapon = selectedRecipe.resultWeapon;

    bool existsInCaravan = CaravanInventory.Instance.HasWeapon(weapon);

    // ------------------------------------------------
    // 1) EÄER SÄ°LAH KARAVANDA VARSA â†’ SWAP
    // ------------------------------------------------
    if (existsInCaravan)
    {
        SwapWithCaravan(weapon);
        Debug.Log($"ğŸ”„ Swap â†’ {weapon.itemName} karavandan alÄ±ndÄ±.");
        
        Close();
        return;
    }

    // ------------------------------------------------
    // 2) DEÄÄ°LSE â†’ NORMAL CRAFT
    // ------------------------------------------------
    bool success = CraftingSystem.Instance.TryCraft(selectedRecipe);

    if (success)
    {
        Debug.Log($"âœ” Craft baÅŸarÄ±lÄ± â†’ {weapon.itemName} Ã¼retildi");
        PopulateRecipes();
        selectedRecipe = null;
        Close();
    }
    else
    {
        Debug.Log($"âŒ Craft baÅŸarÄ±sÄ±z â†’ {weapon.itemName}");
    }
}


private void SwapWithCaravan(WeaponData weapon)
{
    // Silah hangi slotta kullanÄ±lacak?
    WeaponSlotType slotType = WeaponSlotManager.Instance.GetSlotForWeapon(weapon);
    int slotIndex = (int)slotType;

    // Oyuncunun elindeki silah
    WeaponData currentWeapon = WeaponSlotManager.Instance.slots[slotIndex];

    // 1) Oyuncunun mevcut silahÄ±nÄ± karavana koy
    if (currentWeapon != null)
        CaravanInventory.Instance.StoreWeapon(currentWeapon);

    // 2) Karavandan bu silahÄ± al
    List<WeaponData> list = CaravanInventory.Instance.GetWeapons(weapon.weaponType);

    for (int i = 0; i < list.Count; i++)
    {
        if (list[i].itemID == weapon.itemID)
        {
            list.RemoveAt(i);
            break;
        }
    }

    // 3) Oyuncuya tak
    WeaponSlotManager.Instance.slots[slotIndex] = weapon;
    WeaponSlotManager.Instance.clip[slotIndex] = weapon.clipSize;
    WeaponSlotManager.Instance.reserve[slotIndex] = weapon.maxAmmoCapacity;

    WeaponSlotManager.Instance.SwitchSlot(slotIndex);
}



    // ---------------------------------------------------------
    //  Craft UI AÃ§ / Kapat
    // ---------------------------------------------------------
    public void Open()
    {
        PopulateRecipes(); 
        craftPanel.SetActive(true);
        Time.timeScale = 0f;
    }

    public void Close()
{
    craftPanel.SetActive(false);
    selectedRecipe = null;
    Time.timeScale = 1f;
}

}
using UnityEngine;
using UnityEngine.UI;
using System.Collections;
using System.Collections.Generic;
using Unity.VisualScripting;
using TMPro;

public class Enemy : MonoBehaviour
{

    [Header("Sun Burn (Daytime)")]
    public bool burnsInDay = true;
    public int burnDamagePerTick = 10;
    public float burnTickInterval = 1f;

    private Coroutine burnCo;
    private DayNightCycle dayNightCycle;


    public int maxHealth = 5;
    private int currentHealth;

    private bool isDaytimeCached = false;

    public TextMeshPro damageText;

    public GameObject hpBarPrefab; // Prefab atanacak

    public GameObject damagePopupPrefab;

    private Image hpFillImage; // STATIC KALDIRILDI
    private GameObject hpBarInstance;
    public GameObject goldPrefab; // Inspector'dan atanacak
    public GameObject[] blueprintPrefabs; // FarklÄ± blueprint objeleri atanabilir
    public EnemyType enemyType = EnemyType.Normal;
    public float moveSpeed = 2f;
    public int damageToCaravan = 1;
    private Animator animator;
    private AudioSource audioSource; // YENÄ°
    

    [SerializeField] private GameObject ammoMachineGunPrefab;
    [SerializeField] private GameObject ammoPistolPrefab;
    [SerializeField] private GameObject ammoShotgunPrefab;
    [SerializeField] private GameObject ammoSniperPrefab;


    [Header("Audio")]
    [Tooltip("DÃ¼ÅŸman doÄŸduÄŸunda veya belirli aralÄ±klarla Ã§alÄ±nacak sesler.")]
    public List<AudioClip> ambientSounds;
    [Tooltip("DÃ¼ÅŸman hasar aldÄ±ÄŸÄ±nda Ã§alÄ±nacak sesler.")]
    public List<AudioClip> hurtSounds;
    [Tooltip("DÃ¼ÅŸman Ã¶ldÃ¼ÄŸÃ¼nde Ã§alÄ±nacak ses.")]
    public AudioClip deathSound; // Genellikle tek bir Ã¶lÃ¼m sesi olur.

    [Tooltip("Rastgele ortam seslerinin Ã§alÄ±nma aralÄ±ÄŸÄ± (min ve max saniye).")]
    public Vector2 ambientSoundInterval = new Vector2(5f, 15f);

    [Header("Targets")]
    public Transform player;
    public Transform caravan; // Inspectorâ€™dan da atanabilir

    [Header("Armored Settings")]
    public float armoredDamageInterval = 1.0f;
    public int armoredCaravanDamage = 1;

    [Header("Exploder Settings")]
    public float explosionRadius = 2f;
    public int explosionDamageToPlayer = 2;
    public int explosionDamageToCaravan = 2;
    public LayerMask explosionHitMask;

    [Header("Knockback")]
    public bool canBeKnockedBack = true;
    public float knockbackRecoveryTime = 0.25f; // geri tepme sonrasÄ± hareketin toparlanma sÃ¼resi

    private Coroutine knockbackCoroutine;

    [Header("Contact Damage (Normal/Fast -> Player)")]
    public float contactDamageInterval = 1.0f;
    public int damageToPlayer = 1;

    [Header("Control")]
    public bool externalMovement = false; // sade varsayÄ±lan: false

    [Header("Attack Range Settings")]
    public float damageRangeToPlayer = 5f;
    public float damageRangeToCaravan = 5f;




    private bool isDamagingPlayer = false;
    private Coroutine caravanDamageCo;
    private Coroutine playerDamageCo;

    private Vector2 lastMoveDir = Vector2.down; // baÅŸlangÄ±Ã§ bakÄ±ÅŸ yÃ¶nÃ¼

    void Awake()
    {
        audioSource = GetComponent<AudioSource>();
        animator = GetComponent<Animator>();                // <-- ekle
        if (!animator) Debug.LogError("[Enemy] Animator eksik!");
        if (!audioSource) Debug.LogError("[Enemy] AudioSource eksik!");

    }


    void OnDisable()
    {
        DayNightCycle.OnDayNightChanged -= HandleDayNightChanged;
    }



    private void HandleDayNightChanged(bool isDay)
    {
        if (this == null || !gameObject) return; // ğŸ’¥ Koruma satÄ±rÄ±

        isDaytimeCached = isDay;

        if (!burnsInDay) return;

        if (isDay)
        {
            if (burnCo == null)
                burnCo = StartCoroutine(SunBurnRoutine());
        }
        else
        {
            if (burnCo != null)
            {
                StopCoroutine(burnCo);
                burnCo = null;
            }
        }
    }


    public Transform target;

    void Start()
    {
        // CanÄ± baÅŸlat
        currentHealth = maxHealth;

        if (hpBarPrefab != null)
        {
            hpBarInstance = Instantiate(hpBarPrefab, transform.position + Vector3.up * 1f, Quaternion.identity);
            hpBarInstance.transform.SetParent(transform); // dÃ¼ÅŸmanÄ± takip etsin
            Transform fill = hpBarInstance.transform.Find("Background/Fill");
            if (fill != null)
                hpFillImage = fill.GetComponent<Image>();
            else
                Debug.LogError("Fill Image bulunamadÄ±! Prefab hiyerarÅŸisini kontrol et.");

            hpFillImage.fillAmount = 1f; // baÅŸlangÄ±Ã§ta dolu

            DayNightCycle.OnDayNightChanged += HandleDayNightChanged;

            // EÄŸer oyun baÅŸladÄ±ÄŸÄ±nda gÃ¼ndÃ¼zse hemen yanma baÅŸlat
            if (burnsInDay && DayNightCycle.Instance != null && DayNightCycle.Instance.IsDay)
                HandleDayNightChanged(true);

        }


        // Hedefi tÃ¼re gÃ¶re ayarla
        if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
        {
            // Inspector'dan atanmadÄ±ysa tag ile bul
            if (player == null)
            {
                var go = GameObject.FindGameObjectWithTag("Player");
                if (go != null) player = go.transform;
            }
            target = player;
        }
        else if (enemyType == EnemyType.Armored)
        {
            if (caravan == null)
            {
                var go = GameObject.FindGameObjectWithTag("Caravan");
                if (go != null) caravan = go.transform;
            }
            target = caravan;
        }
        else if (enemyType == EnemyType.Exploder)
        {
            // Ä°stersen player'Ä± kovalasÄ±n:
            if (caravan == null)
            {
                var go = GameObject.FindGameObjectWithTag("Caravan");
                if (go != null) caravan = go.transform;
            }
            target = caravan;
        }

        // (Opsiyonel) ortam sesleri iÃ§in
        if (ambientSounds != null && ambientSounds.Count > 0 && audioSource != null)
            StartCoroutine(PlayAmbientSounds());

        // --- Mevcut Start iÃ§eriÄŸin (OverlapCircleAll vb.) devamÄ± ---
        /*Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, 0.5f);
        foreach (var hit in hits)
        {
            if (hit.CompareTag("Player"))
            {
                if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
                    StartPlayerDamage(hit.transform);
            }
            else if (hit.CompareTag("Caravan"))
            {
                if (enemyType == EnemyType.Armored)
                    StartCaravanDamage(hit.transform);
                else if (enemyType == EnemyType.Exploder)
                    Explode();
            }
        }*/

        GameObject cycleObj = GameObject.FindObjectOfType<DayNightCycle>()?.gameObject;
        if (cycleObj != null)
            dayNightCycle = cycleObj.GetComponent<DayNightCycle>();

        if (burnsInDay && dayNightCycle != null && IsDayTime())
        {
            burnCo = StartCoroutine(SunBurnRoutine());
        }

    }



    private bool IsDayTime()
    {
        return dayNightCycle != null &&
               dayNightCycle.GetType().GetField("isDay", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance).GetValue(dayNightCycle).Equals(true);
    }

    private IEnumerator SunBurnRoutine()
    {
        while (true)
        {
            TakeDamage(burnDamagePerTick);

            if (currentHealth <= 0) yield break; // dÃ¼ÅŸman Ã¶ldÃ¼yse Ã§Ä±k
            yield return new WaitForSeconds(burnTickInterval);
        }
    }


    void LateUpdate()
    {
        Vector3 scale = transform.localScale;
        scale.y = Mathf.Abs(scale.y); // her zaman pozitif olsun
        transform.localScale = scale;
    }


    public void ShowDamage(int amount)
    {
        damageText.text = $"-{amount}";
        damageText.color = Color.red;
        damageText.gameObject.SetActive(true);
        StartCoroutine(FadeOutText());
    }

    private System.Collections.IEnumerator FadeOutText()
    {
        float duration = 0.5f;
        float elapsed = 0f;
        Color c = damageText.color;

        while (elapsed < duration)
        {
            float t = elapsed / duration;
            damageText.color = Color.Lerp(Color.red, Color.white, t);
            elapsed += Time.deltaTime;
            yield return null;
        }

        damageText.gameObject.SetActive(false);
    }


    public void ApplyKnockback(Vector2 sourcePosition, float force, float duration)
    {
        if (!canBeKnockedBack) return;

        // EÄŸer zaten bir knockback coroutine Ã§alÄ±ÅŸÄ±yorsa tekrar baÅŸlatma
        if (knockbackCoroutine != null)
            return;

        Vector2 dir = ((Vector2)transform.position - sourcePosition).normalized;
        knockbackCoroutine = StartCoroutine(KnockbackRoutine(dir, force, duration));
    }

    private IEnumerator KnockbackRoutine(Vector2 direction, float force, float duration)
    {
        Rigidbody2D rb = GetComponent<Rigidbody2D>();
        float elapsed = 0f;

        if (rb != null)
        {
            bool wasKinematic = rb.isKinematic;
            if (wasKinematic) rb.isKinematic = false;

            // ğŸ”¹ Kuvvet uygula (Impulse)
            rb.AddForce(direction * force, ForceMode2D.Impulse);

            while (elapsed < duration)
            {
                elapsed += Time.deltaTime;
                yield return null;
            }

            // ğŸ”¹ Hareketi durdur
            rb.linearVelocity = Vector2.zero;

            if (wasKinematic) rb.isKinematic = true;
        }
        else
        {
            // Rigidbody yoksa transform hareketi uygula
            Vector2 startPos = transform.position;
            while (elapsed < duration)
            {
                transform.position = (Vector2)transform.position + direction * (force * Time.deltaTime);
                elapsed += Time.deltaTime;
                yield return null;
            }
        }

        // ğŸ”¹ KÃ¼Ã§Ã¼k bir toparlanma sÃ¼resi
        yield return new WaitForSeconds(knockbackRecoveryTime);

        knockbackCoroutine = null;
    }


    // Enemy.cs iÃ§ine
    public void OnSoundHeard(Vector2 soundPosition)
    {
        if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
        {
            // DÃ¼ÅŸman zaten hedefteyse ve Ã§ok yakÄ±nsa boÅŸver
            if (target != null && Vector2.Distance(transform.position, target.position) < 1f) return;

            // Yeni hedef pozisyona yÃ¶nel (Ã¶rneÄŸin geÃ§ici olarak bir boÅŸ hedef nokta olabilir)
            StartCoroutine(MoveToSoundPosition(soundPosition));
        }
    }

    private System.Collections.IEnumerator MoveToSoundPosition(Vector2 soundPosition)
    {
        float moveTime = 2f;
        float elapsed = 0f;

        while (elapsed < moveTime)
        {
            Vector2 dir = (soundPosition - (Vector2)transform.position).normalized;
            transform.position += (Vector3)(dir * moveSpeed * Time.deltaTime);

            // Ä°stersen burada animasyonlar da ayarla
            animator.SetFloat("MoveX", dir.x);
            animator.SetFloat("MoveY", dir.y);

            elapsed += Time.deltaTime;
            yield return null;
        }

        // Hareket sonrasÄ± tekrar oyuncuya dÃ¶n
        if (player != null)
            target = player;
    }


   void Update()
{
    if (target == null)
    {
        if ((enemyType == EnemyType.Normal || enemyType == EnemyType.Fast) && player != null)
            target = player;
        else if ((enemyType == EnemyType.Armored || enemyType == EnemyType.Exploder) && caravan != null)
            target = caravan;
    }

    if (!externalMovement && target != null)
    {
        float distanceToTarget = Vector2.Distance(transform.position, target.position);
        float stopDistance = (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
            ? damageRangeToPlayer
            : damageRangeToCaravan;

        Vector2 dir = (target.position - transform.position).normalized;

        if (!isAttacking) // ğŸ”¸ saldÄ±rÄ± modunda deÄŸilse
        {
            if (distanceToTarget > stopDistance)
            {
                // ğŸ§­ Hedefe doÄŸru ilerle
                transform.position += (Vector3)(dir * moveSpeed * Time.deltaTime);

                // ğŸ¬ YÃ¼rÃ¼me animasyonu
                if (!animator.GetBool("IsMoving"))
                    animator.SetBool("IsMoving", true);

                // ğŸ” 360Â° rotasyon
                float angle = Mathf.Atan2(dir.y, dir.x) * Mathf.Rad2Deg;
                transform.rotation = Quaternion.Euler(0f, 0f, angle - 90f);
            }
            else
            {
                // ğŸ”¸ hedefe ulaÅŸtÄ±ysa -> saldÄ±rÄ± baÅŸlat
                animator.SetBool("IsMoving", false);
                StartCoroutine(AttackPlayerRoutine());
            }
        }
    }
}


    public void TakeDamage(int amount)
    {

        Debug.Log($"ğŸ“¦ Hasar popup prefab pozisyonu: {transform.position + Vector3.up * 1f}");



        animator.SetTrigger("Hurt");
        currentHealth -= amount;

        PlayRandomSound(hurtSounds);
        // Debug iÃ§in
        Debug.Log($"Enemy took {amount} damage. Current health: {currentHealth}/{maxHealth}");

        if (hpFillImage != null)
        {
            float fillValue = Mathf.Clamp01((float)currentHealth / maxHealth);
            hpFillImage.fillAmount = fillValue;
            Debug.Log($"Fill amount set to: {fillValue}");
        }

        if (currentHealth <= 0)
        {
            if (enemyType == EnemyType.Exploder)
            {
                Explode();
                return;
            }

            animator.SetTrigger("Die");
            Debug.Log("Enemy should die now!");

            // ALTIN DÃœÅÃœRME %25 ÅANS
            if (goldPrefab != null && Random.value < 0.25f)
            {
                Instantiate(goldPrefab, transform.position, Quaternion.identity);
                Debug.Log("ğŸ’° DÃ¼ÅŸman altÄ±n bÄ±raktÄ±!");
            }

            if (damagePopupPrefab != null)
            {
                Debug.Log("âœ… Prefab atandÄ±, instantiate ediliyor.");
                GameObject popup = Instantiate(damagePopupPrefab, transform.position + Vector3.up * 1.0f, Quaternion.identity, transform);
                popup.GetComponent<DamagePopup>().Setup(amount);
            }
            else
            {
                Debug.LogWarning("âš ï¸ damagePopupPrefab atanmadÄ±!");
            }


            if (blueprintPrefabs.Length > 0 && Random.value < 0.75f)
            {
                int index = Random.Range(0, blueprintPrefabs.Length);
                Instantiate(blueprintPrefabs[index], transform.position, Quaternion.identity);
                Debug.Log("ğŸ“˜ DÃ¼ÅŸman blueprint dÃ¼ÅŸÃ¼rdÃ¼!");
            }


            if (hpBarInstance != null)
                Destroy(hpBarInstance);
            Destroy(gameObject);
            Die();
        }

        DamagePopupManager.Instance.SpawnPopup(transform.position, amount);



    }

public bool isAttacking = false;

public IEnumerator AttackPlayerRoutine()
{
    if (isAttacking) yield break;
    isAttacking = true;

    // ğŸ›‘ Hareketi durdur
    animator.SetBool("IsMoving", false);

    // ğŸ¬ SaldÄ±rÄ± animasyonu
    animator.SetTrigger("Attack");

    // â³ Animasyon bitene kadar bekle (Ã¶rneÄŸin 2 sn)
    yield return new WaitForSeconds(2f);

    // ğŸ” Tekrar hareket etmeye devam et
    isAttacking = false;
}

// ğŸ”¥ Animator Event tarafÄ±ndan Ã§aÄŸrÄ±lacak fonksiyon
public void DealDamageToPlayer()
{
    if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
    {
        if (player != null)
        {
            PlayerStats ps = player.GetComponent<PlayerStats>();
            if (ps != null)
            {
                ps.TakeDamage(damageToPlayer);
                Debug.Log("ğŸ’¥ DÃ¼ÅŸman saldÄ±rÄ± animasyonu sÄ±rasÄ±nda oyuncuya hasar verdi!");
            }
        }
    }
}


    /*void OnTriggerStay2D(Collider2D collision)
    {
        if (collision.CompareTag("Player"))
        {
            if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
            {
                StartPlayerDamage(collision.transform);
            }
        }
        else if (collision.CompareTag("Caravan"))
        {
            if (enemyType == EnemyType.Armored)
            {
                StartCaravanDamage(collision.transform);
            }
            else if (enemyType == EnemyType.Exploder)
            {
                Explode();
            }
        }
    }*/


    /* void OnTriggerEnter2D(Collider2D collision)
     {
         // Karavan ile temas
         if (collision.CompareTag("Caravan"))
         {
             if (enemyType == EnemyType.Armored)
             {
                 // Armored: Ã¶lme, karavana periyodik hasar vermeye baÅŸla
                 StartCaravanDamage(collision.transform);
                 return;
             }
             else if (enemyType == EnemyType.Exploder)
             {
                 // Exploder: patla ve alan hasarÄ± ver
                 Explode();
                 return;
             }
             else
             {
                 // Normal/Fast karavana ulaÅŸÄ±rsa istersen yok et veya gÃ¶rmezden gel
                 // Die(); // Ä°STEMÄ°YORSAN yoruma al
             }
         }

         // Oyuncu ile temas
         if (collision.CompareTag("Player"))
         {
             if (enemyType == EnemyType.Exploder)
             {
                 Explode();
                 return;
             }
             else if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
             {
                 StartPlayerDamage(collision.transform);
             }
         }

     }*/

    /*void OnTriggerExit2D(Collider2D collision)
    {
        if (collision.CompareTag("Caravan") && isDamagingCaravan)
        {
            StopCaravanDamage();
        }
        if (collision.CompareTag("Player") && isDamagingPlayer)
        {
            StopPlayerDamage();
        }
    }
    */
    public void StartCaravanDamage(Transform caravanTransform)
    {
        if (!isDamagingCaravan)
            caravanDamageCo = StartCoroutine(DamageCaravanOverTime(caravanTransform));
    }

    public void StopCaravanDamage()
    {
        isDamagingCaravan = false;
        if (caravanDamageCo != null) StopCoroutine(caravanDamageCo);
        caravanDamageCo = null;
    }

    private System.Collections.IEnumerator DamageCaravanOverTime(Transform caravanTransform)
    {
        isDamagingCaravan = true;
        var ch = caravanTransform.GetComponent<CaravanHealth>();

        while (isDamagingCaravan && ch != null)
        {
            ch.TakeDamage(armoredCaravanDamage);
            yield return new WaitForSeconds(armoredDamageInterval);
        }

        isDamagingCaravan = false;
        caravanDamageCo = null;
    }

   /* public void StartPlayerDamage(Transform playerTransform)
    {
        if (!isDamagingPlayer)
            playerDamageCo = StartCoroutine(DamagePlayerOverTime(playerTransform));
    }

    public void StopPlayerDamage()
    {
        isDamagingPlayer = false;
        if (playerDamageCo != null) StopCoroutine(playerDamageCo);
        playerDamageCo = null;
    }

    private System.Collections.IEnumerator DamagePlayerOverTime(Transform playerTransform)
    {
        isDamagingPlayer = true;
        var ps = playerTransform.GetComponent<PlayerStats>();

        while (isDamagingPlayer && ps != null)
        {
            ps.TakeDamage(damageToPlayer);
            yield return new WaitForSeconds(contactDamageInterval);
        }

        isDamagingPlayer = false;
        playerDamageCo = null;
    }

*/

    private bool isDamagingCaravan = false;




    public void Explode()
    {
        Debug.Log("ğŸ’¥ Exploder patladÄ±!");

        var hits = Physics2D.OverlapCircleAll(transform.position, explosionRadius);

        foreach (var hit in hits)
        {
            if (hit == null) continue;

            if (hit.CompareTag("Player"))
            {
                var ps = hit.GetComponent<PlayerStats>();
                if (ps != null) ps.TakeDamage(explosionDamageToPlayer);
            }
            else if (hit.CompareTag("Caravan"))
            {
                var ch = hit.GetComponent<CaravanHealth>();
                if (ch != null) ch.TakeDamage(explosionDamageToCaravan);
            }
        }

        // ğŸ“¢ Bu satÄ±rÄ± mutlaka ekle:
        Die();
    }


    private void Die()
    {
        Debug.Log("ğŸ’€ Die() Ã§aÄŸrÄ±ldÄ±!");

        // BileÅŸenleri devre dÄ±ÅŸÄ± bÄ±rak
        GetComponent<Collider2D>().enabled = false;
        this.enabled = false;

        // Ã–lÃ¼m animasyonu ve sesi
        if (deathSound != null)
            AudioSource.PlayClipAtPoint(deathSound, transform.position);
        animator.Play("Die");

        // ALTIN bÄ±rakma (%25 ÅŸans)
        if (goldPrefab != null && Random.value < 0.25f)
            Instantiate(goldPrefab, transform.position, Quaternion.identity);

        // BLUEPRINT bÄ±rakma (%75 ÅŸans)
        if (blueprintPrefabs.Length > 0 && Random.value < 0.75f)
        {
            int index = Random.Range(0, blueprintPrefabs.Length);
            Instantiate(blueprintPrefabs[index], transform.position, Quaternion.identity);
        }

        // --- ğŸ”« AMMO bÄ±rakma ---
        float dropChance = 0.4f; // %40 olasÄ±lÄ±kla mermi dÃ¼ÅŸsÃ¼n
        float roll = Random.value;
        Debug.Log($"ğŸ² Ammo drop roll: {roll}");

        if (roll < dropChance)
        {
            List<GameObject> possibleAmmo = new List<GameObject>();

            if (ammoMachineGunPrefab != null) possibleAmmo.Add(ammoMachineGunPrefab);
            if (ammoPistolPrefab != null) possibleAmmo.Add(ammoPistolPrefab);
            if (ammoShotgunPrefab != null) possibleAmmo.Add(ammoShotgunPrefab);
            if (ammoSniperPrefab != null) possibleAmmo.Add(ammoSniperPrefab);

            Debug.Log($"ğŸ¯ {possibleAmmo.Count} ammo tÃ¼rÃ¼ listede.");

            if (possibleAmmo.Count > 0)
            {
                GameObject selectedAmmo = possibleAmmo[Random.Range(0, possibleAmmo.Count)];
                Instantiate(selectedAmmo, transform.position, Quaternion.identity);
                Debug.Log($"ğŸ”« Rastgele mermi dÃ¼ÅŸtÃ¼: {selectedAmmo.name}");
            }
        }

        // HP bar'Ä± yok et
        if (hpBarInstance != null) Destroy(hpBarInstance, 2f);

        // Obje'yi yok et
        Destroy(gameObject);
    }




    // YENÄ°: Rastgele ortam sesi Ã§alan Coroutine
    private System.Collections.IEnumerator PlayAmbientSounds()
    {
        while (true) // Sonsuz dÃ¶ngÃ¼
        {
            // Rastgele bir sÃ¼re bekle
            yield return new WaitForSeconds(Random.Range(ambientSoundInterval.x, ambientSoundInterval.y));

            // Rastgele bir ortam sesi Ã§al
            PlayRandomSound(ambientSounds);
        }
    }

    // YENÄ°: Verilen listeden rastgele bir ses Ã§alan yardÄ±mcÄ± fonksiyon
    private void PlayRandomSound(List<AudioClip> clips)
    {
        if (clips != null && clips.Count > 0 && audioSource != null)
        {
            int index = Random.Range(0, clips.Count);
            audioSource.PlayOneShot(clips[index]);
        }
    }

}
using UnityEngine;

public class EnemyHitbox : MonoBehaviour
{
    private Enemy enemyParent;

    private void Awake()
    {
        enemyParent = GetComponentInParent<Enemy>();
        if (enemyParent == null)
            Debug.LogError("[EnemyHitbox] Parent'ta Enemy scripti yok!");

        // GÃ¼venlik: Collider trigger olmalÄ±
        var col = GetComponent<Collider2D>();
        if (col != null && !col.isTrigger)
            col.isTrigger = true;
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (enemyParent == null) return;

        if (other.CompareTag("Player"))
        {
            // Yeni sistem: temas ettiÄŸinde saldÄ±rÄ±yÄ± baÅŸlat
            if (enemyParent.enemyType == EnemyType.Normal || enemyParent.enemyType == EnemyType.Fast)
            {
                // DÃ¼ÅŸman oyuncuya deÄŸdiÄŸinde artÄ±k direkt saldÄ±rÄ± coroutine'i Ã§aÄŸrÄ±lÄ±yor
                if (!enemyParent.isAttacking)
                    enemyParent.StartCoroutine(enemyParent.AttackPlayerRoutine());
            }
        }
        else if (other.CompareTag("Caravan"))
        {
            if (enemyParent.enemyType == EnemyType.Armored)
                enemyParent.StartCaravanDamage(other.transform);
            else if (enemyParent.enemyType == EnemyType.Exploder)
                enemyParent.Explode(); // PatlayÄ±cÄ±ysa temasta patlat
        }
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (enemyParent == null) return;

        if (other.CompareTag("Caravan"))
            enemyParent.StopCaravanDamage();
    }

    // Ä°stersen sÃ¼rekli temas varken de saldÄ±rÄ± denemesi yapÄ±labilir:
    private void OnTriggerStay2D(Collider2D other)
    {
        if (enemyParent == null) return;

        if (other.CompareTag("Player"))
        {
            if ((enemyParent.enemyType == EnemyType.Normal || enemyParent.enemyType == EnemyType.Fast) && !enemyParent.isAttacking)
            {
                // Temas devam ederken hÃ¢lÃ¢ saldÄ±rmÄ±yorsa tekrar saldÄ±r
                enemyParent.StartCoroutine(enemyParent.AttackPlayerRoutine());
            }
        }
        else if (other.CompareTag("Caravan"))
        {
            if (enemyParent.enemyType == EnemyType.Armored)
                enemyParent.StartCaravanDamage(other.transform);
        }
    }
}
public enum EnemyType
{
    Normal,
    Armored,
    Exploder,
    Fast
}
using UnityEngine;

[RequireComponent(typeof(Enemy))]
public class EnemyWanderDriver : MonoBehaviour
{
    public WanderArea area;                 // Hangi bÃ¶lgede gezinecek?
    public float waypointTolerance = 0.15f; // Hedefe varmÄ±ÅŸ sayÄ±lacaÄŸÄ± mesafe
    public Vector2 idleTimeRange = new Vector2(0.2f, 1.0f); // Noktalar arasÄ±nda kÄ±sa bekleme

    private Enemy enemy;
    private Animator anim;
    private Transform waypoint;     // DÃœÅMANIN HEDEFÄ°
    private bool isIdling = false;
    private float idleTimer = 0f;

    void Awake()
    {
        enemy = GetComponent<Enemy>();
        anim  = GetComponent<Animator>();
    }

    void Start()
    {
        if (area == null)
        {
            Debug.LogWarning("[EnemyWanderDriver] Area atanmamÄ±ÅŸ, yakÄ±n Ã§evrede dolanacak.");
        }

        // Waypoint oluÅŸtur (area altÄ±nda konumlamak dÃ¼zen aÃ§Ä±sÄ±ndan iyidir)
        GameObject wp = new GameObject($"WanderWP_{name}");
        waypoint = wp.transform;
        waypoint.parent = area ? area.transform : null;

        // Ä°lk rastgele nokta ve hedef atamasÄ±
        waypoint.position = GetNextPoint();
        enemy.target = waypoint; // ğŸ”´ Kritik: Enemy artÄ±k bu noktaya yÃ¼rÃ¼yecek
    }

    void Update()
    {
        if (enemy == null || waypoint == null) return;

        if (isIdling)
        {
            idleTimer -= Time.deltaTime;
            if (idleTimer <= 0f)
            {
                isIdling = false;
                waypoint.position = GetNextPoint();
                // enemy.target zaten waypoint, null olmaz -> Enemy oyuncuya dÃ¶nmez
            }
            else
            {
                if (anim) anim.SetFloat("Speed", 0f);
            }
            return;
        }

        // Waypoint'e yeterince yaklaÅŸtÄ±ysak kÄ±sa bekle ve yeni nokta seÃ§
        float distSqr = ((Vector2)(transform.position - waypoint.position)).sqrMagnitude;
        if (distSqr <= waypointTolerance * waypointTolerance)
        {
            isIdling = true;
            idleTimer = Random.Range(idleTimeRange.x, idleTimeRange.y);
        }
        // Hareketi Enemy.cs zaten yapÄ±yor (target -> waypoint olduÄŸu iÃ§in)
    }

    public void Setup(WanderArea areaRef)
{
    if (enemy == null) enemy = GetComponent<Enemy>();
    area = areaRef;

    if (waypoint == null)
    {
        var wp = new GameObject($"WanderWP_{name}");
        waypoint = wp.transform;
        waypoint.parent = area ? area.transform : null;
    }

    waypoint.position = GetNextPoint();
    enemy.target = waypoint; // Hemen waypoint'e kilitlenir (oyuncuya dÃ¶nmez)
}


    private Vector2 GetNextPoint()
    {
        if (area != null) return area.GetRandomPoint();
        // Area yoksa: bulunduÄŸu nokta etrafÄ±nda kÃ¼Ã§Ã¼k daire
        return (Vector2)transform.position + Random.insideUnitCircle * 2f;
    }

    void OnDestroy()
    {
        if (waypoint != null) Destroy(waypoint.gameObject);
    }
}
// SoundEmitter.cs (yeni bir script)
using UnityEngine;

public static class SoundEmitter
{
    public static void EmitSound(Vector2 position, float radius)
    {
        Collider2D[] hits = Physics2D.OverlapCircleAll(position, radius);
        foreach (var hit in hits)
        {
            Enemy enemy = hit.GetComponent<Enemy>();
            if (enemy != null)
            {
                enemy.OnSoundHeard(position);
            }
        }
    }
}
using UnityEngine;

public class FuelPickup : MonoBehaviour
{
    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            GameManager.Instance.AddFuel(1);
            Destroy(gameObject);
        }
    }
}
using UnityEngine;

public class FuelSpawner : MonoBehaviour
{
    public GameObject fuelPrefab;
    public int fuelCount = 4;
    public Vector2 spawnMin = new Vector2(-10, -5);
    public Vector2 spawnMax = new Vector2(10, 5);

    //Deneme iÃ§in

    void Start()
    {
        for (int i = 0; i < fuelCount; i++)
        {
            Vector2 randomPos = new Vector2(
                Random.Range(spawnMin.x, spawnMax.x),
                Random.Range(spawnMin.y, spawnMax.y)
            );

            Instantiate(fuelPrefab, randomPos, Quaternion.identity);
        }
    }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Items/Ammo Data")]
public class AmmoItemData : ItemData
{
    [Header("Ammo Settings")]
    public string ammoType;          // 9mm, 5.56, 7.62
    public int ammoAmount = 10;      // Bir kutudan gelen toplam mermi miktarÄ±
}




[CreateAssetMenu(menuName = "Items/Ammo Type")]
public class AmmoType : ScriptableObject
{
    public string ammoId;     // dictionary iÃ§in benzersiz ID
    public string ammoName;
    public Sprite icon;
}


using UnityEngine;

public class AmmoPickup : MonoBehaviour
{
    public AmmoType ammoType;
    public int amount = 15;

    private Transform player;

    void Start()
    {
        player = GameObject.FindGameObjectWithTag("Player")?.transform;
    }

    void Update()
    {
        if (!player) return;

        if (Vector3.Distance(player.position, transform.position) < 1.5f)
        {
            Inventory.Instance.AddAmmo(ammoType.ammoId, amount);
            Destroy(gameObject);
        }
    }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Items/Resource Data")]
public class CraftResourceData : ItemData
{
    public int amountPerPickup = 1;
}
using UnityEngine;

[CreateAssetMenu(menuName = "Inventory/Generic Item")]
public class GenericItemData : ItemData
{
    [Header("Consumable Settings")]
    public bool isConsumable = false;   // Bandaj mÄ±, ilaÃ§ mÄ± vs.
    public int healAmount = 25;        // KaÃ§ can dolduruyor
    public float useDuration = 2f;     // Kullanma sÃ¼resi (anim / bekleme)
}
public interface IAmmoProvider
{
    void SetAmmo(int clip, int reserve);
    void GetAmmo(out int clip, out int reserve);
}
using System;
using System.Collections.Generic;
using UnityEngine;

public class Inventory : MonoBehaviour
{
    public static Inventory Instance { get; private set; }

    [Header("Config")]
    [Min(1)] public int capacity = 30;

    [Header("State")]
    public InventoryItem[] slots;

    // Blueprint kilitleri (turret / craft iÃ§in)
    private HashSet<string> unlockedBlueprints = new HashSet<string>();

    public event Action OnChanged;
    public void RaiseChanged() => OnChanged?.Invoke();

    // Yeni mermi depolama sistemi: ammoType(string) -> toplam mermi sayÄ±sÄ±
    public Dictionary<string, int> ammoStorage = new Dictionary<string, int>();

    void Awake()
    {
        if (Instance != null)
        {
            Destroy(gameObject);
            return;
        }

        Instance = this;

        slots = new InventoryItem[capacity];
        for (int i = 0; i < capacity; i++)
            slots[i] = new InventoryItem();
    }

    // ---------------- ADD ----------------
    public bool TryAdd(ItemData data, int amount = 1)
    {
        if (data == null || amount <= 0) return false;

        // âœ… EÄŸer AmmoItemData ise: slot'a koyma, direkt ammoStorage'a mermi ekle
        if (data is AmmoItemData ammoData)
        {
            int totalAmmo = ammoData.ammoAmount * amount;
            AddAmmo(ammoData.ammoType, totalAmmo);
            Debug.Log($"[Inventory] {ammoData.ammoType} iÃ§in +{totalAmmo} mermi eklendi.");
            // Slot kullanmadÄ±ÄŸÄ±mÄ±z iÃ§in RaiseChanged Ã§aÄŸÄ±rmaya gerek yok ama istersen ekleyebilirsin
            return true;
        }

        // Normal stacklenebilir item mantÄ±ÄŸÄ±
        if (data.stackable)
        {
            int remain = amount;

            // Var olan stack'leri doldur
            for (int i = 0; i < slots.Length && remain > 0; i++)
            {
                var s = slots[i];
                if (s.data == data && s.count < data.maxStack)
                {
                    int add = Mathf.Min(remain, data.maxStack - s.count);
                    s.count += add;
                    remain -= add;
                }
            }

            // BoÅŸ slotlara yeni stack aÃ§
            for (int i = 0; i < slots.Length && remain > 0; i++)
            {
                if (slots[i].data == null)
                {
                    int add = Mathf.Min(remain, data.maxStack);
                    slots[i] = new InventoryItem(data, add);
                    remain -= add;
                }
            }

            if (remain == 0)
            {
                RaiseChanged();
                return true;
            }

            return false;
        }
        else
        {
            // Stacklenmeyen item
            for (int i = 0; i < slots.Length; i++)
            {
                if (slots[i].data == null)
                {
                    slots[i] = new InventoryItem(data, 1);
                    RaiseChanged();
                    return true;
                }
            }
            return false;
        }
    }

    // --------- YARDIMCI SAYIM METOTLARI ---------

    public int GetTotalCount(ItemData data)
    {
        if (data == null) return 0;
        int total = 0;
        foreach (var s in slots)
            if (s.data == data)
                total += s.count;
        return total;
    }

    // Envanterde yeterince var mÄ±?
    public bool HasEnough(ItemData data, int amount)
    {
        if (data == null || amount <= 0) return false;
        return GetTotalCount(data) >= amount;
    }

    // Blueprint kilidi aÃ§
    public void UnlockBlueprint(string id)
    {
        if (!string.IsNullOrEmpty(id))
            unlockedBlueprints.Add(id);
    }

    // Blueprint var mÄ±?
    public bool HasBlueprint(string id)
    {
        if (string.IsNullOrEmpty(id)) return true; // id yoksa serbest
        return unlockedBlueprints.Contains(id);
    }

    // ---------------- CONSUME / REMOVE ----------------

    public bool TryConsume(ItemData data, int amount)
    {
        if (data == null || amount <= 0) return false;

        int total = GetTotalCount(data);
        if (total < amount) return false;

        int remain = amount;

        for (int i = 0; i < slots.Length && remain > 0; i++)
        {
            var s = slots[i];
            if (s.data == data)
            {
                int take = Mathf.Min(remain, s.count);
                s.count -= take;
                remain -= take;

                if (s.count <= 0)
                    slots[i] = new InventoryItem();
            }
        }

        RaiseChanged();
        return true;
    }

    public bool TryMoveOrMerge(int from, int to)
    {
        if (from == to ||
            from < 0 || from >= slots.Length ||
            to < 0 || to >= slots.Length)
            return false;

        var a = slots[from];
        var b = slots[to];

        if (a.data == null) return false;

        if (b.data == null)
        {
            slots[to] = a;
            slots[from] = new InventoryItem();
            RaiseChanged();
            return true;
        }

        if (a.data == b.data && a.data.stackable)
        {
            int move = Mathf.Min(a.count, a.data.maxStack - b.count);
            b.count += move;
            a.count -= move;

            if (a.count <= 0)
                slots[from] = new InventoryItem();

            RaiseChanged();
            return true;
        }

        // swap
        slots[to] = a;
        slots[from] = b;
        RaiseChanged();
        return true;
    }

    public void ClearInventory()
    {
        for (int i = 0; i < slots.Length; i++)
            slots[i] = new InventoryItem();
        RaiseChanged();
    }

    public int GetItemCount(ItemData item)
    {
        if (item == null) return 0;

        int total = 0;

        for (int i = 0; i < slots.Length; i++)
        {
            InventoryItem invItem = slots[i];
            if (invItem == null || invItem.data == null)
                continue;

            if (invItem.data == item)
                total += invItem.count;
        }

        return total;
    }

    // ---------------- AMMO SÄ°STEMÄ° ----------------

    // Ammo ekleme (pickup vs. burayÄ± kullanacak)
    public void AddAmmo(string ammoId, int amount)
{
    if (!ammoStorage.ContainsKey(ammoId))
        ammoStorage[ammoId] = 0;

    ammoStorage[ammoId] += amount;

    Debug.Log($"Ammo Added: {ammoId} -> {ammoStorage[ammoId]}");
}


    // Belirli ammo tipinden kaÃ§ adet var?
    public int GetAmmoAmount(string ammoType)
    {
        if (string.IsNullOrEmpty(ammoType)) return 0;
        return ammoStorage.TryGetValue(ammoType, out int value) ? value : 0;
    }

    // Ammo tÃ¼ket (ÅŸarjÃ¶r doldurma vb.)
    public bool TryUseAmmo(string ammoType, int amount)
    {
        if (string.IsNullOrEmpty(ammoType) || amount <= 0) return false;

        int current = GetAmmoAmount(ammoType);
        if (current < amount) return false;

        ammoStorage[ammoType] = current - amount;
        return true;
    }

    // ÅarjÃ¶re ammo yÃ¼kleme - ammoStorage'dan Ã§eker
    public void LoadAmmoIntoMag(MagazineItem mag, int amount)
    {
        if (mag == null)
        {
            Debug.LogWarning("LoadAmmoIntoMag: mag == null");
            return;
        }

        if (mag.IsFull)
        {
            Debug.Log("LoadAmmoIntoMag: ÅarjÃ¶r zaten dolu.");
            return;
        }

        string ammoType = mag.ammoType;
        if (string.IsNullOrEmpty(ammoType))
        {
            Debug.LogWarning("LoadAmmoIntoMag: ÅarjÃ¶rÃ¼n ammoType'Ä± tanÄ±mlÄ± deÄŸil!");
            return;
        }

        int available = GetAmmoAmount(ammoType);
        if (available <= 0)
        {
            Debug.Log($"LoadAmmoIntoMag: Envanterde {ammoType} mermisi yok.");
            return;
        }

        int space = mag.capacity - mag.currentAmmo;
        int loadAmount = Mathf.Min(space, amount, available);
        if (loadAmount <= 0)
        {
            Debug.Log("LoadAmmoIntoMag: YÃ¼klenecek mermi yok / yer yok.");
            return;
        }

        // Envanterden mermi dÃ¼ÅŸ
        if (!TryUseAmmo(ammoType, loadAmount))
        {
            Debug.LogWarning("LoadAmmoIntoMag: TryUseAmmo baÅŸarÄ±sÄ±z oldu, eÅŸzamanlÄ±lÄ±k sorunu olabilir.");
            return;
        }

        // ÅarjÃ¶rÃ¼ doldur
        mag.currentAmmo += loadAmount;

        Debug.Log($"ÅarjÃ¶r {mag.magName} mermi yÃ¼klendi: +{loadAmount} ({ammoType}), Envanterde kalan: {GetAmmoAmount(ammoType)}");
    }
}
using UnityEngine;
using UnityEngine.InputSystem;

public class InventoryInput : MonoBehaviour
{
    [Header("UI")]
    public GameObject inventoryPanel;
    public CraftUIController craftUI;   // Envanter aÃ§Ä±ldÄ±ÄŸÄ±nda craft kapanacak

    private PlayerControls controls;
    private bool inventoryOpen = false;

    private void Awake()
    {
        controls = new PlayerControls();
    }

    private void OnEnable()
    {
        controls.Gameplay.Enable();
        controls.Gameplay.Inventory.performed += OnInventoryPressed;
    }

    private void OnDisable()
    {
        controls.Gameplay.Inventory.performed -= OnInventoryPressed;
        controls.Gameplay.Disable();
    }

    private void OnInventoryPressed(InputAction.CallbackContext ctx)
{
    if (inventoryPanel == null) return;

    // EÄŸer craft aÃ§Ä±k ise Ã¶nce craft'Ä± kapat
    if (craftUI != null && craftUI.craftPanel.activeSelf)
        craftUI.Close();

    inventoryOpen = !inventoryOpen;
    inventoryPanel.SetActive(inventoryOpen);
}

}
using System;
using UnityEngine;

[Serializable]
public class InventoryItem
{
    public ItemData data;
    public int count = 1;

    [Serializable]
    public class WeaponInstancePayload
    {
        public string id;
        public int clip;
        public int reserve;
        public int durability;
    }

    public WeaponInstancePayload weapon; // silahlar iÃ§in payload

    public bool IsWeapon => weapon != null;

    public InventoryItem() 
    {
        data = null;
        count = 0;
    }

    public InventoryItem(ItemData data, int count = 1)
    {
        this.data = data;
        this.count = count;
    }
}
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.UI;
using TMPro;

public class InventorySlotUI : MonoBehaviour,
    IPointerClickHandler, IBeginDragHandler, IDragHandler, IEndDragHandler, IDropHandler
{
    [Header("UI")]
    public Image icon;
    public TMP_Text countText;
    public CanvasGroup canvasGroup;

    private int index;
    private InventoryUI owner;
    private InventoryItem cached;
    private RectTransform rt;
    private GameObject dragIcon;

    private void Awake()
    {
        if (canvasGroup == null)
            canvasGroup = gameObject.AddComponent<CanvasGroup>();

        rt = GetComponent<RectTransform>();
    }

    // InventoryUI tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
    public void Bind(int index, InventoryUI owner)
    {
        this.index = index;
        this.owner = owner;

        canvasGroup.alpha = 1f;
        canvasGroup.blocksRaycasts = true;
    }

    // Envanterdeki slot verisini UI'a basar
    public void Render(InventoryItem item)
    {
        cached = item;

        if (item == null || item.data == null)
        {
            icon.enabled = false;
            countText.text = "";
            return;
        }

        icon.enabled = true;
        icon.sprite = item.data.icon;
        icon.preserveAspect = true;

        // Ammo ise: item.count * ammoPerItem gÃ¶ster
        if (item.data is AmmoItemData ammoData)
        {
            int totalAmmo = item.count * ammoData.ammoAmount;
            countText.text = $"x{totalAmmo}";
        }
        else
        {
            countText.text = $"x{item.count}";
        }
    }

    // SaÄŸ tÄ±k / sol tÄ±k davranÄ±ÅŸÄ±
    public void OnPointerClick(PointerEventData eventData)
    {
        if (cached == null || cached.data == null)
            return;

        // Åimdilik: saÄŸ tÄ±kla hiÃ§bir Ã¶zel iÅŸlem yapmÄ±yoruz.
        // Ä°leride buraya "yemek ye / bandaj kullan / ammo yÃ¼kle" gibi davranÄ±ÅŸlar eklenebilir.
    }

    // ---- DRAG & DROP ----

    public void OnBeginDrag(PointerEventData eventData)
    {
        if (cached == null || cached.data == null) return;

        canvasGroup.blocksRaycasts = false;
        canvasGroup.alpha = 0.7f;

        dragIcon = new GameObject("DragIcon");
        dragIcon.transform.SetParent(owner.transform.root);
        dragIcon.transform.SetAsLastSibling();

        var img = dragIcon.AddComponent<Image>();
        img.sprite = icon.sprite;
        img.raycastTarget = false;
        img.preserveAspect = true;

        var drt = dragIcon.GetComponent<RectTransform>();
        drt.sizeDelta = rt.sizeDelta;
    }

    public void OnDrag(PointerEventData eventData)
    {
        if (dragIcon == null) return;
        dragIcon.transform.position = eventData.position;
    }

    public void OnEndDrag(PointerEventData eventData)
    {
        canvasGroup.blocksRaycasts = true;
        canvasGroup.alpha = 1f;

        if (dragIcon != null)
            Destroy(dragIcon);
    }

    public void OnDrop(PointerEventData eventData)
    {
        var src = eventData.pointerDrag ? eventData.pointerDrag.GetComponent<InventorySlotUI>() : null;
        if (src == null || src == this) return;

        owner.MoveOrMerge(src.index, this.index);
    }
}
using UnityEngine;
using UnityEngine.InputSystem; // Yeni sistem iÃ§in ÅŸart

public class InventoryToggle : MonoBehaviour
{
    public GameObject inventoryPanel;

    private Keyboard keyboard;

    void Awake()
    {
        keyboard = Keyboard.current;
    }

    void Update()
    {
        
    }
}
using UnityEngine;

public class InventoryUI : MonoBehaviour
{
    [Header("Refs")]
    public Inventory inventory;
    public Transform gridParent;        // 30 slotu bunun altÄ±na koy
    public GameObject slotPrefab;

    [Header("Visual")]
    public int slotCount = 30;

    private InventorySlotUI[] slots;

    void Awake()
    {
        if (inventory == null)
            inventory = Inventory.Instance;

        slots = new InventorySlotUI[slotCount];

        for (int i = 0; i < slotCount; i++)
        {
            GameObject go = Instantiate(slotPrefab, gridParent); // sadece bir kez oluÅŸtur
            InventorySlotUI slot = go.GetComponent<InventorySlotUI>();

            if (slot == null)
            {
                Debug.LogError("Slot prefab iÃ§inde InventorySlotUI component eksik!");
                continue;
            }

            slot.Bind(i, this);
            go.SetActive(false); // BaÅŸlangÄ±Ã§ta gizli
            slots[i] = slot;
            go.SetActive(false); // âœ… BaÅŸta gizle
        }
    
}



    void OnEnable()
    {
        if (inventory == null) inventory = Inventory.Instance;
        if (inventory != null) inventory.OnChanged += Refresh;
        Refresh();
    }

    void OnDisable()
    {
        if (inventory != null) inventory.OnChanged -= Refresh;
    }

    public void Refresh()
{
    if (inventory == null || slots == null) return;

    for (int i = 0; i < slots.Length; i++)
    {
        if (slots[i] == null || inventory.slots[i] == null) continue;

        // EÄŸer envanterde eÅŸya yoksa slotu gizle
        if (inventory.slots[i].data == null)
        {
            slots[i].gameObject.SetActive(false);
        }
        else
        {
            slots[i].gameObject.SetActive(true);
            slots[i].Render(inventory.slots[i]);
        }
    }
}


    public void MoveOrMerge(int fromIndex, int toIndex)
{
    Inventory.Instance.TryMoveOrMerge(fromIndex, toIndex);
    Refresh();
}

}
using UnityEngine;


public enum ItemCategory { Resource, Ammo, Weapon, Misc }
[CreateAssetMenu(menuName = "Items/Item Data")]
public abstract class ItemData : ScriptableObject
{

    [Header("Base")]
    public string itemName;
    public string itemID;
    public Sprite icon;
    public ItemCategory category;
    public bool stackable = true;
    [Min(1)] public int maxStack = 99;

    public bool showCountBadge => stackable;
}
using System.Collections.Generic;
using UnityEngine;

public static class ItemDatabase
{
    private static Dictionary<string, ItemData> dict;

    public static void RegisterAll(ItemData[] items)
    {
        dict = new Dictionary<string, ItemData>();

        foreach (var item in items)
        {
            if (string.IsNullOrWhiteSpace(item.itemID))
            {
                Debug.LogError($"âŒ Item '{item.name}' iÃ§in itemID atanmadÄ±!");
                continue;
            }

            if (dict.ContainsKey(item.itemID))
            {
                Debug.LogError($"âŒ Duplicate itemID bulundu: {item.itemID}");
                continue;
            }

            dict.Add(item.itemID, item);
        }

        Debug.Log($"ItemDatabase â†’ {dict.Count} item yÃ¼klendi.");
    }

    public static ItemData Get(string id)
    {
        if (dict == null)
        {
            Debug.LogError("âŒ ItemDatabase: RegisterAll daha Ã§aÄŸrÄ±lmadÄ±!");
            return null;
        }

        if (dict.TryGetValue(id, out var data))
            return data;

        Debug.LogError($"âŒ Item bulunamadÄ± â†’ ID = {id}");
        return null;
    }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Inventory/Item Registry")]
public class ItemRegistry : ScriptableObject
{
    public ItemData[] items;
}
public enum ItemType
{
    Resource,
    Weapon,
    Ammo,
    CraftMaterial
}
using UnityEngine;

[CreateAssetMenu(menuName = "Inventory/Part Item")]
public class PartItemData : ItemData
{
    public WeaponPartType partType;
}
using UnityEngine;

public class CloudShadowMover : MonoBehaviour
{
    public float speed = 1f;
    public float resetX = -20f;
    public float startX = 20f;

    void Update()
    {
        transform.Translate(Vector2.left * speed * Time.deltaTime);

        if (transform.position.x < resetX)
        {
            float randomY = Random.Range(2f, 5f);
            transform.position = new Vector3(startX, randomY, transform.position.z);
        }
    }
}
using UnityEngine;
using TMPro;

public class DamagePopup : MonoBehaviour
{
    public TextMeshProUGUI textMesh;
    private float floatSpeed = 25f;
    private float fadeDuration = 1.2f;
    private float elapsed = 0f;
    private Color startColor = Color.red;

    public void Setup(int damage)
    {
        if (textMesh == null)
            textMesh = GetComponent<TextMeshProUGUI>();

        if (textMesh == null)
        {
            Debug.LogError("âŒ TextMeshProUGUI bileÅŸeni yok!");
            return;
        }

        textMesh.text = damage.ToString();
        textMesh.color = startColor;
    }

    void Update()
    {
        transform.Translate(Vector3.up * floatSpeed * Time.deltaTime);
        elapsed += Time.deltaTime;

        if (textMesh != null)
        {
            float t = elapsed / fadeDuration;
            textMesh.color = Color.Lerp(startColor, Color.clear, t);
        }

        if (elapsed >= fadeDuration)
            Destroy(gameObject);
    }
}
using UnityEngine;
using TMPro;
using UnityEngine.EventSystems;

public class DamagePopupManager : MonoBehaviour
{
    public static DamagePopupManager Instance;

    public GameObject popupPrefab;
    public RectTransform popupParent; // MainCanvas
    public Camera mainCam;

    void Awake()
    {
        if (Instance == null) Instance = this;
        else Destroy(gameObject);

        if (mainCam == null) mainCam = Camera.main;
    }

    public void SpawnPopup(Vector3 worldPosition, int damageAmount)
    {
        if (popupPrefab == null || popupParent == null)
        {
            Debug.LogError("âŒ DamagePopupManager: Prefab veya parent eksik!");
            return;
        }

        // World position â†’ screen position
        Vector3 screenPos = mainCam.WorldToScreenPoint(worldPosition + Vector3.up * 1f);

        // Screen position â†’ local UI position
        Vector2 localPos;
        RectTransformUtility.ScreenPointToLocalPointInRectangle(popupParent, screenPos, mainCam, out localPos);

        GameObject popup = Instantiate(popupPrefab, popupParent);
        popup.GetComponent<RectTransform>().anchoredPosition = localPos;

        var damageScript = popup.GetComponent<DamagePopup>();
        if (damageScript != null)
            damageScript.Setup(damageAmount);
    }
}
// DayNightCycle.cs
using UnityEngine;
using System;
public class DayNightCycle : MonoBehaviour
{

public static DayNightCycle Instance { get; private set; }
public static event System.Action<bool> OnDayNightChanged; // true = day, false = night

public bool IsDay => isDay;



    public float dayDuration = 30f;
    public float nightDuration = 30f;
    private float timer = 0f;

    public LightController lightController;
    public ResourceSpawner spawner;
    public EnemyManager enemyManager;


    [Range(0f, 1f)]
    public float regenerationRatio = 0.5f;

    private bool isDay = true;

    // âœ… SAHNE HER AÃ‡ILDIÄINDA Ã‡AÄRILACAK
    void Awake()
    {
         Instance = this;
        ResetCycle();
    }

    // (Ä°stersen OnEnableâ€™da da gÃ¼venceye alabilirsin)
    void OnEnable()
    {
        // ResetCycle();  // Awake yetmiyorsa bunu da aÃ§
    }

    void Update()
{
    timer -= Time.deltaTime;

    if (timer <= 0f)
    {
        isDay = !isDay;
        timer = isDay ? dayDuration : nightDuration;

        OnDayNightChanged?.Invoke(isDay); // âœ… GÃœNDEMÄ°ZDE BU Ã‡OK Ã–NEMLÄ°

        if (isDay) HandleDayStart();
        else       HandleNightStart();
    }
}


    // âœ… YENÄ°: BaÅŸtan kurulum
    public void ResetCycle()
{
    Debug.Log("ğŸ”¥ ResetCycle Ã‡AÄRILDI! GÃœNDÃœZ BAÅLATILIYOR!");

    // ğŸ”¥ TÃ¼m gece/gÃ¼ndÃ¼z mÃ¼ziklerini sÄ±fÄ±rla
    if (MusicManager.Instance != null)
    {
        MusicManager.Instance.StopAll();  // â† Ekliyoruz
    }

    // ğŸ•’ Oyunun her yeni yÃ¼kleniÅŸi GÃœNDÃœZ baÅŸlayacaksa:
    isDay = true;
    timer = dayDuration;

    // EÄŸer ileride gece baÅŸlamasÄ±nÄ± istersen bunu false yaparsÄ±n.
    
    // ğŸ”† GÃ¼ndÃ¼z setup
    lightController?.SetDay(true);
    enemyManager?.ResetDayCount();
    spawner?.RegenerateResources(0f);
    SetAnimalsNightState(false);

    // ğŸµ Temiz gÃ¼ndÃ¼z mÃ¼ziÄŸi *tek baÅŸÄ±na* Ã§alsÄ±n
    MusicManager.Instance?.SetDay(true);
}


    void HandleDayStart()
    {
        spawner?.RegenerateResources(regenerationRatio);
        SetAnimalsNightState(false);
        lightController?.SetDay(true);
        MusicManager.Instance?.SetDay(true);
    }

    void HandleNightStart()
    {
        enemyManager?.SpawnEnemies();
        SetAnimalsNightState(true);
        lightController?.SetDay(false);
        MusicManager.Instance?.SetDay(false);
    }

    void SetAnimalsNightState(bool night)
    {
        foreach (var a in FindObjectsOfType<Animal>())
            a.SetNight(night);
    }
}
using UnityEngine;

public class EnemyManager : MonoBehaviour
{
    [Header("DÃ¼ÅŸman AyarlarÄ±")]
    public GameObject[] enemyPrefabs;
    public Transform[] spawnPoints;

    [Header("Gece BaÅŸÄ±na Ayarlar")]
    public int baseEnemyCount = 5;
    public float enemyCountIncreasePerDay = 2f;
    private int currentDay = 1;

    public SpawnZoneManager spawnZoneManager; // Inspectorâ€™dan sÃ¼rÃ¼kle bÄ±rak


    // ğŸ”¹ EK: Belirli bÃ¶lgelerde ekstra GEZGÄ°N (sadece Normal/Fast)
    [System.Serializable]
    public class ExtraWanderGroup
    {
        public WanderArea area;                 // BÃ¶lge
        public GameObject[] wanderPrefabs;      // Sadece EnemyType.Normal / EnemyType.Fast olan prefabler
        public int extraCount = 3;              // KaÃ§ tane
    }
    public ExtraWanderGroup[] extraWanderGroups;

    public void SpawnEnemies()
    {
        if (enemyPrefabs.Length == 0 || spawnPoints.Length == 0)
        {
            Debug.LogWarning("âŒ EnemyManager: Prefab veya spawn noktasÄ± eksik!");
            return;
        }

        int total = Mathf.RoundToInt(baseEnemyCount + (currentDay - 1) * enemyCountIncreasePerDay);
        Debug.Log($"ğŸŒ™ Gece {currentDay}. Toplam dÃ¼ÅŸman: {total}");

        // ğŸ”¸ 1) NORMAL spawnlar (kovalamaya devam eder)
        for (int i = 0; i < total; i++)
        {
            int enemyIndex = Random.Range(0, enemyPrefabs.Length);
            int spawnPointIndex = i % spawnPoints.Length;
            Instantiate(enemyPrefabs[enemyIndex], spawnPoints[spawnPointIndex].position, Quaternion.identity);
        }

        // ğŸ”¹ 2) EKSTRA gezginler (yalnÄ±zca Normal/Fast)
        SpawnExtraWanderers();

        currentDay++;

        if (spawnZoneManager != null)
    spawnZoneManager.SpawnAllZones();

    }

    private void SpawnExtraWanderers()
    {
        if (extraWanderGroups == null) return;

        foreach (var g in extraWanderGroups)
        {
            if (g == null || g.area == null || g.wanderPrefabs == null || g.wanderPrefabs.Length == 0) continue;

            for (int i = 0; i < g.extraCount; i++)
            {
                var prefab = g.wanderPrefabs[Random.Range(0, g.wanderPrefabs.Length)];
                Vector2 pos = g.area.GetRandomPoint();
                var go = Instantiate(prefab, pos, Quaternion.identity);

                // Tip kontrolÃ¼ (sadece Normal/Fast olmalÄ±)
                var e = go.GetComponent<Enemy>();
                if (e == null)
                {
                    Debug.LogWarning("[EnemyManager] Ekstra wander prefabÄ±nda Enemy component yok.");
                    continue;
                }
                if (e.enemyType != EnemyType.Normal && e.enemyType != EnemyType.Fast)
                {
                    Debug.LogWarning($"[EnemyManager] {go.name} enemyType={e.enemyType}. Ekstra wander iÃ§in Normal/Fast seÃ§in.");
                }

                // GEZGÄ°N sÃ¼rÃ¼cÃ¼yÃ¼ ekle ve alanÄ± baÄŸla
                var driver = go.GetComponent<EnemyWanderDriver>();
                if (!driver) driver = go.AddComponent<EnemyWanderDriver>();
                driver.area = g.area;
            }
        }
    }

    public void ResetDayCount() { currentDay = 1; }
}
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.InputSystem;

public class GameManager : MonoBehaviour
{
    public static GameManager Instance;

    public int requiredFuel = 4;
    private int currentFuel = 0;

    public GameObject gameOverPanel;

    private void Start()
{
    var player = GameObject.FindWithTag("Player");
    if (player != null)
    {
        var stats = player.GetComponent<PlayerStats>();
        if (stats != null)
        {
            stats.onDeath += GameOver;   // ğŸ”¥ Ã–lÃ¼nce GameOver tetikleniyor
            Debug.Log("âœ” Player death event GameManager'a baÄŸlandÄ±.");
        }
        else
        {
            Debug.LogError("âŒ PlayerStats component bulunamadÄ±!");
        }
    }
    else
    {
        Debug.LogError("âŒ 'Player' tag'Ä±na sahip obje bulunamadÄ±!");
    }
}

private void OnSceneLoaded(Scene scene, LoadSceneMode mode)
{
    if (scene.name == "MainMenu")
        return;

    // Yeni Sahne â†’ DayNightCycle var mÄ±?
    var cycle = FindObjectOfType<DayNightCycle>();
    if (cycle != null)
    {
        Debug.Log("ğŸ”¥ SceneLoaded â†’ ResetCycle() Ã§aÄŸrÄ±lÄ±yor!");
        cycle.ResetCycle();
    }
    else
    {
        Debug.LogError("âŒ DayNightCycle SAHNEDE YOK!");
    }
}


    private void Awake()
    {
        if (Instance == null)
            Instance = this;
        else
            Destroy(gameObject);
             SceneManager.sceneLoaded += OnSceneLoaded;

    }



    public void AddFuel(int amount)
    {
        currentFuel += amount;
        Debug.Log($"â›½ YakÄ±t toplandÄ±: {currentFuel}/{requiredFuel}");
    }

    public bool HasAllFuel()
    {
        return currentFuel >= requiredFuel;
    }

    public void LoadNextScene()
    {
        Debug.Log("ğŸšš TÃ¼m yakÄ±tlar toplandÄ±, sonraki sahneye geÃ§iliyor...");
        int currentIndex = SceneManager.GetActiveScene().buildIndex;

        // ğŸ§  Oyuncunun en son oynadÄ±ÄŸÄ± bÃ¶lÃ¼mÃ¼ hatÄ±rla
        PlayerPrefs.SetInt("LastLevel", currentIndex + 1);
        PlayerPrefs.Save();

        // ğŸ¬ Sonraki sahneye geÃ§
        SceneManager.LoadScene(currentIndex + 1);
    }

    public void GameOver()
    {
        if (gameOverPanel != null)
        {
            gameOverPanel.SetActive(true);
            Time.timeScale = 0f;

            GameStateManager.IsGameOver = true;

            // Oyuncu inputunu kapat
            var player = GameObject.FindWithTag("Player");
            if (player != null)
            {
                var input = player.GetComponent<PlayerInput>();
                if (input != null) input.enabled = false;

                var controller = player.GetComponent<PlayerMovement>();
                if (controller != null) controller.enabled = false;
            }
        }
    }


    public void RestartGame()
    {
        GameStateManager.IsGameOver = false;
        GameStateManager.ResetGameState();
        Time.timeScale = 1f;
        SceneManager.LoadScene(SceneManager.GetActiveScene().name);
    }

   public void ReturnToMainMenu()
{
    Debug.Log("ğŸ Ana menÃ¼ye dÃ¶nÃ¼lÃ¼yor...");

    // Oyun hÄ±zÄ±nÄ± sÄ±fÄ±rla
    Time.timeScale = 1f;

    // GameState reset
    GameStateManager.IsGameOver = false;
    GameStateManager.ResetGameState();

    // ğŸ”¥ SAHNEDEKÄ° TÃœM SESLERÄ° DURDUR (Bolum1 dahil)
    StopAllSceneAudio();

    // Ana MenÃ¼ sahnesine geÃ§
    SceneManager.LoadScene("MainMenu");
}

private void StopAllSceneAudio()
{
    AudioSource[] allAudioSources = FindObjectsOfType<AudioSource>();

    foreach (AudioSource audio in allAudioSources)
    {
        audio.Stop();
        audio.enabled = false;   // ğŸ”¥ MÃ¼zik tekrar baÅŸlamasÄ±n
    }

    Debug.Log("ğŸ”‡ Bolum1 iÃ§indeki TÃœM sesler durduruldu!");
}



}
// GameSceneBootstrap.cs (Ã¶rnek)
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.InputSystem;

public class GameSceneBootstrap : MonoBehaviour
{
    public bool hideCursorInGame = true;
    public CursorLockMode lockMode = CursorLockMode.Confined;

    void Awake()
    {
        // Oyun akÄ±ÅŸÄ± aÃ§Ä±k olsun
        Time.timeScale = 1f;

        // Cursor ayarÄ±
        Cursor.visible   = !hideCursorInGame;
        Cursor.lockState = lockMode;

        // ğŸ”§ HATA VEREN SATIRI SÄ°L:
        // PauseMenu.IsPaused = false;

        // âœ… Yerine ÅŸunu kullan:
        var pm = PauseMenu.Instance ?? FindObjectOfType<PauseMenu>();
        if (pm != null) pm.ResumeGame();

        // (Ä°steÄŸe baÄŸlÄ±) DiÄŸer panelleri de kapat
        if (NPCInteraction.Instance != null)       NPCInteraction.Instance.CloseTradePanel();

        // PlayerInput action map'i Gameplay'e zorla (kullanÄ±yorsan)
        foreach (var pi in FindObjectsOfType<PlayerInput>(includeInactive: true))
        {
            if (pi.actions != null && pi.actions.FindActionMap("Gameplay") != null)
                pi.SwitchCurrentActionMap("Gameplay");
        }

        // EventSystem Ã§akÄ±ÅŸmasÄ±nÄ± Ã¶nle
        var allEventSystems = FindObjectsOfType<EventSystem>();
        for (int i = 1; i < allEventSystems.Length; i++)
            Destroy(allEventSystems[i].gameObject);
    }
}
// Assets/Scripts/Managers/GameStateManager.cs
public static class GameStateManager
{
    public static bool IsGamePaused =>
        PauseMenu.IsPaused ||
        NPCInteraction.IsTradeOpen;
    public static bool IsGameOver = false;

    public static void ResetGameState()
    {
        IsGameOver = false;
    }


}
using UnityEngine;
using UnityEngine.Rendering.Universal;

public class LightController : MonoBehaviour
{
    [Header("Global Light")]
    public Light2D globalLight;

    [Header("Time Of Day")]
    [Range(0, 24)]
    public float timeOfDay = 8f;     // 0â€“24 arasÄ± saat
    public float daySpeed = 0.25f;   // GÃ¼nÃ¼n akÄ±ÅŸ hÄ±zÄ±

    [Header("Colors")]
    public Color morningColor = new Color(1f, 0.78f, 0.63f);   // Sabah
    public Color noonColor    = new Color(1f, 1f, 0.9f);       // Ã–ÄŸle
    public Color afternoonColor = new Color(1f, 0.86f, 0.7f);  // Ä°kindi
    public Color eveningColor = new Color(1f, 0.63f, 0.47f);   // AkÅŸam
    public Color nightColor   = new Color(0.16f, 0.23f, 0.47f); // Gece

    [Header("Intensity")]
    public float morningIntensity   = 0.8f;
    public float noonIntensity      = 1.0f;
    public float afternoonIntensity = 0.7f;
    public float eveningIntensity   = 0.5f;
    public float nightIntensity     = 0.25f;

    public float transitionSpeed = 2f;

    private Color targetColor;
    private float targetIntensity;

    // DayNightCycle burayÄ± kullanÄ±yor
    private bool isDay = true;

    private void Awake()
    {
        if (globalLight == null)
            globalLight = GetComponent<Light2D>();

        // GÃ¼venli baÅŸlangÄ±Ã§
        SetDay(true);
    }

    private void Update()
    {
        if (globalLight == null) return;

        if (isDay)
        {
            // Sadece gÃ¼ndÃ¼z vakti saat akÄ±yor
            timeOfDay += Time.deltaTime * daySpeed;

            // GÃ¼ndÃ¼z aralÄ±ÄŸÄ±: 06â€“21
            if (timeOfDay < 6f)  timeOfDay = 6f;
            if (timeOfDay > 21f) timeOfDay = 6f;

            // Sabah: 06â€“09
            if (timeOfDay >= 6f && timeOfDay < 9f)
            {
                targetColor = morningColor;
                targetIntensity = morningIntensity;
            }
            // Ã–ÄŸle: 09â€“15
            else if (timeOfDay >= 9f && timeOfDay < 15f)
            {
                targetColor = noonColor;
                targetIntensity = noonIntensity;
            }
            // Ä°kindi: 15â€“18
            else if (timeOfDay >= 15f && timeOfDay < 18f)
            {
                targetColor = afternoonColor;
                targetIntensity = afternoonIntensity;
            }
            // AkÅŸam: 18â€“21
            else if (timeOfDay >= 18f && timeOfDay < 21f)
            {
                targetColor = eveningColor;
                targetIntensity = eveningIntensity;
            }
        }
        else
        {
            // Gece modunda sabit deÄŸer
            targetColor = nightColor;
            targetIntensity = nightIntensity;
        }

        // YumuÅŸak geÃ§iÅŸ
        globalLight.color = Color.Lerp(globalLight.color, targetColor, Time.deltaTime * transitionSpeed);
        globalLight.intensity = Mathf.Lerp(globalLight.intensity, targetIntensity, Time.deltaTime * transitionSpeed);
    }

    /// <summary>
    /// DayNightCycle burayÄ± Ã§aÄŸÄ±rÄ±yor.
    /// true = gÃ¼ndÃ¼z, false = gece
    /// </summary>
    public void SetDay(bool day)
    {
        isDay = day;

        if (!isDay)
        {
            // Geceye geÃ§erken hedefleri direkt geceye Ã§ek
            targetColor = nightColor;
            targetIntensity = nightIntensity;
        }
        else
        {
            // GÃ¼ndÃ¼ze geÃ§erken zamanÄ± sabaha zorlayabilirsin
            if (timeOfDay < 6f || timeOfDay > 21f)
                timeOfDay = 6f; // sabah baÅŸlasÄ±n
        }
    }
}
using UnityEngine;

public class SettingsLoader : MonoBehaviour
{
    void Awake()
    {
        // Bu objeyi sahne deÄŸiÅŸse bile yok etme
        DontDestroyOnLoad(gameObject);

        // MÃ¼zik sesi
        AudioListener.volume = PlayerPrefs.GetFloat("MusicVolume", 1f);

        // Grafik kalitesi
        QualitySettings.SetQualityLevel(
            PlayerPrefs.GetInt("QualityLevel", QualitySettings.GetQualityLevel())
        );

        // Tam ekran
        Screen.fullScreen = PlayerPrefs.GetInt("Fullscreen", 1) == 1;
    }
}
using UnityEngine;

public class SpawnZoneManager : MonoBehaviour
{
    [System.Serializable]
    public class ZoneSpawn
    {
        public WanderArea area;
        public GameObject[] enemyPrefabs;
        public int count = 5;
        public bool addWanderer = true;  // ArtÄ±k EnemyWanderDriver anlamÄ±na geliyor
        public float spreadPadding = 0.2f;
    }

    public ZoneSpawn[] zones;

    [ContextMenu("Spawn All Zones")]
    public void SpawnAllZones()
    {
        foreach (var z in zones)
        {
            if (z.area == null || z.enemyPrefabs == null || z.enemyPrefabs.Length == 0) continue;

            for (int i = 0; i < z.count; i++)
            {
                var prefab = z.enemyPrefabs[Random.Range(0, z.enemyPrefabs.Length)];
                Vector2 p = z.area.GetRandomPoint() + Random.insideUnitCircle * z.spreadPadding;

                var go = Instantiate(prefab, p, Quaternion.identity);

                if (!z.addWanderer) continue;

                var enemy = go.GetComponent<Enemy>();
                if (!enemy)
                {
                    Debug.LogWarning("[SpawnZoneManager] Prefab'ta Enemy yok.");
                    continue;
                }

                // Sadece Normal / Fast olan ekstra dÃ¼ÅŸmanlarÄ± wander yap
                if (enemy.enemyType != EnemyType.Normal && enemy.enemyType != EnemyType.Fast)
                    continue;

                var driver = go.GetComponent<EnemyWanderDriver>();
                if (!driver) driver = go.AddComponent<EnemyWanderDriver>();

                // AlanÄ± baÄŸla ve waypoint'i hemen hedef yap
                driver.Setup(z.area); // â†“ aÅŸaÄŸÄ±daki kÃ¼Ã§Ã¼k metodu ekle
            }
        }
    }
}
using UnityEngine;

[RequireComponent(typeof(BoxCollider2D))]
public class WanderArea : MonoBehaviour
{
    private BoxCollider2D box;

    void Awake() { box = GetComponent<BoxCollider2D>(); }

    public Vector2 GetRandomPoint()
    {
        var center = (Vector2)transform.TransformPoint(box.offset);
        var size   = Vector2.Scale(box.size, (Vector2)transform.lossyScale);
        float rx = Random.Range(-size.x * 0.5f, size.x * 0.5f);
        float ry = Random.Range(-size.y * 0.5f, size.y * 0.5f);
        return center + new Vector2(rx, ry);
    }

#if UNITY_EDITOR
    void OnDrawGizmosSelected()
    {
        var b = GetComponent<BoxCollider2D>();
        if (!b) return;
        Gizmos.color = Color.cyan;
        var center = (Vector2)transform.TransformPoint(b.offset);
        var size   = Vector2.Scale(b.size, (Vector2)transform.lossyScale);
        Gizmos.DrawWireCube(center, size);
    }
#endif
}
using UnityEngine;
using UnityEngine.UI;

public static class CanvasScalerUpdater
{
    public static void UpdateAllCanvasScalers()
    {
        float x = PlayerPrefs.GetFloat("ResX", 1920);
        float y = PlayerPrefs.GetFloat("ResY", 1080);

        CanvasScaler[] scalers = Resources.FindObjectsOfTypeAll<CanvasScaler>();

        foreach (CanvasScaler scaler in scalers)
        {
            // Sadece sahnedeki CanvasScalerâ€™lara uygula (Prefab deÄŸil)
            if (scaler.gameObject.scene.isLoaded)
                scaler.referenceResolution = new Vector2(x, y);
        }
    }
}
using UnityEngine;

public class EscapeHandler : MonoBehaviour, PlayerControls.IGameplayActions
{
    private PlayerControls controls;

    public GameObject inventoryPanel;
    public GameObject craftPanel;
    public GameObject tradePanel;
    public GameObject pauseMenu;   // artÄ±k kullanÄ±lmayacak ama referansÄ± kalsÄ±n

    private bool AnyPanelOpen =>
        (inventoryPanel && inventoryPanel.activeSelf) ||
        (craftPanel && craftPanel.activeSelf) ||
        (tradePanel && tradePanel.activeSelf);

    private void Awake()
    {
        controls = new PlayerControls();
        controls.Gameplay.SetCallbacks(this);
    }

    private void OnEnable()
    {
        controls.Gameplay.Enable();
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

    public void OnEscape(UnityEngine.InputSystem.InputAction.CallbackContext ctx)
{
    if (!ctx.performed) return;

    HandleEscape();
}

    private void HandleEscape()
    {
        // 1) EÄŸer Inventory / Craft / Trade aÃ§Ä±k ise â†’ sadece onlarÄ± kapat
        if (AnyPanelOpen)
        {
            if (inventoryPanel) inventoryPanel.SetActive(false);
            if (craftPanel) craftPanel.SetActive(false);
            if (tradePanel) tradePanel.SetActive(false);

            Time.timeScale = 1f;
            return;
        }

        // âŒ 2) PauseMenu'yu artÄ±k EscapeHandler KESÄ°NLÄ°KLE YÃ–NETMÄ°YOR âŒ
        // PauseMenu tamamen PauseMenu.cs tarafÄ±ndan kontrol edilecek.
    }

    // kullanÄ±lmayan callbacks:
    public void OnMove(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnSprint(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnMap(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnInventory(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnCraft(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnReload(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnWeapon1(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnWeapon2(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnWeapon3(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnMelee(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnADS(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnShoot(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
    public void OnCaravanWeapons(UnityEngine.InputSystem.InputAction.CallbackContext ctx) {}
}
using UnityEngine;

public class PanelController : MonoBehaviour
{
    public void Open()
    {
        UIPanelSystem.Instance.OpenPanel(gameObject);
    }

    public void Close()
    {
        UIPanelSystem.Instance.CloseCurrentPanel();
    }
}
using UnityEngine;
using UnityEngine.InputSystem;

public class PlayerInputRouter : MonoBehaviour, PlayerControls.IGameplayActions
{
    private PlayerControls controls;

    [Header("Referans Paneller")]
    public GameObject inventoryPanel;
    public GameObject craftPanel;
    public GameObject tradePanel;
    public GameObject pauseMenuPanel;

    private void Awake()
    {
        controls = new PlayerControls();
        controls.Gameplay.SetCallbacks(this);
    }

    private void OnEnable() => controls.Gameplay.Enable();
    private void OnDisable() => controls.Gameplay.Disable();

    // ---------------- PANEL INPUT -------------------

    public void OnInventory(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;
        if (UIPanelSystem.Instance.IsPanelOpen()) return;

        UIPanelSystem.Instance.OpenPanel(inventoryPanel);
    }

    public void OnCraft(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;
        if (UIPanelSystem.Instance.IsPanelOpen()) return;

        UIPanelSystem.Instance.OpenPanel(craftPanel);
    }

    public void OnTrade(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;
        if (UIPanelSystem.Instance.IsPanelOpen()) return;

        UIPanelSystem.Instance.OpenPanel(tradePanel);
    }

    public void OnEscape(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;

        if (UIPanelSystem.Instance.IsPanelOpen())
        {
            UIPanelSystem.Instance.CloseCurrentPanel();
        }
        else
        {
            UIPanelSystem.Instance.OpenPanel(pauseMenuPanel);
        }
    }

    // ------------- ARAYÃœZ ZORUNLU FONKSIYONLAR --------------

    public void OnMove(InputAction.CallbackContext ctx) { }
    public void OnSprint(InputAction.CallbackContext ctx) { }
    public void OnMap(InputAction.CallbackContext ctx) { }
    public void OnReload(InputAction.CallbackContext ctx) { }
    public void OnWeapon1(InputAction.CallbackContext ctx) { }
    public void OnWeapon2(InputAction.CallbackContext ctx) { }
    public void OnWeapon3(InputAction.CallbackContext ctx) { }
    public void OnMelee(InputAction.CallbackContext ctx) { }
    public void OnADS(InputAction.CallbackContext ctx) { }
    public void OnCaravanWeapons(InputAction.CallbackContext ctx) { }
}
using UnityEngine;
using TMPro;

public class ResolutionChanger : MonoBehaviour
{
    public TMP_Dropdown resolutionDropdown;

    private readonly Vector2[] resolutions =
    {
        new Vector2(320,200),
        new Vector2(320,240),
        new Vector2(400,300),
        new Vector2(512,384),
        new Vector2(640,400),
        new Vector2(640,480),
        new Vector2(800,600),
        new Vector2(1024,768),
        new Vector2(1152,864),
        new Vector2(1280,600),
        new Vector2(1280,720),
        new Vector2(1280,768),
        new Vector2(1280,800),
        new Vector2(1280,960),
        new Vector2(1280,1024),
        new Vector2(1360,768),
        new Vector2(1366,768),
        new Vector2(1400,1050),
        new Vector2(1440,900),
        new Vector2(1600,900),
        new Vector2(1680,1050),
        new Vector2(1920,1080),
        
    };

    private void Start()
    {
        int saved = PlayerPrefs.GetInt("ResolutionIndex", 0);
        resolutionDropdown.value = saved;
        resolutionDropdown.onValueChanged.AddListener(SetResolution);
    }

    private void SetResolution(int index)
    {
        Vector2 res = resolutions[index];

        PlayerPrefs.SetFloat("ResX", res.x);
        PlayerPrefs.SetFloat("ResY", res.y);
        PlayerPrefs.SetInt("ResolutionIndex", index);
        PlayerPrefs.Save();

        CanvasScalerUpdater.UpdateAllCanvasScalers();
    }
}
using UnityEngine;
using System.Collections;

public class ResolutionInitializer : MonoBehaviour
{
    private void Start()
    {
        StartCoroutine(ApplyDelayed());
    }

    IEnumerator ApplyDelayed()
    {
        yield return null; // 1 frame gecikme
        CanvasScalerUpdater.UpdateAllCanvasScalers();
    }
}
using UnityEngine;
using System.Collections.Generic;

public class UIPanelSystem : MonoBehaviour
{
    public static UIPanelSystem Instance;

    [Header("Ana Canvas (Canvas kÃ¶k)")]
    public Canvas mainCanvas;

    [Header("TÃ¼m Paneller (Inspectorâ€™dan ekle)")]
    public List<GameObject> allPanels;

    private GameObject currentPanel;

    private void Awake()
    {
        Instance = this;
    }

    public bool IsPanelOpen() => currentPanel != null;

    // ------------------ PANEL AÃ‡MA ------------------

    public void OpenPanel(GameObject panel)
    {
        CloseAllPanels();             // Ã–nce hepsini kapat
        currentPanel = panel;

        panel.SetActive(true);

        HideEverythingExcept(panel);
        Time.timeScale = 0f;
    }

    // ------------------ PANEL KAPATMA ------------------

    public void CloseCurrentPanel()
    {
        if (currentPanel != null)
        {
            currentPanel.SetActive(false);
            currentPanel = null;
        }

        ShowEverything();
        Time.timeScale = 1f;
    }

    public void CloseAllPanels()
    {
        foreach (var p in allPanels)
            p.SetActive(false);

        currentPanel = null;
    }

    // ------------------ TÃœM UIâ€™YÄ° GÄ°ZLE / GÃ–STER ------------------

    private void HideEverythingExcept(GameObject panel)
    {
        foreach (Transform t in mainCanvas.transform)
        {
            if (t.gameObject != panel)
                t.gameObject.SetActive(false);
        }
    }

    private void ShowEverything()
    {
        foreach (Transform t in mainCanvas.transform)
            t.gameObject.SetActive(true);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class MapToggle : MonoBehaviour
{
    [Header("UI ReferanslarÄ±")]
    public GameObject mapPanel;
    public RectTransform mapRect;
    public RectTransform playerMarker;

    [Header("Oyuncu ve Ayarlar")]
    public Transform player;
    public float mapScale = 1f;

    private bool isMapVisible = false;
    private Vector3 mapBottomLeft;
    private PlayerControls controls; // Script kendi oluÅŸturacak

    private void Awake()
    {
        // PlayerControls Ã¶rneÄŸini oluÅŸtur
        controls = new PlayerControls();
    }

    private void OnEnable()
    {
        // Map tuÅŸuna basÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak eventâ€™leri baÄŸla
        controls.Gameplay.Map.performed += OnMapPressed;
        controls.Gameplay.Map.canceled += OnMapReleased;
        controls.Gameplay.Enable();

        if (mapPanel != null)
            mapPanel.SetActive(false);

        if (mapRect != null)
        {
            Vector3[] corners = new Vector3[4];
            mapRect.GetWorldCorners(corners);
            mapBottomLeft = corners[0];
        }
    }

    private void OnDisable()
    {
        controls.Gameplay.Map.performed -= OnMapPressed;
        controls.Gameplay.Map.canceled -= OnMapReleased;
        controls.Gameplay.Disable();
    }

    private void OnMapPressed(InputAction.CallbackContext context)
    {
        if (mapPanel == null) return;

        mapPanel.SetActive(true);
        isMapVisible = true;
        Debug.Log("ğŸ—ºï¸ Harita aÃ§Ä±ldÄ± (Tab basÄ±ldÄ±)");
    }

    private void OnMapReleased(InputAction.CallbackContext context)
    {
        if (mapPanel == null) return;

        mapPanel.SetActive(false);
        isMapVisible = false;
        Debug.Log("âŒ Harita kapandÄ± (Tab bÄ±rakÄ±ldÄ±)");
    }

    private void Update()
    {
        if (isMapVisible)
            UpdatePlayerMarker();
    }

    private void UpdatePlayerMarker()
    {
        if (player == null || playerMarker == null || mapRect == null) return;

        // 2D pozisyon hesaplama
        Vector3 worldOffset = player.position;
        Vector2 mapPos = new Vector2(worldOffset.x, worldOffset.y) * mapScale;

        Vector3[] corners = new Vector3[4];
        mapRect.GetWorldCorners(corners);
        mapBottomLeft = corners[0];

        Vector2 anchored = new Vector2(
            mapPos.x + (mapRect.rect.width / 2),
            mapPos.y + (mapRect.rect.height / 2)
        );

        playerMarker.anchoredPosition = anchored;
    }
}
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.Events;

public class CreditsAutoScroll : MonoBehaviour
{
    [Header("Refs")]
    public ScrollRect scrollRect;

    [Header("Ayarlar")]
    public float speed = 20f;      // px/sn
    public float topHold = 0.5f;   // baÅŸlamadan Ã¶nce bekleme
    public float bottomHold = 1f;  // en altta bekleme (kapanmadan Ã¶nce)

    [Header("BitiÅŸ DavranÄ±ÅŸÄ±")]
    public bool closePanelOnFinish = false;
    public GameObject panelToClose;             // credits paneli
    public UnityEvent onFinished;               // bittiÄŸinde tetiklenir

    private RectTransform contentRT;
    private RectTransform viewportRT;
    private bool running;

    void OnEnable()
    {
        if (scrollRect == null || scrollRect.content == null) return;

        // Viewport boÅŸ bÄ±rakÄ±lmÄ±ÅŸsa ilk Ã§ocuk olarak ayarla
        if (scrollRect.viewport == null)
            scrollRect.viewport = scrollRect.transform.GetChild(0).GetComponent<RectTransform>();

        contentRT  = scrollRect.content;
        viewportRT = scrollRect.viewport;

        StartCoroutine(ScrollRoutine());
    }

    System.Collections.IEnumerator ScrollRoutine()
    {
        running = true;

        // BaÅŸta en Ã¼ste getir
        scrollRect.verticalNormalizedPosition = 1f;

        // Layout otursun
        yield return new WaitForSeconds(topHold);
        yield return null; // 1 frame

        // Ä°Ã§erik gÃ¶rÃ¼nÃ¼r alandan kÄ±sa ise Ã§Ä±k
        float h = Mathf.Max(0f, contentRT.rect.height - viewportRT.rect.height);
        if (h <= 1f) { Finish(); yield break; }

        // AkÄ±ÅŸ: 1 -> 0
        while (running && contentRT != null)
        {
            // hÄ±z (px/sn) -> normalized adÄ±m
            float step = (speed * Time.unscaledDeltaTime) / h;
            scrollRect.verticalNormalizedPosition -= step;

            if (scrollRect.verticalNormalizedPosition <= 0f)
            {
                scrollRect.verticalNormalizedPosition = 0f;
                // En alta ulaÅŸtÄ±k => bekle ve bitir
                if (bottomHold > 0f) yield return new WaitForSeconds(bottomHold);
                Finish();
                yield break;
            }

            yield return null;
        }
    }

    void Finish()
    {
        running = false;
        onFinished?.Invoke();

        if (closePanelOnFinish && panelToClose != null)
            panelToClose.SetActive(false);
    }

    void OnDisable() { running = false; }
}
// CreditsBuilder.cs
using UnityEngine;
using TMPro;
using UnityEngine.UI;

public class CreditsBuilder : MonoBehaviour
{
    [System.Serializable]
    public class Section
    {
        public string title;
        [TextArea] public string[] lines;
    }

    public Transform content;           // Scroll View -> Viewport -> Content
    public TextMeshProUGUI sectionTitlePrefab;
    public TextMeshProUGUI linePrefab;

    public Section[] sections;

    void Start()
    {
        Build();
    }


    public void Build()
    {
        foreach (Transform child in content) Destroy(child.gameObject);

        foreach (var s in sections)
        {
            if (!string.IsNullOrEmpty(s.title))
            {
                var title = Instantiate(sectionTitlePrefab, content);
                title.text = $"<b>{s.title}</b>";
            }

            foreach (var line in s.lines)
            {
                var l = Instantiate(linePrefab, content);
                l.text = line;
            }

            var spacer = Instantiate(linePrefab, content);
            spacer.text = "\n";
        }

        // --- kritik: layoutâ€™Ä± hemen hesaplat ---
        LayoutRebuilder.ForceRebuildLayoutImmediate((RectTransform)content);

        // baÅŸtan baÅŸla
        ((RectTransform)content).anchoredPosition = Vector2.zero;
    }


}
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.InputSystem;

public class MainMenu : MonoBehaviour
{
    [Header("MÃ¼zik")]
    public AudioSource musicSource;
    public AudioClip menuMusic;

    [Header("UI Panelleri")]
    public GameObject mainPanel;
    public GameObject settingsPanel;
    public GameObject creditsPanel;
    public GameObject levelPanel;

    private bool isInSettings = false;
    private bool isInLevels = false;
    private bool isInCredits = false;

    private void Start()
    {
        // ğŸ”¥ Oyun sahnesinden gelen MusicManager varsa yok et
        if (MusicManager.Instance != null)
            Destroy(MusicManager.Instance.gameObject);

        // ğŸ”¥ TimeScale sÄ±fÄ±r kalmÄ±ÅŸ olabilir. MenÃ¼de kesinlikle 1 olsun.
        Time.timeScale = 1f;

        StartCoroutine(PlayMusicWithDelay(0.25f));  

        // Devam Et butonunu aktif/pasif yap
        var continueBtn = GameObject.Find("Continue Button")?.GetComponent<UnityEngine.UI.Button>();
        if (continueBtn != null)
            continueBtn.interactable = SaveSystem.HasSave();
    }

    private System.Collections.IEnumerator PlayMusicWithDelay(float delay)
    {
        yield return new WaitForSecondsRealtime(delay);

        if (musicSource != null && menuMusic != null)
        {
            musicSource.clip = menuMusic;
            musicSource.loop = true;
            musicSource.volume = 1f;

            // Mixer Ã§Ä±kÄ±ÅŸÄ±nÄ± bypass et â†’ test iÃ§in en temiz yÃ¶ntem
            musicSource.outputAudioMixerGroup = null;

            musicSource.Play();
            Debug.Log("ğŸµ Ana MenÃ¼ mÃ¼ziÄŸi BAÅLADI!");
        }
        else
        {
            Debug.LogError("âŒ musicSource veya menuMusic atanmadÄ±!");
        }
    }

    // -----------------------------------
    //           OYUN BAÅLATMA
    // -----------------------------------

    public void YeniOyunaBasla()
    {
        SaveSystem.DeleteSave();
        SaveBootstrap.ShouldLoadFromSave = false;
        SceneManager.LoadScene("Bolum1");
    }

    public void DevamEt()
    {
        if (!SaveSystem.HasSave())
            return;

        SaveBootstrap.ShouldLoadFromSave = true;
        SceneManager.LoadScene("Bolum1");
    }

    // -----------------------------------
    //           PANEL KONTROLÃœ
    // -----------------------------------
    public void OpenSettings()
    {
        mainPanel.SetActive(false);
        settingsPanel.SetActive(true);
        isInSettings = true;
    }

    public void CloseSettings()
    {
        settingsPanel.SetActive(false);
        mainPanel.SetActive(true);
        isInSettings = false;
    }

    public void OpenLevels()
    {
        mainPanel.SetActive(false);
        levelPanel.SetActive(true);
        isInLevels = true;
    }

    public void CloseLevels()
    {
        levelPanel.SetActive(false);
        mainPanel.SetActive(true);
        isInLevels = false;
    }

    public void OpenCredits()
    {
        mainPanel.SetActive(false);
        creditsPanel.SetActive(true);
        isInCredits = true;
    }

    public void CloseCredits()
    {
        creditsPanel.SetActive(false);
        mainPanel.SetActive(true);
        isInCredits = false;
    }

    public void QuitGame()
    {
        Application.Quit();
    }
}
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.InputSystem;

public class PauseMenu : MonoBehaviour
{
    public static PauseMenu Instance { get; private set; }

    public GameObject pausePanel;
    public GameObject settingsPanel;
    private bool justClosedSettings = false;


    public static bool IsPaused { get; private set; }

    private PlayerControls controls;

    private void Awake()
    {
        Instance = this;

        controls = new PlayerControls();
        controls.Gameplay.Escape.performed += ctx => OnEscapePressed();
    }

    private void OnEnable()
    {
        controls.Gameplay.Enable();
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

   private void OnEscapePressed()
{
    // ğŸ”¥ Game Over durumunda ESC hiÃ§bir ÅŸey yapamaz
    if (GameStateManager.IsGameOver)
        return;

    // ESC korumasÄ± (SettingsPanel yeni kapandÄ±ysa)
    if (justClosedSettings)
    {
        justClosedSettings = false; // Bir kere blokla
        return;
    }

    if (settingsPanel.activeSelf)
    {
        CloseSettings();
        return;
    }

    if (IsPaused)
        ResumeGame();
    else
        PauseGame();
}


    public void PauseGame()
    {
        IsPaused = true;
        pausePanel.SetActive(true);
        settingsPanel.SetActive(false);
        Time.timeScale = 0f;
    }

    public void ResumeGame()
    {
        IsPaused = false;
        pausePanel.SetActive(false);
        settingsPanel.SetActive(false);
        Time.timeScale = 1f;
    }

    public void OpenSettings()
    {
        // Settings aÃ§Ä±ldÄ±ÄŸÄ±nda PauseMenu gizlenir ama oyun duraklamaya devam eder
        IsPaused = true;
        pausePanel.SetActive(false);
        settingsPanel.SetActive(true);
    }

   public void CloseSettings()
{
    // Sadece SettingsPanel kapanÄ±r
    settingsPanel.SetActive(false);

    // PauseMenuPanel tekrar gÃ¶rÃ¼nÃ¼r olmalÄ±
    pausePanel.SetActive(true);

    // Oyun pause durumda kalmalÄ±
    IsPaused = true;
    Time.timeScale = 0f;

    // ESCâ€™nin hemen PauseMenuâ€™yu kapatmamasÄ± iÃ§in 0.2 sn koruma
    justClosedSettings = true;
    Invoke(nameof(ResetSettingsCloseFlag), 0.2f);
}


private void ResetSettingsCloseFlag()
{
    justClosedSettings = false;
}


}
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;

public class SettingsMenu : MonoBehaviour
{
    public GameObject panel;
    public Slider masterSlider;

    public Slider musicSlider;
    public Slider sfxSlider;
    public TMP_Dropdown qualityDropdown;
    public Toggle fullscreenToggle;
    public TMP_Dropdown resolutionDropdown;
    private Resolution[] resolutions;

    private void Start()
    {
        // AyarlarÄ± yÃ¼kle
        masterSlider.value = PlayerPrefs.GetFloat("MasterVolume", 1f);
        masterSlider.onValueChanged.AddListener(SetMasterVolume);

        musicSlider.value = PlayerPrefs.GetFloat("MusicVolume", 1f);
        sfxSlider.value = PlayerPrefs.GetFloat("SFXVolume", 1f);
        qualityDropdown.value = PlayerPrefs.GetInt("QualityLevel", QualitySettings.GetQualityLevel());
        fullscreenToggle.isOn = PlayerPrefs.GetInt("Fullscreen", 1) == 1;

        ApplySettings();

        resolutions = Screen.resolutions;
        resolutionDropdown.ClearOptions();

        int currentResolutionIndex = 0;
        List<string> options = new List<string>();

        for (int i = 0; i < resolutions.Length; i++)
        {
            string option = $"{resolutions[i].width} x {resolutions[i].height} ({resolutions[i].refreshRate}Hz)";
            options.Add(option);

            if (resolutions[i].width == Screen.currentResolution.width &&
                resolutions[i].height == Screen.currentResolution.height)
            {
                currentResolutionIndex = i;
            }
        }

        resolutionDropdown.AddOptions(options);
        resolutionDropdown.value = PlayerPrefs.GetInt("ResolutionIndex", currentResolutionIndex);
        resolutionDropdown.RefreshShownValue();

        resolutionDropdown.onValueChanged.AddListener(SetResolution);
        musicSlider.onValueChanged.AddListener(SetMusicVolume);
        sfxSlider.onValueChanged.AddListener(SetSFXVolume);
        qualityDropdown.onValueChanged.AddListener(SetQuality);
        fullscreenToggle.onValueChanged.AddListener(SetFullscreen);
    }

    public void OpenPanel()
    {
        panel.SetActive(true);
    }

    public void ClosePanel()
    {
        panel.SetActive(false);

        // EÄŸer ayarlar menÃ¼sÃ¼ pause menÃ¼sÃ¼nden aÃ§Ä±ldÄ±ysa, geri dÃ¶n
        if (PauseMenu.Instance != null && PauseMenu.IsPaused)
        {
            PauseMenu.Instance.CloseSettings();
        }
    }

    
    void SetResolution(int index)
    {
        Resolution res = resolutions[index];
        Screen.SetResolution(res.width, res.height, Screen.fullScreenMode);
        PlayerPrefs.SetInt("ResolutionIndex", index);
        Debug.Log($"ğŸ“º Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k deÄŸiÅŸti: {res.width}x{res.height}");
    }


    void SetMasterVolume(float value)
    {
        AudioManager.Instance?.SetMasterVolume(value);
    }


    void SetMusicVolume(float value)
    {
        AudioManager.Instance?.SetMusicVolume(value);
    }

    void SetSFXVolume(float value)
    {
        AudioManager.Instance?.SetSFXVolume(value);
    }

    void SetQuality(int index)
    {
        QualitySettings.SetQualityLevel(index);
        PlayerPrefs.SetInt("QualityLevel", index);
    }

    void SetFullscreen(bool isFullscreen)
    {
        Screen.fullScreen = isFullscreen;
        PlayerPrefs.SetInt("Fullscreen", isFullscreen ? 1 : 0);
    }

    void ApplySettings()
    {
        SetMusicVolume(musicSlider.value);
        SetSFXVolume(sfxSlider.value);
        SetQuality(qualityDropdown.value);
        SetFullscreen(fullscreenToggle.isOn);
    }
}
public enum SettingsMenuOrigin
{
    None,
    PauseMenu,
    MainMenu
}
using System.Collections;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.SceneManagement;

public class MultiImageIntroController : MonoBehaviour
{
    [System.Serializable]
    public class IntroStep
    {
        public Image image;             // GÃ¶rsel
        public AudioClip soundEffect;   // O anda Ã§alacak ses
    }

    public IntroStep[] steps;             // TÃ¼m adÄ±mlar
    public float fadeDuration = 1f;
    public float displayTime = 2f;
    public string nextSceneName = "MainMenu";

    public AudioSource audioSource;      // Ses oynatÄ±cÄ±

    private void Start()
    {
        StartCoroutine(PlayIntroSequence());
    }

    private IEnumerator PlayIntroSequence()
    {
        // BaÅŸta tÃ¼m gÃ¶rselleri kapat
        foreach (var step in steps)
        {
            step.image.gameObject.SetActive(false);
            SetAlpha(step.image, 0f);
        }

        foreach (var step in steps)
        {
            step.image.gameObject.SetActive(true);

            if (step.soundEffect != null && audioSource != null)
            {
                yield return new WaitForSeconds(1f); // 1 saniye bekle
                audioSource.clip = step.soundEffect;
                audioSource.Play();
            }


            yield return StartCoroutine(FadeImage(step.image, 0f, 1f));
            yield return new WaitForSeconds(displayTime);
            yield return StartCoroutine(FadeImage(step.image, 1f, 0f));

            step.image.gameObject.SetActive(false);
        }

        SceneManager.LoadScene(nextSceneName);
    }

    private IEnumerator FadeImage(Image img, float startAlpha, float endAlpha)
    {
        Color color = img.color;
        float elapsed = 0f;

        while (elapsed < fadeDuration)
        {
            float t = elapsed / fadeDuration;
            color.a = Mathf.Lerp(startAlpha, endAlpha, t);
            img.color = color;
            elapsed += Time.deltaTime;
            yield return null;
        }

        color.a = endAlpha;
        img.color = color;
    }

    private void SetAlpha(Image img, float alpha)
    {
        Color color = img.color;
        color.a = alpha;
        img.color = color;
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;                     // âœ… eklendi
using System.Collections.Generic;
using System.Linq;
using UnityEngine.EventSystems;

public class NPCInteraction : MonoBehaviour
{


    private readonly List<TradeOfferButton> spawned = new List<TradeOfferButton>();
    private bool layoutDone = false;

    [Header("Trade Data")]
    public List<TradeOffer> tradeOffers;

    [Header("Layout Settings (code-driven)")]
    public float rowSpacing = 8f;   // satÄ±rlar arasÄ±
    public float innerSpacing = 12f; // buton ile text arasÄ± (prefab iÃ§i HLG.spacing)

    [Header("Layout (manual)")]
    public float topPadding = 10f;
    public float bottomPadding = 10f;



    [Header("UI Refs")]
    public GameObject tradeUIPanel;
    public GameObject interactPromptUI;
    public Transform tradeOffersContainer;          // Content
    public GameObject tradeOfferButtonPrefab;       // iÃ§inde TradeOfferButton var
    public ScrollRect tradeScrollRect;              // âœ… Scroll Viewâ€™in Ã¼zerindeki ScrollRect

    private bool inertiaDefault = true;

    [Header("Auto Load (optional)")]
    public bool autoLoadFromResources = true;
    public string resourcesFolder = "Animals";

    private bool isPlayerNearby = false;
    private PlayerStats playerStats;

    public static NPCInteraction Instance { get; private set; }
    public static bool IsTradeOpen =>
        Instance != null && Instance.tradeUIPanel != null && Instance.tradeUIPanel.activeSelf;

    private void Awake() { Instance = this; }

    private void Start()
    {
        playerStats = FindObjectOfType<PlayerStats>();
        if (tradeUIPanel != null) tradeUIPanel.SetActive(false);
        if (interactPromptUI != null) interactPromptUI.SetActive(false);

        // (opsiyonel) Resourcesâ€™tan teklifleri yÃ¼kle
        if (autoLoadFromResources)
        {
            var loaded = Resources.LoadAll<TradeOffer>(resourcesFolder);
            if (loaded != null && loaded.Length > 0)
            {
                var set = new HashSet<TradeOffer>(tradeOffers);
                foreach (var t in loaded) if (!set.Contains(t)) tradeOffers.Add(t);
            }
        }

        // âœ… Content doÄŸru yapÄ±landÄ±rÄ±lmÄ±ÅŸ mÄ± emin ol (runtimeâ€™da gÃ¼venlik)

    }

    private System.Collections.IEnumerator OpenTradePanelStable()
    {
        // 1) UIâ€™Ä± kur
        PopulateTradeOffers();

        // 2) 1 frame bekle -> layout otursun
        yield return null;
        Canvas.ForceUpdateCanvases();

        // 3) Contentâ€™i tepeye Ã§ek
        var contentRT = (RectTransform)tradeOffersContainer;
        // YalnÄ±zca Yâ€™yi 0â€™la (pivot 0,1 olduÄŸunda tepe demek)
        contentRT.anchoredPosition = new Vector2(contentRT.anchoredPosition.x, 0f);

        // 4) Scrollâ€™u dondur ve tepeye al
        if (tradeScrollRect != null)
        {
            tradeScrollRect.StopMovement();
            tradeScrollRect.velocity = Vector2.zero;
            tradeScrollRect.verticalNormalizedPosition = 1f;
            tradeScrollRect.inertia = false; // ister kalÄ±cÄ± kapat
        }

        // 5) Otomatik seÃ§ili UI temizle
        EventSystem.current?.SetSelectedGameObject(null);
    }

    private void Update()
    {
        if (isPlayerNearby && Keyboard.current != null && Keyboard.current.eKey.wasPressedThisFrame)
            ToggleTradePanel();

        if (IsTradeOpen && Keyboard.current != null && Keyboard.current.escapeKey.wasPressedThisFrame)
            CloseTradePanel();
    }

    public void CloseTradePanel()
    {
        if (tradeUIPanel == null) return;
        tradeUIPanel.SetActive(false);
        Time.timeScale = 1f;
        if (isPlayerNearby && interactPromptUI != null) interactPromptUI.SetActive(true);
    }

    private System.Collections.IEnumerator AfterFirstFrameStabilize()
    {
        yield return null; // 1 frame bekle (layout bitsin)
        Canvas.ForceUpdateCanvases();

        if (tradeScrollRect != null)
        {
            tradeScrollRect.StopMovement();
            tradeScrollRect.velocity = Vector2.zero;                 // gÃ¼vence
            tradeScrollRect.verticalNormalizedPosition = 1f;         // tekrar tepe
            tradeScrollRect.inertia = inertiaDefault;                // eski ayara dÃ¶n
        }

        if (EventSystem.current != null)
            EventSystem.current.SetSelectedGameObject(null);         // oto-seÃ§imi temizle
    }


    private void ToggleTradePanel()
    {
        if (tradeUIPanel == null) return;

        bool shouldOpen = !tradeUIPanel.activeSelf;
        tradeUIPanel.SetActive(shouldOpen);

        if (shouldOpen)
        {
            StartCoroutine(OpenTradePanelStable());
            Time.timeScale = 0f;
            interactPromptUI?.SetActive(false);
        }
        else
        {
            Time.timeScale = 1f;
            if (isPlayerNearby) interactPromptUI?.SetActive(true);
        }
    }

    private void PopulateTradeOffers()
    {
        // Scroll pozisyonunu koru
        float prevScroll = tradeScrollRect ? tradeScrollRect.verticalNormalizedPosition : 1f;

        // Ä°LK KEZ: oluÅŸtur + konumlandÄ±r
        if (!layoutDone)
        {
            // Var olan Ã§ocuklarÄ± temizle (sadece 1 kere)
            for (int i = tradeOffersContainer.childCount - 1; i >= 0; i--)
                Destroy(tradeOffersContainer.GetChild(i).gameObject);

            float y = -topPadding;
            for (int i = 0; i < tradeOffers.Count; i++)
            {
                var go = Instantiate(tradeOfferButtonPrefab, tradeOffersContainer);
                var btn = go.GetComponent<TradeOfferButton>();

                // Anchor/pivot sabit
                var rt = (RectTransform)go.transform;
                rt.anchorMin = new Vector2(0f, 1f);
                rt.anchorMax = new Vector2(0f, 1f);
                rt.pivot = new Vector2(0f, 1f);

                // YERLEÅÄ°M YALNIZCA BURADA!
                float h = Mathf.Max(rt.sizeDelta.y, LayoutUtility.GetPreferredHeight(rt));
                rt.anchoredPosition = new Vector2(0f, y);
                y -= (h + rowSpacing);

                spawned.Add(btn);
            }

            // Content yÃ¼ksekliÄŸi
            var contentRT = (RectTransform)tradeOffersContainer;
            float needed = -y - rowSpacing + bottomPadding;
            if (needed < 0f) needed = 0f;
            var sz = contentRT.sizeDelta;
            contentRT.sizeDelta = new Vector2(sz.x, needed);

            layoutDone = true;
        }

        // HER SEFERÄ°NDE: sadece veri / interaktiflik gÃ¼ncelle
        for (int i = 0; i < spawned.Count && i < tradeOffers.Count; i++)
            spawned[i].Setup(tradeOffers[i]);


        // UI sabitle
        Canvas.ForceUpdateCanvases();
        if (tradeScrollRect)
        {
            tradeScrollRect.StopMovement();
            tradeScrollRect.velocity = Vector2.zero;
            tradeScrollRect.verticalNormalizedPosition = prevScroll; // kayma yok
        }
        EventSystem.current?.SetSelectedGameObject(null);
    }

    // --- Kaynak kontrol & dÃ¼ÅŸÃ¼m ---
    private bool HasEnoughResources(TradeOffer offer)
{
    if (playerStats == null || offer == null) return false;

    // 0 isteyenleri atla
    if (offer.requiredStone > 0 && !Inventory.Instance.HasEnough(offer.stoneSO, offer.requiredStone)) return false;
    if (offer.requiredWood > 0 && !Inventory.Instance.HasEnough(offer.woodSO, offer.requiredWood)) return false;
    if (offer.requiredScrapMetal > 0 && !Inventory.Instance.HasEnough(offer.scrapSO, offer.requiredScrapMetal)) return false;
    if (offer.requiredMeat > 0 && !Inventory.Instance.HasEnough(offer.meatSO, offer.requiredMeat)) return false;
    if (offer.requiredDeerHide > 0 && !Inventory.Instance.HasEnough(offer.deerHideSO, offer.requiredDeerHide)) return false;
    if (offer.requiredRabbitHide > 0 && !Inventory.Instance.HasEnough(offer.rabbitHideSO, offer.requiredRabbitHide)) return false;
    if (offer.requiredHerb > 0 && !Inventory.Instance.HasEnough(offer.herbSO, offer.requiredHerb)) return false;
    if (offer.requiredAmmo > 0 && !Inventory.Instance.HasEnough(offer.ammoSO, offer.requiredAmmo)) return false;

    return true;
}


    private void DeductResources(TradeOffer offer)
{
    if (offer == null) return;

    if (offer.requiredStone > 0) Inventory.Instance.TryConsume(offer.stoneSO, offer.requiredStone);
    if (offer.requiredWood > 0) Inventory.Instance.TryConsume(offer.woodSO, offer.requiredWood);
    if (offer.requiredScrapMetal > 0) Inventory.Instance.TryConsume(offer.scrapSO, offer.requiredScrapMetal);
    if (offer.requiredMeat > 0) Inventory.Instance.TryConsume(offer.meatSO, offer.requiredMeat);
    if (offer.requiredDeerHide > 0) Inventory.Instance.TryConsume(offer.deerHideSO, offer.requiredDeerHide);
    if (offer.requiredRabbitHide > 0) Inventory.Instance.TryConsume(offer.rabbitHideSO, offer.requiredRabbitHide);
    if (offer.requiredHerb > 0) Inventory.Instance.TryConsume(offer.herbSO, offer.requiredHerb);
    if (offer.requiredAmmo > 0) Inventory.Instance.TryConsume(offer.ammoSO, offer.requiredAmmo);
}

    // --- Takas iÅŸlemi ---
public void ExecuteTrade(TradeOffer offer)
{
    if (offer == null) return;

    // Yeterli kaynak var mÄ±?
    if (!HasEnoughResources(offer))
    {
        Debug.Log("Takas baÅŸarÄ±sÄ±z! Yeterli materyal yok.");
        return;
    }

    // KaynaklarÄ± dÃ¼ÅŸ
    DeductResources(offer);

    // Ã–dÃ¼l tipi: normal resource
    if (offer.rewardKind == RewardKind.Resource)
    {
        if (offer.rewardItemSO != null && offer.rewardAmount > 0)
        {
            Inventory.Instance.TryAdd(offer.rewardItemSO, offer.rewardAmount);
            Debug.Log($"Takas baÅŸarÄ±lÄ±! {offer.rewardAmount} x {offer.rewardItemSO.itemName} alÄ±ndÄ±.");
        }
    }
    // Ã–dÃ¼l tipi: silah parÃ§asÄ±
    else if (offer.rewardKind == RewardKind.WeaponPart)
    {
        if (offer.partToGive != null && offer.amountToGive > 0)
        {
            Inventory.Instance.TryAdd(offer.partToGive, offer.amountToGive);
            Debug.Log($"Takas baÅŸarÄ±lÄ±! {offer.amountToGive} x {offer.partToGive.itemName} alÄ±ndÄ±.");
        }
    }

    // UI yenile
    PopulateTradeOffers();
}



    // --- Trigger alanÄ± ---

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;

        isPlayerNearby = true;

        // Panel kapalÄ±ysa promptâ€™u gÃ¶ster
        if (!IsTradeOpen && interactPromptUI != null)
            interactPromptUI.SetActive(true);
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;

        isPlayerNearby = false;

        // Alandan Ã§Ä±kÄ±nca promptâ€™u gizle
        if (interactPromptUI != null)
            interactPromptUI.SetActive(false);

        // Ä°steÄŸe baÄŸlÄ±: Alandan Ã§Ä±kÄ±nca paneli kapat
        // CloseTradePanel();
    }

    [ContextMenu("Reload Trade Offers")]
    private void ReloadTradeOffersInEditor()
    {
        var loaded = Resources.LoadAll<TradeOffer>(resourcesFolder);
        tradeOffers = loaded.ToList();
#if UNITY_EDITOR
        UnityEditor.EditorUtility.SetDirty(this);
#endif
    }
}
using UnityEngine;

public enum RewardKind
{
    WeaponPart,
    Resource
}

[CreateAssetMenu(fileName = "New Trade Offer", menuName = "NPC/Trade Offer")]
public class TradeOffer : ScriptableObject
{
    [Header("Player Gives (Costs)")]
    public ItemData stoneSO;
    public int requiredStone = 0;

    public ItemData woodSO;
    public int requiredWood = 0;

    public ItemData scrapSO;
    public int requiredScrapMetal = 0;

    public ItemData ammoSO;
    public int requiredAmmo = 0;

    public ItemData meatSO;
    public int requiredMeat = 0;

    public ItemData deerHideSO;
    public int requiredDeerHide = 0;

    public ItemData rabbitHideSO;
    public int requiredRabbitHide = 0;

    public ItemData herbSO;
    public int requiredHerb = 0;

    [Header("Player Gets (Rewards)")]
    public RewardKind rewardKind = RewardKind.Resource;

    // âœ” WeaponPart Ã¶dÃ¼lÃ¼ iÃ§in (Yeni sistem)
    public PartItemData partToGive;
    public int amountToGive = 1;

    // Resource Ã¶dÃ¼lÃ¼ iÃ§in
    public ItemData rewardItemSO;
    public int rewardAmount = 0;
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;

public class TradeOfferButton : MonoBehaviour
{
    [Header("UI Prefabs")]
    [SerializeField] private GameObject offerTextPrefab;
    [SerializeField] private Button tradeButton;
    [SerializeField] private Image iconImage;

    [Header("Layout")]
    [SerializeField] private float gap = 10f;
    [SerializeField] private float textPosX = 490f;
    [SerializeField] private float textWidth = 1000f;
    [SerializeField] private float textHeight = 100f;

    [Header("Sprites (Optional)")]
    public Sprite fallbackSprite;

    private Dictionary<PartItemData, Sprite> partMap = new();
    private TradeOffer currentOffer;
    private NPCInteraction npc;

    [SerializeField] private TextMeshProUGUI offerTextSlot;
    private TextMeshProUGUI offerTextInstance;

    void Awake()
    {
        if (!iconImage && tradeButton)
            iconImage = tradeButton.GetComponent<Image>();

        EnsureOfferText();
    }

    private void EnsureOfferText()
    {
        if (offerTextInstance != null) return;

        if (offerTextSlot != null)
            offerTextInstance = offerTextSlot;
        else if (offerTextPrefab != null)
            offerTextInstance = Instantiate(offerTextPrefab, transform).GetComponent<TextMeshProUGUI>();
        else
            Debug.LogError("[TradeOfferButton] No text source assigned!");

        PositionAndSizeText();
    }

    public void Setup(TradeOffer offer)
    {
        currentOffer = offer;
        npc = NPCInteraction.Instance;

        if (!tradeButton || currentOffer == null)
            return;

        EnsureOfferText();
        ApplyIconForOffer(offer);

        string cost = BuildCostText(offer);

        string reward = offer.rewardKind == RewardKind.WeaponPart
            ? $"Verilen: {offer.amountToGive} x {offer.partToGive?.itemName}"
            : $"Verilen: {offer.rewardAmount} x {offer.rewardItemSO?.itemName}";

        offerTextInstance.text = $"{cost}\n{reward}";

        tradeButton.interactable = CanAfford(offer);
        tradeButton.onClick.RemoveAllListeners();
        tradeButton.onClick.AddListener(OnTradeClicked);
    }

    private bool CanAfford(TradeOffer o)
    {
        return
            Inventory.Instance.GetTotalCount(o.stoneSO) >= o.requiredStone &&
            Inventory.Instance.GetTotalCount(o.woodSO) >= o.requiredWood &&
            Inventory.Instance.GetTotalCount(o.scrapSO) >= o.requiredScrapMetal &&
            Inventory.Instance.GetTotalCount(o.meatSO) >= o.requiredMeat &&
            Inventory.Instance.GetTotalCount(o.deerHideSO) >= o.requiredDeerHide &&
            Inventory.Instance.GetTotalCount(o.rabbitHideSO) >= o.requiredRabbitHide &&
            Inventory.Instance.GetTotalCount(o.herbSO) >= o.requiredHerb &&
            Inventory.Instance.GetTotalCount(o.ammoSO) >= o.requiredAmmo;
    }

    private string BuildCostText(TradeOffer o)
    {
        List<string> parts = new();

        if (o.requiredWood > 0) parts.Add($"{o.requiredWood} Odun");
        if (o.requiredStone > 0) parts.Add($"{o.requiredStone} TaÅŸ");
        if (o.requiredScrapMetal > 0) parts.Add($"{o.requiredScrapMetal} Metal");
        if (o.requiredMeat > 0) parts.Add($"{o.requiredMeat} Et");
        if (o.requiredDeerHide > 0) parts.Add($"{o.requiredDeerHide} Geyik Derisi");
        if (o.requiredRabbitHide > 0) parts.Add($"{o.requiredRabbitHide} TavÅŸan Derisi");
        if (o.requiredHerb > 0) parts.Add($"{o.requiredHerb} Ot");
        if (o.requiredAmmo > 0) parts.Add($"{o.requiredAmmo} Mermi");

        return "Ä°stenen: " + string.Join(", ", parts);
    }

    private void PositionAndSizeText()
    {
        var rt = offerTextInstance.rectTransform;

        rt.anchorMin = new Vector2(0f, 0.5f);
        rt.anchorMax = new Vector2(0f, 0.5f);
        rt.pivot = new Vector2(0f, 0.5f);

        rt.anchoredPosition = new Vector2(textPosX, 0f);

        rt.SetSizeWithCurrentAnchors(RectTransform.Axis.Horizontal, textWidth);
        rt.SetSizeWithCurrentAnchors(RectTransform.Axis.Vertical, textHeight);

        var le = offerTextInstance.GetComponent<LayoutElement>();
        if (!le) le = offerTextInstance.gameObject.AddComponent<LayoutElement>();
        le.ignoreLayout = true;
    }

    private void ApplyIconForOffer(TradeOffer offer)
    {
        if (!iconImage) return;

        Sprite s = null;

        if (offer.rewardKind == RewardKind.WeaponPart)
        {
            if (offer.partToGive != null)
                s = offer.partToGive.icon;
        }
        else if (offer.rewardKind == RewardKind.Resource)
        {
            if (offer.rewardItemSO != null)
                s = offer.rewardItemSO.icon;
        }

        iconImage.sprite = s ? s : fallbackSprite;
        iconImage.enabled = iconImage.sprite != null;

        if (iconImage.enabled)
            iconImage.preserveAspect = true;
    }

    private void OnTradeClicked()
    {
        if (npc == null || currentOffer == null) return;

        npc.ExecuteTrade(currentOffer);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;

[DisallowMultipleComponent]
[RequireComponent(typeof(AudioSource))]
public class PlayerFootsteps : MonoBehaviour
{
    public enum Mode { DistanceBased, AnimationEvents }
    [Header("Mode")]
    public Mode mode = Mode.DistanceBased;

    [Header("Footstep Clips")]
    public AudioClip[] footstepClips;

    [Header("Step Settings")]
    public float walkStepDistance = 0.85f;  // yÃ¼rÃ¼rken adÄ±m mesafesi
    public float runStepDistance  = 0.55f;  // koÅŸarken daha kÄ±sa mesafe
    public float runThreshold     = 3.0f;   // koÅŸma hÄ±zÄ± eÅŸiÄŸi
    public float minMovementSpeed = 0.05f;  // durma eÅŸiÄŸi

    [Header("Sound Settings")]
    public float volume = 0.9f;
    public float minPitch = 0.95f;
    public float maxPitch = 1.05f;
    public float minStepGap = 0.12f; // iki adÄ±m arasÄ± min sÃ¼re
    private float nextStepAvailableTime = 0f;

    private AudioSource src;
    private Vector3 lastPosition;
    private float accumulatedDistance = 0f;
    private float lastStepTime = 0f;
    private int lastClipIndex = -1;

    void Awake()
    {
        src = GetComponent<AudioSource>();
        src.playOnAwake = false;
        src.spatialBlend = 0f; // 2D sound

        lastPosition = transform.position;
    }

    void Update()
    {
        if (mode == Mode.AnimationEvents)
        {
            lastPosition = transform.position;
            return;
        }

        if (footstepClips == null || footstepClips.Length == 0) return;
        if (Time.timeScale == 0f) return; // oyun durduysa ses yok

        Vector3 currentPos = transform.position;
        float frameDistance = Vector3.Distance(currentPos, lastPosition);
        lastPosition = currentPos;

        float speed = frameDistance / Mathf.Max(Time.deltaTime, 0.0001f);

        if (speed < minMovementSpeed)
        {
            accumulatedDistance = 0f;
            return;
        }

        accumulatedDistance += frameDistance;

        float targetStepDist = speed >= runThreshold ? runStepDistance : walkStepDistance;

        if (accumulatedDistance >= targetStepDist)
        {
            PlayStep();
            accumulatedDistance -= targetStepDist; // stable rhythm
        }
    }

    // Animation event iÃ§in
    public void AnimationFootstep()
    {
        if (mode == Mode.AnimationEvents)
            PlayStep();
    }

    private void PlayStep()
{
    // Ses uzunluÄŸu bitene kadar bekle
    if (Time.time < nextStepAvailableTime) return;

    // Debounce
    if (Time.time - lastStepTime < minStepGap) return;
    lastStepTime = Time.time;

    int idx = PickClipIndex();
    float len = footstepClips[idx].length;

    src.pitch = Random.Range(minPitch, maxPitch);
    src.PlayOneShot(footstepClips[idx], volume);

    // Ses sÃ¼resi boyunca yeni adÄ±m engelli
    nextStepAvailableTime = Time.time + len;
}

    private int PickClipIndex()
    {
        if (footstepClips.Length == 1) return 0;

        int i;
        do { i = Random.Range(0, footstepClips.Length); }
        while (i == lastClipIndex);
        lastClipIndex = i;

        return i;
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using System.Collections.Generic;

public class PlayerCollector : MonoBehaviour
{
    public float collectRange = 1.5f;
    private List<Resource> highlightedResources = new List<Resource>();

    void Update()
    {
        // Ã–nceki vurgularÄ± kaldÄ±r
        foreach (var res in highlightedResources)
        {
            if (res != null)
                res.Highlight(false);
        }
        highlightedResources.Clear();

        // Yeni yakÄ±ndaki kaynaklarÄ± bul
        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, collectRange);
        foreach (var hit in hits)
        {
            Resource res = hit.GetComponent<Resource>();
            if (res != null)
            {
                res.Highlight(true);
                highlightedResources.Add(res);
            }
        }

        // E tuÅŸu ile toplama
        if (Keyboard.current.eKey.wasPressedThisFrame)
        {
            Debug.Log("E tuÅŸuna basÄ±ldÄ±!");
            foreach (var res in highlightedResources)
            {
                if (res != null)
                {
                    res.Collect();
                    break;
                }
            }
        }
    }
}
using UnityEngine;
using UnityEngine.UI;

public class PlayerHealthUI : MonoBehaviour
{
    public Image fillImage;
    public PlayerStats playerStats;

    void Start()
    {
        if (playerStats != null)
        {
            playerStats.onHealthChanged += UpdateHealthBar;
        }
    }

    void OnDestroy()
    {
        if (playerStats != null)
        {
            playerStats.onHealthChanged -= UpdateHealthBar;
        }
    }

    void UpdateHealthBar(int current, int max)
    {
        fillImage.fillAmount = Mathf.Clamp01((float)current / max);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class PlayerMovement : MonoBehaviour
{
    [Header("Movement")]
    public float moveSpeed = 5f;
    public float sprintMultiplier = 1.7f; // KoÅŸarken hÄ±z artÄ±ÅŸÄ±
    private bool isSprinting = false;

    // --- BileÅŸen ReferanslarÄ± ---
    private Rigidbody2D rb;
    private PlayerStats stats;
    private Animator animator;
    private Camera mainCamera;

    // --- Input System ---
    private PlayerControls controls;
    private Vector2 moveInput;

    // --- Ek Ã–zellikler ---
    public static float FacingDirection { get; private set; } = 1f;
    public float soundRadius = 5f;

    private void Awake()
    {
        rb = GetComponent<Rigidbody2D>();
        animator = GetComponent<Animator>();
        controls = new PlayerControls();
        stats = GetComponent<PlayerStats>();
        mainCamera = Camera.main;
    }

    private void OnEnable()
    {
        controls.Gameplay.Move.performed += OnMovePerformed;
        controls.Gameplay.Move.canceled += OnMoveCanceled;
        controls.Gameplay.Sprint.performed += ctx => isSprinting = true;
        controls.Gameplay.Sprint.canceled += ctx => isSprinting = false;
        controls.Gameplay.Enable();
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

    private void OnMovePerformed(InputAction.CallbackContext context)
    {
        moveInput = context.ReadValue<Vector2>();
    }

    private void OnMoveCanceled(InputAction.CallbackContext context)
    {
        moveInput = Vector2.zero;
    }

    public void EmitFootstep()
    {
        SoundEmitter.EmitSound(transform.position, soundRadius);
    }

    private void FixedUpdate()
{
    float currentSpeed = moveSpeed;
    bool isMoving = moveInput.magnitude > 0.1f;

    // PlayerStats'a koÅŸu/yÃ¼rÃ¼me bilgisini HER FRAME gÃ¶nder
    stats.SetMovementState(isMoving, isSprinting);

    if (isSprinting && stats.HasStamina() && isMoving)
        currentSpeed *= sprintMultiplier;
    else
        isSprinting = false;

    Vector2 moveDelta = moveInput * currentSpeed * Time.fixedDeltaTime;
    rb.MovePosition(rb.position + moveDelta);
}


    void Update()
    {
        if (GameStateManager.IsGamePaused) return;

        UpdateRotationAndAnimation();

    }



    // --- 360Â° Fareye DÃ¶nÃ¼k Animasyon ve Rotasyon ---
    private void UpdateRotationAndAnimation()
    {
        if (animator == null || mainCamera == null) return;

        // ğŸ§­ Fare konumunu al ve yÃ¶nÃ¼ hesapla
        Vector2 mouseScreenPos = Mouse.current.position.ReadValue();
        Vector3 mouseWorldPos = mainCamera.ScreenToWorldPoint(mouseScreenPos);
        Vector2 aimDirection = (mouseWorldPos - transform.position).normalized;

        // ğŸŒ€ Karakteri fareye Ã§evir (360Â°)
        float angle = Mathf.Atan2(aimDirection.y, aimDirection.x) * Mathf.Rad2Deg;
        transform.rotation = Quaternion.Euler(0f, 0f, angle - 90f); // Sprite yukarÄ± bakÄ±yorsa -90f uygundur

        // ğŸ Animasyon durumu
        bool isMoving = moveInput.magnitude > 0.1f;
        animator.SetBool("IsMoving", isMoving);

        // ğŸ” FacingDirection flip kontrolÃ¼ (silah veya atÄ±ÅŸ yÃ¶nÃ¼ iÃ§in)
        FacingDirection = aimDirection.x >= 0 ? 1f : -1f;
    }
}
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.InputSystem;
using TMPro;
using UnityEngine.UI;

public class PlayerStats : MonoBehaviour
{
    // ------------------------------
    //   STAMINA (AÃ§lÄ±ÄŸa BaÄŸlÄ±)
    // ------------------------------
    [Header("Stamina AyarlarÄ±")]
    public float maxStamina = 100f;            // ARTIK: maxHunger ile eÅŸitlenecek
    [SerializeField] private float currentStamina;
    public float staminaDrainRate = 15f;       // koÅŸarken azalÄ±r
    public float staminaRegenIdle = 18f;       // dururken artar

    private bool isRunning = false;            // Movement scriptinden baÄŸlanacak (setter fonk ekledim)
    private bool isMoving = false;

    public float GetStamina() => currentStamina;
    public float GetMaxStamina() => maxStamina;

    public void ModifyStamina(float amount)
    {
        currentStamina = Mathf.Clamp(currentStamina + amount, 0, maxStamina);
        UpdateStaminaUI();
    }

    public void ResetStamina() => currentStamina = maxStamina;
    public bool HasStamina() => currentStamina > 0;

    [Header("AÃ§lÄ±k KoÅŸu Ã‡arpanÄ±")]
    public float runningHungerMultiplier = 1.5f; // koÅŸarken aÃ§lÄ±k 2 hÄ±zlÄ± azalÄ±r
    [Header("Stamina UI")]
    public Slider staminaSlider;




    // ------------------------------
    //            SAÄLIK
    // ------------------------------
    [Header("SaÄŸlÄ±k")]
    public int maxHealth = 100;
    public int currentHealth;
    public float damageCooldown = 0.5f;
    private float lastDamageTime = -999f;

    public delegate void OnDeath();
    public event OnDeath onDeath;

    [Header("UI")]
    [SerializeField] private PlayerHealthUI healthUI;
    public delegate void OnHealthChanged(int current, int max);
    public event OnHealthChanged onHealthChanged;


    // ------------------------------
    //     HAREKET / ENVANTER
    // ------------------------------
    [Header("Hareket/Envanter")]
    public float moveSpeed = 5f;
    public int gold = 10;


    // ------------------------------
    //            AÃ‡LIK
    // ------------------------------
    [Header("AÃ§lÄ±k")]
    public int maxHunger = 100;
    public int currentHunger;
    public float hungerDecreaseInterval = 5f;
    public int hungerDecreaseAmount = 1;
    private float hungerTimer;

    [Header("AÃ§lÄ±k UI")]
    public TextMeshProUGUI hungerText;

    public int hungerOnRawMeatUse = 10;
    public int hungerOnCookedMeatUse = 30;
    public int hungerOnHerbUse = 0;


    // ------------------------------
    //   AÃ‡LIK â†’ SAÄLIK/YORGUNLUK
    // ------------------------------
    [Header("AÃ§lÄ±k BazlÄ± SaÄŸlÄ±k Sistemi")]
    public float highHungerThresholdPercent = 0.70f;   // %70 Ã¼stÃ¼ can yeniler
    public float lowHungerThresholdPercent = 0.10f;    // %10 altÄ± can dÃ¼ÅŸer

    public float healthRegenRate = 1f;         // saniyede +1
    public float healthRegenInterval = 1f;
    private float healthRegenTimer;

    private float starvationTickInterval = 1.5f;   // aÃ§lÄ±k bitince can azalmasÄ±
    private float starvationTimer;



    // ------------------------------
    //        SES
    // ------------------------------
    [Header("Ses")]
    public AudioClip hurtClip;
    private AudioSource audioSource;


    // ------------------------------
    // ITEM REFERANSLARI
    // ------------------------------
    [Header("Item References")]
    public ItemData cookedMeatSO;
    public ItemData rawMeatSO;
    public ItemData herbSO;
    public float staminaRegenWalk = 8f;



    void Awake()
    {
        audioSource = GetComponent<AudioSource>();
        if (audioSource == null)
            audioSource = gameObject.AddComponent<AudioSource>();

        AudioManager.Instance?.RouteToSFX(audioSource);
    }

    void Start()
    {
        currentHunger = maxHunger;
        hungerTimer = hungerDecreaseInterval;

        currentStamina = maxHunger;      // baÅŸlangÄ±Ã§ta max stamina = aÃ§lÄ±k
        maxStamina = maxHunger;

        currentHealth = maxHealth;
        onHealthChanged?.Invoke(currentHealth, maxHealth);

        if (staminaSlider != null)
{
    staminaSlider.maxValue = maxStamina;
    staminaSlider.value = currentStamina;
}

    }

    void Update()
    {
        HandleHungerSystem();
        UpdateStaminaByHunger();
        UpdateStaminaRegen();
        UpdateHealthByHunger();
        

        if (Keyboard.current != null && Keyboard.current.fKey.wasPressedThisFrame)
            TryConsumeFood();

        UpdateHungerUI();
        UpdateStaminaUI();

    }

    private void UpdateStaminaUI()
{
    if (staminaSlider == null) return;

    // Full ise gizle
    if (currentStamina >= maxStamina)
    {
        staminaSlider.gameObject.SetActive(false);
    }
    else
    {
        staminaSlider.gameObject.SetActive(true);
        staminaSlider.maxValue = maxStamina;
        staminaSlider.value = currentStamina;
    }
}




    // ============================================================
    //                 HUNGER SYSTEM
    // ============================================================

    void HandleHungerSystem()
{
    float interval = hungerDecreaseInterval;

    // KoÅŸuyorsa aÃ§lÄ±k daha hÄ±zlÄ± azalÄ±r
    if (isRunning)
        interval /= runningHungerMultiplier;

    hungerTimer -= Time.deltaTime;

    if (hungerTimer <= 0f)
    {
        currentHunger = Mathf.Max(0, currentHunger - hungerDecreaseAmount);
        hungerTimer = interval;
    }
}




    // ============================================================
    //     MAX STAMINA = CURRENT HUNGER  (PEAK SISTEMI)
    // ============================================================

    void UpdateStaminaByHunger()
    {
        maxStamina = currentHunger;

        // currentStamina fazla kaldÄ±ysa otomatik dÃ¼ÅŸÃ¼r
        if (currentStamina > maxStamina)
            currentStamina = maxStamina;
    }



    // ============================================================
    //       STAMINA REGEN RATE = HUNGER LEVEL
    // ============================================================

    void UpdateStaminaRegen()
{
    float hungerPercent = (float)currentHunger / maxHunger;

    // AÃ§lÄ±k â†’ regen katsayÄ±sÄ±
    float hungerMult;
    if (hungerPercent >= 0.70f)
        hungerMult = 1.5f;   // tok â†’ hÄ±zlÄ± regen
    else if (hungerPercent >= 0.40f)
        hungerMult = 1f;     // normal
    else if (hungerPercent >= 0.20f)
        hungerMult = 0.5f;   // yorgun
    else
        hungerMult = 0.2f;   // bitkin

    // KOÅARKEN â†’ sadece STAMINA AZALIR
    if (isRunning && isMoving)
    {
        ModifyStamina(-staminaDrainRate * Time.deltaTime);
        return;
    }

    // YÃœRÃœRKEN â†’ az regen
    if (isMoving)
    {
        float regen = staminaRegenWalk * hungerMult;
        ModifyStamina(regen * Time.deltaTime);
    }
    // HÄ°Ã‡ HAREKET ETMEZKEN â†’ daha fazla regen
    else
    {
        float regen = staminaRegenIdle * hungerMult;
        ModifyStamina(regen * Time.deltaTime);
    }
}




    // ============================================================
    //       HEALTH = HUNGER STATE
    // ============================================================

    void UpdateHealthByHunger()
    {
        if (currentHealth <= 0) return;

        float hungerPercent = (float)currentHunger / maxHunger;

        // Tok â†’ Can yenilenir
        if (hungerPercent >= highHungerThresholdPercent)
        {
            healthRegenTimer += Time.deltaTime;

            if (healthRegenTimer >= healthRegenInterval && currentHealth < maxHealth)
            {
                Heal(Mathf.RoundToInt(healthRegenRate));
                healthRegenTimer = 0f;
            }

            return;
        }


        // Ã‡ok aÃ§ â†’ Can dÃ¼ÅŸer
        if (hungerPercent <= lowHungerThresholdPercent)
        {
            starvationTimer += Time.deltaTime;

            if (starvationTimer >= starvationTickInterval)
            {
                TakeDamage(1);
                starvationTimer = 0f;
            }
        }
        else
        {
            starvationTimer = 0f; // gÃ¼venli reset
        }
    }




    // ============================================================
    //                   FOOD CONSUME
    // ============================================================

    private void TryConsumeFood()
    {
        if (Inventory.Instance.HasEnough(cookedMeatSO, 1))
        {
            Inventory.Instance.TryConsume(cookedMeatSO, 1);
            GainHunger(hungerOnCookedMeatUse);
            return;
        }

        if (Inventory.Instance.HasEnough(rawMeatSO, 1))
        {
            Inventory.Instance.TryConsume(rawMeatSO, 1);
            GainHunger(hungerOnRawMeatUse);
            return;
        }

        if (Inventory.Instance.HasEnough(herbSO, 1))
        {
            Inventory.Instance.TryConsume(herbSO, 1);
            GainHunger(hungerOnHerbUse);
            return;
        }
    }

    private void GainHunger(int amount)
    {
        if (amount > 0)
            currentHunger = Mathf.Clamp(currentHunger + amount, 0, maxHunger);
    }



    // ============================================================
    //                      UI UPDATE
    // ============================================================

    void UpdateHungerUI()
    {
        if (hungerText == null) return;

        hungerText.text = $"AÃ§lÄ±k: {currentHunger}/{maxHunger}";

        if (currentHunger > 60) hungerText.color = Color.green;
        else if (currentHunger > 30) hungerText.color = Color.yellow;
        else hungerText.color = Color.red;
    }


    // ============================================================
    //          SAÄLIK FONKSÄ°YONLARI
    // ============================================================

    public bool IsAlive() => currentHealth > 0;

    public void TakeDamage(int amount)
    {
        if (!IsAlive()) return;
        if (Time.time - lastDamageTime < damageCooldown) return;

        lastDamageTime = Time.time;
        currentHealth = Mathf.Max(0, currentHealth - amount);

        onHealthChanged?.Invoke(currentHealth, maxHealth);

        if (hurtClip != null)
            audioSource?.PlayOneShot(hurtClip);

        if (currentHealth <= 0)
            Die();

        DamagePopupManager.Instance?.SpawnPopup(transform.position, amount);
    }

    public void Heal(int amount)
    {
        if (!IsAlive() || amount <= 0) return;
        currentHealth = Mathf.Min(maxHealth, currentHealth + amount);
        onHealthChanged?.Invoke(currentHealth, maxHealth);
    }

    private void Die()
    {
        Debug.Log("ğŸ’€ Player died");
        onDeath?.Invoke();
    }


    // ============================================================
    //      DÄ±ÅŸ Scriptlerden Hareket Bilgisi Alma
    // ============================================================

    public void SetMovementState(bool moving, bool running)
    {
        isMoving = moving;
        isRunning = running;
    }


    public void RefreshHealthUI()
    {
        onHealthChanged?.Invoke(currentHealth, maxHealth);
    }

}
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.Rendering.Universal;

[RequireComponent(typeof(AudioSource))]
public class PlayerWeapon : MonoBehaviour
{
    // References
    private GameObject currentModel;
    private AudioSource audioSource;
    private Animator animator;

    private WeaponSlotManager slotManager;

    [Header("Weapon Configuration")]
    public WeaponData weaponData;

    [Header("Components")]
    public Transform firePoint;
    public GameObject bulletPrefab;
    public LayerMask enemyLayer;

    [Header("Muzzle Flash")]
    public Light2D muzzleFlash;
    public float muzzleFlashDuration = 0.05f;
    public float muzzleFlashIntensity = 3f;
    private Coroutine muzzleFlashCo;

    [Header("Audio")]
    public AudioClip shootSound;
    public AudioClip reloadSound;
    public AudioClip emptyClipSound;

    // Input System
    private PlayerControls controls;

    // State
    private bool isReloading = false;
    private bool isAiming = false;

    private float lastAutoFireTime = 0f;

    // NEW MAGAZINE SYSTEM
    public MagazineItem currentMagazine;                 // Takılı şarjör
    public List<MagazineItem> inventoryMags = new();     // Yedek şarjörler

    // Reload Hold Detection
    private float reloadPressTime;
    public float reloadHoldThreshold = 0.4f;

    private void Awake()
    {
        audioSource = GetComponent<AudioSource>();
        animator = GetComponentInChildren<Animator>();

        controls = new PlayerControls();

        if (muzzleFlash != null)
            muzzleFlash.enabled = false;
    }

    private void Start()
    {
        slotManager = WeaponSlotManager.Instance;

        if (slotManager != null)
            LoadFromSlot(slotManager.activeSlotIndex);
        else
            Debug.LogError("[PlayerWeapon] Slot Manager null!");
    }

    // ============================
    // INPUT SYSTEM ONENABLE / OFF
    // ============================
    private void OnEnable()
    {
        controls.Gameplay.Enable();

        // Slot Switching
        controls.Gameplay.Weapon1.performed += ctx => SwitchToSlot(0);
        controls.Gameplay.Weapon2.performed += ctx => SwitchToSlot(1);
        controls.Gameplay.Weapon3.performed += ctx => SwitchToSlot(2);

        // ADS
        controls.Gameplay.ADS.started += ctx => StartADS();
        controls.Gameplay.ADS.canceled += ctx => StopADS();

        // Reload Hold Detection
        controls.Gameplay.Reload.started += ctx =>
        {
            reloadPressTime = Time.time;
        };

        controls.Gameplay.Reload.canceled += ctx =>
        {
            float held = Time.time - reloadPressTime;

            if (held >= reloadHoldThreshold)
                StartCoroutine(MagCheck());
            else
                StartCoroutine(ReloadRoutine());
        };
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

    private void SwitchToSlot(int slot)
    {
        WeaponSlotManager.Instance.SwitchSlot(slot);
    }

    // ============================
    // SHOOT (NEW INPUT SYSTEM)
    // ============================

    private void HandleShootStart()
    {

        if (!weaponData.isAutomatic)
            Shoot();
    }


    private void Update()
{
    if (PauseMenu.IsPaused || weaponData == null || isReloading)
        return;

    // 🔫 Tekli atış (semi-auto)
    if (!weaponData.isAutomatic)
    {
        if (Input.GetMouseButtonDown(0))
            Shoot();
    }

    // 🔥 Otomatik atış (auto)
    if (weaponData.isAutomatic)
    {
        if (Input.GetMouseButton(0))
            AutoFire();
    }
}


    private void AutoFire()
    {
        float fireDelay = 1f / weaponData.fireRate;

        if (Time.time - lastAutoFireTime >= fireDelay)
        {
            lastAutoFireTime = Time.time;
            Shoot();
        }
    }

    // ============================
    // ACTUAL SHOOT LOGIC
    // ============================
    public void Shoot()
    {
        if (isReloading) return;

        if (currentMagazine == null || currentMagazine.currentAmmo <= 0)
        {
            PlayEmptyClipSound();
            Debug.Log("Boş! Ateş yok.");
            return;
        }

        currentMagazine.currentAmmo--;

        RangedAttack();
        Debug.Log($"Ateş edildi! Şarjör: {currentMagazine.currentAmmo}/{currentMagazine.capacity}");
    }

    private void RangedAttack()
    {
        if (shootSound != null)
            audioSource.PlayOneShot(shootSound);

        animator?.SetTrigger("Shoot");

        if (weaponData.isShotgun)
            FireShotgunPellets();
        else
            FireSingleBullet();

        TryMuzzleFlash();
    }

    private void FireSingleBullet()
    {
        var bullet = Instantiate(bulletPrefab, firePoint.position, firePoint.rotation);

        if (bullet.TryGetComponent(out WeaponBullet b))
        {
            b.damage = weaponData.damage;
            b.owner = transform;
            b.weaponType = weaponData.weaponType;
            b.knockbackForce = weaponData.knockbackForce;
            b.knockbackDuration = weaponData.knockbackDuration;
        }
    }

    private void FireShotgunPellets()
    {
        int pellets = Mathf.Max(weaponData.pelletsPerShot, 1);
        float spread = weaponData.pelletSpreadAngle;

        for (int i = 0; i < pellets; i++)
        {
            float t = pellets == 1 ? 0f : (float)i / (pellets - 1);
            float angle = Mathf.Lerp(-spread, spread, t);
            Quaternion rot = firePoint.rotation * Quaternion.Euler(0, 0, angle);

            var bullet = Instantiate(bulletPrefab, firePoint.position, rot);

            if (bullet.TryGetComponent(out WeaponBullet b))
            {
                b.damage = weaponData.damage;
                b.owner = transform;
                b.weaponType = weaponData.weaponType;
                b.knockbackForce = weaponData.knockbackForce;
                b.knockbackDuration = weaponData.knockbackDuration;
            }
        }
    }

    // ============================
    // ADS
    // ============================
    private void StartADS()
    {
        isAiming = true;
        animator?.SetBool("ADS", true);
    }

    private void StopADS()
    {
        isAiming = false;
        animator?.SetBool("ADS", false);
    }

    // ============================
    // RELOAD (SHORT OR LONG HOLD)
    // ============================
    private IEnumerator ReloadRoutine()
    {
        if (isReloading) yield break;

        if (inventoryMags.Count == 0)
        {
            Debug.Log("Yedek şarjör yok.");
            yield break;
        }

        isReloading = true;

        audioSource.PlayOneShot(reloadSound);
        yield return new WaitForSeconds(weaponData.reloadTime);

        // Eski şarjörü geri koy
        if (currentMagazine != null)
            inventoryMags.Add(currentMagazine);

        // En dolu şarjörü bul
        var nextMag = inventoryMags.OrderByDescending(m => m.currentAmmo).FirstOrDefault();
        if (nextMag == null)
        {
            Debug.Log("Takılabilir şarjör yok!");
            isReloading = false;
            yield break;
        }

        inventoryMags.Remove(nextMag);
        currentMagazine = nextMag;

        Debug.Log($"Yeni şarjör → {currentMagazine.currentAmmo}/{currentMagazine.capacity}");

        isReloading = false;
    }

    // ============================
    // MAGAZINE CHECK (HOLD R)
    // ============================
    IEnumerator MagCheck()
    {
        if (currentMagazine == null)
        {
            Debug.Log("Şarjör takılı değil.");
            yield break;
        }

        yield return new WaitForSeconds(0.3f);

        float ratio = (float)currentMagazine.currentAmmo / currentMagazine.capacity;

        if (ratio == 1f) Debug.Log("Tam dolu.");
        else if (ratio >= 0.7f) Debug.Log("Neredeyse dolu.");
        else if (ratio >= 0.4f) Debug.Log("Yarısı dolu.");
        else if (ratio > 0) Debug.Log("Az mermi kaldı.");
        else Debug.Log("Tamamen boş.");
    }

    // ============================
    // MUZZLE FLASH
    // ============================
    private void TryMuzzleFlash()
    {
        if (muzzleFlash == null) return;

        muzzleFlash.transform.position = firePoint.position;

        if (muzzleFlashCo != null)
            StopCoroutine(muzzleFlashCo);

        muzzleFlashCo = StartCoroutine(MuzzleFlashRoutine());
    }

    private IEnumerator MuzzleFlashRoutine()
    {
        float original = muzzleFlash.intensity;
        muzzleFlash.enabled = true;
        muzzleFlash.intensity = muzzleFlashIntensity;

        yield return new WaitForSeconds(muzzleFlashDuration);

        muzzleFlash.intensity = original;
        muzzleFlash.enabled = false;
    }

    public void PlayEmptyClipSound()
    {
        if (emptyClipSound != null)
            audioSource.PlayOneShot(emptyClipSound);
    }

    // ============================
    // SLOT / WEAPON LOAD
    // ============================
    public void LoadFromSlot(int slot)
    {
        var data = slotManager.GetEquippedWeapon(slot);
        if (data == null) return;

        weaponData = data;
        lastAutoFireTime = 0f;
        isReloading = false;

        if (currentModel != null)
            Destroy(currentModel);

        if (weaponData.prefab != null)
        {
            currentModel = Instantiate(weaponData.prefab, transform);
            Transform fp = currentModel.transform.Find("FirePoint");
            if (fp != null)
                firePoint = fp;
        }
    }

    public void SetWeapon(WeaponData data)
{
    if (data == null)
        return;

    weaponData = data;

    // Mevcut modeli sil
    if (currentModel != null)
        Destroy(currentModel);

    // Yeni modeli oluştur
    if (weaponData.prefab != null)
    {
        currentModel = Instantiate(weaponData.prefab, transform);
        currentModel.transform.localPosition = Vector3.zero;
        currentModel.transform.localRotation = Quaternion.identity;

        // FirePoint'i bul
        Transform fp = currentModel.transform.Find("FirePoint");
        if (fp != null)
            firePoint = fp;
    }

    // Şarjör sistemini sıfırla
    currentMagazine = null;
    inventoryMags.Clear();

    Debug.Log($"[PlayerWeapon] Yeni silah takıldı → {weaponData.name}. Şarjörler sıfırlandı.");
}

}
using UnityEngine;

public class BandagePickup : MonoBehaviour
{
    public GenericItemData bandageSO;
    public int amount = 1;

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player"))
            return;

        PlayerStats stats = other.GetComponent<PlayerStats>();
        if (stats == null)
            return;

        Debug.Log("ğŸ©¹ Bandaj toplandÄ± +" + amount);

        // Envantere ekle
        Inventory.Instance.TryAdd(bandageSO, amount);


        // Prefab'Ä± yok et
        Destroy(gameObject);
    }
}
using UnityEngine;

public class BlueprintPickup : MonoBehaviour
{
    [Header("Blueprint Item")]
    public ItemData blueprintSO;   // âœ… ArtÄ±k string id yerine direkt ItemData

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            if (blueprintSO != null)
            {
                Inventory.Instance.TryAdd(blueprintSO, 1);
                Debug.Log($"ğŸ“œ Blueprint eklendi: {blueprintSO.itemName}");
            }
            else
            {
                Debug.LogError("[BlueprintPickup] blueprintSO atanmadÄ±!");
            }

            Destroy(gameObject);
        }
    }
}
using UnityEngine;

public class GoldPickup : MonoBehaviour
{
    public int amount = 1;

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            PlayerStats stats = other.GetComponent<PlayerStats>();
            if (stats != null)
            {
                stats.gold += amount;
                Debug.Log($"ğŸ’° AltÄ±n alÄ±ndÄ±! Yeni bakiye: {stats.gold}");
            }

            Destroy(gameObject);
        }
    }
}
using UnityEngine;

public class Resource : MonoBehaviour
{

    public ItemData itemData;       // Yeni sistemdeki ScriptableObject

    [Header("Resource Settings")]
    public ResourceType type;
    public int amount = 1;

    [Header("Collection Mechanics")]
    [Tooltip("Bu kaynaÄŸÄ± toplamak iÃ§in kaÃ§ kez 'E'ye basÄ±lmasÄ± gerekiyor.")]
    public int hitsRequired = 3;

    [Tooltip("Ä°ki 'E' basÄ±ÅŸÄ± arasÄ±ndaki minimum bekleme sÃ¼resi (saniye).")]
    public float hitCooldown = 1.0f;

    // --- AMMO PICKUP AYARLARI ---
    [Header("Ammo Pickup")]
    [Tooltip("Mermiyi aktif silaha mÄ± ekleyelim? (false ise hedef slota ekler)")]
    public bool ammoToActiveSlot = true;

    [Tooltip("aktif deÄŸilse, bu slota ekle")]
    public int ammoTargetSlotIndex = 0;

    [Tooltip("MiktarÄ± 'maxAmmoCapacity' yÃ¼zdesi olarak mÄ± hesaplayalÄ±m?")]
    public bool ammoAmountAsPercentOfMax = true;

    [Range(0f, 1f)] public float ammoPercentOfMax = 0.25f; // Ã¶rn. %25
    public int ammoFixedAmount = 12;                      // yÃ¼zdelik kapalÄ±ysa sabit ek
    [Tooltip("Rezerv mermiyi weaponData.maxAmmoCapacity Ã¼stÃ¼ne taÅŸmayacak ÅŸekilde sÄ±nÄ±rla")]
    public bool clampToMaxCapacity = true;


    // --- Sistem DeÄŸiÅŸkenleri ---
    private int currentHits = 0;
    private bool canBeHit = true; // Cooldown kontrolÃ¼ iÃ§in

    public Sprite normalSprite;
    public Sprite highlightedSprite;
    private SpriteRenderer sr;

    void Start()
    {
        sr = GetComponent<SpriteRenderer>();
        if (sr != null && normalSprite != null)
            sr.sprite = normalSprite;
    }


    public void Collect()
{
    if (itemData == null)
    {
        Debug.LogError($"[Resource] itemData null! '{gameObject.name}' Ã¼zerinde itemData atanmamÄ±ÅŸ.");
        return;
    }

    if (Inventory.Instance == null)
    {
        Debug.LogError("[Resource] Inventory.Instance bulunamadÄ±.");
        return;
    }

    // Item'Ä± envantere ekle
    Inventory.Instance.TryAdd(itemData, amount);

    // Eski PlayerInventory sistemine baÄŸlÄ± satÄ±r SÄ°LÄ°NDÄ°
    // Ã‡Ã¼nkÃ¼ yeni sistemde gerek yok.

    Destroy(gameObject);
}


    public void HitResource()
    {
        // EÄŸer bekleme sÃ¼resi aktifse, hiÃ§bir ÅŸey yapma.
        if (!canBeHit)
        {
            Debug.Log("BEKLE! Ã‡ok hÄ±zlÄ± basÄ±yorsun.");
            return;
        }

        currentHits++;
        Debug.Log($"{type} vuruldu! ({currentHits} / {hitsRequired})");

        // Ä°steÄŸe baÄŸlÄ±: Her vuruÅŸta bir ses Ã§al veya gÃ¶rsel efekt gÃ¶ster.
        // EffectManager.Instance.PlayHitEffect(transform.position);

        // Yeterli vuruÅŸ sayÄ±sÄ±na ulaÅŸÄ±ldÄ± mÄ±?
        if (currentHits >= hitsRequired)
        {
            Collect();
        }
        else
        {
            // HenÃ¼z toplanmadÄ±ysa, bekleme sÃ¼resini baÅŸlat.
            StartCoroutine(HitCooldown());
        }
    }

    private System.Collections.IEnumerator HitCooldown()
    {
        canBeHit = false;
        yield return new WaitForSeconds(hitCooldown);
        canBeHit = true;
    }

    public void Highlight(bool state)
    {
        if (sr == null) sr = GetComponent<SpriteRenderer>();

        if (state && highlightedSprite != null)
            sr.sprite = highlightedSprite;
        else if (normalSprite != null)
            sr.sprite = normalSprite;
    }


}
using UnityEngine;

public class ResourceSpawner : MonoBehaviour
{
    public GameObject stonePrefab;
    public GameObject woodPrefab;
    public GameObject scrapMetalPrefab;

    public int stoneCount = 5;
    public int woodCount = 3;
    public int scrapMetalCount = 2;

    public Vector2 spawnAreaMin = new Vector2(-10, -5);
    public Vector2 spawnAreaMax = new Vector2(10, 5);

    private Transform resourceParent;

    void Start()
    {
        // Resources adlÄ± GameObject'i bul
        GameObject container = GameObject.Find("Resources(Silme)");
        if (container != null)
        {
            resourceParent = container.transform;
        }
        else
        {
            Debug.LogWarning("Resources GameObject bulunamadÄ±! KÃ¶k objeye ekleniyor.");
        }

        SpawnResources(stonePrefab, stoneCount);
        SpawnResources(woodPrefab, woodCount);
        SpawnResources(scrapMetalPrefab, scrapMetalCount);
    }

    void SpawnResources(GameObject prefab, int count)
    {
        for (int i = 0; i < count; i++)
        {
            Vector2 randomPos = new Vector2(
                Random.Range(spawnAreaMin.x, spawnAreaMax.x),
                Random.Range(spawnAreaMin.y, spawnAreaMax.y)
            );

            // Parent olarak Resources objesini ata
            GameObject spawned = Instantiate(prefab, randomPos, Quaternion.identity);
            if (resourceParent != null)
                spawned.transform.parent = resourceParent;
        }
    }
    public void RegenerateResources(float ratio)
    {
        int newStones = Mathf.RoundToInt(stoneCount * ratio);
        int newWoods = Mathf.RoundToInt(woodCount * ratio);
        int newMeteors = Mathf.RoundToInt(scrapMetalCount * ratio);

        SpawnResources(stonePrefab, newStones);
        SpawnResources(woodPrefab, newWoods);
        SpawnResources(scrapMetalPrefab, newMeteors);
    }

}
public enum ResourceType
{
    Stone,
    Wood,
    scrapMetal,
    Meat,
    DeerHide,
    RabbitHide,
    CookedMeat,
    AmmoMachineGun,
    AmmoPistol,
    AmmoShotgun,
    AmmoSniper,
    Spear,
    Herb,
    Ammo,
    Blueprint,
    Molotov,
    Bandage// âœ… yeni eklenen

}
using UnityEngine;

public class ScrapPile : MonoBehaviour
{
    public GameObject[] partPrefabs; // Inspector'a ekleyeceğiz

    public void OnCollected()
    {
        if (Random.value < 0.2f)
        {
            int index = Random.Range(0, partPrefabs.Length);
            Instantiate(partPrefabs[index], transform.position + Vector3.up * 0.5f, Quaternion.identity);
            Debug.Log("🔧 Silah parçası düştü!");
        }

        Destroy(gameObject);
    }
}
using System;
using System.Collections.Generic;  // ğŸ”´ EKLE
using UnityEngine;    

[System.Serializable]
public class CaravanSaveData
{
    public List<WeaponSaveEntry> weaponEntries = new();
}

[System.Serializable]
public class WeaponSaveEntry
{
    public WeaponType type;
    public List<string> weaponIDs;
}
using UnityEngine;

public class GameInitializer : MonoBehaviour
{
    [Header("Referanslar")]
    public Transform player;       // Player Transform
    public ItemRegistry registry;  // TÃ¼m item SO'larÄ±
    public Inventory inventory;    // Player Ã¼zerindeki Inventory
    public PlayerStats stats;      // PlayerStats

    [Header("Yeni Oyun Spawn NoktasÄ±")]
    public Transform defaultSpawnPoint;   // Inspectorâ€™dan bir boÅŸ obje ver (spawn noktasÄ±)
    public Vector3 fallbackSpawnPosition; // Ä°stersen elle de girebilirsin

    private void Awake()
    {
        if (registry != null && registry.items != null && registry.items.Length > 0)
        {
            ItemDatabase.RegisterAll(registry.items);
        }
        else
        {
            Debug.LogError("ItemDatabase boooÅŸ! registry veya registry.items atanmadÄ±!");
        }

    }

    private void Start()
{
    Debug.Log("GameInitializer: ShouldLoad = " + SaveBootstrap.ShouldLoadFromSave);
    Debug.Log("GameInitializer: HasSave = " + SaveSystem.HasSave());

    // 1) Save yÃ¼kleme...
    if (SaveBootstrap.ShouldLoadFromSave && SaveSystem.HasSave())
    {
        SaveSystem.LoadPlayerAndInventory(player, inventory, stats);
        SaveBootstrap.ShouldLoadFromSave = false;
        return;
    }

    // 2) Yeni oyun â†’ default spawn
    Vector3 spawnPos = player.position;

    if (defaultSpawnPoint != null)
        spawnPos = defaultSpawnPoint.position;
    else if (fallbackSpawnPosition != Vector3.zero)
        spawnPos = fallbackSpawnPosition;

    player.position = spawnPos;


    // 3) BAÅLANGIÃ‡ PÄ°STOL
    ItemData pistolItem = ItemDatabase.Get("weapon_pistol");
    if (pistolItem != null)
    {
        WeaponSlotManager.Instance.EquipWeapon(pistolItem);
        Debug.Log("â–¶ Yeni oyun â†’ BaÅŸlangÄ±Ã§ silahÄ± verildi: Pistol");
    }


   
    // Aktif slot pistol olsun
    WeaponSlotManager.Instance.activeSlotIndex = 0;
}


}
    public static class SaveBootstrap
{
    public static bool ShouldLoadFromSave = false;
}
using System.Collections.Generic;

[System.Serializable]
public class SaveData
{
    public float posX, posY, posZ;

    public int currentHealth;
    public int maxHealth;

    public float currentStamina;
    public float maxStamina;

    public int currentHunger;
    public int maxHunger;

    public int gold;

    public List<InventoryItemData> inventory = new();
    public List<string> unlockedWeaponIDs = new();

    public string[] equippedWeaponIDs = new string[3];
    public int[] slotClip = new int[3];
    public int[] slotReserve = new int[3];
    public int activeSlotIndex;

    // ğŸ”¥ Karavan silahlarÄ±
    public CaravanSaveData caravanSave;
}

[System.Serializable]
public class InventoryItemData
{
    public string itemID;
    public int amount;
}
using System.IO;
using UnityEngine;
using System.Collections.Generic;

public static class SaveSystem
{
    private static string savePath = Path.Combine(Application.persistentDataPath, "save.json");

    public static bool HasSave() => File.Exists(savePath);

    public static void DeleteSave()
    {
        if (HasSave())
            File.Delete(savePath);
    }

    // ============================================================
    //                          SAVE
    // ============================================================

    public static void SavePlayerAndInventory(
        Transform player,
        Inventory inventory,
        PlayerStats stats)
    {
        if (player == null || inventory == null || stats == null)
        {
            Debug.LogWarning("SavePlayerAndInventory: Eksik referans!");
            return;
        }

        SaveData data = new SaveData();

        // ---- Pozisyon ----
        data.posX = player.position.x;
        data.posY = player.position.y;
        data.posZ = player.position.z;

        // ---- Statlar ----
        data.currentHealth = stats.currentHealth;
        data.maxHealth = stats.maxHealth;

        data.currentStamina = stats.GetStamina();
        data.maxStamina = stats.GetMaxStamina();

        data.currentHunger = stats.currentHunger;
        data.maxHunger = stats.maxHunger;

        data.gold = stats.gold;

        // ---- Envanter ----
        data.inventory.Clear();
        foreach (var slot in inventory.slots)
        {
            if (slot.data == null) continue;

            var saved = new InventoryItemData
            {
                itemID = slot.data.itemID,
                amount = slot.count
            };

            data.inventory.Add(saved);
        }

        // ---- Craft ile aÃ§Ä±lmÄ±ÅŸ silahlar ----
        data.unlockedWeaponIDs.Clear();
        if (CraftingSystem.Instance != null)
        {
            foreach (var id in CraftingSystem.Instance.unlockedWeapons)
                data.unlockedWeaponIDs.Add(id);
        }

        // ---- Ekipman Silah SlotlarÄ± (WeaponSlotManager) ----
        WeaponSlotManager wsm = WeaponSlotManager.Instance;
        if (wsm != null)
        {
            for (int i = 0; i < 3; i++)
            {
                WeaponData wd = wsm.slots[i];

                if (wd != null)
                    data.equippedWeaponIDs[i] = wd.itemID;
                else
                    data.equippedWeaponIDs[i] = "";

                var ammo = wsm.GetAmmo(i);
                data.slotClip[i] = ammo.clip;
                data.slotReserve[i] = ammo.reserve;
            }

            data.activeSlotIndex = wsm.activeSlotIndex;
        }

        // ---- Karavan Envanteri ----
        if (CaravanInventory.Instance != null)
            data.caravanSave = CaravanInventory.Instance.GetSaveData();

        // ---- JSON Yaz ----
        string json = JsonUtility.ToJson(data, true);
        File.WriteAllText(savePath, json);

        Debug.Log("ğŸ’¾ SAVE â†’ TÃ¼m veriler kaydedildi.");
    }

    // ============================================================
    //                          LOAD
    // ============================================================

    public static void LoadPlayerAndInventory(
        Transform player,
        Inventory inventory,
        PlayerStats stats)
    {
        if (player == null || inventory == null || stats == null)
        {
            Debug.LogWarning("LoadPlayerAndInventory: Eksik referans!");
            return;
        }

        if (!HasSave())
        {
            Debug.LogWarning("LoadPlayerAndInventory: KayÄ±t bulunamadÄ±.");
            return;
        }

        string json = File.ReadAllText(savePath);
        SaveData data = JsonUtility.FromJson<SaveData>(json);

        // ---- Pozisyon ----
        Vector3 loadedPos = new Vector3(data.posX, data.posY, data.posZ);
        if (loadedPos.y < 1f) loadedPos.y = 1f;  // yere gÃ¶mÃ¼lme Ã¶nlemi
        player.position = loadedPos;

        // ---- Statlar ----
        stats.maxHealth = data.maxHealth;
        stats.currentHealth = data.currentHealth;
        stats.RefreshHealthUI();

        stats.maxStamina = data.maxStamina;
        stats.ResetStamina();
        stats.ModifyStamina(data.currentStamina - stats.GetStamina());

        stats.maxHunger = data.maxHunger;
        stats.currentHunger = data.currentHunger;

        stats.gold = data.gold;

        // ---- Envanter ----
        inventory.ClearInventory();
        foreach (var item in data.inventory)
        {
            if (string.IsNullOrEmpty(item.itemID) || item.amount <= 0) continue;

            ItemData so = ItemDatabase.Get(item.itemID);
            if (so == null) continue;

            inventory.TryAdd(so, item.amount);
        }

        // ---- Craft ile aÃ§Ä±lmÄ±ÅŸ silahlar ----
        if (CraftingSystem.Instance != null)
        {
            CraftingSystem.Instance.unlockedWeapons.Clear();
            foreach (var id in data.unlockedWeaponIDs)
                CraftingSystem.Instance.unlockedWeapons.Add(id);
        }

        // ---- WeaponSlotManager yÃ¼kleme ----
        WeaponSlotManager wsm = WeaponSlotManager.Instance;
        if (wsm != null)
        {
            for (int i = 0; i < 3; i++)
            {
                string id = data.equippedWeaponIDs[i];

                if (!string.IsNullOrEmpty(id))
                {
                    ItemData so = ItemDatabase.Get(id);
                    if (so is WeaponItemData wid)
                    {
                        wsm.slots[i] = wid.weaponData;
                        wsm.clip[i] = data.slotClip[i];
                        wsm.reserve[i] = data.slotReserve[i];
                    }
                    else
                    {
                        wsm.slots[i] = null;
                        wsm.clip[i] = 0;
                        wsm.reserve[i] = 0;
                    }
                }
                else
                {
                    wsm.slots[i] = null;
                    wsm.clip[i] = 0;
                    wsm.reserve[i] = 0;
                }
            }

            // Aktif slotu uygula
            wsm.activeSlotIndex = Mathf.Clamp(data.activeSlotIndex, 0, 2);
            wsm.SwitchSlot(wsm.activeSlotIndex);
        }

        // ---- Karavan YÃ¼kleme ----
        if (data.caravanSave != null && CaravanInventory.Instance != null)
        {
            CaravanInventory.Instance.LoadFromData(data.caravanSave);
        }

        Debug.Log("ğŸ“¥ LOAD â†’ TÃ¼m veriler geri yÃ¼klendi.");
    }
}
using System;

[Serializable]
public class WeaponSlotSaveData
{
    public string[] equippedWeaponIDs = new string[3];
    public int[] clip = new int[3];
    public int[] reserve = new int[3];
    public int activeSlotIndex;
}
using UnityEngine;
using TMPro;

public class NoteTrigger : MonoBehaviour
{
    public GameObject notePanel;
    public TextMeshProUGUI noteTextUI;
    public AudioSource audioSource;

    private bool isPlayerNearby = false;
    private StoryNote currentNote;
    private int currentIndex = 0; // sÄ±rayla ya da rastgele

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            currentNote = GetComponent<StoryNote>();
            isPlayerNearby = true;

            if (notePanel != null && currentNote != null && currentNote.noteTexts.Length > 0)
            {
                notePanel.SetActive(true);

                // Ä°stersen sÄ±rayla:
                string text = currentNote.noteTexts[currentIndex];
                noteTextUI.text = text;

                if (currentNote.radioClips != null && currentNote.radioClips.Length > currentIndex && audioSource != null)
                {
                    audioSource.clip = currentNote.radioClips[currentIndex];
                    audioSource.Play();
                }

                // sÄ±radakine geÃ§ (loop)
                currentIndex = (currentIndex + 1) % currentNote.noteTexts.Length;
            }
        }
    }

    void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            notePanel.SetActive(false);
            if (audioSource != null) audioSource.Stop();
        }
    }
}
using UnityEngine;

public class StoryNote : MonoBehaviour
{
    [TextArea]
    public string[] noteTexts;   // Birden fazla metin
    public AudioClip[] radioClips; // Her metne karÅŸÄ±lÄ±k ses (opsiyonel)
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class BuildSpot : MonoBehaviour
{
    [Header("Taret Seviyeleri")]
    public TurretLevelData[] levels;

    [Header("Ä°nÅŸa UI")]
    public float buildTime = 2f;
    public Slider progressBar;
    public GameObject progressCanvas;

    private bool isPlayerNearby = false;
    private float holdTimer = 0f;
    private bool isBuilding = false;

    private int currentLevel = 0;
    private GameObject currentTurret;

    private PlayerStats playerStats;

    private void Start()
    {
        if (progressCanvas != null)
            progressCanvas.SetActive(false);

        GameObject player = GameObject.FindWithTag("Player");
        if (player != null)
            playerStats = player.GetComponent<PlayerStats>();
    }

    void Update()
    {
        if (!isPlayerNearby || playerStats == null) return;

        if (Keyboard.current.eKey.isPressed)
        {
            if (currentLevel >= levels.Length)
            {
                Debug.Log("âš ï¸ Zaten maksimum seviyede.");
                return;
            }

            if (!HasEnoughResources())
            {
                Debug.Log("ğŸš« Yetersiz kaynak!");
                return;
            }

            if (!isBuilding)
            {
                isBuilding = true;
                if (progressCanvas != null)
                    progressCanvas.SetActive(true);
            }

            holdTimer += Time.deltaTime;
            if (progressBar != null)
                progressBar.value = holdTimer / buildTime;

            if (holdTimer >= buildTime)
                BuildOrUpgradeTurret();
        }
        else if (isBuilding)
        {
            ResetBuild();
        }
    }

    void BuildOrUpgradeTurret()
{
    if (currentLevel >= levels.Length) return;
    TurretLevelData levelData = levels[currentLevel];

    // Kaynak dÃ¼ÅŸÃ¼r
    if (!Inventory.Instance.TryConsume(levelData.stoneSO, levelData.requiredStone) ||
        !Inventory.Instance.TryConsume(levelData.woodSO, levelData.requiredWood))
    {
        Debug.Log("ğŸš« Kaynak eksik!");
        return;
    }

    if (currentTurret != null)
        Destroy(currentTurret);

    Vector3 spawnPos = new Vector3(transform.position.x, transform.position.y, -1f);
    currentTurret = Instantiate(levelData.prefab, spawnPos, Quaternion.identity);
    currentLevel++;

    ResetBuild();
    Debug.Log($"âœ… Kule seviyesi {currentLevel} oldu!");
}


    void ResetBuild()
    {
        isBuilding = false;
        holdTimer = 0f;

        if (progressBar != null)
            progressBar.value = 0f;

        if (progressCanvas != null)
            progressCanvas.SetActive(false);
    }

    void OnTriggerEnter2D(Collider2D collision)
    {
        if (collision.CompareTag("Player"))
            isPlayerNearby = true;
    }

    void OnTriggerExit2D(Collider2D collision)
    {
        if (collision.CompareTag("Player"))
        {
            isPlayerNearby = false;
            ResetBuild();
        }
    }

    bool HasEnoughResources()
{
    if (currentLevel >= levels.Length || playerStats == null) return false;

    TurretLevelData levelData = levels[currentLevel];

    bool hasResources =
        Inventory.Instance.HasEnough(levelData.stoneSO, levelData.requiredStone) &&
        Inventory.Instance.HasEnough(levelData.woodSO, levelData.requiredWood);

    // EÄŸer blueprint sistemi Inventoryâ€™ye baÄŸlandÄ±ysa:
    bool hasBlueprint = string.IsNullOrEmpty(levelData.requiredBlueprintId)
        || Inventory.Instance.HasBlueprint(levelData.requiredBlueprintId);

    if (!hasBlueprint)
        Debug.Log($"ğŸš« Gerekli taslak yok: {levelData.requiredBlueprintId}");

    return hasResources && hasBlueprint;
}


}
using UnityEngine;

public class Turret : MonoBehaviour
{
    public float attackRange = 5f;
    public float fireRate = 1f;
    public GameObject bulletPrefab;
    public float bulletSpeed = 10f;

    private float fireTimer = 0f;

    void Update()
    {
        fireTimer -= Time.deltaTime;

        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, attackRange);
        foreach (var hit in hits)
        {
            Enemy enemy = hit.GetComponent<Enemy>();
            if (enemy != null && fireTimer <= 0)
            {
                Shoot(enemy.transform.position);
                fireTimer = 1f / fireRate;
                break; // Ä°lk dÃ¼ÅŸmanÄ± vur, Ã§Ä±k
            }
        }
    }

void Shoot(Vector3 targetPosition)
{
    Vector3 direction = (targetPosition - transform.position).normalized;

    // YÃ¶n doÄŸrultusunda bir rotasyon hesapla (X yÃ¶nÃ¼ne gÃ¶re dÃ¶ndÃ¼r)
    float angle = Mathf.Atan2(direction.y, direction.x) * Mathf.Rad2Deg;
    Quaternion rotation = Quaternion.Euler(0, 0, angle); // â¬…ï¸ sadece bu Ã¶nemli

    // Mermiyi doÄŸru rotasyonla oluÅŸtur
    GameObject bullet = Instantiate(bulletPrefab, transform.position, rotation);
}




    void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.red;
        Gizmos.DrawWireSphere(transform.position, attackRange);
    }
}
using UnityEngine;

[RequireComponent(typeof(Rigidbody2D))]
public class TurretBullet : MonoBehaviour
{
    public float speed = 15f;
    public int damage = 5;

    private Rigidbody2D rb;

    void Awake()
    {
        rb = GetComponent<Rigidbody2D>();
    }

    void Start()
    {
        // Mermiyi yÃ¶nÃ¼ne gÃ¶re fÄ±rlat
        rb.linearVelocity = transform.right * speed;

        // 3 saniye sonra yok olsun
        Destroy(gameObject, 3f);
    }

    private void OnTriggerEnter2D(Collider2D collision)
    {
        // Oyuncuya veya baÅŸka mermiye Ã§arpmasÄ±n
        if (collision.CompareTag("Player") || collision.CompareTag("Bullet"))
            return;

        Enemy enemy = collision.GetComponent<Enemy>();
        if (enemy != null)
        {
            enemy.TakeDamage(damage);
        }

        Destroy(gameObject);
    }
}
using UnityEngine;

[System.Serializable]
public class TurretLevelData
{
    public GameObject prefab;
    public int requiredStone;
    public int requiredWood;
    public string requiredBlueprintId;
     [Header("Sample Items")]
    public ItemData stoneSO;
    public ItemData woodSO;



}
using UnityEngine;
using System.Collections;

public class BurnZone : MonoBehaviour
{
    public int damagePerSecond = 5;
    public float duration = 5f;

    private float tickTimer;

private void OnTriggerStay2D(Collider2D other)
{
    if (other.CompareTag("Enemy"))
    {
        tickTimer += Time.deltaTime;
        if (tickTimer >= 1f)
        {
            tickTimer = 0f;
            Enemy enemy = other.GetComponent<Enemy>();
            if (enemy != null)
                enemy.TakeDamage(damagePerSecond);
        }
    }
}

}
using System.Collections;
using UnityEngine;

public class MolotovProjectile : MonoBehaviour
{
    [Header("Explosion Settings")]
    public GameObject fireEffectPrefab;
    public float explosionRadius = 2.5f;
    public int impactDamage = 20;
    public int burnDamagePerSecond = 5;
    public float fireDuration = 5f;

    private bool hasExploded = false;

   private void OnTriggerEnter2D(Collider2D other)
{
    Debug.Log($"ğŸ”¥ Trigger tetiklendi: {other.name} (Layer: {LayerMask.LayerToName(other.gameObject.layer)})");

    if (hasExploded) return;

    // ğŸ’¡ Sadece zemine Ã§arpÄ±nca patla
    if (other.gameObject.layer == LayerMask.NameToLayer("GroundTrigger"))
    {
        hasExploded = true;
        Debug.Log("ğŸ’¥ Molotov yere Ã§arptÄ±, patlÄ±yor!");
        Explode();
    }
    else
    {
        // DiÄŸer layer'lar (Animal, Build vs.) tamamen gÃ¶rmezden gel
        Debug.Log($"â­ {other.name} yoksayÄ±ldÄ± (Layer: {LayerMask.LayerToName(other.gameObject.layer)})");
    }
}



    private void Explode()
    {
        Debug.Log("ğŸ’¥ Molotov yere Ã§arptÄ±, patlÄ±yor!");

        // ğŸ”¥ 1. Fire effect oluÅŸtur
        if (fireEffectPrefab != null)
        {
            GameObject fire = Instantiate(fireEffectPrefab, transform.position, Quaternion.identity);
            Destroy(fire, fireDuration);
            Debug.Log("ğŸ”¥ Fire effect oluÅŸturuldu!");
        }

        // ğŸ’¢ 2. Ä°lk patlama hasarÄ±
        ApplyDamage(impactDamage);

        // ğŸ”¥ 3. Yanma alanÄ± oluÅŸtur
        StartCoroutine(CreateBurnZone());

        // ğŸ§¨ 4. Molotov objesini sahneden kaldÄ±r (gÃ¶rÃ¼nmez yap)
        GetComponent<SpriteRenderer>().enabled = false;
        GetComponent<Collider2D>().enabled = false;
        GetComponent<Rigidbody2D>().isKinematic = true;
    }

private void ApplyDamage(int damage)
{
    Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, explosionRadius);
    foreach (var hit in hits)
    {
        if (hit.CompareTag("Enemy"))
        {
            Enemy enemy = hit.GetComponent<Enemy>();
            if (enemy != null)
            {
                enemy.TakeDamage(damage);
                Debug.Log($"ğŸ’¥ Patlama hasarÄ±: {damage} verildi -> {enemy.name}");
            }
        }
    }
}

    private IEnumerator CreateBurnZone()
    {
        Debug.Log("ğŸ”¥ Yanma alanÄ± oluÅŸturuldu!");
        float elapsed = 0f;

        // GeÃ§ici alan objesi oluÅŸtur
        GameObject burnZone = new GameObject("BurnZone");
        burnZone.transform.position = transform.position;
        CircleCollider2D col = burnZone.AddComponent<CircleCollider2D>();
        col.isTrigger = true;
        col.radius = explosionRadius;

        // 2D rigidbody (Trigger Ã§alÄ±ÅŸmasÄ± iÃ§in ÅŸart)
        Rigidbody2D rb = burnZone.AddComponent<Rigidbody2D>();
        rb.isKinematic = true;

        // Hasar scriptâ€™i ekle
        BurnZone zone = burnZone.AddComponent<BurnZone>();
        zone.damagePerSecond = burnDamagePerSecond;
        zone.duration = fireDuration;

        // Fire bitince alanÄ± kaldÄ±r
        Destroy(burnZone, fireDuration);

        yield return null;
    }


    private IEnumerator BurnDamageOverTime()
    {
        float elapsed = 0f;
        while (elapsed < fireDuration)
        {
            Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, explosionRadius);
            foreach (var hit in hits)
            {
                if (hit.CompareTag("Enemy"))
                {
                    var enemy = hit.GetComponent<Enemy>();
                    if (enemy != null) enemy.TakeDamage(burnDamagePerSecond);
                }
            }
            yield return new WaitForSeconds(1f);
            elapsed += 1f;
        }
    }
}
using System.Collections;
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;


public class MolotovThrower : MonoBehaviour
{
    [Header("Molotov Settings")]
    public GameObject molotovPrefab;
    public Transform throwPoint;
    public float maxThrowForce = 12f;
    public float minThrowForce = 4f;
    public float chargeSpeed = 4f;
    public float cooldown = 1.5f;

    private float currentForce;
    private bool isCharging;
    private float chargeStartTime;
    private float lastThrowTime;

    private bool justEnabled;

    [Header("UI")]
    public Slider chargeBar; // ÅŸarj dolum gÃ¶stergesi


    private void Start()
    {
        if (chargeBar == null)
        {
            chargeBar = GameObject.FindObjectOfType<Slider>(true);
            if (chargeBar != null)
                Debug.Log("âœ… ChargeBar sahnede otomatik bulundu!");
            else
                Debug.LogWarning("âš ï¸ ChargeBar sahnede bulunamadÄ±!");
        }
    }

    void Awake()
    {
        AutoWireThrowPoint();
    }

    void Update()
    {

        if (justEnabled)
        {
            // ğŸ”’ Bu frame'de hiÃ§bir input iÅŸleme
            justEnabled = false;
            return;
        }



        // --- FÄ±rlatma kilidi: cooldown bitmeden atÄ±ÅŸ olmasÄ±n
        if (Time.time < lastThrowTime + cooldown)
            return;

        // --- BasÄ±lÄ± tutma sÃ¼resine gÃ¶re ÅŸarj et
        if (Mouse.current.leftButton.wasPressedThisFrame)
        {
            isCharging = true;
            chargeStartTime = Time.time;
            currentForce = minThrowForce;
            Debug.Log("ğŸ”¥ Molotov ÅŸarj ediliyor...");

            if (chargeBar != null)
            {
                chargeBar.gameObject.SetActive(true);
                chargeBar.value = 0f;
            }
        }

        if (isCharging && Mouse.current.leftButton.isPressed)
        {
            float elapsed = Time.time - chargeStartTime;
            float t = Mathf.Clamp01(elapsed / 3f); // 3 saniyede tam ÅŸarj
            currentForce = Mathf.Lerp(minThrowForce, maxThrowForce, t);

            // ğŸ”¹ Bar'Ä± gÃ¼ncelle
            if (chargeBar != null)
                chargeBar.value = t;
        }

        // --- Mouse bÄ±rakÄ±ldÄ±ÄŸÄ±nda fÄ±rlat
        if (isCharging && Mouse.current.leftButton.wasReleasedThisFrame)
        {
            ThrowMolotov();
            isCharging = false;

            if (chargeBar != null)
            {
                chargeBar.value = 0f;
                chargeBar.gameObject.SetActive(false);
            }
        }

    }

    void OnEnable()
    {
        justEnabled = true; // aktif edildiÄŸi frame
    }




    private void AutoWireThrowPoint()
    {
        if (throwPoint != null) return;

        // Ã–nce playerâ€™Ä±n FirePointâ€™ini bul
        var playerWeapon = GetComponentInParent<PlayerWeapon>();
        if (playerWeapon != null && playerWeapon.firePoint != null)
        {
            throwPoint = playerWeapon.firePoint;
            Debug.Log($"MolotovThrower â†’ FirePoint otomatik atandÄ±: {throwPoint.name}");
            return;
        }

        // Sahne iÃ§inde â€œFirePointâ€ isminde bir child varsa onu kullan
        var found = transform.Find("FirePoint");
        if (found != null)
        {
            throwPoint = found;
            Debug.Log($"MolotovThrower â†’ FirePoint bulundu: {throwPoint.name}");
        }
    }

    // MolotovThrower.cs - deÄŸiÅŸiklikler
    private void ThrowMolotov()
    {
        if (molotovPrefab == null || throwPoint == null)
        {
            Debug.LogWarning("âš ï¸ MolotovPrefab veya ThrowPoint atanmadÄ±!");
            return;
        }

        Vector3 mouseWorldPos = Camera.main.ScreenToWorldPoint(Mouse.current.position.ReadValue());
        Vector2 direction = (mouseWorldPos - throwPoint.position).normalized;

        Vector3 spawnPos = throwPoint.position + (Vector3)direction * 0.5f;
        GameObject molotov = Instantiate(molotovPrefab, spawnPos, Quaternion.identity);

        Debug.Log($"ğŸ§¨ Molotov oluÅŸturuldu: {molotov.name} @ {spawnPos}");

        Rigidbody2D rb = molotov.GetComponent<Rigidbody2D>();
        if (rb != null)
        {
            rb.gravityScale = 1f;
            rb.AddForce(direction * currentForce, ForceMode2D.Impulse);
            Debug.Log($"ğŸ’£ Kuvvet uygulandÄ±: {direction * currentForce}");
        }
        else
        {
            Debug.LogWarning("âš ï¸ Rigidbody2D bulunamadÄ±!");
        }

        lastThrowTime = Time.time;

    }




}
using UnityEngine;

public class MolotovWeapon : PlayerWeapon
{
    [Header("Molotov Settings")]
    public GameObject molotovProjectilePrefab;
    public Transform throwPoint;
    public float throwForce = 10f;

    public void Shoot()
    {
        if (molotovProjectilePrefab == null || throwPoint == null)
            return;

        GameObject molotov = Instantiate(molotovProjectilePrefab, throwPoint.position, throwPoint.rotation);
        Rigidbody2D rb = molotov.GetComponent<Rigidbody2D>();
        if (rb != null)
            rb.AddForce(throwPoint.up * throwForce, ForceMode2D.Impulse);

        Debug.Log("Molotov fÄ±rlatÄ±ldÄ±!");

        // DayanÄ±klÄ±lÄ±k gideri
        base.Shoot();
    }
}
using UnityEngine;

[System.Serializable]
public class PartRequirement
{
    public PartItemData partType;
    public int amount = 1;
}
// RequirementLineUI.cs (TEK TEXT'LÄ° VERSÄ°YON)

using UnityEngine;
using TMPro;

public class RequirementLineUI : MonoBehaviour
{
    // ArtÄ±k sadece tek bir text elemanÄ±na ihtiyacÄ±mÄ±z var.
    public TextMeshProUGUI requirementText;

    // Bu fonksiyon, satÄ±rÄ± doÄŸru bilgilerle doldurur ve renklendirir.
    public void Setup(string name, int currentAmount, int requiredAmount)
    {
        if (requirementText == null) return;

        // Yeterli malzememiz var mÄ±?
        bool hasEnough = (currentAmount >= requiredAmount);

        // Metnin rengini belirle.
        // Yeterliyse yeÅŸil, deÄŸilse kÄ±rmÄ±zÄ±.
        // ColorUtility.ToHtmlStringRGB ile renk kodlarÄ±nÄ± string iÃ§ine gÃ¶mebiliriz.
        string colorHex = hasEnough ? "green" : "red";

        // BiÃ§imlendirilmiÅŸ metni oluÅŸtur: "Barrel: <color=red>0 / 3</color>"
        requirementText.text = $"{name}: <color={colorHex}>{currentAmount} / {requiredAmount}</color>";
    }
}
using UnityEngine;

public class UIController : MonoBehaviour
{
    public static UIController Instance;
    public GameObject craftMessage;

    void Awake()
    {
        if (Instance == null) Instance = this;
        else Destroy(gameObject);
    }

    public void ShowCraftMessage()
    {
        if (craftMessage != null)
            craftMessage.SetActive(true);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.Rendering.Universal;

public class WeaponAim : MonoBehaviour
{
    [Header("Components")]
    [Tooltip("SilahÄ±n ve altÄ±ndaki her ÅŸeyin dÃ¶neceÄŸi ana pivot. Genellikle silahÄ±n kendisidir.")]
    public Transform weaponPivot;

    [Tooltip("Bu silaha ait Light 2D objesi.")]
    public Light2D flashlight;

    [Tooltip("Merminin Ã§Ä±kacaÄŸÄ± namlu ucu transformu.")]
    public Transform firePoint;

    private SpriteRenderer weaponSpriteRenderer;

    // FirePoint'in baÅŸlangÄ±Ã§ lokal pozisyonu
    private Vector3 firePointDefaultLocalPos;

    private void Awake()
    {
        if (weaponPivot != null)
            weaponSpriteRenderer = weaponPivot.GetComponentInChildren<SpriteRenderer>();

        if (firePoint != null)
            firePointDefaultLocalPos = firePoint.localPosition; // Ã¶rn: (0.05, 0.01, 0)
    }

    private void OnDisable()
    {
        if (flashlight != null) flashlight.gameObject.SetActive(false);
    }

    private void OnEnable()
    {
        if (flashlight != null) flashlight.gameObject.SetActive(true);
    }

    private void LateUpdate()
    {
        if (GameStateManager.IsGamePaused ||GameStateManager.IsGameOver) return;
        if (Camera.main == null || weaponPivot == null) return;

        // Fare hedefi
        Vector3 mousePosition = Mouse.current.position.ReadValue();
        Vector3 worldPosition = Camera.main.ScreenToWorldPoint(mousePosition);
        Vector3 aimDirection = (worldPosition - weaponPivot.position).normalized;
        float angle = Mathf.Atan2(aimDirection.y, aimDirection.x) * Mathf.Rad2Deg;

        // SilahÄ± dÃ¶ndÃ¼r
        weaponPivot.rotation = Quaternion.Euler(0f, 0f, angle);

        // Sprite flip (senin mantÄ±ÄŸÄ±n)
        float facingDirection = PlayerMovement.FacingDirection;
        bool flip = (facingDirection < 0);

        if (weaponSpriteRenderer != null)
        {
            // Hem X hem Y flip
            weaponSpriteRenderer.flipX = flip;
            weaponSpriteRenderer.flipY = flip;
        }

        // Fener yÃ¶nÃ¼
        if (flashlight != null)
            flashlight.transform.rotation = Quaternion.Euler(0f, 0f, angle - 90f);

        // FirePoint pozisyonu ve yÃ¶nÃ¼
        if (firePoint != null)
        {
            // Hem X hem Y iÅŸaretini facing'e gÃ¶re deÄŸiÅŸtir
            float sx = flip ? -1f : 1f;
            float sy = flip ? -1f : 1f;

            firePoint.localPosition = new Vector3(
                firePointDefaultLocalPos.x * sx,
                firePointDefaultLocalPos.y * sy,
                firePointDefaultLocalPos.z
            );

            // Rotasyonu pivot'tan miras alsÄ±n
            firePoint.localRotation = Quaternion.identity;
        }
    }
}
using UnityEngine;

[RequireComponent(typeof(Rigidbody2D))]
public class WeaponBullet : MonoBehaviour
{
    [Header("Bullet Settings")]
    public float speed = 20f;
    public int damage = 10;
    private Rigidbody2D rb;

    [Header("References")]
    public Transform owner;            // PlayerWeapon atar
    public WeaponType weaponType;      // 📌 Hangi silah türünden atıldığı buraya atanacak

    [Header("Animal Scare")]
    public float fleeOnHitDuration = 3.5f;
    public float fleeOnHitMultiplier = 2.2f;

     [Header("Knockback (applied always)")]
    public float knockbackForce = 6f;      // atanacak kuvvet (bullet'e atanır)
    public float knockbackDuration = 0.18f; // kuvvet uygulanma süresi

     private int enemiesHit = 0;
    private const int maxPenetration = 2; // 2 düşmandan sonra yok olur

    void Awake()
    {
        rb = GetComponent<Rigidbody2D>();
    }

    void Start()
    {
        rb.linearVelocity = transform.right * speed;
        Destroy(gameObject, 3f);
    }

    private void OnTriggerEnter2D(Collider2D collision)
    {
        if (collision.CompareTag("Player") || collision.CompareTag("Bullet")) return;

        // 🎯 Düşmana çarptıysa hasar ver ve knockback kontrolü yap
         Enemy enemy = collision.GetComponent<Enemy>();
        if (enemy != null)
        {
            enemiesHit++;

            int appliedDamage = damage;
            if (weaponType == WeaponType.Sniper && enemiesHit > 1)
                appliedDamage = Mathf.RoundToInt(damage * 0.5f); // ikinci hedefe yarı hasar

            enemy.TakeDamage(appliedDamage);

            // Knockback uygula (her zaman)
            if (weaponType == WeaponType.Shotgun || weaponType == WeaponType.Sniper)
            {
                Vector2 sourcePos = transform.position;
                enemy.ApplyKnockback(sourcePos, knockbackForce, knockbackDuration);
            }

            // 🔹 Eğer sniper mermisi 2 düşmana çarpmışsa yok ol
            if (weaponType == WeaponType.Sniper && enemiesHit >= maxPenetration)
            {
                Destroy(gameObject);
                return;
            }
            // 🔹 Diğer silahlar hemen yok olur
            else if (weaponType != WeaponType.Sniper)
            {
                Destroy(gameObject);
                return;
            }
        }

        // 🐺 Hayvanlara korku efekti
        Animal animal = collision.GetComponent<Animal>();
        if (animal != null)
        {
            Vector2 threatPos = (owner != null) ? (Vector2)owner.position : (Vector2)transform.position;
            animal.Scare(threatPos, fleeOnHitDuration, fleeOnHitMultiplier);
            animal.TakeDamage(damage);
        }

        if (!collision.isTrigger)
        Destroy(gameObject);
    }
}
using System;
using System.Collections.Generic;
using UnityEngine;

[CreateAssetMenu(fileName = "New Weapon Craft Recipe", menuName = "Crafting/Weapon Craft Recipe")]
public class WeaponCraftRecipe : ScriptableObject
{
    [Header("Ãœretilecek Silah")]
    public WeaponData resultWeapon;

    [Header("Craft AÃ§Ä±klamasÄ± (Opsiyonel)")]
    [TextArea]
    public string description;

    [Header("Gerekli Kaynaklar")]
    public List<ResourceCost> costs = new List<ResourceCost>();
}

[Serializable]
public class ResourceCost
{
    public ItemData item;
    public int amount = 1;
}
using UnityEngine;

[CreateAssetMenu(fileName = "New Weapon Data", menuName = "Weapons/Weapon Data")]
public class WeaponData : ItemData
{
    public GameObject prefab;
    public WeaponType weaponType;

    public float knockbackForce = 6f;
    public float knockbackDuration = 0.18f;

    public bool isAutomatic;
    public float fireRate = 2f;
    public int damage;

    public int clipSize;
    public int maxAmmoCapacity;
    public float reloadTime = 1.5f;

    public float attackRange = 1.5f;

    public bool isShotgun = false;
    public int pelletsPerShot = 3;
    public float pelletSpreadAngle = 8f;
    public float shotgunCooldown = 2.5f;

    public bool isSniper = false;
    public float sniperCooldown = 3.0f;
    public int sniperPenetrationCount = 2;

    public ResourceType ammoType;

    public bool isMolotov;
    public GameObject fireEffectPrefab;
    public float explosionRadius = 2.5f;
    public int burnDamage = 1;
    public float burnDuration = 5f;
    public float tickInterval = 1f;
}
using UnityEngine;

public class WeaponDataHolder : MonoBehaviour
{
    public WeaponData weaponData;
}
using UnityEngine;

public class WeaponHolder : MonoBehaviour
{
    public WeaponData weaponData;
}
// WeaponInventory.cs (DÜZELTİLMİŞ VE DOĞRU HALİ)

using UnityEngine;
using UnityEngine.UI;
using System.Collections.Generic;

public class WeaponInventory : MonoBehaviour
{
    // Bu referans artık doğrudan silahları yönetmek için değil,
    // yeni silahın verilerini merkezi ateş etme sistemine bildirmek için kullanılacak.
    public PlayerWeapon playerWeapon;
    public GameObject[] weaponPrefabs; // 0: Makineli, 1: Tabanca, 2: Yakın dövüş
    public Transform weaponHolder; // Silahların oluşturulacağı yer (firePoint yerine bu daha mantıklı)

    // Aktif silah objelerini bu dizide tutacağız.
    private GameObject[] weaponInstances;
    private int currentSlot = 1; // Başlangıç slotu

    // ... (crafting ile ilgili değişkenleriniz aynı kalabilir) ...
    public Text craftHintText;
    private HashSet<string> collectedParts = new HashSet<string>();
    private string[] requiredParts = new string[] {
        "Barrel", "Magazine", "Foregrip", "Grip", "Trigger", "TriggerGuard"
    };

    void Start()
    {
        // weaponInstances dizisini başlat
        weaponInstances = new GameObject[weaponPrefabs.Length];
        EquipSlot(currentSlot);

        if (craftHintText != null)
            craftHintText.gameObject.SetActive(false);
    }

    void Update()
    {
        // ... (Update içeriğiniz aynı kalabilir) ...
        if (Input.GetKeyDown(KeyCode.Alpha1)) EquipSlot(0);
        if (Input.GetKeyDown(KeyCode.Alpha2)) EquipSlot(1);
        if (Input.GetKeyDown(KeyCode.Alpha3)) EquipSlot(2);

        if (Input.GetKeyDown(KeyCode.C) && HasAllParts())
        {
            CraftNewWeapon();
        }
    }

    private void EquipSlot(int slotIndex)
    {
        // Geçersiz slot veya zaten o slot seçiliyse işlem yapma
        if (slotIndex < 0 || slotIndex >= weaponPrefabs.Length || slotIndex == currentSlot) return;

        // 1. Mevcut aktif silahı yok et (eğer varsa)
        if (weaponInstances[currentSlot] != null)
        {
            Destroy(weaponInstances[currentSlot]);
        }

        // 2. Yeni silahın prefab'ını al ve oluştur
        GameObject weaponPrefabToInstantiate = weaponPrefabs[slotIndex];
        if (weaponPrefabToInstantiate == null)
        {
            Debug.LogError($"Slot {slotIndex} için silah prefab'ı atanmamış!");
            return;
        }

        // Yeni silahı weaponHolder'ın altında oluştur
        GameObject newWeaponInstance = Instantiate(weaponPrefabToInstantiate, weaponHolder.position, weaponHolder.rotation, weaponHolder);

        // 3. Oluşturulan yeni silahı dizide sakla
        weaponInstances[slotIndex] = newWeaponInstance;
        currentSlot = slotIndex; // Mevcut slotu güncelle

        // 4. Merkezi ateş etme sistemini (PlayerWeapon) yeni silahın verileriyle yapılandır.
        // Bu satır sizin kodunuzda vardı, çok doğru bir yaklaşım.
        WeaponDataHolder dataHolder = newWeaponInstance.GetComponent<WeaponDataHolder>();
        if (dataHolder != null && playerWeapon != null)
        {
            // PlayerWeapon'ın weaponData'sını yeni silahınkiyle değiştiriyoruz.
            playerWeapon.weaponData = dataHolder.weaponData;
            // Not: Mermi ve şarjör mekaniği için burada PlayerWeapon'daki mermi sayısını da güncellemeniz gerekecek.
            // Bu kısım WeaponSlotManager'daki mantığa benziyor.
        }
    }

    // ... (Crafting fonksiyonlarınız aynı kalabilir) ...
    public void CollectPart(string partName) { /* ... */ }
    private bool HasAllParts() { /* ... */ return true; }
    private void CraftNewWeapon() { /* ... */ }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Inventory/Weapon Item")]
public class WeaponItemData : ItemData
{
    [Header("Weapon Link")]
    public WeaponType weaponType;   // Pistol / Rifle / Melee
    public WeaponData weaponData;   // AteÅŸ etme davranÄ±ÅŸlarÄ±

    private void OnValidate()
    {
        category = ItemCategory.Weapon;
        stackable = false;
        maxStack = 1;
    }
}
using UnityEngine;

public class WeaponPart : MonoBehaviour
{
    public WeaponPartType partType;
}
public enum WeaponPartType
{
    Barrel,
    Magazine,
    Handguard,
    Grip,
    Trigger,
    TriggerGuard,
    Stone,
    Wood,
    ScrapMetal
}
using UnityEngine;

public enum WeaponSlotType
{
    Pistol = 0,
    Rifle = 1,
    Melee = 2
}

public class WeaponSlotManager : MonoBehaviour
{
    public static WeaponSlotManager Instance;

    [Header("Player Weapon Handlers")]
    public PlayerWeapon pistolHandler;
    public PlayerWeapon rifleHandler;
    public PlayerWeapon meleeHandler;

    [Header("Equipped Weapons (WeaponData)")]
    public WeaponData[] slots = new WeaponData[3];

    // Mermi durumu (clip + reserve)
    [Header("Ammo State per Slot")]
    public int[] clip = new int[3];
    public int[] reserve = new int[3];

    [Header("Active Slot")]
    public int activeSlotIndex = 0;



    void Awake()
    {
        if (Instance != null) { Destroy(gameObject); return; }
        Instance = this;

        // Mermileri 0 baÅŸlat
        for (int i = 0; i < 3; i++)
        {
            clip[i] = 0;
            reserve[i] = 0;
        }
    }



    // -------------------------------
    // Silah tipine gÃ¶re slot belirle
    // -------------------------------
    public WeaponSlotType GetSlotForWeapon(WeaponData weapon)
    {
        if (weapon == null)
            return WeaponSlotType.Rifle; // default

        switch (weapon.weaponType)
        {
            // TABANCA SLOTU (0)
            case WeaponType.Pistol:
                return WeaponSlotType.Pistol;

            // TÃœFEK / UZUN MENZÄ°L SLOTU (1)
            case WeaponType.MachineGun:
            case WeaponType.Shotgun:
            case WeaponType.Sniper:
            case WeaponType.Bow:
                return WeaponSlotType.Rifle;

            // YAKIN DÃ–VÃœÅ SLOTU (2)
            case WeaponType.ThrowingSpear:
            case WeaponType.MeeleSword:
                return WeaponSlotType.Melee;

            // TanÄ±nmayanlar varsayÄ±lan: tÃ¼fek slotu
            default:
                return WeaponSlotType.Rifle;
        }
    }


    // -------------------------------
    // Silah kuÅŸan
    // -------------------------------
    public void EquipWeapon(ItemData item)
    {
        WeaponItemData wid = item as WeaponItemData;
        if (wid == null)
        {
            Debug.LogError("EquipWeapon â†’ Bu item bir WeaponItemData deÄŸil!");
            return;
        }

        WeaponData weapon = wid.weaponData;
        if (weapon == null)
        {
            Debug.LogError("EquipWeapon â†’ WeaponItemData.weaponData boÅŸ!");
            return;
        }

        int slot = (int)GetSlotForWeapon(weapon);
        slots[slot] = weapon;

        clip[slot] = weapon.clipSize;
        reserve[slot] = weapon.maxAmmoCapacity;

        ApplyToHandler(slot);

        Debug.Log($"[WeaponSlotManager] {item.itemName} (WeaponData: {weapon.name}) slot {slot} iÃ§ine takÄ±ldÄ±.");
    }


    // -------------------------------
    // Aktif slota geÃ§iÅŸ
    // -------------------------------
    public void SwitchSlot(int newSlot)
    {
        if (newSlot < 0 || newSlot > 2) return;

        activeSlotIndex = newSlot;
        ApplyToHandler(newSlot);
    }

    // -------------------------------
    // PlayerWeapon'a silahÄ± aktar
    // -------------------------------
    private void ApplyToHandler(int slot)
{
    // TÃ¼m handlerâ€™larÄ± kapat
    pistolHandler.gameObject.SetActive(false);
    rifleHandler.gameObject.SetActive(false);
    meleeHandler.gameObject.SetActive(false);

    // Yeni handler
    PlayerWeapon handler = GetHandler(slot);
    if (handler == null)
    {
        Debug.LogError("Handler bulunamadÄ±! Slot: " + slot);
        return;
    }

    // Handlerâ€™Ä± aktif et
    handler.gameObject.SetActive(true);

    // SilahÄ± yÃ¼kle
    WeaponData weapon = slots[slot];
    if (weapon != null)
    {
        handler.SetWeapon(weapon);

        Debug.Log("Handler aÃ§Ä±ldÄ± ve silah verildi: " + weapon.name);
    }
    else
    {
        Debug.LogWarning("Slot boÅŸ ama handler aktif edildi: " + slot);
    }
}



    private PlayerWeapon GetHandler(int slot)
    {
        switch ((WeaponSlotType)slot)
        {
            case WeaponSlotType.Pistol: return pistolHandler;
            case WeaponSlotType.Rifle: return rifleHandler;
            case WeaponSlotType.Melee: return meleeHandler;
        }
        return null;
    }

    // -------------------------------
    // Ammo state
    // -------------------------------
    public (int clip, int reserve) GetAmmo(int slot)
    {
        return (clip[slot], reserve[slot]);
    }

    public void SetAmmo(int slot, int newClip, int newReserve)
    {
        clip[slot] = newClip;
        reserve[slot] = newReserve;

        // aktif slot ise PlayerWeaponâ€™Ä± gÃ¼ncelle
        if (slot == activeSlotIndex)
        {
            ApplyToHandler(slot);
        }
    }

    // -------------------------------
    // Save/Load iÃ§in Getter
    // -------------------------------
    public WeaponData GetEquippedWeapon(int slot)
    {
        return slots[slot];
    }

    public void EquipCraftedWeapon(WeaponData newWeapon)
{
    int slot = (int)GetSlotForWeapon(newWeapon);

    Debug.Log($"[EquipCraftedWeapon] Yeni silah: {newWeapon.itemName}, Slot: {slot}");

    // 1) Eski silahÄ± karavana gÃ¶nder
    WeaponData oldWeapon = slots[slot];
    if (oldWeapon != null)
    {
        CaravanInventory.Instance.StoreWeapon(oldWeapon);
        Debug.Log("Eski silah karavana gÃ¶nderildi: " + oldWeapon.itemName);
    }

    // 2) Yeni silah slota ekle
    slots[slot] = newWeapon;

    // 3) Mermi bilgilerini sÄ±fÄ±rla
    clip[slot] = newWeapon.clipSize;
    reserve[slot] = newWeapon.maxAmmoCapacity;

    // 4) EÄŸer aktif slot buysa hemen gÃ¼ncelle
    if (activeSlotIndex == slot)
    {
        ApplyToHandler(slot);
    }
    else
    {
        // Craft edilen silaha otomatik geÃ§mek istiyorsan:
        activeSlotIndex = slot;
        ApplyToHandler(slot);
    }

    Debug.Log("Yeni silah oyuncuya takÄ±ldÄ±: " + newWeapon.itemName);
}

// ----------------------------------------------------
//  SAVE
// ----------------------------------------------------
public WeaponSlotSaveData GetSaveData()
{
    WeaponSlotSaveData data = new WeaponSlotSaveData();

    for (int i = 0; i < 3; i++)
    {
        if (slots[i] != null)
            data.equippedWeaponIDs[i] = slots[i].itemID;
        else
            data.equippedWeaponIDs[i] = "";

        data.clip[i] = clip[i];
        data.reserve[i] = reserve[i];
    }

    data.activeSlotIndex = activeSlotIndex;

    return data;
}


// ----------------------------------------------------
//  LOAD
// ----------------------------------------------------
public void LoadData(WeaponSlotSaveData data)
{
    for (int i = 0; i < 3; i++)
    {
        string id = data.equippedWeaponIDs[i];

        if (!string.IsNullOrEmpty(id))
        {
            ItemData item = ItemDatabase.Get(id);
            if (item is WeaponItemData wid)
            {
                slots[i] = wid.weaponData;
                clip[i] = data.clip[i];
                reserve[i] = data.reserve[i];
            }
            else
            {
                slots[i] = null;
                clip[i] = 0;
                reserve[i] = 0;
            }
        }
        else
        {
            slots[i] = null;
            clip[i] = 0;
            reserve[i] = 0;
        }
    }

    activeSlotIndex = Mathf.Clamp(data.activeSlotIndex, 0, 2);

    // handler'Ä± gÃ¼ncelle
    SwitchSlot(activeSlotIndex);
}



}
public enum WeaponType
{
    Pistol,
    MachineGun,
    Shotgun,
    Sniper,
    Molotov,
    ThrowingSpear,
    Bow,
    MeeleSword
}

using UnityEngine;

[CreateAssetMenu(menuName = "Items/Magazine Item")]
public class MagazineItem : ScriptableObject
{
    public string magName;
    public Sprite icon;

    public string ammoType;   // â† Ã–NEMLÄ°: string olmalÄ±!
    public int capacity = 12;
    public int currentAmmo = 0;

    public bool IsFull => currentAmmo >= capacity;
    public bool IsEmpty => currentAmmo <= 0;
}
using UnityEditor;
using UnityEngine;

[CustomEditor(typeof(WeaponData))]
public class WeaponDataEditor : Editor
{
    SerializedProperty prefab;
    SerializedProperty weaponType;

    SerializedProperty knockbackForce;
    SerializedProperty knockbackDuration;

    SerializedProperty isAutomatic;
    SerializedProperty fireRate;
    SerializedProperty damage;

    SerializedProperty clipSize;
    SerializedProperty maxAmmoCapacity;
    SerializedProperty reloadTime;

    SerializedProperty attackRange;

    SerializedProperty pelletsPerShot;
    SerializedProperty pelletSpreadAngle;
    SerializedProperty shotgunCooldown;

    SerializedProperty sniperCooldown;
    SerializedProperty sniperPenetrationCount;

    SerializedProperty ammoType;

    SerializedProperty fireEffectPrefab;
    SerializedProperty explosionRadius;
    SerializedProperty burnDamage;
    SerializedProperty burnDuration;
    SerializedProperty tickInterval;

    SerializedProperty isMolotov;

    void OnEnable()
    {
        prefab = serializedObject.FindProperty("prefab");
        weaponType = serializedObject.FindProperty("weaponType");

        knockbackForce = serializedObject.FindProperty("knockbackForce");
        knockbackDuration = serializedObject.FindProperty("knockbackDuration");

        isAutomatic = serializedObject.FindProperty("isAutomatic");
        fireRate = serializedObject.FindProperty("fireRate");
        damage = serializedObject.FindProperty("damage");

        clipSize = serializedObject.FindProperty("clipSize");
        maxAmmoCapacity = serializedObject.FindProperty("maxAmmoCapacity");
        reloadTime = serializedObject.FindProperty("reloadTime");

        attackRange = serializedObject.FindProperty("attackRange");

        pelletsPerShot = serializedObject.FindProperty("pelletsPerShot");
        pelletSpreadAngle = serializedObject.FindProperty("pelletSpreadAngle");
        shotgunCooldown = serializedObject.FindProperty("shotgunCooldown");

        sniperCooldown = serializedObject.FindProperty("sniperCooldown");
        sniperPenetrationCount = serializedObject.FindProperty("sniperPenetrationCount");

        ammoType = serializedObject.FindProperty("ammoType");

        fireEffectPrefab = serializedObject.FindProperty("fireEffectPrefab");
        explosionRadius = serializedObject.FindProperty("explosionRadius");
        burnDamage = serializedObject.FindProperty("burnDamage");
        burnDuration = serializedObject.FindProperty("burnDuration");
        tickInterval = serializedObject.FindProperty("tickInterval");

        isMolotov = serializedObject.FindProperty("isMolotov");
    }

    public override void OnInspectorGUI()
    {
        serializedObject.Update();

        EditorGUILayout.PropertyField(prefab);
        EditorGUILayout.PropertyField(weaponType);

        WeaponType wt = (WeaponType)weaponType.enumValueIndex;

        EditorGUILayout.Space(5);
        EditorGUILayout.LabelField("Stats", EditorStyles.boldLabel);

        EditorGUILayout.PropertyField(knockbackForce);
        EditorGUILayout.PropertyField(knockbackDuration);

        EditorGUILayout.PropertyField(fireRate);
        EditorGUILayout.PropertyField(damage);
        EditorGUILayout.PropertyField(clipSize);
        EditorGUILayout.PropertyField(maxAmmoCapacity);
        EditorGUILayout.PropertyField(reloadTime);
        EditorGUILayout.PropertyField(attackRange);

        // ---- Normal / Pistol / Rifle / MG vb. (Shotgun, Sniper, Molotov HARÄ°Ã‡ hepsi) ----
        if (wt != WeaponType.Shotgun && wt != WeaponType.Sniper && wt != WeaponType.Molotov)
        {
            EditorGUILayout.PropertyField(isAutomatic);
        }

        // ---- Shotgun ----
        if (wt == WeaponType.Shotgun)
        {
            EditorGUILayout.Space(5);
            EditorGUILayout.LabelField("Shotgun Settings", EditorStyles.boldLabel);
            EditorGUILayout.PropertyField(pelletsPerShot);
            EditorGUILayout.PropertyField(pelletSpreadAngle);
            EditorGUILayout.PropertyField(shotgunCooldown);
        }

        // ---- Sniper ----
        if (wt == WeaponType.Sniper)
        {
            EditorGUILayout.Space(5);
            EditorGUILayout.LabelField("Sniper Settings", EditorStyles.boldLabel);
            EditorGUILayout.PropertyField(sniperCooldown);
            EditorGUILayout.PropertyField(sniperPenetrationCount);
        }

        // ---- Molotov ----
        if (wt == WeaponType.Molotov)
        {
            // Ä°stersen runtime iÃ§in boolâ€™u da senkron tut:
            isMolotov.boolValue = true;

            EditorGUILayout.Space(5);
            EditorGUILayout.LabelField("Molotov Settings", EditorStyles.boldLabel);

            EditorGUILayout.PropertyField(fireEffectPrefab);
            EditorGUILayout.PropertyField(explosionRadius);
            EditorGUILayout.PropertyField(burnDamage);
            EditorGUILayout.PropertyField(burnDuration);
            EditorGUILayout.PropertyField(tickInterval);
        }
        else
        {
            // DiÄŸer tÃ¼m silahlarda false
            isMolotov.boolValue = false;
        }

        EditorGUILayout.Space(10);
        EditorGUILayout.PropertyField(ammoType);

        serializedObject.ApplyModifiedProperties();
    }
}
