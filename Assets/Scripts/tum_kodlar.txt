using System.Collections;
using TMPro;
using UnityEngine;

public class AmmoCheckUI : MonoBehaviour
{
    public CanvasGroup group;
    public TMP_Text text;
    public float showTime = 1.2f;

    Coroutine co;

    private void Awake()
    {
        HideInstant();
    }

    public void Show(string msg)
{
    if (co != null) StopCoroutine(co);
    co = StartCoroutine(ShowRoutine(msg));
}

    IEnumerator ShowRoutine(string msg)
{
    text.text = msg;
    group.alpha = 1f;
    group.blocksRaycasts = false;
    group.interactable = false;

    yield return new WaitForSeconds(showTime);

    HideInstant();
}

    void HideInstant()
{
    if (group != null) 
        group.alpha = 0f;
    if (text != null) 
        text.text = "";
}
}
using UnityEngine;

[CreateAssetMenu(
    menuName = "Items/Weapon/Ammo",
    fileName = "itm_ammo_"
)]
public class AmmoItemData : ItemData
{
    [Header("Ammo Settings")]
    public AmmoTypeData ammoType;

    [Tooltip("Bu item alÄ±ndÄ±ÄŸÄ±nda ammoPool'a eklenecek miktar")]
    public int ammoAmount = 10;

    private void OnValidate()
    {
        category = ItemCategory.Ammo;
        stackable = false;
        maxStack = 1;
    }
}
using UnityEngine;
[CreateAssetMenu(menuName = "Items/Weapon/Ammo Type")]
public class AmmoTypeData : ScriptableObject
{
    public string ammoId;     // "9mm", "556", vs (unique)
    public string ammoName;   // UI iÃ§in
    public Sprite icon;
}
using System.Collections.Generic;
using UnityEngine;

public class AmmoTypeRegistry : MonoBehaviour
{
    public static AmmoTypeRegistry Instance { get; private set; }

    [Header("All AmmoTypeData assets")]
    public AmmoTypeData[] ammoTypes;

    private Dictionary<string, AmmoTypeData> map = new();

    private void Awake()
    {
        if (Instance != null) { Destroy(gameObject); return; }
        Instance = this;

        map.Clear();
        if (ammoTypes == null) return;

        foreach (var a in ammoTypes)
        {
            if (a == null || string.IsNullOrEmpty(a.ammoId)) continue;
            map[a.ammoId] = a;
        }
    }

    public static AmmoTypeData Get(string ammoId)
    {
        if (Instance == null || string.IsNullOrEmpty(ammoId)) return null;
        return Instance.map.TryGetValue(ammoId, out var v) ? v : null;
    }
}
public interface IAmmoProvider
{
    void SetAmmo(int clip, int reserve);
    void GetAmmo(out int clip, out int reserve);
}
using UnityEngine;

[CreateAssetMenu(menuName = "Items/Weapon/Magazine")]
public class MagazineData : ItemData
{

    public AmmoTypeData ammoType;
    public MagazineType magazineType;

    public int capacity;
    
    private void OnValidate()
    {
        category = ItemCategory.Weapon;
        stackable = false;
        maxStack = 1;
    }

}

using UnityEngine;


[System.Serializable]
public class MagazineInstance
{
    public MagazineData data;
    public int currentAmmo;

    public bool IsFull
    {
        get
        {
            if (data == null)
            {
                Debug.LogError("MagazineInstance.data NULL!");
                return data != null && currentAmmo >= data.capacity;

            }

            return currentAmmo >= data.capacity;
        }
    }

    public bool IsEmpty
    {
        get
        {
            return currentAmmo <= 0;
        }
    }

    public MagazineInstance(MagazineData data)
    {
        this.data = data;
        currentAmmo = 0;
    }
}

using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class MagazineLoadPanel : MonoBehaviour
{
    public TMP_Text titleText;
    public TMP_Text ammoInfoText;
    public Slider loadSlider;

    public Button btnLoad;
    public Button btnFullLoad;
    public Button btnClose; // ğŸ”¥ YENÄ°
    private PlayerWeapon playerWeapon;



    private MagazineInstance currentMag;

    private void Awake()
    {
        gameObject.SetActive(false);

        loadSlider.onValueChanged.AddListener(_ =>
        {
            RefreshText();
        });

        if (btnClose != null)
            btnClose.onClick.AddListener(Hide);
    }

    private void Update()
    {
        // ğŸ”¥ ESC ile kapatma
        if (!gameObject.activeSelf)
            return;

        if (Input.GetKeyDown(KeyCode.Escape))
        {
            Hide();
        }
    }

    public void Show(MagazineInstance mag)
    {
        if (mag == null || mag.data == null)
            return;

        currentMag = mag;
        currentMag = mag;

        var sm = WeaponSlotManager.Instance;
        if (sm != null)
            playerWeapon = sm.ActiveWeapon;

        gameObject.SetActive(true);

        titleText.text = mag.data.itemName;

        int availableAmmo =
            Inventory.Instance.GetAmmoAmount(mag.data.ammoType);

        int space = mag.data.capacity - mag.currentAmmo;

        loadSlider.minValue = 0;
        loadSlider.maxValue = Mathf.Min(space, availableAmmo);
        loadSlider.value = loadSlider.maxValue;

        bool canLoad = loadSlider.maxValue > 0;
        btnLoad.interactable = canLoad;
        btnFullLoad.interactable = canLoad;

        RefreshText();
    }


    public void Hide()
    {
        currentMag = null;
        gameObject.SetActive(false);
    }

    public void RefreshText()
    {
        if (currentMag == null) return;

        ammoInfoText.text =
            $"{currentMag.currentAmmo}/{currentMag.data.capacity}  " +
            $"â†’ +{(int)loadSlider.value}";
    }

    public void OnLoadPressed()
{
    if (currentMag == null) return;

    Inventory.Instance.LoadAmmoIntoMagazine(
        currentMag,
        (int)loadSlider.value
    );

    playerWeapon?.NotifyMagazineAmmoChanged();
    Show(currentMag);
}

    public void OnFullLoadPressed()
{
    if (currentMag == null) return;

    Inventory.Instance.FullLoadMagazine(currentMag);

    playerWeapon?.NotifyMagazineAmmoChanged();
    Show(currentMag);
}

}
using UnityEngine;

public class MagazinePickup : MonoBehaviour
{
    public MagazineData magazineData;

    [Header("Start Ammo Range")]
    public int minStartAmmo = 0;
    public int maxStartAmmo = 0;

    private PlayerWeapon pw;

    private void Awake()
    {
        pw = FindObjectOfType<PlayerWeapon>();
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player"))
            return;

        if (magazineData == null) return;

        MagazineInstance mag = new MagazineInstance(magazineData);

        int randomAmmo = Random.Range(minStartAmmo, maxStartAmmo + 1);
        mag.currentAmmo = Mathf.Clamp(randomAmmo, 0, magazineData.capacity);

        Inventory.Instance.TryAddMagazine(mag);

        pw?.CollectMagazinesFromInventory();

        Destroy(gameObject);
    }
}

public enum MagazineType
{
    None,
    Glock18_9mm,
    M4A1_556mm,
    M24_762mm,
    Drum_556,
    ShotgunTube
}
public enum ReloadStrategy
{
    MostFull,      // En dolu ÅŸarjÃ¶r
    NextInList,    // Listede sÄ±radaki
    LastUsed       // Son kullanÄ±lan
}
using System.Linq;
using TMPro;
using UnityEngine;

public class WeaponHUD : MonoBehaviour
{
    [Header("Texts")]
    public TMP_Text magazineText;   // "8 / 12" gibi
    public TMP_Text spareMagText;   // Ä°stersen "x3" gÃ¶sterebiliriz (opsiyonel)

    private PlayerWeapon pw;
    private Inventory inv;

    private void Awake()
    {
        inv = Inventory.Instance;
    }

    private void OnEnable()
    {
            inv = Inventory.Instance;

    var sm = WeaponSlotManager.Instance;
    if (sm != null)
        pw = sm.ActiveWeapon;

    BindEvents();
    RefreshAll();

        // Weapon eventleri
        if (pw != null)
        {
            pw.OnMagazineChanged += OnWeaponAmmoChanged;
            pw.OnSpareMagazineCountChanged += OnSpareMagCountChanged;
        }

        // Inventory event
        if (inv != null)
            inv.OnChanged += RefreshAll;

        RefreshAll();
    }

    private void OnDisable()
    {
        if (pw != null)
        {
            pw.OnMagazineChanged -= OnWeaponAmmoChanged;
            pw.OnSpareMagazineCountChanged -= OnSpareMagCountChanged;
        }

        if (inv != null)
            inv.OnChanged -= RefreshAll;
    }

    private void OnWeaponAmmoChanged(int current, int capacity)
    {
        // current deÄŸiÅŸince ikisini de yeniden hesaplamak daha gÃ¼venli
        RefreshAll();
    }
    void BindEvents()
{
    if (pw == null) return;

    pw.OnMagazineChanged += OnWeaponAmmoChanged;
    pw.OnSpareMagazineCountChanged += OnSpareMagCountChanged;

    if (inv != null)
        inv.OnChanged += RefreshAll;
}

    private void OnSpareMagCountChanged(int count)
    {
        // Sadece count yazmak istersen:
        if (spareMagText != null)
            spareMagText.text = $"x{count}";

        // Ama esas deÄŸerler yine gÃ¼ncellensin:
        RefreshAll();
    }
    void Update()
{
    var sm = WeaponSlotManager.Instance;
    if (sm == null) return;

    if (pw != sm.ActiveWeapon)
    {
        UnbindEvents();
        pw = sm.ActiveWeapon;
        BindEvents();
        RefreshAll();
    }
}

void UnbindEvents()
{
    if (pw == null) return;

    pw.OnMagazineChanged -= OnWeaponAmmoChanged;
    pw.OnSpareMagazineCountChanged -= OnSpareMagCountChanged;

    if (inv != null)
        inv.OnChanged -= RefreshAll;
}

    private void RefreshAll()
{
    if (pw == null || pw.weaponData == null)
    {
        magazineText.text = "-- / --";
        spareMagText.text = "x0";
        return;
    }

    int equippedAmmo = 0;
    if (pw.currentMagazine != null && pw.currentMagazine.data != null)
        equippedAmmo = pw.currentMagazine.currentAmmo;

    int inventoryAmmo = 0;
    for (int i = 0; i < pw.inventoryMags.Count; i++)
    {
        var m = pw.inventoryMags[i];
        if (m == null || m.data == null) continue;
        inventoryAmmo += m.currentAmmo;
    }

    magazineText.text = $"{equippedAmmo} / {inventoryAmmo}";
    spareMagText.text = $"x{pw.inventoryMags.Count}";
}

}
using UnityEngine;

public class WeaponPickup : MonoBehaviour
{
    [Header("Weapon Item (Inventory)")]
    public WeaponItemData weaponItem;

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player"))
            return;

        if (weaponItem == null)
        {
            Debug.LogError("[WeaponPickup] weaponItem atanmadÄ±!");
            return;
        }

        // SilahÄ± karavana / envantere ekle
        CaravanInventory.Instance.StoreWeapon(weaponItem);

        Debug.Log($"ğŸŸ¢ Weapon pickup alÄ±ndÄ±: {weaponItem.itemName}");

        Destroy(gameObject);
    }
}
using UnityEngine;
using UnityEngine.UI;


public class Animal : MonoBehaviour
{

    private Animator animator;
    private Vector2 lastMoveDir = Vector2.down; // idle yÃ¶nÃ¼ iÃ§in


    [Header("Animation Direction")]
    public float dirDeadzone = 0.15f;   // Ã§ok kÃ¼Ã§Ã¼k x/y titreÅŸimlerini yok say
    public float axisHysteresis = 0.10f; // eksenler arasÄ± geÃ§iÅŸte yapÄ±ÅŸkanlÄ±k (0.05-0.15 iyi)

    // Son seÃ§ilen animasyon yÃ¶nÃ¼nÃ¼ tut (saÄŸ/sol/yukarÄ±/aÅŸaÄŸÄ±)
    private Vector2 lastAnimDir = Vector2.down;

    public string animalType = "Geyik";
    public int maxHealth = 6;
    public float moveSpeed = 2f;
    public float roamRadius = 5f;
    public float baseDetectionRadius = 4f;
    public float nightDetectionFactor = 0.5f;
    public float fleeSpeedMultiplier = 1.5f;
    public float animalCount = 3;

    public GameObject meatPrefab;
    public GameObject hidePrefab;
    public GameObject hpBarPrefab;

    private int currentHealth;
    private GameObject hpBarInstance;
    private Image hpFillImage;

    private Vector2 roamTarget;
    private AnimalState currentState = AnimalState.Roaming;

    private Transform threatTarget;
    private float detectionRadius;

    private float nightBehaviorTimer;
    private bool isNight;
    

    [Header("Flee Tuning")]
    public float minScareCooldown = 0.5f; // spam Ã¶nlemek iÃ§in
    private float lastScareTime = -999f;

    private Vector2? fleeFromPoint = null;   // tehdit noktasÄ± (silah sesi/mermi)
    private float tempFleeMultiplier = 1f;
    private Coroutine fleeTimerCo;

    void Start()
    {

        animator = GetComponent<Animator>();
        if (animator == null) Debug.LogError("[Animal] Animator bileÅŸeni bulunamadÄ±!");
        currentHealth = maxHealth;
        detectionRadius = baseDetectionRadius;
        PickNewRoamTarget();

        //deneme

        if (hpBarPrefab != null)
        {
            hpBarInstance = Instantiate(hpBarPrefab, transform.position + Vector3.up * 1f, Quaternion.identity);
            hpBarInstance.transform.SetParent(transform, true);

            Transform fill = hpBarInstance.transform.Find("Background/Fill");
            if (fill != null)
                hpFillImage = fill.GetComponent<Image>();
        }

        // Gecelik davranÄ±ÅŸÄ± tetikleyici
        InvokeRepeating(nameof(UpdateNightBehavior), 0f, 10f);
    }

    void Update()
    {
        DetectThreats();

        switch (currentState)
        {
            case AnimalState.Roaming:
            case AnimalState.NightRoaming:
                Roam();
                break;

            case AnimalState.Fleeing:
                Flee();
                break;

            case AnimalState.Sleeping:
                // sadece uyurken idle'a zorla
                UpdateAnimator(Vector2.zero, 0f);
                break;
        }
    }

    void OnEnable()
    {
        AnimalSoundEmitter.OnSound += OnSoundHeard;
    }

    void OnDisable()
    {
        AnimalSoundEmitter.OnSound -= OnSoundHeard;
    }

    private void OnSoundHeard(SoundEvent s)
    {
        // Uzaksa veya uyuyor ve duymasÄ± istenmiyorsa (istersen burada Sleep'e istisna koyabilirsin)
        if (Vector2.Distance(transform.position, s.position) > s.radius) return;

        // Gece/gÃ¼ndÃ¼z fark etmeksizin panik
        Scare(s.position, s.fleeDuration, s.speedMultiplier);
    }

    private Vector2 GetAnimCardinalDir(Vector2 dir)
    {
        if (dir.sqrMagnitude < 0.0001f) return lastAnimDir;

        float ax = Mathf.Abs(dir.x);
        float ay = Mathf.Abs(dir.y);

        // eksen seÃ§imini biraz yapÄ±ÅŸkan yap
        bool preferX = ax > ay + axisHysteresis;
        bool preferY = ay > ax + axisHysteresis;

        Vector2 target;
        if (preferX || (!preferY && lastAnimDir.y != 0))
            target = new Vector2(dir.x >= 0f ? 1f : -1f, 0f);
        else if (preferY || (!preferX && lastAnimDir.x != 0))
            target = new Vector2(0f, dir.y >= 0f ? 1f : -1f);
        else
            target = (ax >= ay) ? new Vector2(dir.x >= 0f ? 1f : -1f, 0f)
                                : new Vector2(0f, dir.y >= 0f ? 1f : -1f);

        if (Mathf.Abs(dir.x) < dirDeadzone && lastAnimDir.x != 0f) target = lastAnimDir;
        if (Mathf.Abs(dir.y) < dirDeadzone && lastAnimDir.y != 0f) target = lastAnimDir;

        return target;
    }

    public void Scare(Vector2 fromPosition, float duration, float speedMult)
    {
        if (Time.time - lastScareTime < minScareCooldown) return;
        lastScareTime = Time.time;

        fleeFromPoint = fromPosition;
        tempFleeMultiplier = Mathf.Max(speedMult, 1f);
        currentState = AnimalState.Fleeing;

        if (fleeTimerCo != null) StopCoroutine(fleeTimerCo);
        fleeTimerCo = StartCoroutine(StopFleeAfter(duration));
    }

    private System.Collections.IEnumerator StopFleeAfter(float seconds)
    {
        yield return new WaitForSeconds(seconds);
        fleeFromPoint = null;
        tempFleeMultiplier = 1f;

        // Panik sonrasÄ± rutinine dÃ¶n
        if (isNight) EnterNightMode();
        else currentState = AnimalState.Roaming;

        PickNewRoamTarget();
        fleeTimerCo = null;
    }


    void DetectThreats()
    {
        if (currentState == AnimalState.Sleeping) return;

        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, detectionRadius);
        foreach (var hit in hits)
        {
            if (hit.CompareTag("Player") || hit.CompareTag("Enemy"))
            {
                currentState = AnimalState.Fleeing;
                threatTarget = hit.transform;
                return;
            }
        }

        if (currentState == AnimalState.Fleeing && threatTarget == null)
        {
            if (isNight)
                EnterNightMode(); // tekrar gece davranÄ±ÅŸÄ±na dÃ¶n
            else
                currentState = AnimalState.Roaming;

            PickNewRoamTarget();
        }
    }

    void Roam()
    {
        float distance = Vector2.Distance(transform.position, roamTarget);
        if (distance < 0.5f)
        {
            PickNewRoamTarget();
        }

        Vector2 dir = (roamTarget - (Vector2)transform.position).normalized;
        MoveWithAnim(dir, moveSpeed);
    }

    void Flee()
    {
        // Ã–ncelik: canlÄ± tehdit -> tehdit hedefi (Player/Enemy)
        // Yoksa: en son duyulan/gelinen tehdit noktasÄ±
        Vector2 source;

        if (threatTarget != null)
        {
            source = threatTarget.position;
        }
        else if (fleeFromPoint.HasValue)
        {
            source = fleeFromPoint.Value;
        }
        else
        {
            // GÃ¼venli geri dÃ¶nÃ¼ÅŸ
            if (isNight) { EnterNightMode(); } else { currentState = AnimalState.Roaming; }
            PickNewRoamTarget();
            UpdateAnimator(Vector2.zero, 0f); // gÃ¼venli
            return;
        }

        Vector2 dir = ((Vector2)transform.position - source).normalized;
        float speed = moveSpeed * fleeSpeedMultiplier * tempFleeMultiplier;
        MoveWithAnim(dir, speed);
    }

    private void MoveWithAnim(Vector2 dir, float speed)
    {
        if (dir.sqrMagnitude > 0.0001f)
            transform.Translate(dir * speed * Time.deltaTime);

        Vector2 animDir = GetAnimCardinalDir(dir);     // <-- kritik
        UpdateAnimator(animDir, speed);
    }

    private void UpdateAnimator(Vector2 animDir, float speed)
    {
        if (animator == null) return;

        bool isMovingNow = animDir.sqrMagnitude > 0.0001f && speed > 0.01f;
        animator.SetBool("isMoving", isMovingNow);

        if (isMovingNow)
        {
            animator.SetFloat("MoveX", animDir.x);  // -1,0,1
            animator.SetFloat("MoveY", animDir.y);  // -1,0,1
            lastMoveDir = animDir;
            lastAnimDir = animDir;
        }
        else
        {
            animator.SetFloat("MoveX", lastMoveDir.x);
            animator.SetFloat("MoveY", lastMoveDir.y);
        }
    }

    void PickNewRoamTarget()
    {
        Vector2 randomOffset = Random.insideUnitCircle * roamRadius;
        roamTarget = (Vector2)transform.position + randomOffset;
    }

    public void TakeDamage(int damage)
    {
        currentHealth -= damage;

        if (hpFillImage != null)
        {
            float fillValue = Mathf.Clamp01((float)currentHealth / maxHealth);
            hpFillImage.fillAmount = fillValue;
        }

        // â— Vurulduysa, saldÄ±rÄ± yÃ¶nÃ¼nÃ¼ bilmiyorsak bile rastgele uzaÄŸa kaÃ§
        if (!fleeFromPoint.HasValue && threatTarget == null)
        {
            // kÃ¼Ã§Ã¼k bir ofsetle bulunduÄŸu yerden ters yÃ¶ne hedef seÃ§
            Vector2 away = (Vector2)transform.position + Random.insideUnitCircle.normalized * 2f;
            Scare(away, 3f, 2.0f);
        }

        if (currentHealth <= 0)
        {
            DropLoot();
            if (hpBarInstance != null) Destroy(hpBarInstance);
            Destroy(gameObject);
        }
    }

    void DropLoot()
    {
        Instantiate(meatPrefab, transform.position, Quaternion.identity);
        Instantiate(hidePrefab, transform.position + Vector3.right * 0.5f, Quaternion.identity);
    }

    public void SetNight(bool night)
    {
        isNight = night;
        detectionRadius = baseDetectionRadius * (isNight ? nightDetectionFactor : 1f);
        EnterNightMode();
    }

    void EnterNightMode()
    {
        if (!isNight) return;

        // %50 ÅŸansla uyur, %50 gezer
        if (Random.value < 0.5f)
            currentState = AnimalState.Sleeping;
        else
            currentState = AnimalState.NightRoaming;

        PickNewRoamTarget();
    }

    void UpdateNightBehavior()
    {
        if (isNight)
            EnterNightMode(); // her 10 saniyede yeniden davranÄ±ÅŸ belirle
    }

    void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.yellow;
        Gizmos.DrawWireSphere(transform.position, detectionRadius);
    }
}
using System;
using UnityEngine;

public struct SoundEvent
{
    public Vector2 position;
    public float radius;
    public float fleeDuration;
    public float speedMultiplier;

    public SoundEvent(Vector2 pos, float rad, float dur = 2f, float mult = 1.5f)
    {
        position = pos;
        radius = rad;
        fleeDuration = dur;
        speedMultiplier = mult;
    }
}

public static class AnimalSoundEmitter
{
    public static event Action<SoundEvent> OnSound;

    // ğŸ”¹ 2 parametreli versiyon (default deÄŸerlerle)
    public static void EmitSound(Vector2 pos, float radius)
    {
        EmitSound(pos, radius, 2f, 1.5f);
    }

    // ğŸ”¹ 4 parametreli versiyon
    public static void EmitSound(Vector2 pos, float radius, float fleeDuration, float speedMultiplier)
    {
        OnSound?.Invoke(new SoundEvent(pos, radius, fleeDuration, speedMultiplier));
    }
}
public enum AnimalState
{
    Roaming,
    Fleeing,
    Sleeping,
    NightRoaming
}
// AudioManager.cs
using UnityEngine;
using UnityEngine.Audio;

public class AudioManager : MonoBehaviour
{
    public static AudioManager Instance { get; private set; }

    [Header("Mixer")]
    public AudioMixer mainMixer;            // MainMixer.asset
    public AudioMixerGroup musicGroup;      // Inspector: Music
    public AudioMixerGroup sfxGroup;        // Inspector: SFX

    [Tooltip("Exposed param adlarÄ±")]
    public string musicParam = "MusicVolume";
    public string sfxParam = "SFXVolume";
    public string masterParam = "MasterVolume";

   void Awake()
{
    // 1. ADIM: Singleton ve KalÄ±cÄ±lÄ±k KontrolÃ¼
    if (Instance == null) 
    { 
        Instance = this; 
        DontDestroyOnLoad(gameObject); // Bu obje sahneler deÄŸiÅŸtikÃ§e silinmez
    }
    else 
    { 
        Destroy(gameObject); // EÄŸer zaten bir AudioManager varsa, yeni geleni yok et
        return; 
    }

    // 2. ADIM: AyarlarÄ± YÃ¼kle (Sadece ilk oluÅŸan AudioManager iÃ§in Ã§alÄ±ÅŸÄ±r)
    float master = PlayerPrefs.GetFloat("MasterVolume", 1f);
    float music = PlayerPrefs.GetFloat("MusicVolume", 1f);
    float sfx = PlayerPrefs.GetFloat("SFXVolume", 1f);
    
    SetMasterVolume(master);
    SetMusicVolume(music);
    SetSFXVolume(sfx);
}

    float ToDecibels(float value) => (value <= 0.0001f) ? -80f : Mathf.Log10(value) * 20f;

    public void SetMasterVolume(float v)
{
    float db = ToDecibels(v);
    Debug.Log($"Master Volume Slider: {v} -> dB: {db}"); // Konsolda bu yazÄ±yÄ± gÃ¶rÃ¼yor musunuz?
    bool success = mainMixer.SetFloat(masterParam, db);
    if(!success) Debug.LogError($"{masterParam} isimli parametre Mixer'da bulunamadÄ±!");
    PlayerPrefs.SetFloat("MasterVolume", v);
}
    public void SetMusicVolume(float v)
    {
        mainMixer.SetFloat(musicParam, ToDecibels(v));
        PlayerPrefs.SetFloat("MusicVolume", v);
    }

    public void SetSFXVolume(float v)
    {
        mainMixer.SetFloat(sfxParam, ToDecibels(v));
        PlayerPrefs.SetFloat("SFXVolume", v);
    }

    // PlayClipAtPoint alternatifi: miksere baÄŸlÄ± tek-seferlik Ã§alma
    public void PlayOneShotAt(AudioClip clip, Vector3 pos, float volume = 1f)
    {
        if (clip == null || sfxGroup == null) return;
        var go = new GameObject("OneShotSFX");
        go.transform.position = pos;
        var src = go.AddComponent<AudioSource>();
        src.outputAudioMixerGroup = sfxGroup;
        src.spatialBlend = 0f; // 2D UI/SFX ise 0f, 3D istiyorsan 1fâ€™e Ã§ekebilirsin
        src.PlayOneShot(clip, volume);
        Destroy(go, clip.length + 0.1f);
    }

    // Bir AudioSourceâ€™u programatik olarak SFXâ€™e baÄŸlamak istersen:
    public void RouteToSFX(AudioSource src)
    {
        if (src != null && sfxGroup != null) src.outputAudioMixerGroup = sfxGroup;
    }

    public void RouteToMusic(AudioSource src)
    {
        if (src != null && musicGroup != null) src.outputAudioMixerGroup = musicGroup;
    }
}
// MusicManager.cs

using UnityEngine;
using System.Collections; // Coroutine iÃ§in
using System.Collections.Generic; // List iÃ§in

[RequireComponent(typeof(AudioSource))]
public class MusicManager : MonoBehaviour
{
    public static MusicManager Instance { get; private set; }

    [Header("Music Playlists")]
    public List<AudioClip> dayMusicPlaylist;
    public List<AudioClip> nightMusicPlaylist;

    [Header("Settings")]
    [Tooltip("ÅarkÄ±lar arasÄ±ndaki geÃ§iÅŸin yumuÅŸaklÄ±ÄŸÄ± (saniye).")]
    public float crossfadeDuration = 2.0f;

    private AudioSource audioSource;
    private bool isDay = true;
    private int currentTrackIndex = -1;

    private bool isAppPaused = false;
    private bool wasPausedByFocus = false;

    void Awake()
    {
        Debug.Log("ğŸµ MusicManager Awake Ã‡ALIÅTI! Playlist Day=" 
          + dayMusicPlaylist.Count 
          + " Night=" + nightMusicPlaylist.Count);

        // Singleton Pattern
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject); // Bu yÃ¶neticinin sahneler arasÄ± geÃ§iÅŸte kalmasÄ±nÄ± saÄŸlar.
        }
        else
        {
            Destroy(gameObject);
            return;
        }

        audioSource = GetComponent<AudioSource>();
        audioSource.loop = false; // ÅarkÄ± bitince Coroutine ile yenisini baÅŸlatacaÄŸÄ±z.
    }

    void Update()
    {
        // Uygulama odak dÄ±ÅŸÄ±ndayken/pauselayken asla parÃ§a deÄŸiÅŸtirme
        if (isAppPaused) return;

        // Sadece gerÃ§ekten ÅŸarkÄ± bitince yeni parÃ§aya geÃ§
        if (!audioSource.isPlaying && (isDay ? dayMusicPlaylist.Count > 0 : nightMusicPlaylist.Count > 0))
        {
            PlayNextTrack();
        }
    }
public void StopAll()
{
    if (audioSource != null)
    {
        audioSource.Stop();
        audioSource.clip = null;      // Clip temizlensin
        audioSource.time = 0f;        // ParÃ§a zamanÄ± reset
        // audioSource.enabled = false;  // âŒ KALDIRILDI!
    }

    currentTrackIndex = -1;
}




    // DayNightCycle bu fonksiyonu Ã§aÄŸÄ±rarak durumu bildirir.
    public void SetDay(bool isCurrentlyDay)
{
    // Durumu her zaman gÃ¼ncelle
    this.isDay = isCurrentlyDay;

    // MÃ¼zik Ã§almÄ±yorsa direkt baÅŸlat
    if (!audioSource.isPlaying || audioSource.clip == null)
    {
        PlayNextTrack();
        return;
    }

    // EÄŸer mÃ¼zik Ã§alÄ±yorsa crossfade yap
    StartCoroutine(CrossfadeToNextTrack());
}


    private void PlayNextTrack()
    {
        List<AudioClip> currentPlaylist = isDay ? dayMusicPlaylist : nightMusicPlaylist;
        if (currentPlaylist.Count == 0) return;

        // Rastgele bir sonraki ÅŸarkÄ± seÃ§ (aynÄ± ÅŸarkÄ±yÄ± tekrar Ã§almasÄ±n diye kontrol edebiliriz).
        int nextTrackIndex = Random.Range(0, currentPlaylist.Count);
        if (currentPlaylist.Count > 1 && nextTrackIndex == currentTrackIndex)
        {
            nextTrackIndex = (nextTrackIndex + 1) % currentPlaylist.Count;
        }
        currentTrackIndex = nextTrackIndex;

        audioSource.clip = currentPlaylist[currentTrackIndex];
        audioSource.Play();
    }

    private IEnumerator CrossfadeToNextTrack()
{
    // Sesi yavaÅŸÃ§a kÄ±s (0'a kadar)
    while (audioSource.volume > 0)
    {
        audioSource.volume -= Time.deltaTime / crossfadeDuration;
        yield return null;
    }

    audioSource.Stop();
    
    // Yeni ÅŸarkÄ±yÄ± seÃ§ ve baÅŸlat
    PlayNextTrack();

    // Sesi yavaÅŸÃ§a aÃ§ (1'e kadar)
    // Mixer grubuna baÄŸlÄ± olduÄŸu iÃ§in 1 deÄŸeri aslÄ±nda kullanÄ±cÄ±nÄ±n slider ayarÄ±dÄ±r.
    while (audioSource.volume < 1)
    {
        audioSource.volume += Time.deltaTime / crossfadeDuration;
        yield return null;
    }
}

    // Uygulama duraklatÄ±ldÄ±ÄŸÄ±nda/geri gelince Ã§aÄŸrÄ±lÄ±r
    void OnApplicationPause(bool pause)
    {
        isAppPaused = pause;
        if (audioSource == null) return;

        if (pause)
        {
            // Odak gidince o anki ÅŸarkÄ±yÄ± duraklat (clip ve time korunur)
            if (audioSource.isPlaying)
            {
                audioSource.Pause();
                wasPausedByFocus = true;
            }
        }
        else
        {
            // Geri dÃ¶nÃ¼nce aynen kaldÄ±ÄŸÄ± yerden devam et
            if (wasPausedByFocus)
            {
                audioSource.UnPause();
                wasPausedByFocus = false;
            }
        }
    }

    // BazÄ± platformlarda sadece focus tetiklenir; aynÄ± mantÄ±ÄŸÄ± yÃ¶nlendir
    void OnApplicationFocus(bool hasFocus)
    {
        OnApplicationPause(!hasFocus);
    }

    
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class CampfireCooking : MonoBehaviour
{
    [Header("Cooking")]
    public float cookTime = 5f;
    public GameObject cookedMeatPrefab;
    public Transform dropPoint;

    [SerializeField] private ItemData meatSO;
    [SerializeField] private ItemData cookedMeatSO;

    [Header("UI")]
    public GameObject progressCanvas;
    public Slider progressBar;

    private bool isPlayerNearby = false;
    private bool isCooking = false;
    private float holdTimer = 0f;

    void Start()
    {
        if (progressCanvas) progressCanvas.SetActive(false);
        if (progressBar) progressBar.value = 0f;
    }

    void Update()
    {
        if (!isPlayerNearby) return;

        bool hasMeat = Inventory.Instance.GetTotalCount(meatSO) > 0;

        if (hasMeat && Keyboard.current.cKey.isPressed)
        {
            if (!isCooking)
            {
                isCooking = true;
                if (progressCanvas) progressCanvas.SetActive(true);
            }

            holdTimer += Time.deltaTime;
            if (progressBar) progressBar.value = holdTimer / cookTime;

            if (holdTimer >= cookTime)
            {
                CookMeat();
                ResetCooking();
            }
        }
        else
        {
            if (isCooking)
                ResetCooking();
        }
    }

    private void CookMeat()
    {
        if (Inventory.Instance.TryConsume(meatSO, 1))
        {
            Vector3 pos = dropPoint ? dropPoint.position
                                    : transform.position + new Vector3(0.4f, 0f, 0f);

            Instantiate(cookedMeatPrefab, pos, Quaternion.identity);
        }
    }

    private void ResetCooking()
    {
        isCooking = false;
        holdTimer = 0f;

        if (progressBar) progressBar.value = 0f;
        if (progressCanvas) progressCanvas.SetActive(false);
    }

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player")) isPlayerNearby = true;
    }

    void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            ResetCooking();
        }
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;
using TMPro;

public class CampfireInteraction : MonoBehaviour
{
    [SerializeField] private ItemData meatSO;
    [SerializeField] private ItemData cookedMeatSO;

    [Header("Cooking")]
    public GameObject cookedMeatPrefab;
    public Transform dropPoint;
    public float cookDuration = 5f;
    public AudioSource sfx;
    public AudioClip sizzleClip;

    [Header("UI")]
    public GameObject cookPromptPanel;
    public TextMeshProUGUI cookPromptText;
    public Slider cookProgress;

    private bool isPlayerNearby = false;
    private bool isHolding = false;
    private float holdTimer = 0f;

    void Start()
    {
        if (cookPromptPanel != null) cookPromptPanel.SetActive(false);
        if (cookProgress != null) cookProgress.value = 0f;
    }

    void Update()
    {
        if (!isPlayerNearby)
        {
            HidePrompt();
            return;
        }

        bool hasMeat = Inventory.Instance.GetTotalCount(meatSO) > 0;

        if (cookPromptPanel) cookPromptPanel.SetActive(hasMeat);
        if (cookPromptText) cookPromptText.text = hasMeat ? "C'ye basÄ±lÄ± tut: Eti PiÅŸir" : "Et yok";

        if (!hasMeat)
        {
            ResetHold();
            return;
        }

        if (Keyboard.current.cKey.isPressed)
        {
            isHolding = true;
            holdTimer += Time.deltaTime;

            if (cookProgress != null)
                cookProgress.value = holdTimer / cookDuration;

            if (holdTimer >= cookDuration)
            {
                CookAndDrop();
                ResetHold();
            }
        }
        else
        {
            if (isHolding)
                ResetHold();
        }
    }

    private void CookAndDrop()
    {
        if (!Inventory.Instance.TryConsume(meatSO, 1))
        {
            Debug.Log("ğŸ¥© Et yok, piÅŸirme iptal.");
            return;
        }

        if (sfx && sizzleClip)
            sfx.PlayOneShot(sizzleClip);

        Vector3 pos = dropPoint
            ? dropPoint.position
            : transform.position + new Vector3(0.4f, 0, 0);

        Instantiate(cookedMeatPrefab, pos, Quaternion.identity);
    }

    private void ResetHold()
    {
        isHolding = false;
        holdTimer = 0f;

        if (cookProgress != null)
            cookProgress.value = 0f;
    }

    private void HidePrompt()
    {
        if (cookPromptPanel) cookPromptPanel.SetActive(false);
        ResetHold();
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player")) isPlayerNearby = true;
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            HidePrompt();
        }
    }
}
using UnityEngine;
using UnityEngine.UI;

public class CaravanHealth : MonoBehaviour
{
    public int maxHealth = 10;
    private int currentHealth;

    public Slider healthSlider;  // UI'dan baÄŸlanacak

    void Start()
    {
        currentHealth = maxHealth;
        UpdateUI();
    }

    public void TakeDamage(int damage)
    {
        currentHealth -= damage;
        Debug.Log("KaravanÄ±n canÄ±: " + currentHealth);
        UpdateUI();

        if (currentHealth <= 0)
        {
            Debug.Log("ğŸšï¸ Karavan yÄ±kÄ±ldÄ±! Oyun bitti.");
            GameManager.Instance.GameOver();
        }

    }

    void UpdateUI()
    {
        if (healthSlider != null)
            healthSlider.value = (float)currentHealth / maxHealth;
    }
}
using UnityEngine;
using UnityEngine.UI;

public class CaravanIndicator : MonoBehaviour
{
    public Transform player;
    public Transform caravan;
    public RectTransform canvasRect;
    public RectTransform indicator;

    private CanvasGroup canvasGroup;

    [Header("Animasyon AyarlarÄ±")]
    public float fadeSpeed = 5f;
    public float scaleSpeed = 5f;
    public float targetAlpha = 1f;
    public Vector3 visibleScale = Vector3.one;
    public Vector3 hiddenScale = Vector3.zero;

    void Start()
    {
        canvasGroup = indicator.GetComponent<CanvasGroup>();
        if (canvasGroup == null)
            Debug.LogError("âŒ CanvasGroup eksik! LÃ¼tfen CaravanIndicator objesine ekleyin.");

        // BaÅŸlangÄ±Ã§ durumu
        canvasGroup.alpha = 0f;
        indicator.localScale = hiddenScale;
    }

    void Update()
    {
        if (player == null || caravan == null || indicator == null || canvasRect == null) return;

        Vector3 direction = caravan.position - player.position;

        // Kamera gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ kontrolÃ¼
        Vector3 viewportPos = Camera.main.WorldToViewportPoint(caravan.position);
        bool isCaravanVisible = viewportPos.x >= 0f && viewportPos.x <= 1f &&
                               viewportPos.y >= 0f && viewportPos.y <= 1f &&
                               viewportPos.z > 0f;

        bool shouldShow = !isCaravanVisible;

        // Fade ve Scale animasyonu
        float target = shouldShow ? targetAlpha : 0f;
        canvasGroup.alpha = Mathf.Lerp(canvasGroup.alpha, target, Time.deltaTime * fadeSpeed);
        indicator.localScale = Vector3.Lerp(indicator.localScale, shouldShow ? visibleScale : hiddenScale, Time.deltaTime * scaleSpeed);

        if (!shouldShow) return;

        // YÃ¶n gÃ¶sterimi
        float angle = Mathf.Atan2(direction.y, direction.x) * Mathf.Rad2Deg;
        indicator.rotation = Quaternion.Euler(0, 0, angle - 90f);

        Vector3 screenPoint = Camera.main.WorldToViewportPoint(player.position + direction.normalized * 5f);
        screenPoint = new Vector3(Mathf.Clamp01(screenPoint.x), Mathf.Clamp01(screenPoint.y), 0);

        Vector2 canvasSize = canvasRect.sizeDelta;
        Vector2 uiPos = new Vector2(
            (screenPoint.x * canvasSize.x) - (canvasSize.x / 2),
            (screenPoint.y * canvasSize.y) - (canvasSize.y / 2)
        );

        indicator.anchoredPosition = uiPos;
    }
}
using UnityEngine;

[RequireComponent(typeof(Collider2D))]
public class CaravanInteraction : MonoBehaviour
{
    public bool playerInRange { get; private set; }

    private void Awake()
    {
        // GÃ¼venlik: collider trigger olmak zorunda
        var col = GetComponent<Collider2D>();
        col.isTrigger = true;
    }

    private void OnTriggerEnter2D(Collider2D other)
{
    if (other.GetComponentInParent<PlayerMovement>() != null)
    {
        playerInRange = true;
        Debug.Log("Caravan â†’ Player MENZÄ°LE GÄ°RDÄ°");
    }
}

private void OnTriggerExit2D(Collider2D other)
{
    if (other.GetComponentInParent<PlayerMovement>() != null)
    {
        playerInRange = false;
        Debug.Log("Caravan â†’ Player MENZÄ°LDEN Ã‡IKTI");
        PlayerInputRouter.Instance?.ForceCloseCraft();
    }
}

}
using System.Collections.Generic;
using UnityEngine;

public class CaravanInventory : MonoBehaviour
{
    public static CaravanInventory Instance;

    // WeaponType â†’ List<WeaponItemData>
    public Dictionary<WeaponType, List<WeaponItemData>> storedWeapons =
        new Dictionary<WeaponType, List<WeaponItemData>>();

    private void Awake()
    {
        Instance = this;

        foreach (WeaponType type in System.Enum.GetValues(typeof(WeaponType)))
        {
            storedWeapons[type] = new List<WeaponItemData>();
        }
    }

    // ============================================
    // 1) ItemID Ã¼zerinden silah ekleme (Save / SlotManager)
    // ============================================
    public void AddItem(string itemID, int amount = 1)
    {
        ItemData data = ItemDatabase.Get(itemID);
        if (data == null)
        {
            Debug.LogError("CaravanInventory â†’ itemID bulunamadÄ±: " + itemID);
            return;
        }

        if (data is not WeaponItemData weaponItem)
        {
            Debug.LogError("CaravanInventory.AddItem â†’ Bu item bir silah deÄŸil: " + itemID);
            return;
        }

        StoreWeapon(weaponItem);
    }

    // ============================================
    // 2) Silah depolama (ITEM)
    // ============================================
    public void StoreWeapon(WeaponItemData weaponItem)
    {
        if (weaponItem == null)
            return;

        if (!storedWeapons.ContainsKey(weaponItem.weaponType))
            storedWeapons[weaponItem.weaponType] = new List<WeaponItemData>();

        storedWeapons[weaponItem.weaponType].Add(weaponItem);

        Debug.Log($"{weaponItem.weaponType} tÃ¼rÃ¼nde silah karavana eklendi: {weaponItem.itemName}");
    }

    // ============================================
    // 3) Silah Ã§ekme (UI / Swap)
    // ============================================
    public WeaponItemData TakeWeapon(WeaponType type, int index)
    {
        if (!storedWeapons.ContainsKey(type) || storedWeapons[type].Count == 0)
            return null;

        if (index < 0 || index >= storedWeapons[type].Count)
            return null;

        WeaponItemData item = storedWeapons[type][index];
        storedWeapons[type].RemoveAt(index);

        return item;
    }

    // ============================================
    // 4) Silah listesini dÃ¶ndÃ¼r (UI iÃ§in)
    // ============================================
    public List<WeaponItemData> GetWeapons(WeaponType type)
    {
        if (!storedWeapons.ContainsKey(type))
            storedWeapons[type] = new List<WeaponItemData>();

        return storedWeapons[type];
    }

    // ============================================
    // 5) SAVE SYSTEM
    // ============================================
    public CaravanSaveData GetSaveData()
    {
        CaravanSaveData save = new CaravanSaveData();

        foreach (var kvp in storedWeapons)
        {
            WeaponSaveEntry entry = new WeaponSaveEntry
            {
                type = kvp.Key,
                weaponIDs = new List<string>()
            };

            foreach (var weaponItem in kvp.Value)
            {
                entry.weaponIDs.Add(weaponItem.itemID);
            }

            save.weaponEntries.Add(entry);
        }

        return save;
    }

    public bool HasWeapon(WeaponItemData weaponItem)
    {
        if (weaponItem == null)
            return false;

        if (!storedWeapons.ContainsKey(weaponItem.weaponType))
            return false;

        foreach (var w in storedWeapons[weaponItem.weaponType])
        {
            if (w.itemID == weaponItem.itemID)
                return true;
        }

        return false;
    }

    public void LoadFromData(CaravanSaveData save)
    {
        // TÃ¼m silahlarÄ± temizle
        foreach (var key in storedWeapons.Keys)
            storedWeapons[key].Clear();

        if (save == null)
            return;

        // Save verisini geri yÃ¼kle
        foreach (var entry in save.weaponEntries)
        {
            if (!storedWeapons.ContainsKey(entry.type))
                storedWeapons[entry.type] = new List<WeaponItemData>();

            foreach (string id in entry.weaponIDs)
            {
                ItemData data = ItemDatabase.Get(id);

                if (data is WeaponItemData weaponItem)
                {
                    storedWeapons[entry.type].Add(weaponItem);
                }
                else
                {
                    Debug.LogWarning("Save'de silah item bulunamadÄ±: " + id);
                }
            }
        }

        Debug.Log("CaravanInventory yÃ¼klendi.");
    }
}
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CaravanWeaponUI : MonoBehaviour
{
    public Transform pistolRoot;
    public Transform rifleRoot;
    public Transform meleeRoot;

    public GameObject weaponButtonPrefab;

    private void OnEnable()
    {
        RefreshUI();
    }

    public void RefreshUI()
    {
        Clear(pistolRoot);
        Clear(rifleRoot);
        Clear(meleeRoot);

        // Pistols
        CreateButtons(WeaponType.Pistol, pistolRoot);

        // Rifles
        CreateButtons(WeaponType.MachineGun, rifleRoot);
        CreateButtons(WeaponType.Shotgun, rifleRoot);
        CreateButtons(WeaponType.Sniper, rifleRoot);
        CreateButtons(WeaponType.Bow, rifleRoot);

        // Melee
        CreateButtons(WeaponType.MeeleSword, meleeRoot);
        CreateButtons(WeaponType.ThrowingSpear, meleeRoot);
    }

    private void Clear(Transform parent)
    {
        foreach (Transform child in parent)
            Destroy(child.gameObject);
    }

    private void CreateButtons(WeaponType type, Transform root)
    {
        List<WeaponItemData> list = CaravanInventory.Instance.GetWeapons(type);

        for (int i = 0; i < list.Count; i++)
        {
            WeaponItemData weaponItem = list[i];

            GameObject btnGO = Instantiate(weaponButtonPrefab, root);

            // UI text
            TMP_Text txt = btnGO.GetComponentInChildren<TMP_Text>();
            if (txt != null)
                txt.text = weaponItem.itemName;

            Button btn = btnGO.GetComponent<Button>();

            int indexCopy = i;
            btn.onClick.AddListener(() =>
            {
                OnWeaponSelected(type, indexCopy);
            });
        }
    }

    private void OnWeaponSelected(WeaponType type, int index)
    {
        // 1) Karavandan silah ITEM'ini Ã§ek
        WeaponItemData selectedItem =
            CaravanInventory.Instance.TakeWeapon(type, index);

        if (selectedItem == null)
        {
            Debug.LogError("Karavandan silah alÄ±namadÄ±!");
            return;
        }

        // 2) Bu silah hangi slotta kullanÄ±lacak?
        WeaponSlotType slotType =
            WeaponSlotManager.Instance.GetSlotForWeapon(selectedItem.weaponType);

        int slotIndex = (int)slotType;

        // 3) Oyuncunun Ã¼zerindeki silahÄ± karavana gÃ¶nder
        WeaponItemData oldItem =
            WeaponSlotManager.Instance.GetWeaponItemInSlot(slotIndex);

        if (oldItem != null)
        {
            CaravanInventory.Instance.StoreWeapon(oldItem);
        }

        // 4) Yeni silahÄ± oyuncuya tak
        WeaponSlotManager.Instance.EquipWeaponInSlot(selectedItem, slotIndex);
        WeaponSlotManager.Instance.SwitchSlot(slotIndex);

        Debug.Log($"ğŸ”„ Swap baÅŸarÄ±lÄ±! {selectedItem.itemName} oyuncuya takÄ±ldÄ±.");

        // 5) UI yenile
        RefreshUI();
    }
}
using UnityEngine;
using TMPro;

public class GameClock : MonoBehaviour
{
    [Header("BaÄŸlantÄ±lar")]
    public DayNightCycle dayNightCycle;
    public TextMeshProUGUI timeText;
    public Transform player; // <<< AUTOSAVE Ä°Ã‡Ä°N EKLENDÄ°

    [Header("Zaman AyarlarÄ±")]
    public float dayStartHour = 6f;    // Oyun 06:00'da baÅŸlar
    public float nightStartHour = 19f; // AkÅŸam 19:00

    private float currentTime;   // 0â€“24 arasÄ± gerÃ§ek saat
    private float timeSpeed;     // GÃ¼ndÃ¼z hÄ±zÄ±
    private float nightSpeed;    // Gece hÄ±zÄ±

    // AUTOSAVE
    private bool savedThisMorning = false;
    private const int autoSaveHour = 8;   // 08:00'de kayÄ±t

    void Start()
    {
        if (dayNightCycle == null)
            dayNightCycle = FindObjectOfType<DayNightCycle>();

        // Saat baÅŸlangÄ±cÄ±
        currentTime = dayStartHour;

        // GÃ¼ndÃ¼z/gece hÄ±zlarÄ±
        timeSpeed = (nightStartHour - dayStartHour) / dayNightCycle.dayDuration;
        nightSpeed = ((24f - nightStartHour) + dayStartHour) / dayNightCycle.nightDuration;
    }

    private void Awake()
    {
        if (player == null)
        {
            player = GameObject.FindWithTag("Player")?.transform;
            if (player == null) return;
        }

    }



    void Update()
    {


        // ---- ZAMAN Ä°LERLETME ----
        if (dayNightCycle.IsDay)
            currentTime += Time.deltaTime * timeSpeed;
        else
            currentTime += Time.deltaTime * nightSpeed;

        if (currentTime >= 24f)
        {
            currentTime -= 24f;
            savedThisMorning = false; // Yeni gÃ¼n baÅŸladÄ±
        }

        // ---- EKRANDA GÃ–STER ----
        int hour = Mathf.FloorToInt(currentTime);
        int minute = Mathf.FloorToInt((currentTime % 1f) * 60f);

        if (timeText != null)
            timeText.text = $"Saat: {hour:00}:{minute:00}";

        // ---- AUTOSAVE ----
        CheckAutoSave(hour, minute);
    }

    private void CheckAutoSave(int hour, int minute)
    {
        // EÄŸer tam 08:00'deysek ve daha Ã¶nce kaydetmediysek
        if (!savedThisMorning && hour == autoSaveHour && minute == 0)
        {
            if (player != null)
            {
                SaveSystem.SavePlayerAndInventory(
    player,
    Inventory.Instance,
    FindObjectOfType<PlayerStats>(),
    FindObjectOfType<PlayerWeapon>()
);



                Debug.Log("ğŸŸ¢ 08:00 â†’ Otomatik kayÄ±t alÄ±ndÄ±!");
            }
            else
            {
                Debug.LogWarning("âŒ GameClock: Player referansÄ± eksik, autosave yapÄ±lamadÄ±!");
            }

            savedThisMorning = true;
        }
    }
}
using UnityEngine;

public class Collectible : MonoBehaviour
{
    [Header("Inventory Item (opsiyonel)")]
    public ItemData item;
    public int minAmount = 1;
    public int maxAmount = 1;

    [Header("Ammo (opsiyonel)")]
    public AmmoTypeData ammoType;

    [Header("Visual")]
    public Sprite normalSprite;
    public Sprite highlightedSprite;

    private SpriteRenderer sr;

    void Awake()
    {
        sr = GetComponent<SpriteRenderer>();
        if (sr && normalSprite)
            sr.sprite = normalSprite;
    }

    public void Highlight(bool state)
    {
        if (!sr) return;

        if (highlightedSprite != null)
            sr.sprite = state ? highlightedSprite : normalSprite;
    }

    public void Collect()
    {
        int amount = Random.Range(minAmount, maxAmount + 1);

        bool collected = false;

        // 1ï¸âƒ£ Inventory Item
        if (item != null)
        {
            Inventory.Instance.TryAdd(item, amount);
            collected = true;
        }

        // 2ï¸âƒ£ Ammo
        if (ammoType != null)
        {
            Inventory.Instance.AddAmmo(ammoType, amount);
            collected = true;
        }

        if (!collected)
        {
            Debug.LogWarning(
                $"[Collectible] {gameObject.name} Ã¼zerinde item veya ammo tanÄ±mlÄ± deÄŸil!"
            );
            return;
        }

        Destroy(gameObject);
    }
}
using UnityEditor;
using UnityEngine;

[CustomEditor(typeof(Collectible))]
public class CollectibleEditor : Editor
{
    SerializedProperty item;
    SerializedProperty minAmount;
    SerializedProperty maxAmount;

    SerializedProperty ammoType;

    SerializedProperty normalSprite;
    SerializedProperty highlightedSprite;

    void OnEnable()
    {
        item = serializedObject.FindProperty("item");
        minAmount = serializedObject.FindProperty("minAmount");
        maxAmount = serializedObject.FindProperty("maxAmount");

        ammoType = serializedObject.FindProperty("ammoType");

        normalSprite = serializedObject.FindProperty("normalSprite");
        highlightedSprite = serializedObject.FindProperty("highlightedSprite");
    }

    public override void OnInspectorGUI()
    {
        serializedObject.Update();

        bool hasItem = item.objectReferenceValue != null;
        bool hasAmmo = ammoType.objectReferenceValue != null;

        // ---------------- MODE INFO ----------------
        EditorGUILayout.LabelField("Collectible Data", EditorStyles.boldLabel);

        EditorGUILayout.PropertyField(item);
        EditorGUILayout.PropertyField(ammoType);

        // ---------------- VALIDATION ----------------
        if (hasItem && hasAmmo)
        {
            EditorGUILayout.HelpBox(
                "Bu Collectible hem Item hem Ammo iÃ§eriyor! Sadece biri dolu olmalÄ±.",
                MessageType.Error
            );
        }
        else if (!hasItem && !hasAmmo)
        {
            EditorGUILayout.HelpBox(
                "Bu Collectible hiÃ§bir ÅŸey vermiyor (Item veya Ammo seÃ§melisin).",
                MessageType.Warning
            );
        }

        // ---------------- AMOUNT ----------------
        if (hasItem || hasAmmo)
        {
            EditorGUILayout.Space(6);
            EditorGUILayout.LabelField("Amount Settings", EditorStyles.boldLabel);

            EditorGUILayout.PropertyField(minAmount);
            EditorGUILayout.PropertyField(maxAmount);

            if (minAmount.intValue > maxAmount.intValue)
            {
                EditorGUILayout.HelpBox(
                    "Min Amount, Max Amount'tan bÃ¼yÃ¼k olamaz!",
                    MessageType.Warning
                );
            }
        }

        // ---------------- VISUAL ----------------
        EditorGUILayout.Space(10);
        EditorGUILayout.LabelField("Visual", EditorStyles.boldLabel);

        EditorGUILayout.PropertyField(normalSprite);
        EditorGUILayout.PropertyField(highlightedSprite);

        serializedObject.ApplyModifiedProperties();
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CraftCostUI : MonoBehaviour
{
    public Image icon;
    public TMP_Text amountText;

    public void Setup(ItemData item, int requiredAmount, int playerAmount)
    {
        if (icon != null && item != null)
            icon.sprite = item.icon;

        if (amountText != null)
        {
            amountText.text = $"{playerAmount}/{requiredAmount}";
            amountText.color = playerAmount >= requiredAmount ? Color.white : Color.red;
        }
    }
}
using System.Collections.Generic;
using UnityEngine;

public class CraftingSystem : MonoBehaviour
{
    public static CraftingSystem Instance { get; private set; }

    [Header("Weapon Craft Recipes")]
    public List<WeaponCraftRecipe> recipes = new();

    public CaravanInventory caravanInventory;

    // Craft edilip kalÄ±cÄ± aÃ§Ä±lan silahlar (itemID)
    public HashSet<string> unlockedWeapons = new();

    private void Awake()
    {
        Instance = this;

        if (caravanInventory == null)
            caravanInventory = FindObjectOfType<CaravanInventory>();
    }

    // ------------------------------------------------------------
    // Recipe â†’ WeaponItemData
    // ------------------------------------------------------------
    private WeaponItemData GetWeaponItem(WeaponCraftRecipe recipe)
    {
        return recipe != null ? recipe.resultWeapon : null;
    }

    private string GetKey(WeaponItemData weaponItem)
    {
        return weaponItem != null ? weaponItem.itemID : string.Empty;
    }

    public bool IsUnlocked(WeaponCraftRecipe recipe)
    {
        WeaponItemData item = GetWeaponItem(recipe);
        return unlockedWeapons.Contains(GetKey(item));
    }

    // ------------------------------------------------------------
    // Craft edilebilir mi?
    // ------------------------------------------------------------
    public bool CanCraft(WeaponCraftRecipe recipe)
    {
        if (recipe == null) return false;

        WeaponItemData weaponItem = GetWeaponItem(recipe);
        if (weaponItem == null) return false;

        if (IsUnlocked(recipe)) return false;

        foreach (var cost in recipe.costs)
        {
            if (!Inventory.Instance.HasEnough(cost.item, cost.amount))
                return false;
        }

        return true;
    }

    // ------------------------------------------------------------
    // Craft â†’ Oyuncuya silahÄ± VER
    // ------------------------------------------------------------
    public bool TryCraft(WeaponCraftRecipe recipe)
    {
        if (!CanCraft(recipe))
        {
            Debug.Log("Craft baÅŸarÄ±sÄ±z: Gereken koÅŸullar saÄŸlanmÄ±yor.");
            return false;
        }

        WeaponItemData weaponItem = GetWeaponItem(recipe);

        // 1) KaynaklarÄ± tÃ¼ket
        foreach (var cost in recipe.costs)
            Inventory.Instance.TryConsume(cost.item, cost.amount);

        // 2) Unlock et (ITEM ID)
        unlockedWeapons.Add(GetKey(weaponItem));

        // 3) SilahÄ± oyuncuya ver / tak
        WeaponSlotManager.Instance.EquipWeapon(weaponItem);


        Debug.Log($"âœ” CRAFT BAÅARILI â†’ {weaponItem.itemName} oyuncuya takÄ±ldÄ±!");

        return true;
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CraftSlotUI : MonoBehaviour
{
    public Image icon;
    public TMP_Text nameText;
    public Transform costRoot;
    public GameObject costEntryPrefab;

    private WeaponCraftRecipe recipe;

    public void Setup(WeaponCraftRecipe recipe, Sprite weaponIcon, string name)
    {
        this.recipe = recipe;

        icon.sprite = weaponIcon;
        nameText.text = name;

        RefreshCosts();
    }

    private void RefreshCosts()
    {
        // Eski maliyet entry'lerini temizle
        foreach (Transform t in costRoot)
            Destroy(t.gameObject);

        foreach (var cost in recipe.costs)
        {
            GameObject costGO = Instantiate(costEntryPrefab, costRoot);
            CraftCostUI ui = costGO.GetComponent<CraftCostUI>();

            int playerAmount = Inventory.Instance.GetItemCount(cost.item);

            ui.Setup(cost.item, cost.amount, playerAmount);
        }
    }

    // UI butonu iÃ§in
    public void OnSelectPressed()
    {
        CraftUIController.Instance.SelectRecipe(recipe);
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class CraftUIController : MonoBehaviour
{
    [Header("UI")]
    public GameObject craftPanel;
    public Transform gridParent;
    public GameObject craftSlotPrefab;
    public Button craftButton;
    public TMP_Text craftButtonText;

    [Header("Logic")]
    public WeaponCraftRecipe selectedRecipe;

    public static CraftUIController Instance;

    private void Awake()
    {
        Instance = this;
    }

    private void Start()
    {
        PopulateRecipes();
        craftPanel.SetActive(false);
    }

    // --------------------------------------------------
    // Tarif SlotlarÄ±nÄ± oluÅŸtur
    // --------------------------------------------------
    public void PopulateRecipes()
    {
        foreach (Transform t in gridParent)
            Destroy(t.gameObject);

        if (CraftingSystem.Instance == null)
        {
            Debug.LogError("CraftingSystem.Instance bulunamadÄ±!");
            return;
        }

        foreach (var recipe in CraftingSystem.Instance.recipes)
        {
            GameObject slotGO = Instantiate(craftSlotPrefab, gridParent);

            CraftSlotUI slotUI = slotGO.GetComponent<CraftSlotUI>();
            if (slotUI == null)
            {
                Debug.LogError("CraftSlot prefabÄ±nda CraftSlotUI yok!");
                continue;
            }

            WeaponItemData weaponItem = recipe.resultWeapon;
            if (weaponItem == null)
            {
                Debug.LogError("Tarifte resultWeapon (WeaponItemData) eksik!");
                continue;
            }

            slotUI.Setup(recipe, weaponItem.icon, weaponItem.itemName);
        }
    }

    // --------------------------------------------------
    // Tarif seÃ§me
    // --------------------------------------------------
    public void SelectRecipe(WeaponCraftRecipe recipe)
    {
        selectedRecipe = recipe;

        WeaponItemData weaponItem = recipe.resultWeapon;
        bool existsInCaravan = CaravanInventory.Instance.HasWeapon(weaponItem);

        craftButtonText.text = existsInCaravan ? "Swap" : "Craft";
    }

    // --------------------------------------------------
    // Craft / Swap butonu
    // --------------------------------------------------
    public void OnCraftButtonPressed()
    {
        if (selectedRecipe == null)
        {
            Debug.Log("Tarif seÃ§ilmedi.");
            return;
        }

        WeaponItemData weaponItem = selectedRecipe.resultWeapon;
        bool existsInCaravan = CaravanInventory.Instance.HasWeapon(weaponItem);

        if (existsInCaravan)
        {
            SwapWithCaravan(weaponItem);
            Debug.Log($"Swap: {weaponItem.itemName}");
            selectedRecipe = null;
            return;
        }

        bool success = CraftingSystem.Instance.TryCraft(selectedRecipe);

        if (success)
        {
            Debug.Log($"Craft baÅŸarÄ±lÄ±: {weaponItem.itemName}");
            PopulateRecipes();
            selectedRecipe = null;
        }
        else
        {
            Debug.Log($"Craft baÅŸarÄ±sÄ±z: {weaponItem.itemName}");
        }
    }

    // --------------------------------------------------
    // Swap iÅŸlemi
    // --------------------------------------------------
    private void SwapWithCaravan(WeaponItemData weaponItem)
    {
        if (weaponItem == null)
            return;

        // Hangi slotta bu silah takÄ±lmalÄ±?
        WeaponSlotType slotType =
            WeaponSlotManager.Instance.GetSlotForWeapon(weaponItem.weaponType);

        int slotIndex = (int)slotType;

        // Mevcut silahÄ± karavana koy
        WeaponItemData currentItem =
            WeaponSlotManager.Instance.GetWeaponItemInSlot(slotIndex);

        if (currentItem != null)
            CaravanInventory.Instance.StoreWeapon(currentItem);

        // Karavandan seÃ§ilen silahÄ± Ã§Ä±kar
        var list = CaravanInventory.Instance.GetWeapons(weaponItem.weaponType);
        for (int i = 0; i < list.Count; i++)
        {
            if (list[i].itemID == weaponItem.itemID)
            {
                list.RemoveAt(i);
                break;
            }
        }

        // Yeni silahÄ± tak
        WeaponSlotManager.Instance.EquipWeaponInSlot(weaponItem, slotIndex);
        WeaponSlotManager.Instance.SwitchSlot(slotIndex);
    }
}
using UnityEngine;
using System.Collections;
using System.Collections.Generic;

public class Enemy : MonoBehaviour
{
    [Header("Core")]
    public EnemyType enemyType = EnemyType.Normal;
    public float moveSpeed = 2f;
    public bool externalMovement = false;

    [Header("Targets")]
    public Transform player;
    public Transform caravan;
    public Transform target;

    [Header("Attack")]
    public int damageToPlayer = 1;
    public int armoredCaravanDamage = 1;
    public float armoredDamageInterval = 1.0f;
    public float damageRangeToPlayer = 1.2f;
    public float damageRangeToCaravan = 1.2f;

    [Header("Exploder")]
    public float explosionRadius = 2f;
    public int explosionDamageToPlayer = 2;
    public int explosionDamageToCaravan = 2;

    [Header("Knockback")]
    public bool canBeKnockedBack = true;
    public float knockbackRecoveryTime = 0.25f;

    [Header("Audio")]
    public List<AudioClip> ambientSounds;
    public List<AudioClip> hurtSounds;
    public AudioClip deathSound;
    public Vector2 ambientSoundInterval = new Vector2(5f, 15f);

    private Animator animator;
    private AudioSource audioSource;

    private Coroutine knockbackCoroutine;
    private Coroutine caravanDamageCo;

    private bool isDamagingCaravan = false;
    public bool isAttacking = false;

    // ========================
    // UNITY
    // ========================
    void Awake()
    {
        animator = GetComponent<Animator>();
        audioSource = GetComponent<AudioSource>();

        if (!animator) Debug.LogError("[Enemy] Animator eksik!");
        if (!audioSource) Debug.LogError("[Enemy] AudioSource eksik!");
    }

    void Start()
    {
        ResolveTargets();

        if (ambientSounds != null && ambientSounds.Count > 0)
            StartCoroutine(PlayAmbientSounds());
        ResolveTargets();
    }

    void Update()
    {
        if (target == null)
        {
            ResolveTargets();
            if (target == null) return; // hÃ¢lÃ¢ yoksa bekle
        }
        if (externalMovement || target == null) return;

        float distance = Vector2.Distance(transform.position, target.position);
        float stopDistance = (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
            ? damageRangeToPlayer
            : damageRangeToCaravan;

        Vector2 dir = (target.position - transform.position).normalized;

        if (!isAttacking && distance > stopDistance)
        {
            transform.position += (Vector3)(dir * moveSpeed * Time.deltaTime);

            animator.SetBool("IsMoving", true);

            float angle = Mathf.Atan2(dir.y, dir.x) * Mathf.Rad2Deg;
            transform.rotation = Quaternion.Euler(0f, 0f, angle - 90f);
        }
        else if (!isAttacking)
        {
            animator.SetBool("IsMoving", false);
            StartCoroutine(AttackPlayerRoutine());
        }
    }

    // ========================
    // TARGET RESOLUTION
    // ========================
    private void ResolveTargets()
    {
        if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
        {
            if (player == null)
                player = GameObject.FindGameObjectWithTag("Player")?.transform;

            target = player;
        }
        else
        {
            if (caravan == null)
                caravan = GameObject.FindGameObjectWithTag("Caravan")?.transform;

            target = caravan;
        }
    }


    // ========================
    // ATTACK
    // ========================
    public IEnumerator AttackPlayerRoutine()
    {
        if (isAttacking) yield break;

        isAttacking = true;
        animator.SetTrigger("Attack");

        yield return new WaitForSeconds(1.5f);

        isAttacking = false;
    }

    // Animator Event
    public void DealDamageToPlayer()
    {
        if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
        {
            var ps = player?.GetComponent<PlayerStats>();
            ps?.TakeDamage(damageToPlayer);
        }
    }

    // ========================
    // CARAVAN DAMAGE
    // ========================
    public void StartCaravanDamage(Transform caravanTransform)
    {
        if (!isDamagingCaravan)
            caravanDamageCo = StartCoroutine(DamageCaravanOverTime(caravanTransform));
    }

    private IEnumerator DamageCaravanOverTime(Transform caravanTransform)
    {
        isDamagingCaravan = true;
        var ch = caravanTransform.GetComponent<CaravanHealth>();

        while (isDamagingCaravan && ch != null)
        {
            ch.TakeDamage(armoredCaravanDamage);
            yield return new WaitForSeconds(armoredDamageInterval);
        }

        isDamagingCaravan = false;
    }

    // ========================
    // KNOCKBACK
    // ========================
    public void ApplyKnockback(Vector2 sourcePosition, float force, float duration)
    {
        if (!canBeKnockedBack || knockbackCoroutine != null) return;

        Vector2 dir = ((Vector2)transform.position - sourcePosition).normalized;
        knockbackCoroutine = StartCoroutine(KnockbackRoutine(dir, force, duration));
    }

    private IEnumerator KnockbackRoutine(Vector2 direction, float force, float duration)
    {
        Rigidbody2D rb = GetComponent<Rigidbody2D>();

        if (rb)
            rb.AddForce(direction * force, ForceMode2D.Impulse);

        yield return new WaitForSeconds(duration);

        if (rb)
            rb.linearVelocity = Vector2.zero;

        yield return new WaitForSeconds(knockbackRecoveryTime);
        knockbackCoroutine = null;
    }

    // ========================
    // EXPLODER
    // ========================
    public void Explode()
    {
        Debug.Log("ğŸ’¥ Exploder patladÄ±!");

        var hits = Physics2D.OverlapCircleAll(transform.position, explosionRadius);

        foreach (var hit in hits)
        {
            if (hit.CompareTag("Player"))
                hit.GetComponent<PlayerStats>()?.TakeDamage(explosionDamageToPlayer);
            else if (hit.CompareTag("Caravan"))
                hit.GetComponent<CaravanHealth>()?.TakeDamage(explosionDamageToCaravan);
        }
    }

    // ========================
    // DEATH CALLBACK (EnemyHealth Ã§aÄŸÄ±rÄ±r)
    // ========================
    public void OnDeath()
    {
        animator.SetTrigger("Die");
        GetComponent<Collider2D>().enabled = false;

        if (deathSound)
            AudioSource.PlayClipAtPoint(deathSound, transform.position);

        this.enabled = false;
    }

    // ========================
    // AUDIO
    // ========================
    private IEnumerator PlayAmbientSounds()
    {
        while (true)
        {
            yield return new WaitForSeconds(Random.Range(
                ambientSoundInterval.x,
                ambientSoundInterval.y));

            PlayRandomSound(ambientSounds);
        }
    }

    private void PlayRandomSound(List<AudioClip> clips)
    {
        if (clips != null && clips.Count > 0 && audioSource != null)
        {
            int index = Random.Range(0, clips.Count);
            audioSource.PlayOneShot(clips[index]);
        }
    }
    public void TakeDamage(int amount)
    {
        EnemyHealth health = GetComponent<EnemyHealth>();
        if (health != null)
        {
            health.TakeDamage(amount);
        }
        else
        {
            Debug.LogWarning("[Enemy] EnemyHealth bulunamadÄ±!");
        }
    }

    public void OnSoundHeard(Vector2 soundPosition)
    {
        if (enemyType == EnemyType.Normal || enemyType == EnemyType.Fast)
        {
            if (target != null && Vector2.Distance(transform.position, target.position) < 1f)
                return;

            StartCoroutine(MoveToSoundPosition(soundPosition));
        }
    }

    private IEnumerator MoveToSoundPosition(Vector2 soundPosition)
    {
        float moveTime = 2f;
        float elapsed = 0f;

        while (elapsed < moveTime)
        {
            Vector2 dir = (soundPosition - (Vector2)transform.position).normalized;
            transform.position += (Vector3)(dir * moveSpeed * Time.deltaTime);

            animator.SetFloat("MoveX", dir.x);
            animator.SetFloat("MoveY", dir.y);

            elapsed += Time.deltaTime;
            yield return null;
        }

        if (player != null)
            target = player;
    }

    public void StopCaravanDamage()
    {
        isDamagingCaravan = false;

        if (caravanDamageCo != null)
            StopCoroutine(caravanDamageCo);

        caravanDamageCo = null;
    }

}
using UnityEngine;
using UnityEngine.UI;

public class EnemyHealth : MonoBehaviour
{
    public int maxHealth = 5;
    private int currentHealth;

    public Image hpFillImage;

    private Enemy enemy;
    private EnemyLootDropper lootDropper;

    void Awake()
    {
        enemy = GetComponent<Enemy>();
        lootDropper = GetComponent<EnemyLootDropper>();
        currentHealth = maxHealth;
    }

    public void TakeDamage(int amount)
    {
        currentHealth -= amount;
        UpdateHP();

        if (currentHealth <= 0)
            Die();
    }

    private void UpdateHP()
    {
        if (hpFillImage)
            hpFillImage.fillAmount = (float)currentHealth / maxHealth;
    }

    private void Die()
    {
        lootDropper?.DropLoot(transform.position);
        enemy.OnDeath(); // Enemyâ€™ye haber ver
        Destroy(gameObject);
    }
}
using UnityEngine;

public class EnemyHitbox : MonoBehaviour
{
    private Enemy enemyParent;

    private void Awake()
    {
        enemyParent = GetComponentInParent<Enemy>();
        if (enemyParent == null)
            Debug.LogError("[EnemyHitbox] Parent'ta Enemy scripti yok!");

        // GÃ¼venlik: Collider trigger olmalÄ±
        var col = GetComponent<Collider2D>();
        if (col != null && !col.isTrigger)
            col.isTrigger = true;
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (enemyParent == null) return;

        if (other.CompareTag("Player"))
        {
            // Yeni sistem: temas ettiÄŸinde saldÄ±rÄ±yÄ± baÅŸlat
            if (enemyParent.enemyType == EnemyType.Normal || enemyParent.enemyType == EnemyType.Fast)
            {
                // DÃ¼ÅŸman oyuncuya deÄŸdiÄŸinde artÄ±k direkt saldÄ±rÄ± coroutine'i Ã§aÄŸrÄ±lÄ±yor
                if (!enemyParent.isAttacking)
                    enemyParent.StartCoroutine(enemyParent.AttackPlayerRoutine());
            }
        }
        else if (other.CompareTag("Caravan"))
        {
            if (enemyParent.enemyType == EnemyType.Armored)
                enemyParent.StartCaravanDamage(other.transform);
            else if (enemyParent.enemyType == EnemyType.Exploder)
                enemyParent.Explode(); // PatlayÄ±cÄ±ysa temasta patlat
        }
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (enemyParent == null) return;

        if (other.CompareTag("Caravan"))
            enemyParent.StopCaravanDamage();
    }

    // Ä°stersen sÃ¼rekli temas varken de saldÄ±rÄ± denemesi yapÄ±labilir:
    private void OnTriggerStay2D(Collider2D other)
    {
        if (enemyParent == null) return;

        if (other.CompareTag("Player"))
        {
            if ((enemyParent.enemyType == EnemyType.Normal || enemyParent.enemyType == EnemyType.Fast) && !enemyParent.isAttacking)
            {
                // Temas devam ederken hÃ¢lÃ¢ saldÄ±rmÄ±yorsa tekrar saldÄ±r
                enemyParent.StartCoroutine(enemyParent.AttackPlayerRoutine());
            }
        }
        else if (other.CompareTag("Caravan"))
        {
            if (enemyParent.enemyType == EnemyType.Armored)
                enemyParent.StartCaravanDamage(other.transform);
        }
    }
}
using UnityEngine;
using System.Collections.Generic;

public class EnemyLootDropper : MonoBehaviour
{
    [Header("Drop Chances")]
    [Range(0f, 1f)] public float goldDropChance = 0.25f;
    [Range(0f, 1f)] public float blueprintDropChance = 0.75f;
    [Range(0f, 1f)] public float ammoDropChance = 0.4f;

    [Header("Prefabs")]
    public GameObject goldPrefab;
    public List<GameObject> blueprintPrefabs;
    public List<GameObject> ammoPrefabs;

    public void DropLoot(Vector3 position)
    {
        if (goldPrefab && Random.value < goldDropChance)
            Instantiate(goldPrefab, position, Quaternion.identity);

        if (blueprintPrefabs.Count > 0 && Random.value < blueprintDropChance)
        {
            var bp = blueprintPrefabs[Random.Range(0, blueprintPrefabs.Count)];
            Instantiate(bp, position, Quaternion.identity);
        }

        if (ammoPrefabs.Count > 0 && Random.value < ammoDropChance)
        {
            var ammo = ammoPrefabs[Random.Range(0, ammoPrefabs.Count)];
            Instantiate(ammo, position, Quaternion.identity);
        }
    }
}
using UnityEngine;
using System.Collections;

public class EnemySunBurn : MonoBehaviour
{
    public bool burnsInDay = true;
    public int burnDamagePerTick = 10;
    public float burnTickInterval = 1f;

    private Coroutine burnCo;
    private EnemyHealth health;

    void Awake()
    {
        health = GetComponent<EnemyHealth>();
    }

    private void OnEnable()
    {
        DayNightCycle.OnDayNightChanged += OnDayChanged;
    }

    private void OnDisable()
    {
        DayNightCycle.OnDayNightChanged -= OnDayChanged;
    }

    private void OnDayChanged(bool isDay)
    {
        if (!burnsInDay) return;

        if (isDay)
            burnCo = StartCoroutine(Burn());
        else if (burnCo != null)
            StopCoroutine(burnCo);
    }

    IEnumerator Burn()
    {
        while (true)
        {
            health.TakeDamage(burnDamagePerTick);
            yield return new WaitForSeconds(burnTickInterval);
        }
    }
}
public enum EnemyType
{
    Normal,
    Armored,
    Exploder,
    Fast
}
using UnityEngine;

[RequireComponent(typeof(Enemy))]
public class EnemyWanderDriver : MonoBehaviour
{
    public WanderArea area;                 // Hangi bÃ¶lgede gezinecek?
    public float waypointTolerance = 0.15f; // Hedefe varmÄ±ÅŸ sayÄ±lacaÄŸÄ± mesafe
    public Vector2 idleTimeRange = new Vector2(0.2f, 1.0f); // Noktalar arasÄ±nda kÄ±sa bekleme

    private Enemy enemy;
    private Animator anim;
    private Transform waypoint;     // DÃœÅMANIN HEDEFÄ°
    private bool isIdling = false;
    private float idleTimer = 0f;

    void Awake()
    {
        enemy = GetComponent<Enemy>();
        anim  = GetComponent<Animator>();
    }

    void Start()
    {
        if (area == null)
        {
            Debug.LogWarning("[EnemyWanderDriver] Area atanmamÄ±ÅŸ, yakÄ±n Ã§evrede dolanacak.");
        }

        // Waypoint oluÅŸtur (area altÄ±nda konumlamak dÃ¼zen aÃ§Ä±sÄ±ndan iyidir)
        GameObject wp = new GameObject($"WanderWP_{name}");
        waypoint = wp.transform;
        waypoint.parent = area ? area.transform : null;

        // Ä°lk rastgele nokta ve hedef atamasÄ±
        waypoint.position = GetNextPoint();
        enemy.target = waypoint; // ğŸ”´ Kritik: Enemy artÄ±k bu noktaya yÃ¼rÃ¼yecek
    }

    void Update()
    {
        if (enemy == null || waypoint == null) return;

        if (isIdling)
        {
            idleTimer -= Time.deltaTime;
            if (idleTimer <= 0f)
            {
                isIdling = false;
                waypoint.position = GetNextPoint();
                // enemy.target zaten waypoint, null olmaz -> Enemy oyuncuya dÃ¶nmez
            }
            else
            {
                if (anim) anim.SetFloat("Speed", 0f);
            }
            return;
        }

        // Waypoint'e yeterince yaklaÅŸtÄ±ysak kÄ±sa bekle ve yeni nokta seÃ§
        float distSqr = ((Vector2)(transform.position - waypoint.position)).sqrMagnitude;
        if (distSqr <= waypointTolerance * waypointTolerance)
        {
            isIdling = true;
            idleTimer = Random.Range(idleTimeRange.x, idleTimeRange.y);
        }
        // Hareketi Enemy.cs zaten yapÄ±yor (target -> waypoint olduÄŸu iÃ§in)
    }

    public void Setup(WanderArea areaRef)
{
    if (enemy == null) enemy = GetComponent<Enemy>();
    area = areaRef;

    if (waypoint == null)
    {
        var wp = new GameObject($"WanderWP_{name}");
        waypoint = wp.transform;
        waypoint.parent = area ? area.transform : null;
    }

    waypoint.position = GetNextPoint();
    enemy.target = waypoint; // Hemen waypoint'e kilitlenir (oyuncuya dÃ¶nmez)
}


    private Vector2 GetNextPoint()
    {
        if (area != null) return area.GetRandomPoint();
        // Area yoksa: bulunduÄŸu nokta etrafÄ±nda kÃ¼Ã§Ã¼k daire
        return (Vector2)transform.position + Random.insideUnitCircle * 2f;
    }

    void OnDestroy()
    {
        if (waypoint != null) Destroy(waypoint.gameObject);
    }
}
// SoundEmitter.cs (yeni bir script)
using UnityEngine;

public static class SoundEmitter
{
    public static void EmitSound(Vector2 position, float radius)
    {
        Collider2D[] hits = Physics2D.OverlapCircleAll(position, radius);
        foreach (var hit in hits)
        {
            Enemy enemy = hit.GetComponent<Enemy>();
            if (enemy != null)
            {
                enemy.OnSoundHeard(position);
            }
        }
    }
}
using UnityEngine;

public class FuelSpawner : MonoBehaviour
{
    public GameObject fuelPrefab;
    public int fuelCount = 4;
    public Vector2 spawnMin = new Vector2(-10, -5);
    public Vector2 spawnMax = new Vector2(10, 5);

    //Deneme iÃ§in

    void Start()
    {
        for (int i = 0; i < fuelCount; i++)
        {
            Vector2 randomPos = new Vector2(
                Random.Range(spawnMin.x, spawnMax.x),
                Random.Range(spawnMin.y, spawnMax.y)
            );

            Instantiate(fuelPrefab, randomPos, Quaternion.identity);
        }
    }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Items/Consumable")]
public class ConsumableItemData : ItemData
{
    [Header("Consumable Settings")]
    public int healAmount = 25;
    public float useDuration = 2f;

    private void OnValidate()
    {
        category = ItemCategory.Consumable;
        stackable = true;
    }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Items/Material")]
public class CraftMaterialItemData : ItemData
{
    private void OnValidate()
    {
        category = ItemCategory.Material;
        stackable = true;
        if (maxStack < 1)
            maxStack = 99;
    }
}
using System;
using System.Collections.Generic;
using UnityEngine;

public class Inventory : MonoBehaviour
{
    public static Inventory Instance { get; private set; }

    [Header("Config")]
    [Min(1)] public int capacity = 30;

    [Header("State")]
    public InventoryItem[] slots;

    // Blueprint kilitleri (turret / craft iÃ§in)
    private HashSet<string> unlockedBlueprints = new HashSet<string>();

    public event Action OnChanged;
    public void RaiseChanged() => OnChanged?.Invoke();

    // Yeni mermi depolama sistemi: ammoType(string) -> toplam mermi sayÄ±sÄ±
    private Dictionary<AmmoTypeData, int> ammoPool =
        new Dictionary<AmmoTypeData, int>();

    void Awake()
    {
        if (Instance != null)
        {
            Destroy(gameObject);
            return;
        }

        Instance = this;

        slots = new InventoryItem[capacity];
        for (int i = 0; i < capacity; i++)
            slots[i] = new InventoryItem();
    }

public bool IsMagazineEquipped(MagazineInstance mag)
{
    if (mag == null) return false;

    PlayerWeapon pw = FindObjectOfType<PlayerWeapon>();
    if (pw == null) return false;

    return pw.GetCurrentMagazine() == mag;
}

public void SetAmmoPool(Dictionary<AmmoTypeData, int> data)
{
    ammoPool = data;
}

    // ---------------- ADD ----------------
    public bool TryAdd(ItemData data, int amount = 1)
{
    if (data == null || amount <= 0)
        return false;

    // ğŸ”¥ MAGAZINE ITEM
    if (data is MagazineData magData)
    {
        for (int i = 0; i < slots.Length; i++)
        {
            if (slots[i].data == null)
            {
                slots[i] = new InventoryItem
                {
                    data = magData,
                    count = 1,
                    magazineInstance = new MagazineInstance(magData)
                };

                RaiseChanged();
                return true;
            }
        }

        return false; // envanter dolu
    }

    // ğŸ”« AMMO ITEM
    if (data is AmmoItemData ammoData)
    {
        int totalAmmo = ammoData.ammoAmount * amount;
        AddAmmo(ammoData.ammoType, totalAmmo);

        Debug.Log($"[Inventory] {ammoData.ammoType.ammoName} +{totalAmmo}");
        return true;
    }

    // ğŸ“¦ STACKLENEBÄ°LEN ITEM
    if (data.stackable)
    {
        int remain = amount;

        for (int i = 0; i < slots.Length && remain > 0; i++)
        {
            var s = slots[i];
            if (s.data == data && s.count < data.maxStack)
            {
                int add = Mathf.Min(remain, data.maxStack - s.count);
                s.count += add;
                remain -= add;
            }
        }

        for (int i = 0; i < slots.Length && remain > 0; i++)
        {
            if (slots[i].data == null)
            {
                int add = Mathf.Min(remain, data.maxStack);
                slots[i] = new InventoryItem(data, add);
                remain -= add;
            }
        }

        if (remain == 0)
        {
            RaiseChanged();
            return true;
        }

        return false;
    }

    // ğŸ“¦ STACKLENMEYEN NORMAL ITEM
    for (int i = 0; i < slots.Length; i++)
    {
        if (slots[i].data == null)
        {
            slots[i] = new InventoryItem(data, 1);
            RaiseChanged();
            return true;
        }
    }

    return false;
}


    // --------- YARDIMCI SAYIM METOTLARI ---------

    public int GetTotalCount(ItemData data)
    {
        if (data == null) return 0;
        int total = 0;
        foreach (var s in slots)
            if (s.data == data)
                total += s.count;
        return total;
    }
    public InventoryItem GetLastAddedSlot()
{
    for (int i = slots.Length - 1; i >= 0; i--)
    {
        if (slots[i] != null && slots[i].data != null)
            return slots[i];
    }
    return null;
}

public bool UnloadOneFromMagazine(MagazineInstance mag)
{
    if (IsMagazineEquipped(mag))
{
    Debug.Log("TakÄ±lÄ± ÅŸarjÃ¶r boÅŸaltÄ±lamaz!");
    return false;
}

    if (mag == null || mag.data == null)
        return false;

    if (mag.currentAmmo <= 0)
        return false;

    AmmoTypeData ammoType = mag.data.ammoType;
    if (ammoType == null)
        return false;

    // ğŸ”« ÅarjÃ¶rden Ã§Ä±kar
    mag.currentAmmo -= 1;

    // ğŸ” AmmoPool'a geri koy
    AddAmmo(ammoType, 1);

    RaiseChanged();

    Debug.Log(
        $"[Inventory] ÅarjÃ¶rden 1 mermi Ã§Ä±karÄ±ldÄ± â†’ " +
        $"{mag.currentAmmo}/{mag.data.capacity}"
    );

    return true;
}

public bool UnloadAllFromMagazine(MagazineInstance mag)
{
    if (IsMagazineEquipped(mag))
{
    Debug.Log("TakÄ±lÄ± ÅŸarjÃ¶r boÅŸaltÄ±lamaz!");
    return false;
}

    if (mag == null || mag.data == null)
        return false;

    int amount = mag.currentAmmo;
    if (amount <= 0)
        return false;

    AmmoTypeData ammoType = mag.data.ammoType;
    if (ammoType == null)
        return false;

    // ğŸ” AmmoPool'a geri koy
    AddAmmo(ammoType, amount);

    // ğŸ”« ÅarjÃ¶rÃ¼ boÅŸalt
    mag.currentAmmo = 0;

    RaiseChanged();

    Debug.Log(
        $"[Inventory] ÅarjÃ¶r tamamen boÅŸaltÄ±ldÄ± â†’ +{amount} mermi"
    );

    return true;
}


    // Envanterde yeterince var mÄ±?
    public bool HasEnough(ItemData data, int amount)
    {
        if (data == null || amount <= 0) return false;
        return GetTotalCount(data) >= amount;
    }

    // Blueprint kilidi aÃ§
    public void UnlockBlueprint(string id)
    {
        if (!string.IsNullOrEmpty(id))
            unlockedBlueprints.Add(id);
    }
    // Inventory.cs
public Dictionary<AmmoTypeData, int> GetAmmoPool()
{
    return ammoPool;
}

public void ClearAmmoPool()
{
    ammoPool.Clear();
}



    // Blueprint var mÄ±?
    public bool HasBlueprint(string id)
    {
        if (string.IsNullOrEmpty(id)) return true; // id yoksa serbest
        return unlockedBlueprints.Contains(id);
    }

    // ---------------- CONSUME / REMOVE ----------------

    public bool TryConsume(ItemData data, int amount)
    {
        if (data == null || amount <= 0) return false;

        int total = GetTotalCount(data);
        if (total < amount) return false;

        int remain = amount;

        for (int i = 0; i < slots.Length && remain > 0; i++)
        {
            var s = slots[i];
            if (s.data == data)
            {
                int take = Mathf.Min(remain, s.count);
                s.count -= take;
                remain -= take;

                if (s.count <= 0)
                    slots[i] = new InventoryItem();
            }
        }

        RaiseChanged();
        return true;
    }
    public bool TryAddMagazine(MagazineInstance mag)
{
    if (mag == null || mag.data == null)
        return false;

    for (int i = 0; i < slots.Length; i++)
    {
        if (slots[i].data == null)
        {
            slots[i] = new InventoryItem
            {
                data = mag.data,
                count = 1,
                magazineInstance = mag
            };

            RaiseChanged();
            return true;
        }
    }

    Debug.Log("Envanter dolu! ÅarjÃ¶r alÄ±namadÄ±.");
    return false;
}

    public bool TryMoveOrMerge(int from, int to)
    {
        if (from == to ||
            from < 0 || from >= slots.Length ||
            to < 0 || to >= slots.Length)
            return false;

        var a = slots[from];
        var b = slots[to];

        if (a.data == null) return false;

        if (b.data == null)
        {
            slots[to] = a;
            slots[from] = new InventoryItem();
            RaiseChanged();
            return true;
        }

        if (a.data == b.data && a.data.stackable)
        {
            int move = Mathf.Min(a.count, a.data.maxStack - b.count);
            b.count += move;
            a.count -= move;

            if (a.count <= 0)
                slots[from] = new InventoryItem();

            RaiseChanged();
            return true;
        }

        // swap
        slots[to] = a;
        slots[from] = b;
        RaiseChanged();
        return true;
    }

    public void ClearInventory()
    {
        for (int i = 0; i < slots.Length; i++)
            slots[i] = new InventoryItem();
        RaiseChanged();
    }

    public int GetItemCount(ItemData item)
    {
        if (item == null) return 0;

        int total = 0;

        for (int i = 0; i < slots.Length; i++)
        {
            InventoryItem invItem = slots[i];
            if (invItem == null || invItem.data == null)
                continue;

            if (invItem.data == item)
                total += invItem.count;
        }

        return total;
    }

    // ---------------- AMMO SÄ°STEMÄ° ----------------

    // Ammo ekleme (pickup vs. burayÄ± kullanacak)
    public void AddAmmo(AmmoTypeData ammoType, int amount)
    {
        if (ammoType == null || amount <= 0) return;

        if (!ammoPool.ContainsKey(ammoType))
            ammoPool[ammoType] = 0;

        ammoPool[ammoType] += amount;

        Debug.Log($"[Ammo] +{amount} {ammoType.ammoName} â†’ Total: {ammoPool[ammoType]}");
    }



    // Belirli ammo tipinden kaÃ§ adet var?
    public int GetAmmoAmount(AmmoTypeData ammoType)
    {
        if (ammoType == null) return 0;

        return ammoPool.TryGetValue(ammoType, out int amount)
            ? amount
            : 0;
    }


    // Ammo tÃ¼ket (ÅŸarjÃ¶r doldurma vb.)
    public bool TryUseAmmo(AmmoTypeData ammoType, int amount)
    {
        if (ammoType == null || amount <= 0) return false;

        if (!ammoPool.ContainsKey(ammoType)) return false;
        if (ammoPool[ammoType] < amount) return false;

        ammoPool[ammoType] -= amount;

        return true;
    }

    public bool FullLoadMagazine(MagazineInstance mag)
{
    if (mag == null || mag.data == null)
        return false;

    int needed = mag.data.capacity - mag.currentAmmo;
    if (needed <= 0)
        return false;

    int available = GetAmmoAmount(mag.data.ammoType);
    if (available <= 0)
        return false;

    int load = Mathf.Min(needed, available);
    return LoadAmmoIntoMagazine(mag, load);
}



    // ÅarjÃ¶re ammo yÃ¼kleme - ammoStorage'dan Ã§eker
    public bool LoadAmmoIntoMagazine(
    MagazineInstance mag,
    int amount
)
{
    if (mag == null || mag.data == null)
        return false;

    if (mag.IsFull)
        return false;

    AmmoTypeData ammoType = mag.data.ammoType;
    if (ammoType == null)
        return false;

    int available = GetAmmoAmount(ammoType);
    if (available <= 0)
        return false;

    int space = mag.data.capacity - mag.currentAmmo;
    int load = Mathf.Min(space, Mathf.Min(amount, available));

    if (load <= 0)
        return false;

    // ğŸ”¥ AMMO HAVUZUNDAN Ã‡EK
    TryUseAmmo(ammoType, load);

    // ğŸ”« ÅARJÃ–RE KOY
    mag.currentAmmo += load;

    RaiseChanged();

    Debug.Log(
        $"[Inventory] ÅarjÃ¶r dolduruldu â†’ +{load} " +
        $"({mag.currentAmmo}/{mag.data.capacity})"
    );

    return true;
}




}
using System;
using UnityEngine;

[Serializable]
public class InventoryItem
{
    public ItemData data;
    public int count = 1;
    public MagazineInstance magazineInstance;

    [Serializable]
    public class WeaponInstancePayload
    {
        public string id;
        public int clip;
        public int reserve;
        public int durability;
    }

    public WeaponInstancePayload weapon; // silahlar iÃ§in payload

    public bool IsWeapon => weapon != null;

    public InventoryItem() 
    {
        data = null;
        count = 0;
        magazineInstance = null;
    }

    public InventoryItem(ItemData data, int count = 1)
    {
        this.data = data;
        this.count = count;
        magazineInstance = null;
    }
}
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.UI;
using TMPro;

public class InventorySlotUI : MonoBehaviour,
    IPointerClickHandler, IBeginDragHandler, IDragHandler, IEndDragHandler, IDropHandler
{
    [Header("UI")]
    public Image icon;
    public TMP_Text countText;
    public CanvasGroup canvasGroup;

    private int index;
    private InventoryUI owner;
    private InventoryItem cached;
    private RectTransform rt;
    private GameObject dragIcon;
    [Header("Magazine Highlight")]
    public Image highlightImage;
    public Color equippedColor = Color.yellow;
    public Color normalColor = Color.clear;


    private void Awake()
    {
        if (canvasGroup == null)
            canvasGroup = gameObject.AddComponent<CanvasGroup>();

        rt = GetComponent<RectTransform>();
    }

    // InventoryUI tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
    public void Bind(int index, InventoryUI owner)
    {
        this.index = index;
        this.owner = owner;

        canvasGroup.alpha = 1f;
        canvasGroup.blocksRaycasts = true;
    }

    // Envanterdeki slot verisini UI'a basar
    public void Render(InventoryItem item)
    {
        cached = item;

        // ğŸ”« MAGAZINE SLOT
        if (item.magazineInstance != null)
        {
            var mag = item.magazineInstance;

            icon.enabled = true;
            icon.sprite = mag.data.icon;
            icon.preserveAspect = true;

            countText.text =
                $"{mag.currentAmmo}/{mag.data.capacity}";

            return;
        }
        if (highlightImage != null)
{
    var pw = FindObjectOfType<PlayerWeapon>();

    if (pw != null && pw.currentMagazine == item.magazineInstance)
        highlightImage.color = equippedColor;
    else
        highlightImage.color = normalColor;
}


        // ğŸ”« ÅARJÃ–RSE â†’ MERMÄ° GÃ–STER
        if (item.magazineInstance != null)
        {
            countText.text =
                $"{item.magazineInstance.currentAmmo}/" +
                $"{item.magazineInstance.data.capacity}";
            return;
        }

        if (item == null || item.data == null)
        {
            icon.enabled = false;
            countText.text = "";
            return;
        }

        icon.enabled = true;
        icon.sprite = item.data.icon;
        icon.preserveAspect = true;

        // ğŸ”¥ 1ï¸âƒ£ MAGAZINE HER ZAMAN Ã–NCELÄ°KLÄ°
        if (item.magazineInstance != null)
        {
            countText.text =
                $"{item.magazineInstance.currentAmmo}/{item.magazineInstance.data.capacity}";
            return;
        }

        // 2ï¸âƒ£ AMMO ITEM
        if (item.data is AmmoItemData ammoData)
        {
            int totalAmmo = item.count * ammoData.ammoAmount;
            countText.text = $"x{totalAmmo}";
            return;
        }

        // 3ï¸âƒ£ NORMAL ITEM
        countText.text = $"x{item.count}";
    }



    // SaÄŸ tÄ±k / sol tÄ±k davranÄ±ÅŸÄ±
    public void OnPointerClick(PointerEventData eventData)
{
    if (cached == null)
        return;

    // ğŸ”« MAGAZINE LEFT CLICK â†’ TAK
    if (cached.magazineInstance != null &&
        eventData.button == PointerEventData.InputButton.Left)
    {
        var pw = FindObjectOfType<PlayerWeapon>();
        if (pw == null) return;

        pw.TryEquipMagazineFromInventory(
            cached.magazineInstance
        );
    }
    if (cached.magazineInstance != null)
{
    owner.SelectMagazine(cached.magazineInstance);
    return;
}

}



    // ---- DRAG & DROP ----

    public void OnBeginDrag(PointerEventData eventData)
    {
        if (cached == null || cached.data == null) return;

        canvasGroup.blocksRaycasts = false;
        canvasGroup.alpha = 0.7f;

        dragIcon = new GameObject("DragIcon");
        dragIcon.transform.SetParent(owner.transform.root);
        dragIcon.transform.SetAsLastSibling();

        var img = dragIcon.AddComponent<Image>();
        img.sprite = icon.sprite;
        img.raycastTarget = false;
        img.preserveAspect = true;

        var drt = dragIcon.GetComponent<RectTransform>();
        drt.sizeDelta = rt.sizeDelta;
    }

    public void OnDrag(PointerEventData eventData)
    {
        if (dragIcon == null) return;
        dragIcon.transform.position = eventData.position;
    }

    public void OnEndDrag(PointerEventData eventData)
    {
        canvasGroup.blocksRaycasts = true;
        canvasGroup.alpha = 1f;

        if (dragIcon != null)
            Destroy(dragIcon);
    }

    public void OnDrop(PointerEventData eventData)
    {
        var src = eventData.pointerDrag ? eventData.pointerDrag.GetComponent<InventorySlotUI>() : null;
        if (src == null || src == this) return;

        owner.MoveOrMerge(src.index, this.index);
    }
}
using UnityEngine;
using UnityEngine.InputSystem; // Yeni sistem iÃ§in ÅŸart

public class InventoryToggle : MonoBehaviour
{
    public GameObject inventoryPanel;

    private Keyboard keyboard;

    void Awake()
    {
        keyboard = Keyboard.current;
    }

    void Update()
    {
        
    }
}
using UnityEngine;

public class InventoryUI : MonoBehaviour
{
    [Header("Refs")]
    public Inventory inventory;
    public Transform gridParent;        // 30 slotu bunun altÄ±na koy
    public GameObject slotPrefab;

    [Header("Visual")]
    public int slotCount = 30;
    public MagazineInstance selectedMagazine;
    public MagazineLoadPanel magazineLoadPanel;


    private InventorySlotUI[] slots;

    void Awake()
    {
        
        if (inventory == null)
            inventory = Inventory.Instance;

        slots = new InventorySlotUI[slotCount];

        for (int i = 0; i < slotCount; i++)
        {
            GameObject go = Instantiate(slotPrefab, gridParent); // sadece bir kez oluÅŸtur
            InventorySlotUI slot = go.GetComponent<InventorySlotUI>();

            if (slot == null)
            {
                Debug.LogError("Slot prefab iÃ§inde InventorySlotUI component eksik!");
                continue;
            }

            slot.Bind(i, this);
            go.SetActive(false); // BaÅŸlangÄ±Ã§ta gizli
            slots[i] = slot;
            go.SetActive(false); // âœ… BaÅŸta gizle
        }
    
}

    public void SelectMagazine(MagazineInstance mag)
{
    selectedMagazine = mag;
    UpdateMagazinePanel();
}
void UpdateMagazinePanel()
{
    if (selectedMagazine != null)
        magazineLoadPanel.Show(selectedMagazine);
    else
        magazineLoadPanel.Hide();
}

    void OnEnable()
    {
        if (inventory == null) inventory = Inventory.Instance;
        if (inventory != null) inventory.OnChanged += Refresh;
        Refresh();
    }

    void OnDisable()
    {
        if (inventory != null) inventory.OnChanged -= Refresh;
    }

    public void Refresh()
{
    if (inventory == null || slots == null) return;

    for (int i = 0; i < slots.Length; i++)
    {
        if (slots[i] == null || inventory.slots[i] == null) continue;

        // EÄŸer envanterde eÅŸya yoksa slotu gizle
        if (inventory.slots[i].data == null)
        {
            slots[i].gameObject.SetActive(false);
        }
        else
        {
            slots[i].gameObject.SetActive(true);
            slots[i].Render(inventory.slots[i]);
        }
    }
}


    public void MoveOrMerge(int fromIndex, int toIndex)
{
    Inventory.Instance.TryMoveOrMerge(fromIndex, toIndex);
    Refresh();
}

}
public enum ItemCategory
{
    Material,    // wood, stone, scrap, hide
    Consumable,
    Ammo,  // bandage, meat, cookedMeat
    Currency,    // gold
    Blueprint,   // turret blueprint
    Weapon,      // silah itemâ€™Ä± (varsa)
    Magazine,    // ÅŸarjÃ¶r
    Part,        // weapon part
    Quest,       // quest item (ileride)
    Misc
}
using UnityEngine;

public abstract class ItemData : ScriptableObject
{
    [Header("Base")]
    public string itemName;

    [Tooltip("Unique, stable id used by ItemDatabase & Save/Load")]
    public string itemID;

    public Sprite icon;

    [HideInInspector]
    public ItemCategory category;

    [Header("Stack")]
    public bool stackable = true;
    [Min(1)] public int maxStack = 99;

    public bool showCountBadge => stackable;
}
using System.Collections.Generic;
using UnityEngine;

public static class ItemDatabase
{
    private static Dictionary<string, ItemData> dict;

    public static void RegisterAll(ItemData[] items)
    {
        dict = new Dictionary<string, ItemData>();

        foreach (var item in items)
        {
            if (string.IsNullOrWhiteSpace(item.itemID))
            {
                Debug.LogError($"âŒ Item '{item.name}' iÃ§in itemID atanmadÄ±!");
                continue;
            }

            if (dict.ContainsKey(item.itemID))
            {
                Debug.LogError($"âŒ Duplicate itemID bulundu: {item.itemID}");
                continue;
            }

            dict.Add(item.itemID, item);
        }

        Debug.Log($"ItemDatabase â†’ {dict.Count} item yÃ¼klendi.");
    }

    public static ItemData Get(string id)
    {
        if (dict == null)
        {
            Debug.LogError("âŒ ItemDatabase: RegisterAll daha Ã§aÄŸrÄ±lmadÄ±!");
            return null;
        }

        if (dict.TryGetValue(id, out var data))
            return data;

        Debug.LogError($"âŒ Item bulunamadÄ± â†’ ID = {id}");
        return null;
    }
}
using UnityEngine;

[CreateAssetMenu(menuName = "Inventory/Item Registry")]
public class ItemRegistry : ScriptableObject
{
    public ItemData[] items;
}
using UnityEngine;

[CreateAssetMenu(menuName = "Items/Weapon/Part")]
public class WeaponPartItemData : ItemData
{
    public WeaponPartType partType;
    private void OnValidate()
    {
        category = ItemCategory.Weapon;
        stackable = true;
    }

}
using UnityEngine;

[CreateAssetMenu(menuName = "Items/Blueprint")]
public class BlueprintItemData : ItemData
{
    [Tooltip("ID used by Inventory.UnlockBlueprint")]
    public string blueprintID;
}
using UnityEngine;

public class Resource : MonoBehaviour
{

    public ItemData itemData;       // Yeni sistemdeki ScriptableObject

    [Header("Resource Settings")]
    public int amount = 1;

    [Header("Collection Mechanics")]
    [Tooltip("Bu kaynaÄŸÄ± toplamak iÃ§in kaÃ§ kez 'E'ye basÄ±lmasÄ± gerekiyor.")]
    public int hitsRequired = 3;

    [Tooltip("Ä°ki 'E' basÄ±ÅŸÄ± arasÄ±ndaki minimum bekleme sÃ¼resi (saniye).")]
    public float hitCooldown = 1.0f;

    // --- AMMO PICKUP AYARLARI ---
    [Header("Ammo Pickup")]
    [Tooltip("Mermiyi aktif silaha mÄ± ekleyelim? (false ise hedef slota ekler)")]
    public bool ammoToActiveSlot = true;

    [Tooltip("aktif deÄŸilse, bu slota ekle")]
    public int ammoTargetSlotIndex = 0;

    [Tooltip("MiktarÄ± 'maxAmmoCapacity' yÃ¼zdesi olarak mÄ± hesaplayalÄ±m?")]
    public bool ammoAmountAsPercentOfMax = true;

    [Range(0f, 1f)] public float ammoPercentOfMax = 0.25f; // Ã¶rn. %25
    public int ammoFixedAmount = 12;                      // yÃ¼zdelik kapalÄ±ysa sabit ek
    [Tooltip("Rezerv mermiyi weaponData.maxAmmoCapacity Ã¼stÃ¼ne taÅŸmayacak ÅŸekilde sÄ±nÄ±rla")]
    public bool clampToMaxCapacity = true;


    // --- Sistem DeÄŸiÅŸkenleri ---
    private int currentHits = 0;
    private bool canBeHit = true; // Cooldown kontrolÃ¼ iÃ§in

    public Sprite normalSprite;
    public Sprite highlightedSprite;
    private SpriteRenderer sr;

    void Start()
    {
        sr = GetComponent<SpriteRenderer>();
        if (sr != null && normalSprite != null)
            sr.sprite = normalSprite;
    }


    public void Collect()
{
    if (itemData == null)
    {
        Debug.LogError($"[Resource] itemData null! '{gameObject.name}' Ã¼zerinde itemData atanmamÄ±ÅŸ.");
        return;
    }

    if (Inventory.Instance == null)
    {
        Debug.LogError("[Resource] Inventory.Instance bulunamadÄ±.");
        return;
    }

    // Item'Ä± envantere ekle
    Inventory.Instance.TryAdd(itemData, amount);

    // Eski PlayerInventory sistemine baÄŸlÄ± satÄ±r SÄ°LÄ°NDÄ°
    // Ã‡Ã¼nkÃ¼ yeni sistemde gerek yok.

    Destroy(gameObject);
}


    public void HitResource()
    {
        // EÄŸer bekleme sÃ¼resi aktifse, hiÃ§bir ÅŸey yapma.
        if (!canBeHit)
        {
            Debug.Log("BEKLE! Ã‡ok hÄ±zlÄ± basÄ±yorsun.");
            return;
        }

        currentHits++;

        // Ä°steÄŸe baÄŸlÄ±: Her vuruÅŸta bir ses Ã§al veya gÃ¶rsel efekt gÃ¶ster.
        // EffectManager.Instance.PlayHitEffect(transform.position);

        // Yeterli vuruÅŸ sayÄ±sÄ±na ulaÅŸÄ±ldÄ± mÄ±?
        if (currentHits >= hitsRequired)
        {
            Collect();
        }
        else
        {
            // HenÃ¼z toplanmadÄ±ysa, bekleme sÃ¼resini baÅŸlat.
            StartCoroutine(HitCooldown());
        }
    }

    private System.Collections.IEnumerator HitCooldown()
    {
        canBeHit = false;
        yield return new WaitForSeconds(hitCooldown);
        canBeHit = true;
    }

    public void Highlight(bool state)
    {
        if (sr == null) sr = GetComponent<SpriteRenderer>();

        if (state && highlightedSprite != null)
            sr.sprite = highlightedSprite;
        else if (normalSprite != null)
            sr.sprite = normalSprite;
    }


}
using UnityEngine;

public class ResourceSpawner : MonoBehaviour
{
    public GameObject stonePrefab;
    public GameObject woodPrefab;
    public GameObject scrapMetalPrefab;

    public int stoneCount = 5;
    public int woodCount = 3;
    public int scrapMetalCount = 2;

    public Vector2 spawnAreaMin = new Vector2(-10, -5);
    public Vector2 spawnAreaMax = new Vector2(10, 5);

    private Transform resourceParent;

    void Start()
    {
        // Resources adlÄ± GameObject'i bul
        GameObject container = GameObject.Find("Resources(Silme)");
        if (container != null)
        {
            resourceParent = container.transform;
        }
        else
        {
            Debug.LogWarning("Resources GameObject bulunamadÄ±! KÃ¶k objeye ekleniyor.");
        }

        SpawnResources(stonePrefab, stoneCount);
        SpawnResources(woodPrefab, woodCount);
        SpawnResources(scrapMetalPrefab, scrapMetalCount);
    }

    void SpawnResources(GameObject prefab, int count)
    {
        for (int i = 0; i < count; i++)
        {
            Vector2 randomPos = new Vector2(
                Random.Range(spawnAreaMin.x, spawnAreaMax.x),
                Random.Range(spawnAreaMin.y, spawnAreaMax.y)
            );

            // Parent olarak Resources objesini ata
            GameObject spawned = Instantiate(prefab, randomPos, Quaternion.identity);
            if (resourceParent != null)
                spawned.transform.parent = resourceParent;
        }
    }
    public void RegenerateResources(float ratio)
    {
        int newStones = Mathf.RoundToInt(stoneCount * ratio);
        int newWoods = Mathf.RoundToInt(woodCount * ratio);
        int newMeteors = Mathf.RoundToInt(scrapMetalCount * ratio);

        SpawnResources(stonePrefab, newStones);
        SpawnResources(woodPrefab, newWoods);
        SpawnResources(scrapMetalPrefab, newMeteors);
    }

}
using UnityEngine;

public class CloudShadowMover : MonoBehaviour
{
    public float speed = 1f;
    public float resetX = -20f;
    public float startX = 20f;

    void Update()
    {
        transform.Translate(Vector2.left * speed * Time.deltaTime);

        if (transform.position.x < resetX)
        {
            float randomY = Random.Range(2f, 5f);
            transform.position = new Vector3(startX, randomY, transform.position.z);
        }
    }
}
using UnityEngine;
using TMPro;

public class DamagePopup : MonoBehaviour
{
    public TextMeshProUGUI textMesh;

    private RectTransform rect;
    private float floatSpeed = 40f;
    private float fadeDuration = 1.2f;
    private float elapsed = 0f;

    private Color startColor = Color.red;

    private void Awake()
    {
        rect = GetComponent<RectTransform>();
    }

    public void Setup(int damage)
    {
        if (textMesh == null)
            textMesh = GetComponent<TextMeshProUGUI>();

        textMesh.text = damage.ToString();
        textMesh.color = startColor;
    }

    void Update()
    {
        // ğŸ”¥ UI UZAYINDA YUKARI KAY
        rect.anchoredPosition += Vector2.up * floatSpeed * Time.deltaTime;

        elapsed += Time.deltaTime;

        float t = elapsed / fadeDuration;
        textMesh.color = Color.Lerp(startColor, Color.clear, t);

        if (elapsed >= fadeDuration)
            Destroy(gameObject);
    }
}
using UnityEngine;
using TMPro;

public class DamagePopupManager : MonoBehaviour
{
    public static DamagePopupManager Instance;

    public GameObject popupPrefab;
    public RectTransform popupParent; // DamagePopups
    public Camera mainCam;

    private void Awake()
    {
        if (Instance == null) Instance = this;
        else Destroy(gameObject);

        if (mainCam == null)
            mainCam = Camera.main;
    }

    public void SpawnPopup(Vector3 worldPos, int damage)
    {
        if (!popupPrefab || !popupParent) return;

        Vector3 screenPos = mainCam.WorldToScreenPoint(worldPos + Vector3.up * 1f);

        RectTransformUtility.ScreenPointToLocalPointInRectangle(
            popupParent,
            screenPos,
            mainCam,               // âš ï¸ Screen Space - Overlay MANTIÄI
            out Vector2 localPos
        );

        GameObject popup = Instantiate(popupPrefab, popupParent);
        popup.GetComponent<RectTransform>().anchoredPosition = localPos;

        popup.GetComponent<DamagePopup>()?.Setup(damage);
    }
}
// DayNightCycle.cs
using UnityEngine;
using System;
public class DayNightCycle : MonoBehaviour
{

public static DayNightCycle Instance { get; private set; }
public static event System.Action<bool> OnDayNightChanged; // true = day, false = night

public bool IsDay => isDay;



    public float dayDuration = 30f;
    public float nightDuration = 30f;
    private float timer = 0f;

    public LightController lightController;
    public ResourceSpawner spawner;
    public EnemyManager enemyManager;


    [Range(0f, 1f)]
    public float regenerationRatio = 0.5f;

    private bool isDay = true;

    // âœ… SAHNE HER AÃ‡ILDIÄINDA Ã‡AÄRILACAK
    void Awake()
    {
         Instance = this;
        ResetCycle();
    }

    // (Ä°stersen OnEnableâ€™da da gÃ¼venceye alabilirsin)
    void OnEnable()
    {
        // ResetCycle();  // Awake yetmiyorsa bunu da aÃ§
    }

    void Update()
{
    timer -= Time.deltaTime;

    if (timer <= 0f)
    {
        isDay = !isDay;
        timer = isDay ? dayDuration : nightDuration;

        OnDayNightChanged?.Invoke(isDay); // âœ… GÃœNDEMÄ°ZDE BU Ã‡OK Ã–NEMLÄ°

        if (isDay) HandleDayStart();
        else       HandleNightStart();
    }
}


    // âœ… YENÄ°: BaÅŸtan kurulum
    public void ResetCycle()
{
    Debug.Log("ğŸ”¥ ResetCycle Ã‡AÄRILDI! GÃœNDÃœZ BAÅLATILIYOR!");

    // ğŸ”¥ TÃ¼m gece/gÃ¼ndÃ¼z mÃ¼ziklerini sÄ±fÄ±rla
    if (MusicManager.Instance != null)
    {
        MusicManager.Instance.StopAll();  // â† Ekliyoruz
    }

    // ğŸ•’ Oyunun her yeni yÃ¼kleniÅŸi GÃœNDÃœZ baÅŸlayacaksa:
    isDay = true;
    timer = dayDuration;

    // EÄŸer ileride gece baÅŸlamasÄ±nÄ± istersen bunu false yaparsÄ±n.
    
    // ğŸ”† GÃ¼ndÃ¼z setup
    lightController?.SetDay(true);
    enemyManager?.ResetDayCount();
    spawner?.RegenerateResources(0f);
    SetAnimalsNightState(false);

    // ğŸµ Temiz gÃ¼ndÃ¼z mÃ¼ziÄŸi *tek baÅŸÄ±na* Ã§alsÄ±n
    MusicManager.Instance?.SetDay(true);
}


    void HandleDayStart()
    {
        spawner?.RegenerateResources(regenerationRatio);
        SetAnimalsNightState(false);
        lightController?.SetDay(true);
        MusicManager.Instance?.SetDay(true);
    }

    void HandleNightStart()
    {
        enemyManager?.SpawnEnemies();
        SetAnimalsNightState(true);
        lightController?.SetDay(false);
        MusicManager.Instance?.SetDay(false);
    }

    void SetAnimalsNightState(bool night)
    {
        foreach (var a in FindObjectsOfType<Animal>())
            a.SetNight(night);
    }
}
using UnityEngine;

public class EnemyManager : MonoBehaviour
{
    [Header("DÃ¼ÅŸman AyarlarÄ±")]
    public GameObject[] enemyPrefabs;
    public Transform[] spawnPoints;

    [Header("Gece BaÅŸÄ±na Ayarlar")]
    public int baseEnemyCount = 5;
    public float enemyCountIncreasePerDay = 2f;
    private int currentDay = 1;

    public SpawnZoneManager spawnZoneManager; // Inspectorâ€™dan sÃ¼rÃ¼kle bÄ±rak


    // ğŸ”¹ EK: Belirli bÃ¶lgelerde ekstra GEZGÄ°N (sadece Normal/Fast)
    [System.Serializable]
    public class ExtraWanderGroup
    {
        public WanderArea area;                 // BÃ¶lge
        public GameObject[] wanderPrefabs;      // Sadece EnemyType.Normal / EnemyType.Fast olan prefabler
        public int extraCount = 3;              // KaÃ§ tane
    }
    public ExtraWanderGroup[] extraWanderGroups;

    public void SpawnEnemies()
    {
        if (enemyPrefabs.Length == 0 || spawnPoints.Length == 0)
        {
            Debug.LogWarning("âŒ EnemyManager: Prefab veya spawn noktasÄ± eksik!");
            return;
        }

        int total = Mathf.RoundToInt(baseEnemyCount + (currentDay - 1) * enemyCountIncreasePerDay);
        Debug.Log($"ğŸŒ™ Gece {currentDay}. Toplam dÃ¼ÅŸman: {total}");

        // ğŸ”¸ 1) NORMAL spawnlar (kovalamaya devam eder)
        for (int i = 0; i < total; i++)
        {
            int enemyIndex = Random.Range(0, enemyPrefabs.Length);
            int spawnPointIndex = i % spawnPoints.Length;
            Instantiate(enemyPrefabs[enemyIndex], spawnPoints[spawnPointIndex].position, Quaternion.identity);
        }

        // ğŸ”¹ 2) EKSTRA gezginler (yalnÄ±zca Normal/Fast)
        SpawnExtraWanderers();

        currentDay++;

        if (spawnZoneManager != null)
            spawnZoneManager.SpawnAllZones();

    }

    private void SpawnExtraWanderers()
    {
        if (extraWanderGroups == null) return;

        foreach (var g in extraWanderGroups)
        {
            if (g == null || g.area == null || g.wanderPrefabs == null || g.wanderPrefabs.Length == 0) continue;

            for (int i = 0; i < g.extraCount; i++)
            {
                var prefab = g.wanderPrefabs[Random.Range(0, g.wanderPrefabs.Length)];
                Vector2 pos = g.area.GetRandomPoint();
                var go = Instantiate(prefab, pos, Quaternion.identity);

                // Tip kontrolÃ¼ (sadece Normal/Fast olmalÄ±)
                var e = go.GetComponent<Enemy>();
                if (e == null)
                {
                    Debug.LogWarning("[EnemyManager] Ekstra wander prefabÄ±nda Enemy component yok.");
                    continue;
                }
                if (e.enemyType != EnemyType.Normal && e.enemyType != EnemyType.Fast)
                {
                    Debug.LogWarning($"[EnemyManager] {go.name} enemyType={e.enemyType}. Ekstra wander iÃ§in Normal/Fast seÃ§in.");
                }

                // GEZGÄ°N sÃ¼rÃ¼cÃ¼yÃ¼ ekle ve alanÄ± baÄŸla
                var driver = go.GetComponent<EnemyWanderDriver>();
                if (!driver) driver = go.AddComponent<EnemyWanderDriver>();
                driver.area = g.area;
            }
        }
    }

    public void ResetDayCount() { currentDay = 1; }
}
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.InputSystem;

public class GameManager : MonoBehaviour
{
    public static GameManager Instance;

    public int requiredFuel = 4;
    private int currentFuel = 0;

    public GameObject gameOverPanel;

    private void Start()
{
    var player = GameObject.FindWithTag("Player");
    if (player != null)
    {
        var stats = player.GetComponent<PlayerStats>();
        if (stats != null)
        {
            stats.onDeath += GameOver;   // ğŸ”¥ Ã–lÃ¼nce GameOver tetikleniyor
            Debug.Log("âœ” Player death event GameManager'a baÄŸlandÄ±.");
        }
        else
        {
            Debug.LogError("âŒ PlayerStats component bulunamadÄ±!");
        }
    }
    else
    {
        Debug.LogError("âŒ 'Player' tag'Ä±na sahip obje bulunamadÄ±!");
    }
}

private void OnSceneLoaded(Scene scene, LoadSceneMode mode)
{
    if (scene.name == "MainMenu")
        return;

    // Yeni Sahne â†’ DayNightCycle var mÄ±?
    var cycle = FindObjectOfType<DayNightCycle>();
    if (cycle != null)
    {
        Debug.Log("ğŸ”¥ SceneLoaded â†’ ResetCycle() Ã§aÄŸrÄ±lÄ±yor!");
        cycle.ResetCycle();
    }
    else
    {
        Debug.LogError("âŒ DayNightCycle SAHNEDE YOK!");
    }
}


    private void Awake()
    {
        if (Instance == null)
            Instance = this;
        else
            Destroy(gameObject);
             SceneManager.sceneLoaded += OnSceneLoaded;

    }



    public void AddFuel(int amount)
    {
        currentFuel += amount;
        Debug.Log($"â›½ YakÄ±t toplandÄ±: {currentFuel}/{requiredFuel}");
    }

    public bool HasAllFuel()
    {
        return currentFuel >= requiredFuel;
    }

    public void LoadNextScene()
    {
        Debug.Log("ğŸšš TÃ¼m yakÄ±tlar toplandÄ±, sonraki sahneye geÃ§iliyor...");
        int currentIndex = SceneManager.GetActiveScene().buildIndex;

        // ğŸ§  Oyuncunun en son oynadÄ±ÄŸÄ± bÃ¶lÃ¼mÃ¼ hatÄ±rla
        PlayerPrefs.SetInt("LastLevel", currentIndex + 1);
        PlayerPrefs.Save();

        // ğŸ¬ Sonraki sahneye geÃ§
        SceneManager.LoadScene(currentIndex + 1);
    }

    public void GameOver()
    {
        if (gameOverPanel != null)
        {
            gameOverPanel.SetActive(true);
            Time.timeScale = 0f;

            GameStateManager.IsGameOver = true;

            // Oyuncu inputunu kapat
            var player = GameObject.FindWithTag("Player");
            if (player != null)
            {
                var input = player.GetComponent<PlayerInput>();
                if (input != null) input.enabled = false;

                var controller = player.GetComponent<PlayerMovement>();
                if (controller != null) controller.enabled = false;
            }
        }
    }


    public void RestartGame()
{
    GameStateManager.IsGameOver = false;
    GameStateManager.ResetGameState();
    
    // AyarlarÄ±n kaybolmamasÄ± iÃ§in diske yazmayÄ± zorla
    PlayerPrefs.Save(); 
    
    Time.timeScale = 1f;
    SceneManager.LoadScene(SceneManager.GetActiveScene().name);
}

   public void ReturnToMainMenu()
{
    Debug.Log("ğŸ Ana menÃ¼ye dÃ¶nÃ¼lÃ¼yor...");

    // Oyun hÄ±zÄ±nÄ± sÄ±fÄ±rla
    Time.timeScale = 1f;

    // GameState reset
    GameStateManager.IsGameOver = false;
    GameStateManager.ResetGameState();

    // ğŸ”¥ SAHNEDEKÄ° TÃœM SESLERÄ° DURDUR (Bolum1 dahil)
    StopAllSceneAudio();

    // Ana MenÃ¼ sahnesine geÃ§
    SceneManager.LoadScene("MainMenu");
}

private void StopAllSceneAudio()
{
    AudioSource[] allAudioSources = FindObjectsOfType<AudioSource>();

    foreach (AudioSource audio in allAudioSources)
    {
        audio.Stop();
        audio.enabled = false;   // ğŸ”¥ MÃ¼zik tekrar baÅŸlamasÄ±n
    }

    Debug.Log("ğŸ”‡ Bolum1 iÃ§indeki TÃœM sesler durduruldu!");
}



}
// GameSceneBootstrap.cs (Ã¶rnek)
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.InputSystem;

public class GameSceneBootstrap : MonoBehaviour
{
    public bool hideCursorInGame = true;
    public CursorLockMode lockMode = CursorLockMode.Confined;

    void Awake()
{
    Time.timeScale = 1f;

    Cursor.visible   = !hideCursorInGame;
    Cursor.lockState = lockMode;

    // SADECE input map ayarÄ± (pause state'e dokunmaz)
    foreach (var pi in FindObjectsOfType<PlayerInput>(includeInactive: true))
    {
        if (pi.actions != null && pi.actions.FindActionMap("Gameplay") != null)
            pi.SwitchCurrentActionMap("Gameplay");
    }

    // EventSystem temizliÄŸi
    var allEventSystems = FindObjectsOfType<EventSystem>();
    for (int i = 1; i < allEventSystems.Length; i++)
        Destroy(allEventSystems[i].gameObject);
}

}
using UnityEngine;
public static class GameStateManager
{
    public static bool IsGamePaused { get; private set; }
    public static bool IsGameOver { get; set; }

    public static void SetPaused(bool paused)
    {
        IsGamePaused = paused;
        Time.timeScale = paused ? 0f : 1f;
    }

    public static void ResetGameState()
    {
        IsGameOver = false;
        SetPaused(false);
    }
}
using UnityEngine;
using UnityEngine.Rendering.Universal;

public class LightController : MonoBehaviour
{
    [Header("Global Light")]
    public Light2D globalLight;

    [Header("Time Of Day")]
    [Range(0, 24)]
    public float timeOfDay = 8f;     // 0â€“24 arasÄ± saat
    public float daySpeed = 0.25f;   // GÃ¼nÃ¼n akÄ±ÅŸ hÄ±zÄ±

    [Header("Colors")]
    public Color morningColor = new Color(1f, 0.78f, 0.63f);   // Sabah
    public Color noonColor    = new Color(1f, 1f, 0.9f);       // Ã–ÄŸle
    public Color afternoonColor = new Color(1f, 0.86f, 0.7f);  // Ä°kindi
    public Color eveningColor = new Color(1f, 0.63f, 0.47f);   // AkÅŸam
    public Color nightColor   = new Color(0.16f, 0.23f, 0.47f); // Gece

    [Header("Intensity")]
    public float morningIntensity   = 0.8f;
    public float noonIntensity      = 1.0f;
    public float afternoonIntensity = 0.7f;
    public float eveningIntensity   = 0.5f;
    public float nightIntensity     = 0.25f;

    public float transitionSpeed = 2f;

    private Color targetColor;
    private float targetIntensity;

    // DayNightCycle burayÄ± kullanÄ±yor
    private bool isDay = true;

    private void Awake()
    {
        if (globalLight == null)
            globalLight = GetComponent<Light2D>();

        // GÃ¼venli baÅŸlangÄ±Ã§
        SetDay(true);
    }

    private void Update()
    {
        if (globalLight == null) return;

        if (isDay)
        {
            // Sadece gÃ¼ndÃ¼z vakti saat akÄ±yor
            timeOfDay += Time.deltaTime * daySpeed;

            // GÃ¼ndÃ¼z aralÄ±ÄŸÄ±: 06â€“21
            if (timeOfDay < 6f)  timeOfDay = 6f;
            if (timeOfDay > 21f) timeOfDay = 6f;

            // Sabah: 06â€“09
            if (timeOfDay >= 6f && timeOfDay < 9f)
            {
                targetColor = morningColor;
                targetIntensity = morningIntensity;
            }
            // Ã–ÄŸle: 09â€“15
            else if (timeOfDay >= 9f && timeOfDay < 15f)
            {
                targetColor = noonColor;
                targetIntensity = noonIntensity;
            }
            // Ä°kindi: 15â€“18
            else if (timeOfDay >= 15f && timeOfDay < 18f)
            {
                targetColor = afternoonColor;
                targetIntensity = afternoonIntensity;
            }
            // AkÅŸam: 18â€“21
            else if (timeOfDay >= 18f && timeOfDay < 21f)
            {
                targetColor = eveningColor;
                targetIntensity = eveningIntensity;
            }
        }
        else
        {
            // Gece modunda sabit deÄŸer
            targetColor = nightColor;
            targetIntensity = nightIntensity;
        }

        // YumuÅŸak geÃ§iÅŸ
        globalLight.color = Color.Lerp(globalLight.color, targetColor, Time.deltaTime * transitionSpeed);
        globalLight.intensity = Mathf.Lerp(globalLight.intensity, targetIntensity, Time.deltaTime * transitionSpeed);
    }

    /// <summary>
    /// DayNightCycle burayÄ± Ã§aÄŸÄ±rÄ±yor.
    /// true = gÃ¼ndÃ¼z, false = gece
    /// </summary>
    public void SetDay(bool day)
    {
        isDay = day;

        if (!isDay)
        {
            // Geceye geÃ§erken hedefleri direkt geceye Ã§ek
            targetColor = nightColor;
            targetIntensity = nightIntensity;
        }
        else
        {
            // GÃ¼ndÃ¼ze geÃ§erken zamanÄ± sabaha zorlayabilirsin
            if (timeOfDay < 6f || timeOfDay > 21f)
                timeOfDay = 6f; // sabah baÅŸlasÄ±n
        }
    }
}
using UnityEngine;

public class SettingsLoader : MonoBehaviour
{
    void Awake()
    {
        // Bu objeyi sahne deÄŸiÅŸse bile yok etme
        DontDestroyOnLoad(gameObject);

        // MÃ¼zik sesi
        AudioListener.volume = PlayerPrefs.GetFloat("MusicVolume", 1f);

        // Grafik kalitesi
        QualitySettings.SetQualityLevel(
            PlayerPrefs.GetInt("QualityLevel", QualitySettings.GetQualityLevel())
        );

        // Tam ekran
        Screen.fullScreen = PlayerPrefs.GetInt("Fullscreen", 1) == 1;
    }
}
using UnityEngine;

public class SpawnZoneManager : MonoBehaviour
{
    [System.Serializable]
    public class ZoneSpawn
    {
        public WanderArea area;
        public GameObject[] enemyPrefabs;
        public int count = 5;
        public bool addWanderer = true;  // ArtÄ±k EnemyWanderDriver anlamÄ±na geliyor
        public float spreadPadding = 0.2f;
    }

    public ZoneSpawn[] zones;

    [ContextMenu("Spawn All Zones")]
    public void SpawnAllZones()
    {
        foreach (var z in zones)
        {
            if (z.area == null || z.enemyPrefabs == null || z.enemyPrefabs.Length == 0) continue;

            for (int i = 0; i < z.count; i++)
            {
                var prefab = z.enemyPrefabs[Random.Range(0, z.enemyPrefabs.Length)];
                Vector2 p = z.area.GetRandomPoint() + Random.insideUnitCircle * z.spreadPadding;

                var go = Instantiate(prefab, p, Quaternion.identity);

                if (!z.addWanderer) continue;

                var enemy = go.GetComponent<Enemy>();
                if (!enemy)
                {
                    Debug.LogWarning("[SpawnZoneManager] Prefab'ta Enemy yok.");
                    continue;
                }

                // Sadece Normal / Fast olan ekstra dÃ¼ÅŸmanlarÄ± wander yap
                if (enemy.enemyType != EnemyType.Normal && enemy.enemyType != EnemyType.Fast)
                    continue;

                var driver = go.GetComponent<EnemyWanderDriver>();
                if (!driver) driver = go.AddComponent<EnemyWanderDriver>();

                // AlanÄ± baÄŸla ve waypoint'i hemen hedef yap
                driver.Setup(z.area); // â†“ aÅŸaÄŸÄ±daki kÃ¼Ã§Ã¼k metodu ekle
            }
        }
    }
}
using UnityEngine;

[RequireComponent(typeof(BoxCollider2D))]
public class WanderArea : MonoBehaviour
{
    private BoxCollider2D box;

    void Awake() { box = GetComponent<BoxCollider2D>(); }

    public Vector2 GetRandomPoint()
    {
        var center = (Vector2)transform.TransformPoint(box.offset);
        var size   = Vector2.Scale(box.size, (Vector2)transform.lossyScale);
        float rx = Random.Range(-size.x * 0.5f, size.x * 0.5f);
        float ry = Random.Range(-size.y * 0.5f, size.y * 0.5f);
        return center + new Vector2(rx, ry);
    }

#if UNITY_EDITOR
    void OnDrawGizmosSelected()
    {
        var b = GetComponent<BoxCollider2D>();
        if (!b) return;
        Gizmos.color = Color.cyan;
        var center = (Vector2)transform.TransformPoint(b.offset);
        var size   = Vector2.Scale(b.size, (Vector2)transform.lossyScale);
        Gizmos.DrawWireCube(center, size);
    }
#endif
}
using UnityEngine;
using UnityEngine.InputSystem;

public class PlayerInputRouter : MonoBehaviour, PlayerControls.IGameplayActions
{
    public static PlayerInputRouter Instance;

    private PlayerControls controls;

    [Header("Panels")]
    public GameObject inventoryPanel;
    public GameObject craftPanel;
    public GameObject tradePanel;
    public GameObject pauseMenuPanel;

   
    [Header("References")]
    public CaravanInteraction caravan; // Craft iÃ§in gerekecek
    

private bool IsPauseOpen()
{
    return pauseMenuPanel != null && pauseMenuPanel.activeSelf;
}

private void Update()
{
    // Craft aÃ§Ä±ksa ama artÄ±k menzilde deÄŸilsek â†’ kapat
    if (craftPanel != null && craftPanel.activeSelf)
    {
        if (caravan == null || !caravan.playerInRange)
        {
            craftPanel.SetActive(false);
            GameStateManager.SetPaused(false);
        }
    }
}
public void ForceCloseCraft()
{
    if (craftPanel != null && craftPanel.activeSelf)
    {
        craftPanel.SetActive(false);
        GameStateManager.SetPaused(false);
    }
}


    private void Awake()
    {
        Instance = this;
        controls = new PlayerControls();
        controls.Gameplay.SetCallbacks(this);
    }

    private void OnEnable()  => controls.Gameplay.Enable();
    private void OnDisable() => controls.Gameplay.Disable();


    // ================================
    // INVENTORY (I)
    // ================================
    public void OnInventory(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;
        if (IsPauseOpen()) return;

        TogglePanel(inventoryPanel);
    }


    // ================================
    // CRAFT (C)
    // ================================
    public void OnCraft(InputAction.CallbackContext ctx)
{
    if (!ctx.performed) return;
    if (IsPauseOpen()) return;

    // âŒ Caravan yoksa veya menzilde deÄŸilse â†’ aÃ§ma
    if (caravan == null || !caravan.playerInRange)
    {
        Debug.Log("Craft aÃ§Ä±lamadÄ± â†’ Caravan menzilinde deÄŸilsin.");
        return;
    }

    TogglePanel(craftPanel);
}


public void SetGameplayInput(bool enabled)
{
    if (enabled)
        controls.Gameplay.Enable();
    else
        controls.Gameplay.Disable();
}

    // ================================
    // TRADE (E)
    // ================================
    public void OnInteract(InputAction.CallbackContext ctx)
    {
        if (!ctx.performed) return;
        if (IsPauseOpen()) return;

        if (NPCInteraction.Instance == null) return;
        if (!NPCInteraction.Instance.PlayerIsNear()) return;

        NPCInteraction.Instance.ToggleTradePanel();
    }


    // ================================
    // ESC (PAUSE + PANEL KAPAMA)
    // ================================
 public void OnEscape(InputAction.CallbackContext ctx)
{
    if (!ctx.performed) return;
    if (GameStateManager.IsGameOver) return;

    // 1ï¸âƒ£ Pause AÃ‡IKSA â†’ sadece Pause kapansÄ±n
    if (pauseMenuPanel != null && pauseMenuPanel.activeSelf)
    {
        PauseMenu.Instance.HidePause();
        GameStateManager.SetPaused(false);
        return;
    }

    // 2ï¸âƒ£ Trade aÃ§Ä±ksa â†’ kapat
    if (tradePanel != null && tradePanel.activeSelf)
    {
        tradePanel.SetActive(false);
        GameStateManager.SetPaused(false);
        return;
    }

    // 3ï¸âƒ£ Craft aÃ§Ä±ksa â†’ kapat
    if (craftPanel != null && craftPanel.activeSelf)
    {
        craftPanel.SetActive(false);
        GameStateManager.SetPaused(false);
        return;
    }

    // 4ï¸âƒ£ Inventory aÃ§Ä±ksa â†’ kapat
    if (inventoryPanel != null && inventoryPanel.activeSelf)
    {
        inventoryPanel.SetActive(false);
        GameStateManager.SetPaused(false);
        return;
    }

    // 5ï¸âƒ£ HiÃ§bir panel aÃ§Ä±k deÄŸil â†’ Pause aÃ§
    CloseAllPanels();                 // ğŸ”’ GÃ¼venlik: baÅŸka panel kalmasÄ±n
    PauseMenu.Instance.ShowPause();
    GameStateManager.SetPaused(true);
}









    // ================================
    // PANEL HELPERS
    // ================================
    private void TogglePanel(GameObject panel)
    {
        if (panel == null) return;

        bool open = !panel.activeSelf;

        CloseAllPanels();
        panel.SetActive(open);

        // Pause logic
        if (panel == pauseMenuPanel)
        {
            Time.timeScale = open ? 0f : 1f;
        }

        
    }

    private void CloseAllPanels()
    {
        if (inventoryPanel) inventoryPanel.SetActive(false);
        if (craftPanel) craftPanel.SetActive(false);
        if (tradePanel) tradePanel.SetActive(false);

        // HUD geri gelsin
        
        // Pause kapandÄ±ysa oyun devam etsin
        if (pauseMenuPanel && pauseMenuPanel.activeSelf)
        {
            pauseMenuPanel.SetActive(false);
            Time.timeScale = 1f;
        }
    }


    // ================================
    // UNUSED INPUTS
    // ================================
    public void OnMove(InputAction.CallbackContext ctx) {}
    public void OnSprint(InputAction.CallbackContext ctx) {}
    public void OnMap(InputAction.CallbackContext ctx) {}
    public void OnReload(InputAction.CallbackContext ctx) {}
    public void OnWeapon1(InputAction.CallbackContext ctx) {}
    public void OnWeapon2(InputAction.CallbackContext ctx) {}
    public void OnWeapon3(InputAction.CallbackContext ctx) {}
    public void OnMelee(InputAction.CallbackContext ctx) {}
    public void OnADS(InputAction.CallbackContext ctx) {}
    public void OnCaravanWeapons(InputAction.CallbackContext ctx) {}
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class MapToggle : MonoBehaviour
{
    [Header("UI ReferanslarÄ±")]
    public GameObject mapPanel;
    public RectTransform mapRect;
    public RectTransform playerMarker;

    [Header("Oyuncu ve Ayarlar")]
    public Transform player;
    public float mapScale = 1f;

    private bool isMapVisible = false;
    private Vector3 mapBottomLeft;
    private PlayerControls controls; // Script kendi oluÅŸturacak

    private void Awake()
    {
        // PlayerControls Ã¶rneÄŸini oluÅŸtur
        controls = new PlayerControls();
    }

    private void OnEnable()
    {
        // Map tuÅŸuna basÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak eventâ€™leri baÄŸla
        controls.Gameplay.Map.performed += OnMapPressed;
        controls.Gameplay.Map.canceled += OnMapReleased;
        controls.Gameplay.Enable();

        if (mapPanel != null)
            mapPanel.SetActive(false);

        if (mapRect != null)
        {
            Vector3[] corners = new Vector3[4];
            mapRect.GetWorldCorners(corners);
            mapBottomLeft = corners[0];
        }
    }

    private void OnDisable()
    {
        controls.Gameplay.Map.performed -= OnMapPressed;
        controls.Gameplay.Map.canceled -= OnMapReleased;
        controls.Gameplay.Disable();
    }

    private void OnMapPressed(InputAction.CallbackContext context)
    {
        if (mapPanel == null) return;

        mapPanel.SetActive(true);
        isMapVisible = true;
        Debug.Log("ğŸ—ºï¸ Harita aÃ§Ä±ldÄ± (Tab basÄ±ldÄ±)");
    }

    private void OnMapReleased(InputAction.CallbackContext context)
    {
        if (mapPanel == null) return;

        mapPanel.SetActive(false);
        isMapVisible = false;
        Debug.Log("âŒ Harita kapandÄ± (Tab bÄ±rakÄ±ldÄ±)");
    }

    private void Update()
    {
        if (isMapVisible)
            UpdatePlayerMarker();
    }

    private void UpdatePlayerMarker()
    {
        if (player == null || playerMarker == null || mapRect == null) return;

        // 2D pozisyon hesaplama
        Vector3 worldOffset = player.position;
        Vector2 mapPos = new Vector2(worldOffset.x, worldOffset.y) * mapScale;

        Vector3[] corners = new Vector3[4];
        mapRect.GetWorldCorners(corners);
        mapBottomLeft = corners[0];

        Vector2 anchored = new Vector2(
            mapPos.x + (mapRect.rect.width / 2),
            mapPos.y + (mapRect.rect.height / 2)
        );

        playerMarker.anchoredPosition = anchored;
    }
}
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.Events;

public class CreditsAutoScroll : MonoBehaviour
{
    [Header("Refs")]
    public ScrollRect scrollRect;

    [Header("Ayarlar")]
    public float speed = 20f;      // px/sn
    public float topHold = 0.5f;   // baÅŸlamadan Ã¶nce bekleme
    public float bottomHold = 1f;  // en altta bekleme (kapanmadan Ã¶nce)

    [Header("BitiÅŸ DavranÄ±ÅŸÄ±")]
    public bool closePanelOnFinish = false;
    public GameObject panelToClose;             // credits paneli
    public UnityEvent onFinished;               // bittiÄŸinde tetiklenir

    private RectTransform contentRT;
    private RectTransform viewportRT;
    private bool running;

    void OnEnable()
    {
        if (scrollRect == null || scrollRect.content == null) return;

        // Viewport boÅŸ bÄ±rakÄ±lmÄ±ÅŸsa ilk Ã§ocuk olarak ayarla
        if (scrollRect.viewport == null)
            scrollRect.viewport = scrollRect.transform.GetChild(0).GetComponent<RectTransform>();

        contentRT  = scrollRect.content;
        viewportRT = scrollRect.viewport;

        StartCoroutine(ScrollRoutine());
    }

    System.Collections.IEnumerator ScrollRoutine()
    {
        running = true;

        // BaÅŸta en Ã¼ste getir
        scrollRect.verticalNormalizedPosition = 1f;

        // Layout otursun
        yield return new WaitForSeconds(topHold);
        yield return null; // 1 frame

        // Ä°Ã§erik gÃ¶rÃ¼nÃ¼r alandan kÄ±sa ise Ã§Ä±k
        float h = Mathf.Max(0f, contentRT.rect.height - viewportRT.rect.height);
        if (h <= 1f) { Finish(); yield break; }

        // AkÄ±ÅŸ: 1 -> 0
        while (running && contentRT != null)
        {
            // hÄ±z (px/sn) -> normalized adÄ±m
            float step = (speed * Time.unscaledDeltaTime) / h;
            scrollRect.verticalNormalizedPosition -= step;

            if (scrollRect.verticalNormalizedPosition <= 0f)
            {
                scrollRect.verticalNormalizedPosition = 0f;
                // En alta ulaÅŸtÄ±k => bekle ve bitir
                if (bottomHold > 0f) yield return new WaitForSeconds(bottomHold);
                Finish();
                yield break;
            }

            yield return null;
        }
    }

    void Finish()
    {
        running = false;
        onFinished?.Invoke();

        if (closePanelOnFinish && panelToClose != null)
            panelToClose.SetActive(false);
    }

    void OnDisable() { running = false; }
}
// CreditsBuilder.cs
using UnityEngine;
using TMPro;
using UnityEngine.UI;

public class CreditsBuilder : MonoBehaviour
{
    [System.Serializable]
    public class Section
    {
        public string title;
        [TextArea] public string[] lines;
    }

    public Transform content;           // Scroll View -> Viewport -> Content
    public TextMeshProUGUI sectionTitlePrefab;
    public TextMeshProUGUI linePrefab;

    public Section[] sections;

    void Start()
    {
        Build();
    }


    public void Build()
    {
        foreach (Transform child in content) Destroy(child.gameObject);

        foreach (var s in sections)
        {
            if (!string.IsNullOrEmpty(s.title))
            {
                var title = Instantiate(sectionTitlePrefab, content);
                title.text = $"<b>{s.title}</b>";
            }

            foreach (var line in s.lines)
            {
                var l = Instantiate(linePrefab, content);
                l.text = line;
            }

            var spacer = Instantiate(linePrefab, content);
            spacer.text = "\n";
        }

        // --- kritik: layoutâ€™Ä± hemen hesaplat ---
        LayoutRebuilder.ForceRebuildLayoutImmediate((RectTransform)content);

        // baÅŸtan baÅŸla
        ((RectTransform)content).anchoredPosition = Vector2.zero;
    }


}
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;
using System.Collections;
using TMPro;

public class LoadingScreen : MonoBehaviour
{
    public Slider progressBar;
    public float fakeLoadSpeed = 0.7f;

    public TMP_Text loadingText;
    public float interval = 0.4f;

    void Start()
    {
        StartCoroutine(LoadSceneAsync());
    }


    private void OnEnable()
    {
        StartCoroutine(AnimateText());
    }

    private void OnDisable()
    {
        StopAllCoroutines();
    }


    IEnumerator AnimateText()
    {
        string baseText = "Loading";
        int dotCount = 0;

        while (true)
        {
            dotCount = (dotCount % 3) + 1;
            loadingText.text = baseText + new string('.', dotCount);
            yield return new WaitForSeconds(interval);
        }
    }
    IEnumerator LoadSceneAsync()
    {
        string sceneToLoad = PlayerPrefs.GetString("SceneToLoad", "Bolum1");

        AsyncOperation op = SceneManager.LoadSceneAsync(sceneToLoad);
        op.allowSceneActivation = false;

        float fakeProgress = 0f;

        while (!op.isDone)
        {
            // GerÃ§ek progress (0â€“0.9 arasÄ± gelir)
            float realProgress = Mathf.Clamp01(op.progress / 0.9f);

            // Fake progress ile yumuÅŸatma
            fakeProgress = Mathf.MoveTowards(
                fakeProgress,
                realProgress,
                Time.deltaTime * fakeLoadSpeed
            );

            progressBar.value = fakeProgress;

            // YÃ¼kleme tamamlandÄ±ysa
            if (fakeProgress >= 0.99f && op.progress >= 0.9f)
            {
                progressBar.value = 1f;
                yield return new WaitForSeconds(0.3f);
                op.allowSceneActivation = true;
            }

            yield return null;
        }
    }
}
using UnityEngine;
using UnityEngine.SceneManagement;

public class MainMenu : MonoBehaviour
{
    [Header("MÃ¼zik")]
    public AudioSource musicSource;
    public AudioClip menuMusic;

    [Header("UI Panelleri")]
    public GameObject mainPanel;
    public GameObject settingsPanel;
    public GameObject creditsPanel;

    void Start()
    {
        // MenÃ¼de oyun mÃ¼ziÄŸi kalmasÄ±n
        if (MusicManager.Instance != null)
            Destroy(MusicManager.Instance.gameObject);

        Time.timeScale = 1f;

        PlayMenuMusic();

        InitContinueButton();
    }

    // ---------------- MUSIC ----------------

    void PlayMenuMusic()
    {
        if (musicSource == null || menuMusic == null)
        {
            Debug.LogError("âŒ MenÃ¼ mÃ¼ziÄŸi atanmadÄ±!");
            return;
        }

        musicSource.clip = menuMusic;
        musicSource.loop = true;

        // 1. ADIM: Mixer grubunu AudioManager'dan alÄ±p atayÄ±n
        if (AudioManager.Instance != null)
        {
            musicSource.outputAudioMixerGroup = AudioManager.Instance.musicGroup;
        }

        // 2. ADIM: AudioSource volume deÄŸerini 1 yapÄ±n. 
        // Ses seviyesini artÄ±k Mixer (desibel olarak) yÃ¶netecek.
        musicSource.volume = 1f;

        musicSource.Play();
    }

    // ---------------- BUTTONS ----------------

    void InitContinueButton()
    {
        var btn = GameObject.Find("Continue Button")
            ?.GetComponent<UnityEngine.UI.Button>();

        if (btn != null)
            btn.interactable = SaveSystem.HasSave();
    }

    public void YeniOyunaBasla()
    {
        SaveSystem.DeleteSave();
        SaveBootstrap.ShouldLoadFromSave = false;
        PlayerPrefs.SetString("SceneToLoad", "Bolum1");
        SceneManager.LoadScene("LoadingScene");
    }

    public void DevamEt()
    {
        if (!SaveSystem.HasSave()) return;

        SaveBootstrap.ShouldLoadFromSave = true;

        PlayerPrefs.SetString("SceneToLoad", "Bolum1");
        SceneManager.LoadScene("LoadingScene");
    }

    public void QuitGame()
    {
        Application.Quit();
    }

    // ---------------- PANELS ----------------

    public void OpenSettings()
    {
        OpenPanel(settingsPanel);
    }



    public void OpenCredits()
    {
        OpenPanel(creditsPanel);
    }

    public void CloseCredits()
    {
        creditsPanel.SetActive(false);
        mainPanel.SetActive(true);
    }
    public void CloseSubPanel(GameObject panel)
    {
        panel.SetActive(false);
        mainPanel.SetActive(true);
    }

    void OpenPanel(GameObject panel)
    {
        mainPanel.SetActive(false);
        panel.SetActive(true);
        Canvas.ForceUpdateCanvases();
    }
    public void CloseSettings()
    {
        settingsPanel.SetActive(false);
        mainPanel.SetActive(true);
    }

}
using UnityEngine;
public class PauseMenu : MonoBehaviour
{
    public static PauseMenu Instance { get; private set; }

    private void Awake()
    {
        if (Instance != null && Instance != this)
        {
            Destroy(gameObject);
            return;
        }

        Instance = this;
    }

    public GameObject pausePanel;
    public GameObject settingsPanel;



    public void ShowPause()
    {
        pausePanel.SetActive(true);
        settingsPanel.SetActive(false);
    }

    public void HidePause()
    {
        pausePanel.SetActive(false);
        settingsPanel.SetActive(false);
        Time.timeScale = 1f;
    }

    public void CloseSettings()
    {
        settingsPanel.SetActive(false);
        pausePanel.SetActive(true);
    }
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections;
using System.Collections.Generic;

public class SettingsMenu : MonoBehaviour
{
    [Header("Panel")]
    public GameObject panel;

    // ---------------- AUDIO ----------------
    [Header("Audio")]
    public Slider masterSlider;
    public Slider musicSlider;
    public Slider sfxSlider;

    // ---------------- VIDEO ----------------
    [Header("Video")]
    public TMP_Dropdown qualityDropdown;
    public Toggle fullscreenToggle;
    public TMP_Dropdown resolutionDropdown;

    private bool initialized = false;
    private int lastResolutionIndex = -1;

    // Sabit (retro / pixel-art uyumlu) Ã§Ã¶zÃ¼nÃ¼rlÃ¼k listesi
    private readonly Vector2Int[] resolutions =
    {
        new(320,200), new(320,240), new(400,300), new(512,384),
        new(640,400), new(640,480), new(800,600), new(1024,768),
        new(1152,864), new(1280,600), new(1280,720),
        new(1280,768), new(1280,800), new(1280,960),
        new(1280,1024), new(1360,768), new(1366,768),
        new(1400,1050), new(1440,900), new(1600,900),
        new(1680,1050), new(1920,1080)
    };

    // -------------------------------------------------
    // UNITY
    // -------------------------------------------------

    private void Awake()
    {
        RegisterListeners();
    }

    private void OnEnable()
    {
        StartCoroutine(SetupMenuDeferred());
    }

    private IEnumerator SetupMenuDeferred()
{
    yield return null;

    InitResolutionDropdown();
    InitQualityDropdown(); // ğŸ”¥ EKLENDÄ°
    LoadPrefs();
}


    // -------------------------------------------------
    // INIT
    // -------------------------------------------------

    void RegisterListeners()
    {
        if (initialized) return;
        initialized = true;

        masterSlider.onValueChanged.AddListener(v =>
        {
            AudioManager.Instance?.SetMasterVolume(v);
            PlayerPrefs.SetFloat("MasterVolume", v);
        });

        musicSlider.onValueChanged.AddListener(v =>
        {
            AudioManager.Instance?.SetMusicVolume(v);
            PlayerPrefs.SetFloat("MusicVolume", v);
        });

        sfxSlider.onValueChanged.AddListener(v =>
        {
            AudioManager.Instance?.SetSFXVolume(v);
            PlayerPrefs.SetFloat("SFXVolume", v);
        });

        qualityDropdown.onValueChanged.AddListener(SetQuality);
        fullscreenToggle.onValueChanged.AddListener(SetFullscreen);
        resolutionDropdown.onValueChanged.AddListener(SetResolution);
    }

    // -------------------------------------------------
    // LOAD PREFS
    // -------------------------------------------------

    void LoadPrefs()
    {
        masterSlider.SetValueWithoutNotify(PlayerPrefs.GetFloat("MasterVolume", 1f));
        musicSlider.SetValueWithoutNotify(PlayerPrefs.GetFloat("MusicVolume", 1f));
        sfxSlider.SetValueWithoutNotify(PlayerPrefs.GetFloat("SFXVolume", 1f));

        qualityDropdown.SetValueWithoutNotify(
            PlayerPrefs.GetInt("QualityLevel", QualitySettings.GetQualityLevel())
        );

        fullscreenToggle.SetIsOnWithoutNotify(
            PlayerPrefs.GetInt("Fullscreen", 1) == 1
        );

        // ğŸ”¥ Ã‡Ã–ZÃœNÃœRLÃœK
        int resIndex = PlayerPrefs.GetInt("ResolutionIndex", -1);
        if (resIndex >= 0 && resIndex < resolutions.Length)
        {
            resolutionDropdown.SetValueWithoutNotify(resIndex);
            ApplyResolution(resIndex); // â— MUTLAKA
        }
    }


    // -------------------------------------------------
    // RESOLUTION
    // -------------------------------------------------

    void InitResolutionDropdown()
    {
        Debug.Log("InitResolutionDropdown Ã‡AÄRILDI");

        if (resolutionDropdown == null)
        {
            Debug.LogError("âŒ resolutionDropdown NULL");
            return;
        }

        resolutionDropdown.ClearOptions();

        List<string> options = new List<string>();

        for (int i = 0; i < resolutions.Length; i++)
        {
            options.Add($"{resolutions[i].x} x {resolutions[i].y}");
        }

        resolutionDropdown.AddOptions(options);
        resolutionDropdown.RefreshShownValue();

        int savedIndex = PlayerPrefs.GetInt("ResolutionIndex", 0);
        lastResolutionIndex = savedIndex;
        resolutionDropdown.SetValueWithoutNotify(savedIndex);
    }


    void SetResolution(int index)
    {
        if (index == lastResolutionIndex) return;
        lastResolutionIndex = index;

        ApplyResolution(index);
    }

    void ApplyResolution(int index)
    {
        if (index < 0 || index >= resolutions.Length) return;

        Vector2Int r = resolutions[index];

        Screen.SetResolution(
    r.x,
    r.y,
    fullscreenToggle.isOn
        ? FullScreenMode.FullScreenWindow
        : FullScreenMode.Windowed
);

        PlayerPrefs.SetInt("ResolutionIndex", index);
        PlayerPrefs.Save();

        Debug.Log($"ğŸ“º Resolution applied: {r.x}x{r.y}");
    }

    // -------------------------------------------------
    // VIDEO
    // -------------------------------------------------

    void SetFullscreen(bool value)
    {
        Screen.fullScreenMode = value
            ? FullScreenMode.ExclusiveFullScreen
            : FullScreenMode.Windowed;

        PlayerPrefs.SetInt("Fullscreen", value ? 1 : 0);
        PlayerPrefs.Save();
    }

    void SetQuality(int index)
    {
        QualitySettings.SetQualityLevel(index);
        PlayerPrefs.SetInt("QualityLevel", index);
        PlayerPrefs.Save();
    }

    // -------------------------------------------------
    // PANEL
    // -------------------------------------------------

    public void OpenPanel()
    {
        panel.SetActive(true);
    }

    public void ClosePanel()
    {
        panel.SetActive(false);

        if (PauseMenu.Instance != null && GameStateManager.IsGamePaused)
            PauseMenu.Instance.CloseSettings();
    }

    void InitQualityDropdown()
{
    if (qualityDropdown == null)
    {
        Debug.LogError("âŒ qualityDropdown NULL");
        return;
    }

    qualityDropdown.ClearOptions();

    List<string> options = new List<string>();

    foreach (string q in QualitySettings.names)
        options.Add(q);

    qualityDropdown.AddOptions(options);

    int savedQuality = PlayerPrefs.GetInt(
        "QualityLevel",
        QualitySettings.GetQualityLevel()
    );

    qualityDropdown.SetValueWithoutNotify(savedQuality);
    qualityDropdown.RefreshShownValue();
}


}
public enum SettingsMenuOrigin
{
    None,
    PauseMenu,
    MainMenu
}
using System.Collections;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.SceneManagement;

public class MultiImageIntroController : MonoBehaviour
{
    [System.Serializable]
    public class IntroStep
    {
        public Image image;             // GÃ¶rsel
        public AudioClip soundEffect;   // O anda Ã§alacak ses
    }

    public IntroStep[] steps;             // TÃ¼m adÄ±mlar
    public float fadeDuration = 1f;
    public float displayTime = 2f;
    public string nextSceneName = "MainMenu";

    public AudioSource audioSource;      // Ses oynatÄ±cÄ±

    private void Start()
    {
        StartCoroutine(PlayIntroSequence());
    }

    private IEnumerator PlayIntroSequence()
    {
        // BaÅŸta tÃ¼m gÃ¶rselleri kapat
        foreach (var step in steps)
        {
            step.image.gameObject.SetActive(false);
            SetAlpha(step.image, 0f);
        }

        foreach (var step in steps)
        {
            step.image.gameObject.SetActive(true);

            if (step.soundEffect != null && audioSource != null)
            {
                yield return new WaitForSeconds(1f); // 1 saniye bekle
                audioSource.clip = step.soundEffect;
                audioSource.Play();
            }


            yield return StartCoroutine(FadeImage(step.image, 0f, 1f));
            yield return new WaitForSeconds(displayTime);
            yield return StartCoroutine(FadeImage(step.image, 1f, 0f));

            step.image.gameObject.SetActive(false);
        }

        SceneManager.LoadScene(nextSceneName);
    }

    private IEnumerator FadeImage(Image img, float startAlpha, float endAlpha)
    {
        Color color = img.color;
        float elapsed = 0f;

        while (elapsed < fadeDuration)
        {
            float t = elapsed / fadeDuration;
            color.a = Mathf.Lerp(startAlpha, endAlpha, t);
            img.color = color;
            elapsed += Time.deltaTime;
            yield return null;
        }

        color.a = endAlpha;
        img.color = color;
    }

    private void SetAlpha(Image img, float alpha)
    {
        Color color = img.color;
        color.a = alpha;
        img.color = color;
    }
}
using UnityEngine;
using UnityEngine.UI;
using System.Collections.Generic;
using System.Linq;
using UnityEngine.EventSystems;

public class NPCInteraction : MonoBehaviour
{
    private readonly List<TradeOfferButton> spawned = new List<TradeOfferButton>();
    private bool layoutDone = false;

    [Header("Trade Data")]
    public List<TradeOffer> tradeOffers;

    [Header("Layout Settings (code-driven)")]
    public float rowSpacing = 8f;
    public float innerSpacing = 12f;

    [Header("Layout (manual)")]
    public float topPadding = 10f;
    public float bottomPadding = 10f;

    [Header("UI Refs")]
    public GameObject tradeUIPanel;
    public GameObject interactPromptUI;
    public Transform tradeOffersContainer;
    public GameObject tradeOfferButtonPrefab;
    public ScrollRect tradeScrollRect;

    private bool inertiaDefault = true;
    private bool isPlayerNearby = false;
    private PlayerStats playerStats;

    public static NPCInteraction Instance { get; private set; }


    private void Awake()
    {
        Instance = this;
    }

    private void Start()
    {
        playerStats = FindObjectOfType<PlayerStats>();

        if (tradeUIPanel != null) tradeUIPanel.SetActive(false);
        if (interactPromptUI != null) interactPromptUI.SetActive(false);

        // (optional) load offers
        var loaded = Resources.LoadAll<TradeOffer>("Animals");
        if (loaded.Length > 0)
        {
            var set = new HashSet<TradeOffer>(tradeOffers);
            foreach (var t in loaded) if (!set.Contains(t)) tradeOffers.Add(t);
        }
    }

    // --------------------------------------------------------------------
    // PANEL AÃ‡ILMADAN Ã–NCE TEKLÄ°FLERÄ° DOLDURAN HAZIRLIK METODU
    // --------------------------------------------------------------------
    public void PrepareTradeUI()
    {
        PopulateTradeOffers();
        Canvas.ForceUpdateCanvases();

        if (tradeScrollRect != null)
        {
            tradeScrollRect.verticalNormalizedPosition = 1f;
            tradeScrollRect.StopMovement();
            tradeScrollRect.velocity = Vector2.zero;
        }

        EventSystem.current?.SetSelectedGameObject(null);
    }

    // --------------------------------------------------------------------
    // PLAYERINPUTROUTER TARAFINDAN Ã‡AÄRILAN PANEL AÃ‡/KAPA METODU
    // --------------------------------------------------------------------
    public void ToggleTradePanel()
    {
        bool next = !tradeUIPanel.activeSelf;

        if (next)   // aÃ§Ä±lÄ±yorsa
        {
            PrepareTradeUI();
        }

        tradeUIPanel.SetActive(next);

        if (interactPromptUI != null)
            interactPromptUI.SetActive(!next);   // panel aÃ§Ä±ldÄ±ÄŸÄ±nda prompt gizlensin
    }

    // --------------------------------------------------------------------
    // TRADE TEKLÄ°FLERÄ°NÄ° YERLEÅTÄ°REN ESKÄ° METOD (DEÄÄ°ÅMEDÄ°)
    // --------------------------------------------------------------------
    private void PopulateTradeOffers()
    {
        float prevScroll = tradeScrollRect ? tradeScrollRect.verticalNormalizedPosition : 1f;

        if (!layoutDone)
        {
            for (int i = tradeOffersContainer.childCount - 1; i >= 0; i--)
                Destroy(tradeOffersContainer.GetChild(i).gameObject);

            float y = -topPadding;

            foreach (var offer in tradeOffers)
            {
                var go = Instantiate(tradeOfferButtonPrefab, tradeOffersContainer);
                var btn = go.GetComponent<TradeOfferButton>();

                var rt = (RectTransform)go.transform;
                rt.anchorMin = new Vector2(0f, 1f);
                rt.anchorMax = new Vector2(0f, 1f);
                rt.pivot = new Vector2(0f, 1f);

                float h = Mathf.Max(rt.sizeDelta.y, LayoutUtility.GetPreferredHeight(rt));
                rt.anchoredPosition = new Vector2(0f, y);
                y -= (h + rowSpacing);

                spawned.Add(btn);
            }

            var contentRT = (RectTransform)tradeOffersContainer;
            float needed = -y - rowSpacing + bottomPadding;
            if (needed < 0f) needed = 0f;
            var sz = contentRT.sizeDelta;
            contentRT.sizeDelta = new Vector2(sz.x, needed);

            layoutDone = true;
        }

        for (int i = 0; i < spawned.Count && i < tradeOffers.Count; i++)
            spawned[i].Setup(tradeOffers[i]);

        Canvas.ForceUpdateCanvases();

        if (tradeScrollRect)
        {
            tradeScrollRect.StopMovement();
            tradeScrollRect.velocity = Vector2.zero;
            tradeScrollRect.verticalNormalizedPosition = prevScroll;
        }

        EventSystem.current?.SetSelectedGameObject(null);
    }

    // --------------------------------------------------------------------
    // TRADE EXECUTION â€” OLDUKÃ‡A DOÄRU, HÄ°Ã‡ DOKUNMADIM
    // --------------------------------------------------------------------
    private bool HasEnoughResources(TradeOffer offer)
    {
        if (playerStats == null || offer == null) return false;

        if (offer.requiredStone > 0 && !Inventory.Instance.HasEnough(offer.stoneSO, offer.requiredStone)) return false;
        if (offer.requiredWood > 0 && !Inventory.Instance.HasEnough(offer.woodSO, offer.requiredWood)) return false;
        if (offer.requiredScrapMetal > 0 && !Inventory.Instance.HasEnough(offer.scrapSO, offer.requiredScrapMetal)) return false;
        if (offer.requiredMeat > 0 && !Inventory.Instance.HasEnough(offer.meatSO, offer.requiredMeat)) return false;
        if (offer.requiredDeerHide > 0 && !Inventory.Instance.HasEnough(offer.deerHideSO, offer.requiredDeerHide)) return false;
        if (offer.requiredRabbitHide > 0 && !Inventory.Instance.HasEnough(offer.rabbitHideSO, offer.requiredRabbitHide)) return false;
        if (offer.requiredHerb > 0 && !Inventory.Instance.HasEnough(offer.herbSO, offer.requiredHerb)) return false;
        if (offer.requiredAmmo > 0 && !Inventory.Instance.HasEnough(offer.ammoSO, offer.requiredAmmo)) return false;

        return true;
    }

    private void DeductResources(TradeOffer offer)
    {
        if (offer.requiredStone > 0) Inventory.Instance.TryConsume(offer.stoneSO, offer.requiredStone);
        if (offer.requiredWood > 0) Inventory.Instance.TryConsume(offer.woodSO, offer.requiredWood);
        if (offer.requiredScrapMetal > 0) Inventory.Instance.TryConsume(offer.scrapSO, offer.requiredScrapMetal);
        if (offer.requiredMeat > 0) Inventory.Instance.TryConsume(offer.meatSO, offer.requiredMeat);
        if (offer.requiredDeerHide > 0) Inventory.Instance.TryConsume(offer.deerHideSO, offer.requiredDeerHide);
        if (offer.requiredRabbitHide > 0) Inventory.Instance.TryConsume(offer.rabbitHideSO, offer.requiredRabbitHide);
        if (offer.requiredHerb > 0) Inventory.Instance.TryConsume(offer.herbSO, offer.requiredHerb);
        if (offer.requiredAmmo > 0) Inventory.Instance.TryConsume(offer.ammoSO, offer.requiredAmmo);
    }

    public void ExecuteTrade(TradeOffer offer)
    {
        if (!HasEnoughResources(offer))
        {
            Debug.Log("Yetersiz materyal!");
            return;
        }

        DeductResources(offer);

        if (offer.rewardKind == RewardKind.Resource)
        {
            if (offer.rewardItemSO != null && offer.rewardAmount > 0)
                Inventory.Instance.TryAdd(offer.rewardItemSO, offer.rewardAmount);
        }
        else if (offer.rewardKind == RewardKind.WeaponPart)
        {
            if (offer.partToGive != null && offer.amountToGive > 0)
                Inventory.Instance.TryAdd(offer.partToGive, offer.amountToGive);
        }

        PopulateTradeOffers();
    }

    // --------------------------------------------------------------------
    // PLAYER NEAR â€” ORÄ°JÄ°NAL
    // --------------------------------------------------------------------
    private void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;

        isPlayerNearby = true;

        if (interactPromptUI != null)
            interactPromptUI.SetActive(true);
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;

        isPlayerNearby = false;

        if (interactPromptUI != null)
            interactPromptUI.SetActive(false);

        // Panel aÃ§Ä±ksa kapatmak istersen:
        // tradeUIPanel.SetActive(false);
    }

    public bool PlayerIsNear() => isPlayerNearby;
}
using UnityEngine;

public enum RewardKind
{
    WeaponPart,
    Resource
}

[CreateAssetMenu(fileName = "New Trade Offer", menuName = "NPC/Trade Offer")]
public class TradeOffer : ScriptableObject
{
    [Header("Player Gives (Costs)")]
    public ItemData stoneSO;
    public int requiredStone = 0;

    public ItemData woodSO;
    public int requiredWood = 0;

    public ItemData scrapSO;
    public int requiredScrapMetal = 0;

    public ItemData ammoSO;
    public int requiredAmmo = 0;

    public ItemData meatSO;
    public int requiredMeat = 0;

    public ItemData deerHideSO;
    public int requiredDeerHide = 0;

    public ItemData rabbitHideSO;
    public int requiredRabbitHide = 0;

    public ItemData herbSO;
    public int requiredHerb = 0;

    [Header("Player Gets (Rewards)")]
    public RewardKind rewardKind = RewardKind.Resource;

    // âœ” WeaponPart Ã¶dÃ¼lÃ¼ iÃ§in (Yeni sistem)
    public WeaponPartItemData partToGive;
    public int amountToGive = 1;

    // Resource Ã¶dÃ¼lÃ¼ iÃ§in
    public ItemData rewardItemSO;
    public int rewardAmount = 0;
}
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;

public class TradeOfferButton : MonoBehaviour
{
    [Header("UI Prefabs")]
    [SerializeField] private GameObject offerTextPrefab;
    [SerializeField] private Button tradeButton;
    [SerializeField] private Image iconImage;

    [Header("Layout")]
    [SerializeField] private float gap = 10f;
    [SerializeField] private float textPosX = 490f;
    [SerializeField] private float textWidth = 1000f;
    [SerializeField] private float textHeight = 100f;

    [Header("Sprites (Optional)")]
    public Sprite fallbackSprite;

    private Dictionary<WeaponPartItemData, Sprite> partMap = new();
    private TradeOffer currentOffer;
    private NPCInteraction npc;

    [SerializeField] private TextMeshProUGUI offerTextSlot;
    private TextMeshProUGUI offerTextInstance;

    void Awake()
    {
        

        EnsureOfferText();
    }

    void OnEnable()
{
    EnsureOfferText();
    ForceRebuild();
}

private void ForceRebuild()
{
    Canvas.ForceUpdateCanvases();

    var rt = GetComponent<RectTransform>();
    if (rt)
        LayoutRebuilder.ForceRebuildLayoutImmediate(rt);
}


    private void EnsureOfferText()
    {
        if (offerTextInstance != null) return;

        if (offerTextSlot != null)
            offerTextInstance = offerTextSlot;
        else if (offerTextPrefab != null)
            offerTextInstance = Instantiate(offerTextPrefab, transform).GetComponent<TextMeshProUGUI>();
        else
            Debug.LogError("[TradeOfferButton] No text source assigned!");

        PositionAndSizeText();
    }

    public void Setup(TradeOffer offer)
    {
        currentOffer = offer;
        npc = NPCInteraction.Instance;

        if (!tradeButton || currentOffer == null)
            return;

        EnsureOfferText();
        ApplyIconForOffer(offer);

        string cost = BuildCostText(offer);

        string reward = offer.rewardKind == RewardKind.WeaponPart
            ? $"Verilen: {offer.amountToGive} x {offer.partToGive?.itemName}"
            : $"Verilen: {offer.rewardAmount} x {offer.rewardItemSO?.itemName}";

        offerTextInstance.text = $"{cost}\n{reward}";

        tradeButton.interactable = CanAfford(offer);
        tradeButton.onClick.RemoveAllListeners();
        tradeButton.onClick.AddListener(OnTradeClicked);
    }

    private bool CanAfford(TradeOffer o)
    {
        return
            Inventory.Instance.GetTotalCount(o.stoneSO) >= o.requiredStone &&
            Inventory.Instance.GetTotalCount(o.woodSO) >= o.requiredWood &&
            Inventory.Instance.GetTotalCount(o.scrapSO) >= o.requiredScrapMetal &&
            Inventory.Instance.GetTotalCount(o.meatSO) >= o.requiredMeat &&
            Inventory.Instance.GetTotalCount(o.deerHideSO) >= o.requiredDeerHide &&
            Inventory.Instance.GetTotalCount(o.rabbitHideSO) >= o.requiredRabbitHide &&
            Inventory.Instance.GetTotalCount(o.herbSO) >= o.requiredHerb &&
            Inventory.Instance.GetTotalCount(o.ammoSO) >= o.requiredAmmo;
    }

    private string BuildCostText(TradeOffer o)
    {
        List<string> parts = new();

        if (o.requiredWood > 0) parts.Add($"{o.requiredWood} Odun");
        if (o.requiredStone > 0) parts.Add($"{o.requiredStone} TaÅŸ");
        if (o.requiredScrapMetal > 0) parts.Add($"{o.requiredScrapMetal} Metal");
        if (o.requiredMeat > 0) parts.Add($"{o.requiredMeat} Et");
        if (o.requiredDeerHide > 0) parts.Add($"{o.requiredDeerHide} Geyik Derisi");
        if (o.requiredRabbitHide > 0) parts.Add($"{o.requiredRabbitHide} TavÅŸan Derisi");
        if (o.requiredHerb > 0) parts.Add($"{o.requiredHerb} Ot");
        if (o.requiredAmmo > 0) parts.Add($"{o.requiredAmmo} Mermi");

        return "Ä°stenen: " + string.Join(", ", parts);
    }

    private void PositionAndSizeText()
    {
        var rt = offerTextInstance.rectTransform;

        rt.anchorMin = new Vector2(0f, 0.5f);
        rt.anchorMax = new Vector2(0f, 0.5f);
        rt.pivot = new Vector2(0f, 0.5f);

        rt.anchoredPosition = new Vector2(textPosX, 0f);

        rt.SetSizeWithCurrentAnchors(RectTransform.Axis.Horizontal, textWidth);
        rt.SetSizeWithCurrentAnchors(RectTransform.Axis.Vertical, textHeight);

        var le = offerTextInstance.GetComponent<LayoutElement>();
        if (!le) le = offerTextInstance.gameObject.AddComponent<LayoutElement>();
        le.ignoreLayout = false;
    }

    private void ApplyIconForOffer(TradeOffer offer)
{
    if (!iconImage) return;

    Sprite s = null;

    if (offer.rewardKind == RewardKind.WeaponPart)
        s = offer.partToGive?.icon;
    else if (offer.rewardKind == RewardKind.Resource)
        s = offer.rewardItemSO?.icon;

    iconImage.sprite = s ? s : fallbackSprite;
    iconImage.enabled = iconImage.sprite != null;
}


    private void OnTradeClicked()
    {
        if (npc == null || currentOffer == null) return;

        npc.ExecuteTrade(currentOffer);
    }
}
using UnityEngine;

[DisallowMultipleComponent]
[RequireComponent(typeof(AudioSource))]
public class PlayerFootsteps : MonoBehaviour
{
    [Header("Footstep Clip (Loop)")]
    public AudioClip footstepLoop;

    [Header("Movement")]
    public float minMovementSpeed = 0.005f;

    [Header("Sound")]
    public float volume = 0.9f;
    public float minPitch = 0.95f;
    public float maxPitch = 1.05f;

    private AudioSource src;
    private Vector3 lastPosition;
    private bool isMoving = false;

    void Awake()
    {
        src = GetComponent<AudioSource>();

        src.playOnAwake = false;
        src.loop = true;          // ğŸ”´ EN Ã–NEMLÄ°
        src.spatialBlend = 0f;    // 2D
        src.volume = volume;

        lastPosition = transform.position;
    }

    void Update()
    {
        Vector3 currentPos = transform.position;
        float distance = (currentPos - lastPosition).magnitude;
        float speed = distance / Mathf.Max(Time.deltaTime, 0.0001f);
        lastPosition = currentPos;

        bool movingNow = speed >= minMovementSpeed;

        // Hareket BAÅLADI
        if (movingNow && !isMoving)
        {
            StartFootsteps();
        }
        // Hareket BÄ°TTÄ°
        else if (!movingNow && isMoving)
        {
            StopFootsteps();
        }

        isMoving = movingNow;
    }

    void StartFootsteps()
    {
        if (footstepLoop == null) return;

        src.clip = footstepLoop;
        src.pitch = Random.Range(minPitch, maxPitch);
        src.volume = volume;

        src.Play();
    }

    void StopFootsteps()
    {
        src.Stop();
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using System.Collections.Generic;

public class PlayerCollector : MonoBehaviour
{
    public float collectRange = 1.5f;
    private List<Collectible> highlighted = new List<Collectible>();

    void Update()
    {
        // eski vurgularÄ± kapat
        foreach (var c in highlighted)
            if (c) c.Highlight(false);
        highlighted.Clear();

        // yenileri bul
        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, collectRange);
        foreach (var hit in hits)
        {
            var c = hit.GetComponent<Collectible>();
            if (c != null)
            {
                c.Highlight(true);
                highlighted.Add(c);
            }
        }

        // E ile toplama
        if (Keyboard.current != null && Keyboard.current.eKey.wasPressedThisFrame)
        {
            foreach (var c in highlighted)
            {
                if (c != null)
                {
                    c.Collect();
                    break;
                }
            }
        }
    }
}
using UnityEngine;
using UnityEngine.UI;

public class PlayerHealthUI : MonoBehaviour
{
    public Image fillImage;
    public PlayerStats playerStats;

    void Start()
    {
        if (playerStats != null)
        {
            playerStats.onHealthChanged += UpdateHealthBar;
        }
    }

    void OnDestroy()
    {
        if (playerStats != null)
        {
            playerStats.onHealthChanged -= UpdateHealthBar;
        }
    }

    void UpdateHealthBar(int current, int max)
    {
        fillImage.fillAmount = Mathf.Clamp01((float)current / max);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class PlayerMovement : MonoBehaviour
{
    [Header("Movement")]
    public float moveSpeed = 5f;
    public float sprintMultiplier = 1.7f; // KoÃ…Å¸arken hÃ„Â±z artÃ„Â±Ã…Å¸Ã„Â±
    private bool isSprinting = false;
    private PlayerWeapon weapon;


    // --- BileÃ…Å¸en ReferanslarÃ„Â± ---
    private Rigidbody2D rb;
    private PlayerStats stats;
    private Animator animator;
    private Camera mainCamera;

    // --- Input System ---
    private PlayerControls controls;
    private Vector2 moveInput;

    // --- Ek Ãƒâ€“zellikler ---
    public static float FacingDirection { get; private set; } = 1f;
    public float soundRadius = 5f;

    private void Awake()
    {
        weapon = GetComponent<PlayerWeapon>();
        rb = GetComponent<Rigidbody2D>();
        animator = GetComponent<Animator>();
        controls = new PlayerControls();
        stats = GetComponent<PlayerStats>();
        mainCamera = Camera.main;
    }

    private void OnEnable()
    {
        controls.Gameplay.Move.performed += OnMovePerformed;
        controls.Gameplay.Move.canceled += OnMoveCanceled;
        controls.Gameplay.Sprint.performed += ctx =>
{
    if (weapon != null && weapon.IsBusy)
        return;

    isSprinting = true;
};

        controls.Gameplay.Sprint.canceled += ctx =>
        {
            isSprinting = false;
        };
        controls.Gameplay.Enable();
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

    private void OnMovePerformed(InputAction.CallbackContext context)
    {
        moveInput = context.ReadValue<Vector2>();
    }

    private void OnMoveCanceled(InputAction.CallbackContext context)
    {
        moveInput = Vector2.zero;
    }

    public void EmitFootstep()
    {
        SoundEmitter.EmitSound(transform.position, soundRadius);
    }

    private void FixedUpdate()
    {
        if (weapon != null && weapon.IsBusy)
        {
            isSprinting = false;
        }

        float currentSpeed = moveSpeed;
        bool isMoving = moveInput.magnitude > 0.1f;

        // PlayerStats'a koÃ…Å¸u/yÃƒÂ¼rÃƒÂ¼me bilgisini HER FRAME gÃƒÂ¶nder
        stats.SetMovementState(isMoving, isSprinting);

        if (isSprinting && stats.HasStamina() && isMoving)
            currentSpeed *= sprintMultiplier;
        else
            isSprinting = false;

        Vector2 moveDelta = moveInput * currentSpeed * Time.fixedDeltaTime;
        rb.MovePosition(rb.position + moveDelta);
    }


    void Update()
    {
        if (GameStateManager.IsGamePaused) return;

        UpdateRotationAndAnimation();

    }



    // --- 360Ã‚Â° Fareye DÃƒÂ¶nÃƒÂ¼k Animasyon ve Rotasyon ---
    private void UpdateRotationAndAnimation()
    {
        if (animator == null || mainCamera == null) return;

        // ÄŸÅ¸Â§Â­ Fare konumunu al ve yÃƒÂ¶nÃƒÂ¼ hesapla
        Vector2 mouseScreenPos = Mouse.current.position.ReadValue();
        Vector3 mouseWorldPos = mainCamera.ScreenToWorldPoint(mouseScreenPos);
        Vector2 aimDirection = (mouseWorldPos - transform.position).normalized;

        // ÄŸÅ¸Å’â‚¬ Karakteri fareye ÃƒÂ§evir (360Ã‚Â°)
        float angle = Mathf.Atan2(aimDirection.y, aimDirection.x) * Mathf.Rad2Deg;
        transform.rotation = Quaternion.Euler(0f, 0f, angle - 90f); // Sprite yukarÃ„Â± bakÃ„Â±yorsa -90f uygundur

        // ÄŸÅ¸ÂÂ Animasyon durumu
        bool isMoving = moveInput.magnitude > 0.1f;
        animator.SetBool("IsMoving", isMoving);

        // ÄŸÅ¸â€Â FacingDirection flip kontrolÃƒÂ¼ (silah veya atÃ„Â±Ã…Å¸ yÃƒÂ¶nÃƒÂ¼ iÃƒÂ§in)
        FacingDirection = aimDirection.x >= 0 ? 1f : -1f;
    }
}
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.InputSystem;
using TMPro;
using UnityEngine.UI;

public class PlayerStats : MonoBehaviour
{
    // ------------------------------
    //   STAMINA (AÃ§lÄ±ÄŸa BaÄŸlÄ±)
    // ------------------------------
    [Header("Stamina AyarlarÄ±")]
    public float maxStamina = 100f;            // ARTIK: maxHunger ile eÅŸitlenecek
    [SerializeField] private float currentStamina;
    public float staminaDrainRate = 15f;       // koÅŸarken azalÄ±r
    public float staminaRegenIdle = 18f;       // dururken artar

    private bool isRunning = false;            // Movement scriptinden baÄŸlanacak (setter fonk ekledim)
    private bool isMoving = false;

    public float GetStamina() => currentStamina;
    public float GetMaxStamina() => maxStamina;

    public void ModifyStamina(float amount)
    {
        currentStamina = Mathf.Clamp(currentStamina + amount, 0, maxStamina);
        UpdateStaminaUI();
    }

    public void ResetStamina() => currentStamina = maxStamina;
    public bool HasStamina() => currentStamina > 0;

    [Header("AÃ§lÄ±k KoÅŸu Ã‡arpanÄ±")]
    public float runningHungerMultiplier = 1.5f; // koÅŸarken aÃ§lÄ±k 2 hÄ±zlÄ± azalÄ±r
    [Header("Stamina UI")]
    public Slider staminaSlider;




    // ------------------------------
    //            SAÄLIK
    // ------------------------------
    [Header("SaÄŸlÄ±k")]
    public int maxHealth = 100;
    public int currentHealth;
    public float damageCooldown = 0.5f;
    private float lastDamageTime = -999f;

    public delegate void OnDeath();
    public event OnDeath onDeath;

    [Header("UI")]
    [SerializeField] private PlayerHealthUI healthUI;
    public delegate void OnHealthChanged(int current, int max);
    public event OnHealthChanged onHealthChanged;

    [Header("Blood Vignette")]
    [SerializeField] private BloodVignetteUI bloodVignetteUI;


    // ------------------------------
    //     HAREKET / ENVANTER
    // ------------------------------
    [Header("Hareket/Envanter")]
    public float moveSpeed = 5f;


    // ------------------------------
    //            AÃ‡LIK
    // ------------------------------
    [Header("AÃ§lÄ±k")]
    public int maxHunger = 100;
    public int currentHunger;
    public float hungerDecreaseInterval = 5f;
    public int hungerDecreaseAmount = 1;
    private float hungerTimer;

    [Header("AÃ§lÄ±k UI")]
    public TextMeshProUGUI hungerText;

    public int hungerOnRawMeatUse = 10;
    public int hungerOnCookedMeatUse = 30;
    public int hungerOnHerbUse = 0;


    // ------------------------------
    //   AÃ‡LIK â†’ SAÄLIK/YORGUNLUK
    // ------------------------------
    [Header("AÃ§lÄ±k BazlÄ± SaÄŸlÄ±k Sistemi")]
    public float highHungerThresholdPercent = 0.70f;   // %70 Ã¼stÃ¼ can yeniler
    public float lowHungerThresholdPercent = 0.10f;    // %10 altÄ± can dÃ¼ÅŸer

    public float healthRegenRate = 1f;         // saniyede +1
    public float healthRegenInterval = 1f;
    private float healthRegenTimer;

    private float starvationTickInterval = 1.5f;   // aÃ§lÄ±k bitince can azalmasÄ±
    private float starvationTimer;



    // ------------------------------
    //        SES
    // ------------------------------
    [Header("Ses")]
    public AudioClip hurtClip;
    private AudioSource audioSource;


    // ------------------------------
    // ITEM REFERANSLARI
    // ------------------------------
    [Header("Item References")]
    public ItemData cookedMeatSO;
    public ItemData rawMeatSO;
    public ItemData herbSO;
    public float staminaRegenWalk = 8f;



    void Awake()
    {
        audioSource = GetComponent<AudioSource>();
        if (audioSource == null)
            audioSource = gameObject.AddComponent<AudioSource>();

        AudioManager.Instance?.RouteToSFX(audioSource);
    }

    void Start()
    {
        currentHunger = maxHunger;
        hungerTimer = hungerDecreaseInterval;

        currentStamina = maxHunger;      // baÅŸlangÄ±Ã§ta max stamina = aÃ§lÄ±k
        maxStamina = maxHunger;

        currentHealth = maxHealth;
        onHealthChanged?.Invoke(currentHealth, maxHealth);
        onHealthChanged += UpdateBloodVignette;
        UpdateBloodVignette(currentHealth, maxHealth);

        if (staminaSlider != null)
        {
            staminaSlider.maxValue = maxStamina;
            staminaSlider.value = currentStamina;
        }

    }

    void Update()
    {
        HandleHungerSystem();
        UpdateStaminaByHunger();
        UpdateStaminaRegen();
        UpdateHealthByHunger();


        if (Keyboard.current != null && Keyboard.current.fKey.wasPressedThisFrame)
            TryConsumeFood();

        UpdateHungerUI();
        UpdateStaminaUI();

    }

    private void UpdateStaminaUI()
    {
        if (staminaSlider == null) return;

        // Full ise gizle
        if (currentStamina >= maxStamina)
        {
            staminaSlider.gameObject.SetActive(false);
        }
        else
        {
            staminaSlider.gameObject.SetActive(true);
            staminaSlider.maxValue = maxStamina;
            staminaSlider.value = currentStamina;
        }
    }




    // ============================================================
    //                 HUNGER SYSTEM
    // ============================================================

    void HandleHungerSystem()
    {
        float interval = hungerDecreaseInterval;

        // KoÅŸuyorsa aÃ§lÄ±k daha hÄ±zlÄ± azalÄ±r
        if (isRunning)
            interval /= runningHungerMultiplier;

        hungerTimer -= Time.deltaTime;

        if (hungerTimer <= 0f)
        {
            currentHunger = Mathf.Max(0, currentHunger - hungerDecreaseAmount);
            hungerTimer = interval;
        }
    }




    // ============================================================
    //     MAX STAMINA = CURRENT HUNGER  (PEAK SISTEMI)
    // ============================================================

    void UpdateStaminaByHunger()
    {
        maxStamina = currentHunger;

        // currentStamina fazla kaldÄ±ysa otomatik dÃ¼ÅŸÃ¼r
        if (currentStamina > maxStamina)
            currentStamina = maxStamina;
    }



    // ============================================================
    //       STAMINA REGEN RATE = HUNGER LEVEL
    // ============================================================

    void UpdateStaminaRegen()
    {
        float hungerPercent = (float)currentHunger / maxHunger;

        // AÃ§lÄ±k â†’ regen katsayÄ±sÄ±
        float hungerMult;
        if (hungerPercent >= 0.70f)
            hungerMult = 1.5f;   // tok â†’ hÄ±zlÄ± regen
        else if (hungerPercent >= 0.40f)
            hungerMult = 1f;     // normal
        else if (hungerPercent >= 0.20f)
            hungerMult = 0.5f;   // yorgun
        else
            hungerMult = 0.2f;   // bitkin

        // KOÅARKEN â†’ sadece STAMINA AZALIR
        if (isRunning && isMoving)
        {
            ModifyStamina(-staminaDrainRate * Time.deltaTime);
            return;
        }

        // YÃœRÃœRKEN â†’ az regen
        if (isMoving)
        {
            float regen = staminaRegenWalk * hungerMult;
            ModifyStamina(regen * Time.deltaTime);
        }
        // HÄ°Ã‡ HAREKET ETMEZKEN â†’ daha fazla regen
        else
        {
            float regen = staminaRegenIdle * hungerMult;
            ModifyStamina(regen * Time.deltaTime);
        }
    }




    // ============================================================
    //       HEALTH = HUNGER STATE
    // ============================================================

    void UpdateHealthByHunger()
    {
        if (currentHealth <= 0) return;

        float hungerPercent = (float)currentHunger / maxHunger;

        // Tok â†’ Can yenilenir
        if (hungerPercent >= highHungerThresholdPercent)
        {
            healthRegenTimer += Time.deltaTime;

            if (healthRegenTimer >= healthRegenInterval && currentHealth < maxHealth)
            {
                Heal(Mathf.RoundToInt(healthRegenRate));
                healthRegenTimer = 0f;
            }

            return;
        }


        // Ã‡ok aÃ§ â†’ Can dÃ¼ÅŸer
        if (hungerPercent <= lowHungerThresholdPercent)
        {
            starvationTimer += Time.deltaTime;

            if (starvationTimer >= starvationTickInterval)
            {
                TakeDamage(1);
                starvationTimer = 0f;
            }
        }
        else
        {
            starvationTimer = 0f; // gÃ¼venli reset
        }
    }




    // ============================================================
    //                   FOOD CONSUME
    // ============================================================

    private void TryConsumeFood()
    {
        if (Inventory.Instance.HasEnough(cookedMeatSO, 1))
        {
            Inventory.Instance.TryConsume(cookedMeatSO, 1);
            GainHunger(hungerOnCookedMeatUse);
            return;
        }

        if (Inventory.Instance.HasEnough(rawMeatSO, 1))
        {
            Inventory.Instance.TryConsume(rawMeatSO, 1);
            GainHunger(hungerOnRawMeatUse);
            return;
        }

        if (Inventory.Instance.HasEnough(herbSO, 1))
        {
            Inventory.Instance.TryConsume(herbSO, 1);
            GainHunger(hungerOnHerbUse);
            return;
        }
    }

    private void GainHunger(int amount)
    {
        if (amount > 0)
            currentHunger = Mathf.Clamp(currentHunger + amount, 0, maxHunger);
    }



    // ============================================================
    //                      UI UPDATE
    // ============================================================

    void UpdateHungerUI()
    {
        if (hungerText == null) return;

        hungerText.text = $"AÃ§lÄ±k: {currentHunger}/{maxHunger}";

        if (currentHunger > 60) hungerText.color = Color.green;
        else if (currentHunger > 30) hungerText.color = Color.yellow;
        else hungerText.color = Color.red;
    }


    // ============================================================
    //          SAÄLIK FONKSÄ°YONLARI
    // ============================================================

    public bool IsAlive() => currentHealth > 0;

    public void TakeDamage(int amount)
{
    if (!IsAlive()) return;
    if (Time.time - lastDamageTime < damageCooldown) return;

    lastDamageTime = Time.time;
    currentHealth = Mathf.Max(0, currentHealth - amount);

    onHealthChanged?.Invoke(currentHealth, maxHealth);

    // ğŸ”´ KAN FLASH
    bloodVignetteUI?.OnDamageFlash();

    if (hurtClip != null)
        audioSource?.PlayOneShot(hurtClip);

    if (currentHealth <= 0)
        Die();

    DamagePopupManager.Instance?.SpawnPopup(transform.position, amount);
}


    public void Heal(int amount)
    {
        if (!IsAlive() || amount <= 0) return;
        currentHealth = Mathf.Min(maxHealth, currentHealth + amount);
        onHealthChanged?.Invoke(currentHealth, maxHealth);
    }

    private void Die()
    {
        Debug.Log("ğŸ’€ Player died");
        onDeath?.Invoke();
    }

    void OnDestroy()
{
    onHealthChanged -= UpdateBloodVignette;
}

    // ============================================================
    //      DÄ±ÅŸ Scriptlerden Hareket Bilgisi Alma
    // ============================================================

    public void SetMovementState(bool moving, bool running)
    {
        isMoving = moving;
        isRunning = running;
    }


    public void RefreshHealthUI()
    {
        onHealthChanged?.Invoke(currentHealth, maxHealth);
    }

    private void UpdateBloodVignette(int current, int max)
{
    if (bloodVignetteUI == null) return;

    bloodVignetteUI.health01 = (float)current / max;
}



}
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.Rendering.Universal;
using System.Linq;

[RequireComponent(typeof(AudioSource))]
public class PlayerWeapon : MonoBehaviour
{
    // References
    private GameObject currentModel;
    private AudioSource audioSource;
    private Animator animator;

    private WeaponSlotManager slotManager;

    [Header("Weapon Configuration")]
    public WeaponDefinition weaponData;

    [Header("Components")]
    public Transform firePoint;
    public LayerMask enemyLayer;

    [Header("Lights")]
    public Light2D spotLight;        // sürekli açık
    public Light2D muzzleFlash;      // ateşte yanar
    public float muzzleFlashDuration = 0.05f;
    public float muzzleFlashIntensity = 1f;
    private Coroutine muzzleFlashCo;
    [Header("Ammo Check")]
    public float ammoCheckDuration = 0.35f;
    public AudioClip ammoCheckSound;
    public string ammoCheckAnimTrigger = "AmmoCheck"; // Animator’da Trigger
    public AmmoCheckUI ammoCheckUI; // UI referansı (aşağıda yazacağım)
    private bool isCheckingMag = false;

    [Header("Reload Strategy")]
    public ReloadStrategy reloadStrategy = ReloadStrategy.MostFull;
    public bool IsBusy =>
    isReloading || isCheckingMag;

    private MagazineInstance lastUsedMagazine;
    private int lastMagIndex = -1;
    public event System.Action<int, int> OnMagazineChanged;
    // currentAmmo, capacity

    public event System.Action<int> OnSpareMagazineCountChanged;
    // yedek şarjör sayısı

    public event System.Action<string> OnAmmoCheckFeedback;
    // "Az mermi var", "Tam dolu" vs.


    [Header("Audio")]
    public AudioClip shootSound;
    public AudioClip reloadSound;
    public AudioClip emptyClipSound;

    // Input System
    private PlayerControls controls;

    // State
    private bool isReloading = false;
    private bool isAiming = false;

    private float lastAutoFireTime = 0f;
    private bool reloadHeldTriggered;
    private int _lastSpareCount = -1;



    // NEW MAGAZINE SYSTEM
    public MagazineInstance currentMagazine;
    public List<MagazineInstance> inventoryMags = new List<MagazineInstance>();


    [Header("Reload Input")]
    public float reloadHoldThreshold = 0.4f;


    private bool magCheckTriggered;



    private void Awake()
    {
        audioSource = GetComponent<AudioSource>();
        animator = GetComponentInChildren<Animator>();
        controls = new PlayerControls();

        if (muzzleFlash != null)
        {
            muzzleFlash.enabled = false;
            muzzleFlash.intensity = 0f;
        }
    }


    private void Start()
    {
        CollectMagazinesFromInventory();

        slotManager = WeaponSlotManager.Instance;

        if (slotManager != null)
            LoadFromSlot(slotManager.activeSlotIndex);
        else
            Debug.LogError("[PlayerWeapon] Slot Manager null!");

        CollectMagazinesFromInventory();

        if (currentMagazine == null && inventoryMags.Count > 0)
        {
            currentMagazine = SelectNextMagazine();
            inventoryMags.Remove(currentMagazine);

            OnMagazineChanged?.Invoke(
                currentMagazine.currentAmmo,
                currentMagazine.data.capacity
            );
        }

    }

    public void CollectMagazinesFromInventory()
    {
        var inv = Inventory.Instance;
        if (inv == null || weaponData == null)
            return;

        inventoryMags.Clear();

        // 🔍 Envanterdeki uyumlu şarjörleri topla
        for (int i = 0; i < inv.slots.Length; i++)
        {
            var slot = inv.slots[i];
            if (slot == null) continue;

            var mag = slot.magazineInstance;
            if (mag == null || mag.data == null) continue;

            if (!IsMagazineCompatible(mag)) continue;

            inventoryMags.Add(mag);
        }

        // 🔒 Takılı şarjör listeden çıkar (double sayılmasın)
        if (currentMagazine != null)
            inventoryMags.Remove(currentMagazine);

        // 📢 Event → SADECE sayı değiştiyse
        int spareCount = inventoryMags.Count;
        if (spareCount != _lastSpareCount)
        {
            _lastSpareCount = spareCount;
            OnSpareMagazineCountChanged?.Invoke(spareCount);
        }
    }




    private MagazineInstance SelectNextMagazine()
    {
        if (inventoryMags == null || inventoryMags.Count == 0)
            return null;

        // Uyumlu olanları topla (GC-free)
        // (İstersen liste oluşturmadan direkt seçebilirsin)
        MagazineInstance best = null;

        if (reloadStrategy == ReloadStrategy.MostFull || reloadStrategy == ReloadStrategy.LastUsed)
        {
            int bestAmmo = -1;

            for (int i = 0; i < inventoryMags.Count; i++)
            {
                var m = inventoryMags[i];
                if (m == null || m.data == null) continue;
                if (!IsMagazineCompatible(m)) continue;

                if (reloadStrategy == ReloadStrategy.LastUsed && lastUsedMagazine != null && m == lastUsedMagazine)
                    return m; // direkt dön

                if (m.currentAmmo > bestAmmo)
                {
                    bestAmmo = m.currentAmmo;
                    best = m;
                }
            }

            return best;
        }

        // NextInList (uyumlular arasında sırayla)
        // Uyumlu sayısını bul, sonra index seç
        int compatibleCount = 0;
        for (int i = 0; i < inventoryMags.Count; i++)
        {
            var m = inventoryMags[i];
            if (m == null || m.data == null) continue;
            if (!IsMagazineCompatible(m)) continue;
            compatibleCount++;
        }

        if (compatibleCount == 0) return null;

        lastMagIndex = (lastMagIndex + 1) % compatibleCount;

        // lastMagIndex’in işaret ettiği uyumlu elemanı bul
        int k = 0;
        for (int i = 0; i < inventoryMags.Count; i++)
        {
            var m = inventoryMags[i];
            if (m == null || m.data == null) continue;
            if (!IsMagazineCompatible(m)) continue;

            if (k == lastMagIndex)
                return m;

            k++;
        }

        return null;
    }


    // ============================
    // INPUT SYSTEM ONENABLE / OFF
    // ============================
    private void OnEnable()
    {
        controls.Gameplay.Enable();

        controls.Gameplay.Reload.started += OnReloadStarted;
        controls.Gameplay.Reload.performed += OnReloadPerformed;
        controls.Gameplay.Reload.canceled += OnReloadCanceled;

        if (Inventory.Instance != null)
            Inventory.Instance.OnChanged += OnInventoryChanged;
    }




    private void OnDisable()
    {
        controls.Gameplay.Reload.started -= OnReloadStarted;
        controls.Gameplay.Reload.performed -= OnReloadPerformed;
        controls.Gameplay.Reload.canceled -= OnReloadCanceled;

        if (Inventory.Instance != null)
            Inventory.Instance.OnChanged -= OnInventoryChanged;

        controls.Gameplay.Disable();
    }

    private void OnInventoryChanged()
    {
        CollectMagazinesFromInventory();
    }


    private void OnReloadPerformed(InputAction.CallbackContext ctx)
    {
        if (isReloading || isCheckingMag) return;
        if (weaponData == null) return;

        // HOLD tamamlandıysa → MagCheck
        if (ctx.interaction is UnityEngine.InputSystem.Interactions.HoldInteraction)
        {
            reloadHeldTriggered = true;
            StartCoroutine(MagCheck());
            return;
        }

        // PRESS → Reload (ama hold’a gitmeyecekse)
        if (!reloadHeldTriggered)
            TryReload();
    }

    private void OnReloadCanceled(InputAction.CallbackContext ctx)
    {
        // Şimdilik boş
    }

    private void OnReloadStarted(InputAction.CallbackContext ctx)
    {
        reloadHeldTriggered = false;
    }




    private void SwitchToSlot(int slot)
    {
        WeaponSlotManager.Instance.SwitchSlot(slot);
    }

    // ============================
    // SHOOT (NEW INPUT SYSTEM)
    // ============================



    private void Update()
    {
        if (GameStateManager.IsGamePaused || weaponData == null)
            return;

        // 🔫 Tekli atış
        if (!weaponData.isAutomatic)
        {
            if (Input.GetMouseButtonDown(0))
                Shoot();
        }

        // 🔥 Otomatik atış
        if (weaponData.isAutomatic)
        {
            if (Input.GetMouseButton(0))
                AutoFire();
        }


    }

    // ============================
    // MAGAZINE CHECK (HOLD R)
    // ============================


    public bool TryEquipMagazineFromInventory(MagazineInstance mag)
    {
        if (mag == null || mag.data == null)
            return false;

        if (!CanEquipMagazine(mag))
        {
            ammoCheckUI?.Show("Bu şarjör uyumsuz!");
            return false;
        }

        if (isReloading || isCheckingMag)
            return false;

        currentMagazine = mag;

        Debug.Log(
            $"[Weapon] Şarjör takıldı → " +
            $"{mag.currentAmmo}/{mag.data.capacity}"
        );

        Inventory.Instance.RaiseChanged();
        return true;
    }


    private void AutoFire()
    {
        if (isReloading || isCheckingMag)
            return;

        float fireDelay = 1f / weaponData.fireRate;

        if (Time.time - lastAutoFireTime >= fireDelay)
        {
            lastAutoFireTime = Time.time;
            Shoot();
        }
    }

    private void TryReload()
    {
        if (isReloading || isCheckingMag) return;
        if (weaponData == null)
        {
            ammoCheckUI?.Show("Silah yok.");
            return;
        }

        // bozuk state koruması
        if (currentMagazine != null && currentMagazine.data == null)
            currentMagazine = null;

        // her reload girişinde listeyi tazele (pickup sonrası otomatik görsün)
        CollectMagazinesFromInventory();

        // Silah boşsa → direkt şarjör tak
        if (currentMagazine == null)
        {
            MagazineInstance next = SelectNextMagazine();
            if (next == null)
            {
                ammoCheckUI?.Show("Uyumlu şarjör yok.");
                return;
            }

            inventoryMags.Remove(next);
            currentMagazine = next;

            OnMagazineChanged?.Invoke(
                currentMagazine.currentAmmo,
                currentMagazine.data.capacity
            );
            OnSpareMagazineCountChanged?.Invoke(inventoryMags.Count);
            return;
        }


        // currentMagazine.data artık garanti
        if (currentMagazine.currentAmmo >= currentMagazine.data.capacity)
        {
            ammoCheckUI?.Show("Şarjör zaten dolu.");
            return;
        }

        StartCoroutine(ReloadRoutine());
    }

    public void NotifyMagazineAmmoChanged()
    {
        if (currentMagazine != null && currentMagazine.data != null)
        {
            OnMagazineChanged?.Invoke(
                currentMagazine.currentAmmo,
                currentMagazine.data.capacity
            );
        }

        CollectMagazinesFromInventory();
    }

    // ============================
    // ACTUAL SHOOT LOGIC
    // ============================
    public void Shoot()
    {
        if (currentMagazine == null)
        {
            PlayEmptyClipSound();
            ammoCheckUI?.Show("Şarjör yok.");
            return;
        }

        if (isReloading || isCheckingMag)
            return;

        if (currentMagazine == null || currentMagazine.data == null)
        {
            Debug.Log("Şarjör takılı değil.");
            return;
        }

        if (weaponData == null || weaponData.ammoType == null)
        {
            Debug.LogError("WeaponData veya ammoType NULL!");
            return;
        }

        if (currentMagazine.data == null || currentMagazine.data.ammoType == null)
        {
            Debug.LogError("MagazineData veya ammoType NULL!");
            return;
        }

        if (isReloading) return;

        if (currentMagazine == null)
        {
            PlayEmptyClipSound();
            Debug.Log("Şarjör takılı değil.");
            return;
        }

        if (currentMagazine.data.ammoType != weaponData.ammoType)
        {
            Debug.LogError("UYUMSUZ ŞARJÖR TAKILI!");
            return;
        }

        if (currentMagazine.currentAmmo <= 0)
        {
            PlayEmptyClipSound();
            Debug.Log("Şarjör boş.");
            return;
        }
        if (currentMagazine == null || currentMagazine.currentAmmo <= 0)
        {
            PlayEmptyClipSound();
            Debug.Log("Boş şarjör!");
            return;
        }


        currentMagazine.currentAmmo--;
        RangedAttack();
        lastUsedMagazine = currentMagazine;
        OnMagazineChanged?.Invoke(
            currentMagazine.currentAmmo,
            currentMagazine.data.capacity
        );



    }
    public MagazineInstance GetCurrentMagazine()
    {
        return currentMagazine;
    }

    public void SetCurrentMagazine(MagazineInstance mag)
    {
        currentMagazine = mag;
    }

    public bool CanEquipMagazine(MagazineInstance mag)
    {
        return IsMagazineCompatible(mag);
    }



    private void RangedAttack()
    {
        if (shootSound != null)
            audioSource.PlayOneShot(shootSound);

        animator?.SetTrigger("Shoot");

        if (weaponData.isShotgun)
            FireShotgunPellets();
        else
            FireSingleBullet();

        TryMuzzleFlash();
    }

    private void FireSingleBullet()
    {
        if (weaponData.projectilePrefab == null)
        {
            Debug.LogError("WeaponData projectilePrefab NULL!");
            return;
        }

        var projectile = Instantiate(
            weaponData.projectilePrefab,
            firePoint.position,
            firePoint.rotation
        );

        if (projectile.TryGetComponent(out WeaponBullet b))
        {
            b.damage = weaponData.damage;
            b.owner = transform;
            b.weaponType = weaponData.weaponType;
            b.knockbackForce = weaponData.knockbackForce;
            b.knockbackDuration = weaponData.knockbackDuration;
        }
    }


    private void FireShotgunPellets()
    {
        if (weaponData.projectilePrefab == null)
            return;

        int pellets = Mathf.Max(weaponData.pelletsPerShot, 1);
        float spread = weaponData.pelletSpreadAngle;

        for (int i = 0; i < pellets; i++)
        {
            float t = pellets == 1 ? 0.5f : (float)i / (pellets - 1);
            float angle = Mathf.Lerp(-spread, spread, t);

            Quaternion rot =
                firePoint.rotation * Quaternion.Euler(0, 0, angle);

            var proj = Instantiate(
                weaponData.projectilePrefab,
                firePoint.position,
                rot
            );

            if (proj.TryGetComponent(out WeaponBullet b))
            {
                b.damage = weaponData.damage;
                b.owner = transform;
                b.weaponType = weaponData.weaponType;
            }
        }
    }


    // ============================
    // ADS
    // ============================
    private void StartADS()
    {
        isAiming = true;
        animator?.SetBool("ADS", true);
    }

    private void StopADS()
    {
        isAiming = false;
        animator?.SetBool("ADS", false);
    }

    // ============================
    // RELOAD (SHORT OR LONG HOLD)
    // ============================


    private IEnumerator ReloadRoutine()
    {
        if (isReloading)
            yield break;

        // 🔒 SADECE UYUMLU ŞARJÖRLER
        bool hasCompatible = false;
        for (int i = 0; i < inventoryMags.Count; i++)
        {
            var m = inventoryMags[i];
            if (m == null || m.data == null) continue;
            if (m.data.ammoType != weaponData.ammoType) continue;
            if (!IsMagazineCompatible(m)) continue;

            hasCompatible = true;
            break;
        }

        if (!hasCompatible)
        {
            // (Log istersen sadece editor)
            // #if UNITY_EDITOR
            // Debug.Log("Bu silaha uygun şarjör yok!");
            // #endif
            yield break;
        }


        isReloading = true;

        if (reloadSound != null)
            audioSource.PlayOneShot(reloadSound);

        yield return new WaitForSeconds(weaponData.reloadTime);

        currentMagazine = null;

        MagazineInstance nextMag = SelectNextMagazine();

        if (nextMag == null)
        {
            Debug.Log("Takılabilir şarjör yok!");
            isReloading = false;
            yield break;
        }

        inventoryMags.Remove(nextMag);
        currentMagazine = nextMag;
        lastUsedMagazine = currentMagazine;


        Debug.Log(
            $"Yeni şarjör takıldı → {currentMagazine.currentAmmo}/{currentMagazine.data.capacity}"
        );

        isReloading = false;
        OnMagazineChanged?.Invoke(
    currentMagazine.currentAmmo,
    currentMagazine.data.capacity
);

        OnSpareMagazineCountChanged?.Invoke(inventoryMags.Count);

    }

    private bool IsMagazineCompatible(MagazineInstance mag)
    {
        if (mag == null || mag.data == null || weaponData == null)
            return false;

        // acceptedMagazines null veya boş kontrolü
        if (weaponData.acceptedMagazines == null || weaponData.acceptedMagazines.Count == 0)
            return false;

        return weaponData.acceptedMagazines.Contains(mag.data.magazineType);
    }




    // ============================
    // MAGAZINE CHECK (HOLD R)
    // ============================
    private IEnumerator MagCheck()
    {
        // Zaten kontrol ediliyorsa tekrar girme
        if (isCheckingMag)
            yield break;

        // Reload sırasında check yapılamaz
        if (isReloading)
            yield break;

        // Şarjör yok
        if (currentMagazine == null || currentMagazine.data == null)
        {
            ammoCheckUI?.Show("Şarjör takılı değil.");
            OnAmmoCheckFeedback?.Invoke("Şarjör takılı değil.");
            yield break;
        }

        // Uyumsuz şarjör (sert kontrol)
        if (!CanEquipMagazine(currentMagazine))
        {
            ammoCheckUI?.Show("Uyumsuz şarjör!");
            OnAmmoCheckFeedback?.Invoke("Uyumsuz şarjör!");
            yield break;
        }

        isCheckingMag = true;

        // 🔊 Ses
        if (ammoCheckSound != null)
            audioSource.PlayOneShot(ammoCheckSound);

        // 🎞 Animasyon
        if (!string.IsNullOrEmpty(ammoCheckAnimTrigger))
            animator?.SetTrigger(ammoCheckAnimTrigger);

        // ⏱ Gerçekçi kontrol süresi
        yield return new WaitForSeconds(ammoCheckDuration);

        // 📊 Doluluk oranı
        int ammo = currentMagazine.currentAmmo;
        int cap = currentMagazine.data.capacity;

        float ratio = cap > 0 ? (float)ammo / cap : 0f;

        string msg;

        if (ammo <= 0)
            msg = "Boş gibi.";
        else if (ratio < 0.25f)
            msg = "Az mermi var.";
        else if (ratio < 0.6f)
            msg = "Yarısı dolu.";
        else if (ratio < 1f)
            msg = "Neredeyse dolu.";
        else
            msg = "Tam dolu.";

        // 📢 UI + Event
        ammoCheckUI?.Show(msg);
        OnAmmoCheckFeedback?.Invoke(msg);

        isCheckingMag = false;
    }




    // ============================
    // MUZZLE FLASH
    // ============================
    private void TryMuzzleFlash()
    {
        if (muzzleFlash == null) return;

        muzzleFlash.transform.position = firePoint.position;

        if (muzzleFlashCo != null)
            StopCoroutine(muzzleFlashCo);

        muzzleFlashCo = StartCoroutine(MuzzleFlashRoutine());
    }


    private IEnumerator MuzzleFlashRoutine()
    {
        muzzleFlash.enabled = true;
        muzzleFlash.intensity = muzzleFlashIntensity;

        yield return new WaitForSeconds(muzzleFlashDuration);

        muzzleFlash.intensity = 0f;
        muzzleFlash.enabled = false;
    }


    public void PlayEmptyClipSound()
    {
        if (emptyClipSound != null)
            audioSource.PlayOneShot(emptyClipSound);
    }

    // ============================
    // SLOT / WEAPON LOAD
    // ============================
    public void LoadFromSlot(int slot)
    {
        WeaponItemData item =
            WeaponSlotManager.Instance.GetWeaponItemInSlot(slot);

        if (item == null || item.weaponDefinition == null)
            return;

        weaponData = item.weaponDefinition;
        lastAutoFireTime = 0f;
        isReloading = false;

        if (currentModel != null)
            Destroy(currentModel);

        if (weaponData.prefab != null)
        {
            currentModel = Instantiate(weaponData.prefab, transform);
            Transform fp = currentModel.transform.Find("FirePoint");
            if (fp != null)
                firePoint = fp;
        }

        CollectMagazinesFromInventory();
    }


    public void SetWeapon(WeaponDefinition data)
    {
        StopAllCoroutines();
        isReloading = false;
        isCheckingMag = false;

        if (data == null)
            return;

        weaponData = data;

        // Model
        if (currentModel != null)
            Destroy(currentModel);

        if (weaponData.prefab != null)
        {
            currentModel = Instantiate(weaponData.prefab, transform);
            currentModel.transform.localPosition = Vector3.zero;
            currentModel.transform.localRotation = Quaternion.identity;

            Transform fp = currentModel.transform.Find("FirePoint");
            if (fp != null)
                firePoint = fp;
        }

        // 🔥 ŞARJÖR BAĞLAMA
        inventoryMags.Clear();
        currentMagazine = null;

        var inv = Inventory.Instance;

        for (int i = 0; i < inv.slots.Length; i++)
        {
            var slot = inv.slots[i];

            if (slot.magazineInstance == null)
                continue;

            MagazineInstance mag = slot.magazineInstance;

            if (mag.data == null || mag.data.ammoType == null)
                continue;

            // 🔒 SADECE BU SİLAHA UYUMLU ŞARJÖR
            if (IsMagazineCompatible(mag))
            {
                inventoryMags.Add(mag);
            }

        }

        // 🔫 OTOMATİK TAK (opsiyonel ama önerilir)
        if (inventoryMags.Count > 0)
        {
            MagazineInstance best = null;
            int maxAmmo = -1;

            foreach (var m in inventoryMags)
            {
                if (m.currentAmmo > maxAmmo)
                {
                    maxAmmo = m.currentAmmo;
                    best = m;
                }
            }

            currentMagazine = best;


            inventoryMags.Remove(currentMagazine);

            Debug.Log(
                $"[Weapon] Otomatik şarjör takıldı → " +
                $"{currentMagazine.currentAmmo}/{currentMagazine.data.capacity}"
            );
        }
        else
        {
            Debug.Log("[Weapon] Uyumlu şarjör bulunamadı.");
        }
        CollectMagazinesFromInventory();

        currentMagazine = null;

        if (inventoryMags.Count > 0)
        {
            currentMagazine = SelectNextMagazine();
            inventoryMags.Remove(currentMagazine);
        }

    }



}
using System;
using System.Collections.Generic;  // ğŸ”´ EKLE
using UnityEngine;    

[System.Serializable]
public class CaravanSaveData
{
    public List<WeaponSaveEntry> weaponEntries = new();
}

[System.Serializable]
public class WeaponSaveEntry
{
    public WeaponType type;
    public List<string> weaponIDs;
}
using UnityEngine;

public class GameInitializer : MonoBehaviour
{
    [Header("Referanslar")]
    public Transform player;       // Player Transform
    public ItemRegistry registry;  // TÃ¼m item SO'larÄ±
    public Inventory inventory;    // Player Ã¼zerindeki Inventory
    public PlayerStats stats;      // PlayerStats

    [Header("Yeni Oyun Spawn NoktasÄ±")]
    public Transform defaultSpawnPoint;   // Inspectorâ€™dan bir boÅŸ obje ver (spawn noktasÄ±)
    public Vector3 fallbackSpawnPosition; // Ä°stersen elle de girebilirsin

    private void Awake()
    {
        if (registry != null && registry.items != null && registry.items.Length > 0)
        {
            ItemDatabase.RegisterAll(registry.items);
        }
        else
        {
            Debug.LogError("ItemDatabase boooÅŸ! registry veya registry.items atanmadÄ±!");
        }

    }

    private void Start()
    {
        Debug.Log("GameInitializer: ShouldLoad = " + SaveBootstrap.ShouldLoadFromSave);
        Debug.Log("GameInitializer: HasSave = " + SaveSystem.HasSave());

        // 1) Save yÃ¼kleme...
        if (SaveBootstrap.ShouldLoadFromSave && SaveSystem.HasSave())
        {
            SaveSystem.LoadPlayerAndInventory(
        player,
        inventory,
        stats,
        FindObjectOfType<PlayerWeapon>()
    );

            SaveBootstrap.ShouldLoadFromSave = false;
            return;
        }

        // 2) Yeni oyun â†’ default spawn
        Vector3 spawnPos = player.position;

        if (defaultSpawnPoint != null)
            spawnPos = defaultSpawnPoint.position;
        else if (fallbackSpawnPosition != Vector3.zero)
            spawnPos = fallbackSpawnPosition;

        player.position = spawnPos;


        // 3) BAÅLANGIÃ‡ PÄ°STOL
        ItemData pistolItem = ItemDatabase.Get("weapon_glock18");
        if (pistolItem is WeaponItemData pistolWeapon)
        {
            WeaponSlotManager.Instance.EquipWeapon(pistolWeapon);
            Debug.Log("â–¶ Yeni oyun â†’ BaÅŸlangÄ±Ã§ silahÄ± verildi: Pistol");
        }




        // Aktif slot pistol olsun
        WeaponSlotManager.Instance.activeSlotIndex = 0;
    }


}
    public static class SaveBootstrap
{
    public static bool ShouldLoadFromSave = false;
}
using System.Collections.Generic;

[System.Serializable]
public class SaveData
{
    // Position
    public float posX, posY, posZ;

    // Stats
    public int currentHealth, maxHealth;
    public float currentStamina, maxStamina;
    public int currentHunger, maxHunger;
    public int gold;

    // Inventory items
    public List<InventoryItemData> inventory = new List<InventoryItemData>();

    // Ammo Pool (JsonUtility uyumlu)
    public List<string> ammoTypeIDs = new List<string>();
    public List<int> ammoAmounts = new List<int>();

    // Weapons
    public string[] equippedWeaponIDs = new string[3];
    public int activeSlotIndex;

    // Equipped magazine
    public int equippedMagazineSlotIndex = -1;
    public int equippedMagazineAmmo = 0;

    // Craft
    public List<string> unlockedWeaponIDs = new List<string>();

    // Caravan
    public CaravanSaveData caravanSave;
}

[System.Serializable]
public class InventoryItemData
{
    public string itemID;
    public int amount;
    public bool hasMagazineInstance;
    public int magazineCurrentAmmo;

}

[System.Serializable]
public class AmmoSaveData
{
    public string ammoId;
    public int amount;
}

[System.Serializable]
public class MagazineSaveData
{
    public string magazineItemID; // MagazineData.itemID
    public int currentAmmo;
}
using System.Collections.Generic;
using System.IO;
using UnityEngine;

public static class SaveSystem
{
    private static readonly string savePath =
        Path.Combine(Application.persistentDataPath, "save.json");

    public static bool HasSave() => File.Exists(savePath);

    public static void DeleteSave()
    {
        if (HasSave())
            File.Delete(savePath);
    }

    // ============================================================
    // SAVE
    // ============================================================
    public static void SavePlayerAndInventory(
        Transform player,
        Inventory inventory,
        PlayerStats stats,
        PlayerWeapon playerWeapon)
    {
        if (!player || !inventory || !stats)
        {
            Debug.LogWarning("SavePlayerAndInventory: Eksik referans!");
            return;
        }

        SaveData data = new SaveData();

        // Position
        Vector3 p = player.position;
        data.posX = p.x;
        data.posY = p.y;
        data.posZ = p.z;

        // Stats
        data.currentHealth = stats.currentHealth;
        data.maxHealth = stats.maxHealth;
        data.currentStamina = stats.GetStamina();
        data.maxStamina = stats.GetMaxStamina();
        data.currentHunger = stats.currentHunger;
        data.maxHunger = stats.maxHunger;

        // Inventory items
        data.inventory.Clear();
        foreach (var slot in inventory.slots)
        {
            if (slot == null || slot.data == null) continue;

            InventoryItemData itemData = new InventoryItemData
            {
                itemID = slot.data.itemID,
                amount = slot.count
            };

            if (slot.magazineInstance != null)
            {
                itemData.hasMagazineInstance = true;
                itemData.magazineCurrentAmmo =
                    slot.magazineInstance.currentAmmo;
            }
            else
            {
                itemData.hasMagazineInstance = false;
            }

            data.inventory.Add(itemData);
        }


        // Ammo Pool
        data.ammoTypeIDs.Clear();
        data.ammoAmounts.Clear();
        foreach (var pair in inventory.GetAmmoPool())
        {
            data.ammoTypeIDs.Add(pair.Key.ammoId);
            data.ammoAmounts.Add(pair.Value);
        }

        // Weapons
        WeaponSlotManager wsm = WeaponSlotManager.Instance;
        if (wsm != null)
        {
            for (int i = 0; i < 3; i++)
                data.equippedWeaponIDs[i] =
                    wsm.slots[i] != null ? wsm.slots[i].itemID : "";

            data.activeSlotIndex = wsm.activeSlotIndex;
        }

        // Equipped magazine (slot index + ammo)
        data.equippedMagazineSlotIndex = -1;
        data.equippedMagazineAmmo = 0;

        if (playerWeapon != null && playerWeapon.GetCurrentMagazine() != null)
        {
            MagazineInstance mag = playerWeapon.GetCurrentMagazine();

            for (int i = 0; i < inventory.slots.Length; i++)
            {
                if (inventory.slots[i].magazineInstance == mag)
                {
                    data.equippedMagazineSlotIndex = i;
                    data.equippedMagazineAmmo = mag.currentAmmo;
                    break;
                }
            }
        }

        // Craft unlocks
        data.unlockedWeaponIDs.Clear();
        if (CraftingSystem.Instance != null)
        {
            foreach (var id in CraftingSystem.Instance.unlockedWeapons)
                data.unlockedWeaponIDs.Add(id);
        }

        // Caravan
        if (CaravanInventory.Instance != null)
            data.caravanSave = CaravanInventory.Instance.GetSaveData();

        File.WriteAllText(savePath, JsonUtility.ToJson(data, true));
        Debug.Log("ğŸ’¾ SAVE â†’ BaÅŸarÄ±lÄ±");
    }

    // ============================================================
    // LOAD
    // ============================================================
    public static void LoadPlayerAndInventory(
        Transform player,
        Inventory inventory,
        PlayerStats stats,
        PlayerWeapon playerWeapon)
    {
        if (!player || !inventory || !stats)
        {
            Debug.LogWarning("LoadPlayerAndInventory: Eksik referans!");
            return;
        }

        if (!HasSave())
        {
            Debug.LogWarning("LoadPlayerAndInventory: KayÄ±t yok.");
            return;
        }

        SaveData data =
            JsonUtility.FromJson<SaveData>(File.ReadAllText(savePath));

        // Position
        Vector3 pos = new Vector3(data.posX, data.posY, data.posZ);
        if (pos.y < 1f) pos.y = 1f;
        player.position = pos;

        // Stats
        stats.maxHealth = data.maxHealth;
        stats.currentHealth = data.currentHealth;
        stats.RefreshHealthUI();

        stats.maxStamina = data.maxStamina;
        stats.ResetStamina();
        stats.ModifyStamina(data.currentStamina - stats.GetStamina());

        stats.maxHunger = data.maxHunger;
        stats.currentHunger = data.currentHunger;

        // Inventory
        inventory.ClearInventory();
        foreach (var it in data.inventory)
        {
            ItemData so = ItemDatabase.Get(it.itemID);
            if (so == null) continue;

            inventory.TryAdd(so, it.amount);

            // ğŸ”¥ ÅarjÃ¶rse, instanceâ€™Ä± dÃ¼zelt
            if (it.hasMagazineInstance)
            {
                // En son eklenen slotu bul
                InventoryItem slot = inventory.GetLastAddedSlot();

                if (slot != null && slot.magazineInstance != null)
                {
                    slot.magazineInstance.currentAmmo =
                        it.magazineCurrentAmmo;
                }
            }
        }


        // Ammo pool
        inventory.ClearAmmoPool();
        for (int i = 0; i < data.ammoTypeIDs.Count; i++)
        {
            AmmoTypeData ammoType =
                AmmoTypeRegistry.Get(data.ammoTypeIDs[i]);
            if (ammoType != null)
                inventory.AddAmmo(ammoType, data.ammoAmounts[i]);
        }

        // Weapons
        WeaponSlotManager wsm = WeaponSlotManager.Instance;
        if (wsm != null)
{
    for (int i = 0; i < 3; i++)
    {
        string id = data.equippedWeaponIDs[i];

        if (!string.IsNullOrEmpty(id))
            wsm.slots[i] = ItemDatabase.Get(id) as WeaponItemData;
        else
            wsm.slots[i] = null;
    }

    wsm.activeSlotIndex =
        Mathf.Clamp(data.activeSlotIndex, 0, 2);

    wsm.SwitchSlot(wsm.activeSlotIndex);
}


        // Equipped magazine
        if (playerWeapon != null &&
            data.equippedMagazineSlotIndex >= 0 &&
            data.equippedMagazineSlotIndex < inventory.slots.Length)
        {
            var mag =
                inventory.slots[data.equippedMagazineSlotIndex]
                    .magazineInstance;

            if (mag != null)
            {
                mag.currentAmmo = data.equippedMagazineAmmo;
                playerWeapon.SetCurrentMagazine(mag);
            }
        }

        // Craft unlocks
        if (CraftingSystem.Instance != null)
        {
            CraftingSystem.Instance.unlockedWeapons.Clear();
            foreach (var id in data.unlockedWeaponIDs)
                CraftingSystem.Instance.unlockedWeapons.Add(id);
        }

        // Caravan
        if (data.caravanSave != null &&
            CaravanInventory.Instance != null)
        {
            CaravanInventory.Instance.LoadFromData(data.caravanSave);
        }


        Debug.Log("ğŸ“¥ LOAD â†’ BaÅŸarÄ±lÄ±");
    }
}
using System;

[Serializable]
public class WeaponSlotSaveData
{
    public string[] equippedWeaponIDs = new string[3];
    public int[] clip = new int[3];
    public int[] reserve = new int[3];
    public int activeSlotIndex;
}
using UnityEngine;
using TMPro;

public class NoteTrigger : MonoBehaviour
{
    public GameObject notePanel;
    public TextMeshProUGUI noteTextUI;
    public AudioSource audioSource;

    private bool isPlayerNearby = false;
    private StoryNote currentNote;
    private int currentIndex = 0; // sÄ±rayla ya da rastgele

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            currentNote = GetComponent<StoryNote>();
            isPlayerNearby = true;

            if (notePanel != null && currentNote != null && currentNote.noteTexts.Length > 0)
            {
                notePanel.SetActive(true);

                // Ä°stersen sÄ±rayla:
                string text = currentNote.noteTexts[currentIndex];
                noteTextUI.text = text;

                if (currentNote.radioClips != null && currentNote.radioClips.Length > currentIndex && audioSource != null)
                {
                    audioSource.clip = currentNote.radioClips[currentIndex];
                    audioSource.Play();
                }

                // sÄ±radakine geÃ§ (loop)
                currentIndex = (currentIndex + 1) % currentNote.noteTexts.Length;
            }
        }
    }

    void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            notePanel.SetActive(false);
            if (audioSource != null) audioSource.Stop();
        }
    }
}
using UnityEngine;

public class StoryNote : MonoBehaviour
{
    [TextArea]
    public string[] noteTexts;   // Birden fazla metin
    public AudioClip[] radioClips; // Her metne karÅŸÄ±lÄ±k ses (opsiyonel)
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;

public class BuildSpot : MonoBehaviour
{
    [Header("Taret Seviyeleri")]
    public TurretLevelData[] levels;

    [Header("Ä°nÅŸa UI")]
    public float buildTime = 2f;
    public Slider progressBar;
    public GameObject progressCanvas;

    private bool isPlayerNearby = false;
    private float holdTimer = 0f;
    private bool isBuilding = false;

    private int currentLevel = 0;
    private GameObject currentTurret;

    private PlayerStats playerStats;

    private void Start()
    {
        if (progressCanvas != null)
            progressCanvas.SetActive(false);

        GameObject player = GameObject.FindWithTag("Player");
        if (player != null)
            playerStats = player.GetComponent<PlayerStats>();
    }

    void Update()
    {
        if (!isPlayerNearby || playerStats == null) return;

        if (Keyboard.current.eKey.isPressed)
        {
            if (currentLevel >= levels.Length)
            {
                Debug.Log("âš ï¸ Zaten maksimum seviyede.");
                return;
            }

            if (!HasEnoughResources())
            {
                Debug.Log("ğŸš« Yetersiz kaynak!");
                return;
            }

            if (!isBuilding)
            {
                isBuilding = true;
                if (progressCanvas != null)
                    progressCanvas.SetActive(true);
            }

            holdTimer += Time.deltaTime;
            if (progressBar != null)
                progressBar.value = holdTimer / buildTime;

            if (holdTimer >= buildTime)
                BuildOrUpgradeTurret();
        }
        else if (isBuilding)
        {
            ResetBuild();
        }
    }

    void BuildOrUpgradeTurret()
{
    if (currentLevel >= levels.Length) return;
    TurretLevelData levelData = levels[currentLevel];

    // Kaynak dÃ¼ÅŸÃ¼r
    if (!Inventory.Instance.TryConsume(levelData.stoneSO, levelData.requiredStone) ||
        !Inventory.Instance.TryConsume(levelData.woodSO, levelData.requiredWood))
    {
        Debug.Log("ğŸš« Kaynak eksik!");
        return;
    }

    if (currentTurret != null)
        Destroy(currentTurret);

    Vector3 spawnPos = new Vector3(transform.position.x, transform.position.y, -1f);
    currentTurret = Instantiate(levelData.prefab, spawnPos, Quaternion.identity);
    currentLevel++;

    ResetBuild();
    Debug.Log($"âœ… Kule seviyesi {currentLevel} oldu!");
}


    void ResetBuild()
    {
        isBuilding = false;
        holdTimer = 0f;

        if (progressBar != null)
            progressBar.value = 0f;

        if (progressCanvas != null)
            progressCanvas.SetActive(false);
    }

    void OnTriggerEnter2D(Collider2D collision)
    {
        if (collision.CompareTag("Player"))
            isPlayerNearby = true;
    }

    void OnTriggerExit2D(Collider2D collision)
    {
        if (collision.CompareTag("Player"))
        {
            isPlayerNearby = false;
            ResetBuild();
        }
    }

    bool HasEnoughResources()
{
    if (currentLevel >= levels.Length || playerStats == null) return false;

    TurretLevelData levelData = levels[currentLevel];

    bool hasResources =
        Inventory.Instance.HasEnough(levelData.stoneSO, levelData.requiredStone) &&
        Inventory.Instance.HasEnough(levelData.woodSO, levelData.requiredWood);

    // EÄŸer blueprint sistemi Inventoryâ€™ye baÄŸlandÄ±ysa:
    bool hasBlueprint = string.IsNullOrEmpty(levelData.requiredBlueprintId)
        || Inventory.Instance.HasBlueprint(levelData.requiredBlueprintId);

    if (!hasBlueprint)
        Debug.Log($"ğŸš« Gerekli taslak yok: {levelData.requiredBlueprintId}");

    return hasResources && hasBlueprint;
}


}
using UnityEngine;

public class Turret : MonoBehaviour
{
    public float attackRange = 5f;
    public float fireRate = 1f;
    public GameObject bulletPrefab;
    public float bulletSpeed = 10f;

    private float fireTimer = 0f;

    void Update()
    {
        fireTimer -= Time.deltaTime;

        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, attackRange);
        foreach (var hit in hits)
        {
            Enemy enemy = hit.GetComponent<Enemy>();
            if (enemy != null && fireTimer <= 0)
            {
                Shoot(enemy.transform.position);
                fireTimer = 1f / fireRate;
                break; // Ä°lk dÃ¼ÅŸmanÄ± vur, Ã§Ä±k
            }
        }
    }

void Shoot(Vector3 targetPosition)
{
    Vector3 direction = (targetPosition - transform.position).normalized;

    // YÃ¶n doÄŸrultusunda bir rotasyon hesapla (X yÃ¶nÃ¼ne gÃ¶re dÃ¶ndÃ¼r)
    float angle = Mathf.Atan2(direction.y, direction.x) * Mathf.Rad2Deg;
    Quaternion rotation = Quaternion.Euler(0, 0, angle); // â¬…ï¸ sadece bu Ã¶nemli

    // Mermiyi doÄŸru rotasyonla oluÅŸtur
    GameObject bullet = Instantiate(bulletPrefab, transform.position, rotation);
}




    void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.red;
        Gizmos.DrawWireSphere(transform.position, attackRange);
    }
}
using UnityEngine;

[RequireComponent(typeof(Rigidbody2D))]
public class TurretBullet : MonoBehaviour
{
    public float speed = 15f;
    public int damage = 5;

    private Rigidbody2D rb;

    void Awake()
    {
        rb = GetComponent<Rigidbody2D>();
    }

    void Start()
    {
        // Mermiyi yÃ¶nÃ¼ne gÃ¶re fÄ±rlat
        rb.linearVelocity = transform.right * speed;

        // 3 saniye sonra yok olsun
        Destroy(gameObject, 3f);
    }

    private void OnTriggerEnter2D(Collider2D collision)
    {
        // Oyuncuya veya baÅŸka mermiye Ã§arpmasÄ±n
        if (collision.CompareTag("Player") || collision.CompareTag("Bullet"))
            return;

        Enemy enemy = collision.GetComponent<Enemy>();
        if (enemy != null)
        {
            enemy.TakeDamage(damage);
        }

        Destroy(gameObject);
    }
}
using UnityEngine;

[System.Serializable]
public class TurretLevelData
{
    public GameObject prefab;
    public int requiredStone;
    public int requiredWood;
    public string requiredBlueprintId;
     [Header("Sample Items")]
    public ItemData stoneSO;
    public ItemData woodSO;



}
using System.Collections;
using UnityEngine;
using UnityEngine.UI;

public class BloodVignetteUI : MonoBehaviour
{
    [Header("Refs")]
    [SerializeField] private Image bloodOverlay;
    private float baseAlpha;   // cana baÄŸlÄ± kalÄ±cÄ±
    private float flashAlpha;  // geÃ§ici hasar efekti

    [Header("Health Input")]
    [Tooltip("0..1 arasÄ± saÄŸlÄ±k yÃ¼zdesini buraya veriyoruz.")]
    [Range(0f, 1f)] public float health01 = 1f; // demo iÃ§in inspector'dan oynatabilirsin

    [Header("Intensity")]
    [Tooltip("Health azaldÄ±kÃ§a alpha nasÄ±l artsÄ±n? X: health(0..1), Y: alpha(0..1)")]

    [SerializeField]
private AnimationCurve alphaByHealth =
    new AnimationCurve(
        new Keyframe(1.0f, 0.00f),
        new Keyframe(0.70f, 0.3f), // full HP
        new Keyframe(0.60f, 0.4f),
        new Keyframe(0.40f, 0.5f),
        new Keyframe(0.25f, 0.6f),
        new Keyframe(0.10f, 0.7f),
        new Keyframe(0.0f, 1f)  // DÄ°KKAT: max deÄŸer
    );



    [SerializeField, Range(0f, 1f)] private float maxAlpha = 0.55f;
    [SerializeField] private float smooth = 10f;

    [Header("Low HP Pulse (COD hissi)")]
    [SerializeField, Range(0f, 1f)] private float pulseStartHealth = 0.22f;
    [SerializeField] private float pulseSpeed = 2.5f;
    [SerializeField] private float pulseAmount = 0.07f;

    [Header("Damage Flash")]
    [SerializeField] private float damageFlashAdd = 0.18f;
    [SerializeField] private float damageFlashTime = 0.08f;

    private float currentAlpha;
    private Coroutine flashCo;

    void Reset()
    {
        if (!bloodOverlay) bloodOverlay = GetComponentInChildren<Image>();
    }

    void Update()
    {
        if (!bloodOverlay) return;

        float h = Mathf.Clamp01(health01);

        float target = Mathf.Clamp01(alphaByHealth.Evaluate(h));


        // DÃ¼ÅŸÃ¼k candayken kÃ¼Ã§Ã¼k nabÄ±z/pulse
        if (h <= pulseStartHealth)
        {
            float t = (pulseStartHealth - h) / Mathf.Max(pulseStartHealth, 0.0001f); // 0..1
            float pulse = (Mathf.Sin(Time.unscaledTime * pulseSpeed) * 0.5f + 0.5f); // 0..1
            target += pulse * pulseAmount * t;
        }

        target = Mathf.Clamp01(target);

        baseAlpha = target;

        // final alpha = base + flash
        float finalAlpha = Mathf.Clamp01(baseAlpha + flashAlpha);

        currentAlpha = Mathf.Lerp(
            currentAlpha,
            finalAlpha,
            1f - Mathf.Exp(-smooth * Time.unscaledDeltaTime)
        );


        var c = bloodOverlay.color;
        c.a = currentAlpha;
        bloodOverlay.color = c;
    }

    /// <summary>
    /// Hasar aldÄ±ÄŸÄ±nda kÄ±sa bir "kan sÄ±Ã§ramasÄ±" / flash eklemek iÃ§in Ã§aÄŸÄ±r.
    /// </summary>
    public void OnDamageFlash()
    {
        if (!bloodOverlay) return;
        if (flashCo != null) StopCoroutine(flashCo);
        flashCo = StartCoroutine(DamageFlashRoutine());
    }

    private IEnumerator DamageFlashRoutine()
    {
        float start = flashAlpha;
        float peak = Mathf.Clamp01(start + damageFlashAdd);

        float t = 0f;
        while (t < 1f)
        {
            t += Time.unscaledDeltaTime / Mathf.Max(damageFlashTime, 0.001f);
            flashAlpha = Mathf.Lerp(start, peak, t);
            yield return null;
        }

        // geri sÃ¶nme
        t = 0f;
        while (t < 1f)
        {
            t += Time.unscaledDeltaTime / Mathf.Max(damageFlashTime, 0.001f);
            flashAlpha = Mathf.Lerp(peak, 0f, t);
            yield return null;
        }

        flashAlpha = 0f;
        flashCo = null;
    }

}
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.EventSystems;

[RequireComponent(typeof(Image), typeof(Button))]
public class ButtonStateController : MonoBehaviour,
    IPointerEnterHandler,
    IPointerExitHandler,
    IPointerDownHandler,
    IPointerUpHandler
{
    [Header("Sprites")]
    public Sprite normalSprite;
    public Sprite hoverSprite;
    public Sprite clickedSprite;

    private Image image;
    private Button button;

    void Awake()
    {
        image = GetComponent<Image>();
        button = GetComponent<Button>();

        image.sprite = normalSprite;
    }

    // ğŸ”’ Button pasifse hiÃ§bir ÅŸey yapma
    bool IsInteractable()
    {
        return button != null && button.interactable;
    }

    public void OnPointerEnter(PointerEventData eventData)
    {
        if (!IsInteractable()) return;
        image.sprite = hoverSprite;
    }

    public void OnPointerExit(PointerEventData eventData)
    {
        if (!IsInteractable()) return;
        image.sprite = normalSprite;
    }

    public void OnPointerDown(PointerEventData eventData)
    {
        if (!IsInteractable()) return;
        image.sprite = clickedSprite;
    }

    public void OnPointerUp(PointerEventData eventData)
    {
        if (!IsInteractable()) return;

        if (RectTransformUtility.RectangleContainsScreenPoint(
            transform as RectTransform,
            Input.mousePosition))
        {
            image.sprite = hoverSprite;
        }
        else
        {
            image.sprite = normalSprite;
        }
    }

    // ğŸ” Button runtime'da disable edilirse sprite resetlensin
    void Update()
    {
        if (!IsInteractable() && image.sprite != normalSprite)
        {
            image.sprite = normalSprite;
        }
    }
}
using TMPro;
using UnityEngine;
using UnityEngine.EventSystems;

public class DropdownStateController : MonoBehaviour,
    IPointerEnterHandler,
    IPointerExitHandler
{
    private TMP_Dropdown dropdown;
    private Animator anim;

    void Awake()
    {
        dropdown = GetComponent<TMP_Dropdown>();
        anim = GetComponent<Animator>();
    }

    public void OnPointerEnter(PointerEventData eventData)
    {
        anim.SetBool("Hover", true);
    }

    public void OnPointerExit(PointerEventData eventData)
    {
        anim.SetBool("Hover", false);
    }

    void Update()
    {
        anim.SetBool("Open", dropdown.IsExpanded);
    }
}
using UnityEngine;
using System.Collections;

public class BurnZone : MonoBehaviour
{
    public int damagePerSecond = 5;
    public float duration = 5f;

    private float tickTimer;

private void OnTriggerStay2D(Collider2D other)
{
    if (other.CompareTag("Enemy"))
    {
        tickTimer += Time.deltaTime;
        if (tickTimer >= 1f)
        {
            tickTimer = 0f;
            Enemy enemy = other.GetComponent<Enemy>();
            if (enemy != null)
                enemy.TakeDamage(damagePerSecond);
        }
    }
}

}
    using System.Collections;
    using UnityEngine;

    public class MolotovProjectile : MonoBehaviour
    {
        [Header("Explosion Settings")]
        public GameObject fireEffectPrefab;
        public float explosionRadius = 2.5f;
        public int impactDamage = 20;
        public int burnDamagePerSecond = 5;
        public float fireDuration = 5f;

        private bool hasExploded = false;

    private void OnTriggerEnter2D(Collider2D other)
    {
        Debug.Log($"ğŸ”¥ Trigger tetiklendi: {other.name} (Layer: {LayerMask.LayerToName(other.gameObject.layer)})");

        if (hasExploded) return;

        // ğŸ’¡ Sadece zemine Ã§arpÄ±nca patla
        if (other.gameObject.layer == LayerMask.NameToLayer("GroundTrigger"))
        {
            hasExploded = true;
            Debug.Log("ğŸ’¥ Molotov yere Ã§arptÄ±, patlÄ±yor!");
            Explode();
        }
        else
        {
            // DiÄŸer layer'lar (Animal, Build vs.) tamamen gÃ¶rmezden gel
            Debug.Log($"â­ {other.name} yoksayÄ±ldÄ± (Layer: {LayerMask.LayerToName(other.gameObject.layer)})");
        }
    }



        private void Explode()
        {
            Debug.Log("ğŸ’¥ Molotov yere Ã§arptÄ±, patlÄ±yor!");

            // ğŸ”¥ 1. Fire effect oluÅŸtur
            if (fireEffectPrefab != null)
            {
                GameObject fire = Instantiate(fireEffectPrefab, transform.position, Quaternion.identity);
                Destroy(fire, fireDuration);
                Debug.Log("ğŸ”¥ Fire effect oluÅŸturuldu!");
            }

            // ğŸ’¢ 2. Ä°lk patlama hasarÄ±
            ApplyDamage(impactDamage);

            // ğŸ”¥ 3. Yanma alanÄ± oluÅŸtur
            StartCoroutine(CreateBurnZone());

            // ğŸ§¨ 4. Molotov objesini sahneden kaldÄ±r (gÃ¶rÃ¼nmez yap)
            GetComponent<SpriteRenderer>().enabled = false;
            GetComponent<Collider2D>().enabled = false;
            GetComponent<Rigidbody2D>().isKinematic = true;
        }

    private void ApplyDamage(int damage)
    {
        Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, explosionRadius);
        foreach (var hit in hits)
        {
            if (hit.CompareTag("Enemy"))
            {
                Enemy enemy = hit.GetComponent<Enemy>();
                if (enemy != null)
                {
                    enemy.TakeDamage(damage);
                    Debug.Log($"ğŸ’¥ Patlama hasarÄ±: {damage} verildi -> {enemy.name}");
                }
            }
        }
    }

        private IEnumerator CreateBurnZone()
        {
            Debug.Log("ğŸ”¥ Yanma alanÄ± oluÅŸturuldu!");
            float elapsed = 0f;

            // GeÃ§ici alan objesi oluÅŸtur
            GameObject burnZone = new GameObject("BurnZone");
            burnZone.transform.position = transform.position;
            CircleCollider2D col = burnZone.AddComponent<CircleCollider2D>();
            col.isTrigger = true;
            col.radius = explosionRadius;

            // 2D rigidbody (Trigger Ã§alÄ±ÅŸmasÄ± iÃ§in ÅŸart)
            Rigidbody2D rb = burnZone.AddComponent<Rigidbody2D>();
            rb.isKinematic = true;

            // Hasar scriptâ€™i ekle
            BurnZone zone = burnZone.AddComponent<BurnZone>();
            zone.damagePerSecond = burnDamagePerSecond;
            zone.duration = fireDuration;

            // Fire bitince alanÄ± kaldÄ±r
            Destroy(burnZone, fireDuration);

            yield return null;
        }


        private IEnumerator BurnDamageOverTime()
        {
            float elapsed = 0f;
            while (elapsed < fireDuration)
            {
                Collider2D[] hits = Physics2D.OverlapCircleAll(transform.position, explosionRadius);
                foreach (var hit in hits)
                {
                    if (hit.CompareTag("Enemy"))
                    {
                        var enemy = hit.GetComponent<Enemy>();
                        if (enemy != null) enemy.TakeDamage(burnDamagePerSecond);
                    }
                }
                yield return new WaitForSeconds(1f);
                elapsed += 1f;
            }
        }
    }
using System.Collections;
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;


public class MolotovThrower : MonoBehaviour
{
    [Header("Molotov Settings")]
    public GameObject molotovPrefab;
    public Transform throwPoint;
    public float maxThrowForce = 12f;
    public float minThrowForce = 4f;
    public float chargeSpeed = 4f;
    public float cooldown = 1.5f;

    private float currentForce;
    private bool isCharging;
    private float chargeStartTime;
    private float lastThrowTime;

    private bool justEnabled;

    [Header("UI")]
    public Slider chargeBar; // ÅŸarj dolum gÃ¶stergesi


    private void Start()
    {
        if (chargeBar == null)
        {
            chargeBar = GameObject.FindObjectOfType<Slider>(true);
            if (chargeBar != null)
                Debug.Log("âœ… ChargeBar sahnede otomatik bulundu!");
            else
                Debug.LogWarning("âš ï¸ ChargeBar sahnede bulunamadÄ±!");
        }
    }

    void Awake()
    {
        AutoWireThrowPoint();
    }

    void Update()
    {

        if (justEnabled)
        {
            // ğŸ”’ Bu frame'de hiÃ§bir input iÅŸleme
            justEnabled = false;
            return;
        }



        // --- FÄ±rlatma kilidi: cooldown bitmeden atÄ±ÅŸ olmasÄ±n
        if (Time.time < lastThrowTime + cooldown)
            return;

        // --- BasÄ±lÄ± tutma sÃ¼resine gÃ¶re ÅŸarj et
        if (Mouse.current.leftButton.wasPressedThisFrame)
        {
            isCharging = true;
            chargeStartTime = Time.time;
            currentForce = minThrowForce;
            Debug.Log("ğŸ”¥ Molotov ÅŸarj ediliyor...");

            if (chargeBar != null)
            {
                chargeBar.gameObject.SetActive(true);
                chargeBar.value = 0f;
            }
        }

        if (isCharging && Mouse.current.leftButton.isPressed)
        {
            float elapsed = Time.time - chargeStartTime;
            float t = Mathf.Clamp01(elapsed / 3f); // 3 saniyede tam ÅŸarj
            currentForce = Mathf.Lerp(minThrowForce, maxThrowForce, t);

            // ğŸ”¹ Bar'Ä± gÃ¼ncelle
            if (chargeBar != null)
                chargeBar.value = t;
        }

        // --- Mouse bÄ±rakÄ±ldÄ±ÄŸÄ±nda fÄ±rlat
        if (isCharging && Mouse.current.leftButton.wasReleasedThisFrame)
        {
            ThrowMolotov();
            isCharging = false;

            if (chargeBar != null)
            {
                chargeBar.value = 0f;
                chargeBar.gameObject.SetActive(false);
            }
        }

    }

    void OnEnable()
    {
        justEnabled = true; // aktif edildiÄŸi frame
    }




    private void AutoWireThrowPoint()
    {
        if (throwPoint != null) return;

        // Ã–nce playerâ€™Ä±n FirePointâ€™ini bul
        var playerWeapon = GetComponentInParent<PlayerWeapon>();
        if (playerWeapon != null && playerWeapon.firePoint != null)
        {
            throwPoint = playerWeapon.firePoint;
            Debug.Log($"MolotovThrower â†’ FirePoint otomatik atandÄ±: {throwPoint.name}");
            return;
        }

        // Sahne iÃ§inde â€œFirePointâ€ isminde bir child varsa onu kullan
        var found = transform.Find("FirePoint");
        if (found != null)
        {
            throwPoint = found;
            Debug.Log($"MolotovThrower â†’ FirePoint bulundu: {throwPoint.name}");
        }
    }

    // MolotovThrower.cs - deÄŸiÅŸiklikler
    private void ThrowMolotov()
    {
        if (molotovPrefab == null || throwPoint == null)
        {
            Debug.LogWarning("âš ï¸ MolotovPrefab veya ThrowPoint atanmadÄ±!");
            return;
        }

        Vector3 mouseWorldPos = Camera.main.ScreenToWorldPoint(Mouse.current.position.ReadValue());
        Vector2 direction = (mouseWorldPos - throwPoint.position).normalized;

        Vector3 spawnPos = throwPoint.position + (Vector3)direction * 0.5f;
        GameObject molotov = Instantiate(molotovPrefab, spawnPos, Quaternion.identity);

        Debug.Log($"ğŸ§¨ Molotov oluÅŸturuldu: {molotov.name} @ {spawnPos}");

        Rigidbody2D rb = molotov.GetComponent<Rigidbody2D>();
        if (rb != null)
        {
            rb.gravityScale = 1f;
            rb.AddForce(direction * currentForce, ForceMode2D.Impulse);
            Debug.Log($"ğŸ’£ Kuvvet uygulandÄ±: {direction * currentForce}");
        }
        else
        {
            Debug.LogWarning("âš ï¸ Rigidbody2D bulunamadÄ±!");
        }

        lastThrowTime = Time.time;

    }




}
using UnityEngine;

public class MolotovWeapon : PlayerWeapon
{
    [Header("Molotov Settings")]
    public GameObject molotovProjectilePrefab;
    public Transform throwPoint;
    public float throwForce = 10f;

    public void Shoot()
    {
        if (molotovProjectilePrefab == null || throwPoint == null)
            return;

        GameObject molotov = Instantiate(molotovProjectilePrefab, throwPoint.position, throwPoint.rotation);
        Rigidbody2D rb = molotov.GetComponent<Rigidbody2D>();
        if (rb != null)
            rb.AddForce(throwPoint.up * throwForce, ForceMode2D.Impulse);

        Debug.Log("Molotov fÄ±rlatÄ±ldÄ±!");

        // DayanÄ±klÄ±lÄ±k gideri
        base.Shoot();
    }
}
using UnityEngine;

[System.Serializable]
public class PartRequirement
{
    public WeaponPartItemData partType;
    public int amount = 1;
}
// RequirementLineUI.cs (TEK TEXT'LÄ° VERSÄ°YON)

using UnityEngine;
using TMPro;

public class RequirementLineUI : MonoBehaviour
{
    // ArtÄ±k sadece tek bir text elemanÄ±na ihtiyacÄ±mÄ±z var.
    public TextMeshProUGUI requirementText;

    // Bu fonksiyon, satÄ±rÄ± doÄŸru bilgilerle doldurur ve renklendirir.
    public void Setup(string name, int currentAmount, int requiredAmount)
    {
        if (requirementText == null) return;

        // Yeterli malzememiz var mÄ±?
        bool hasEnough = (currentAmount >= requiredAmount);

        // Metnin rengini belirle.
        // Yeterliyse yeÅŸil, deÄŸilse kÄ±rmÄ±zÄ±.
        // ColorUtility.ToHtmlStringRGB ile renk kodlarÄ±nÄ± string iÃ§ine gÃ¶mebiliriz.
        string colorHex = hasEnough ? "green" : "red";

        // BiÃ§imlendirilmiÅŸ metni oluÅŸtur: "Barrel: <color=red>0 / 3</color>"
        requirementText.text = $"{name}: <color={colorHex}>{currentAmount} / {requiredAmount}</color>";
    }
}
using UnityEngine;

public class UIController : MonoBehaviour
{
    public static UIController Instance;
    public GameObject craftMessage;

    void Awake()
    {
        if (Instance == null) Instance = this;
        else Destroy(gameObject);
    }

    public void ShowCraftMessage()
    {
        if (craftMessage != null)
            craftMessage.SetActive(true);
    }
}
using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.Rendering.Universal;

public class WeaponAim : MonoBehaviour
{
    [Header("Components")]
    [Tooltip("SilahÃ„Â±n ve altÃ„Â±ndaki her Ã…Å¸eyin dÃƒÂ¶neceÃ„Å¸i ana pivot. Genellikle silahÃ„Â±n kendisidir.")]
    public Transform weaponPivot;

    [Tooltip("Bu silaha ait Light 2D objesi.")]
    public Light2D flashlight;

    [Tooltip("Merminin ÃƒÂ§Ã„Â±kacaÃ„Å¸Ã„Â± namlu ucu transformu.")]
    public Transform firePoint;

    private SpriteRenderer weaponSpriteRenderer;

    // FirePoint'in baÃ…Å¸langÃ„Â±ÃƒÂ§ lokal pozisyonu
    private Vector3 firePointDefaultLocalPos;

    private void Awake()
    {
        if (weaponPivot != null)
            weaponSpriteRenderer = weaponPivot.GetComponentInChildren<SpriteRenderer>();

        if (firePoint != null)
            firePointDefaultLocalPos = firePoint.localPosition; // ÃƒÂ¶rn: (0.05, 0.01, 0)
    }

    private void OnDisable()
    {
        if (flashlight != null) flashlight.gameObject.SetActive(false);
    }

    private void OnEnable()
    {
        if (flashlight != null) flashlight.gameObject.SetActive(true);
    }

    private void LateUpdate()
    {
        if (GameStateManager.IsGamePaused ||GameStateManager.IsGameOver) return;
        if (Camera.main == null || weaponPivot == null) return;

        // Fare hedefi
        Vector3 mousePosition = Mouse.current.position.ReadValue();
        Vector3 worldPosition = Camera.main.ScreenToWorldPoint(mousePosition);
        Vector3 aimDirection = (worldPosition - weaponPivot.position).normalized;
        float angle = Mathf.Atan2(aimDirection.y, aimDirection.x) * Mathf.Rad2Deg;

        // SilahÃ„Â± dÃƒÂ¶ndÃƒÂ¼r
        weaponPivot.rotation = Quaternion.Euler(0f, 0f, angle);

        // Sprite flip (senin mantÃ„Â±Ã„Å¸Ã„Â±n)
        float facingDirection = PlayerMovement.FacingDirection;
        bool flip = (facingDirection < 0);

        if (weaponSpriteRenderer != null)
        {
            // Hem X hem Y flip
            weaponSpriteRenderer.flipX = flip;
            weaponSpriteRenderer.flipY = flip;
        }

        // Fener yÃƒÂ¶nÃƒÂ¼
        if (flashlight != null)
            flashlight.transform.rotation = Quaternion.Euler(0f, 0f, angle - 90f);

        // FirePoint pozisyonu ve yÃƒÂ¶nÃƒÂ¼
        if (firePoint != null)
        {
            // Hem X hem Y iÃ…Å¸aretini facing'e gÃƒÂ¶re deÃ„Å¸iÃ…Å¸tir
            float sx = flip ? -1f : 1f;
            float sy = flip ? -1f : 1f;

            firePoint.localPosition = new Vector3(
                firePointDefaultLocalPos.x * sx,
                firePointDefaultLocalPos.y * sy,
                firePointDefaultLocalPos.z
            );

            // Rotasyonu pivot'tan miras alsÃ„Â±n
            firePoint.localRotation = Quaternion.identity;
        }
    }
}
using UnityEngine;

[RequireComponent(typeof(Rigidbody2D))]
public class WeaponBullet : MonoBehaviour
{
    [Header("Bullet Settings")]
    public float speed = 20f;
    public int damage = 10;
    private Rigidbody2D rb;

    [Header("References")]
    public Transform owner;            // PlayerWeapon atar
    public WeaponType weaponType;      // 📌 Hangi silah türünden atıldığı buraya atanacak

    [Header("Animal Scare")]
    public float fleeOnHitDuration = 3.5f;
    public float fleeOnHitMultiplier = 2.2f;

     [Header("Knockback (applied always)")]
    public float knockbackForce = 6f;      // atanacak kuvvet (bullet'e atanır)
    public float knockbackDuration = 0.18f; // kuvvet uygulanma süresi

     private int enemiesHit = 0;
    private const int maxPenetration = 2; // 2 düşmandan sonra yok olur

    void Awake()
    {
        rb = GetComponent<Rigidbody2D>();
    }

    void Start()
    {
        rb.linearVelocity = transform.right * speed;
        Destroy(gameObject, 3f);
    }

    private void OnTriggerEnter2D(Collider2D collision)
    {
        if (collision.CompareTag("Player") || collision.CompareTag("Bullet")) return;

        // 🎯 Düşmana çarptıysa hasar ver ve knockback kontrolü yap
         Enemy enemy = collision.GetComponent<Enemy>();
        if (enemy != null)
        {
            enemiesHit++;

            int appliedDamage = damage;
            if (weaponType == WeaponType.Sniper && enemiesHit > 1)
                appliedDamage = Mathf.RoundToInt(damage * 0.5f); // ikinci hedefe yarı hasar

            enemy.TakeDamage(appliedDamage);

            // Knockback uygula (her zaman)
            if (weaponType == WeaponType.Shotgun || weaponType == WeaponType.Sniper)
            {
                Vector2 sourcePos = transform.position;
                enemy.ApplyKnockback(sourcePos, knockbackForce, knockbackDuration);
            }

            // 🔹 Eğer sniper mermisi 2 düşmana çarpmışsa yok ol
            if (weaponType == WeaponType.Sniper && enemiesHit >= maxPenetration)
            {
                Destroy(gameObject);
                return;
            }
            // 🔹 Diğer silahlar hemen yok olur
            else if (weaponType != WeaponType.Sniper)
            {
                Destroy(gameObject);
                return;
            }
        }

        // 🐺 Hayvanlara korku efekti
        Animal animal = collision.GetComponent<Animal>();
        if (animal != null)
        {
            Vector2 threatPos = (owner != null) ? (Vector2)owner.position : (Vector2)transform.position;
            animal.Scare(threatPos, fleeOnHitDuration, fleeOnHitMultiplier);
            animal.TakeDamage(damage);
        }

        if (!collision.isTrigger)
        Destroy(gameObject);
    }
}
using UnityEngine;
using System;
using System.Collections.Generic;

[CreateAssetMenu(
    menuName = "Crafting/Recipe/Weapon",
    fileName = "recipe_wpn_"
)]
public class WeaponCraftRecipe : ScriptableObject
{
    [Header("Result")]
    public WeaponItemData resultWeapon;

    [Header("Description")]
    [TextArea]
    public string description;

    [Header("Costs")]
    public List<ItemCost> costs = new();
}

[Serializable]
public class ItemCost
{
    public ItemData item;
    public int amount = 1;
}
using UnityEditor;
using UnityEngine;


[CustomEditor(typeof(WeaponDefinition))]
public class WeaponDataEditor : Editor
{
    // Core
    SerializedProperty prefab;
    SerializedProperty weaponType;
    // Projectile
    SerializedProperty projectilePrefab;

    // Combat
    SerializedProperty knockbackForce;
    SerializedProperty knockbackDuration;
    SerializedProperty isAutomatic;
    SerializedProperty fireRate;
    SerializedProperty damage;
    SerializedProperty reloadTime;
    SerializedProperty attackRange;

    // Shotgun
    SerializedProperty pelletsPerShot;
    SerializedProperty pelletSpreadAngle;
    SerializedProperty shotgunCooldown;

    // Sniper
    SerializedProperty sniperCooldown;
    SerializedProperty sniperPenetrationCount;

    // Ammo & Magazine
    SerializedProperty ammoType;
    SerializedProperty acceptedMagazines;

    // Molotov
    SerializedProperty isMolotov;
    SerializedProperty fireEffectPrefab;
    SerializedProperty explosionRadius;
    SerializedProperty burnDamage;
    SerializedProperty burnDuration;
    SerializedProperty tickInterval;

    void OnEnable()
    {
        prefab = serializedObject.FindProperty("prefab");
        weaponType = serializedObject.FindProperty("weaponType");
        projectilePrefab = serializedObject.FindProperty("projectilePrefab");


        knockbackForce = serializedObject.FindProperty("knockbackForce");
        knockbackDuration = serializedObject.FindProperty("knockbackDuration");

        isAutomatic = serializedObject.FindProperty("isAutomatic");
        fireRate = serializedObject.FindProperty("fireRate");
        damage = serializedObject.FindProperty("damage");
        reloadTime = serializedObject.FindProperty("reloadTime");
        attackRange = serializedObject.FindProperty("attackRange");

        pelletsPerShot = serializedObject.FindProperty("pelletsPerShot");
        pelletSpreadAngle = serializedObject.FindProperty("pelletSpreadAngle");
        shotgunCooldown = serializedObject.FindProperty("shotgunCooldown");

        sniperCooldown = serializedObject.FindProperty("sniperCooldown");
        sniperPenetrationCount = serializedObject.FindProperty("sniperPenetrationCount");

        ammoType = serializedObject.FindProperty("ammoType");
        acceptedMagazines = serializedObject.FindProperty("acceptedMagazines");

        isMolotov = serializedObject.FindProperty("isMolotov");
        fireEffectPrefab = serializedObject.FindProperty("fireEffectPrefab");
        explosionRadius = serializedObject.FindProperty("explosionRadius");
        burnDamage = serializedObject.FindProperty("burnDamage");
        burnDuration = serializedObject.FindProperty("burnDuration");
        tickInterval = serializedObject.FindProperty("tickInterval");
    }

    public override void OnInspectorGUI()
    {
        serializedObject.Update();

        // ---------------- BASIC ----------------
        EditorGUILayout.PropertyField(prefab);
        EditorGUILayout.PropertyField(weaponType);

        WeaponType wt = (WeaponType)weaponType.enumValueIndex;

        EditorGUILayout.Space(6);
        EditorGUILayout.LabelField("Combat Stats", EditorStyles.boldLabel);

        EditorGUILayout.PropertyField(knockbackForce);
        EditorGUILayout.PropertyField(knockbackDuration);
        EditorGUILayout.PropertyField(fireRate);
        EditorGUILayout.PropertyField(damage);
        EditorGUILayout.PropertyField(reloadTime);
        EditorGUILayout.PropertyField(attackRange);
        EditorGUILayout.PropertyField(projectilePrefab);


        // ---------------- AUTOMATIC ----------------
        if (wt != WeaponType.Shotgun &&
            wt != WeaponType.Sniper &&
            wt != WeaponType.Molotov)
        {
            EditorGUILayout.PropertyField(isAutomatic);
        }

        // ---------------- SHOTGUN ----------------
        if (wt == WeaponType.Shotgun)
        {
            EditorGUILayout.Space(6);
            EditorGUILayout.LabelField("Shotgun Settings", EditorStyles.boldLabel);

            EditorGUILayout.PropertyField(pelletsPerShot);
            EditorGUILayout.PropertyField(pelletSpreadAngle);
            EditorGUILayout.PropertyField(shotgunCooldown);
        }

        // ---------------- SNIPER ----------------
        if (wt == WeaponType.Sniper)
        {
            EditorGUILayout.Space(6);
            EditorGUILayout.LabelField("Sniper Settings", EditorStyles.boldLabel);

            EditorGUILayout.PropertyField(sniperCooldown);
            EditorGUILayout.PropertyField(sniperPenetrationCount);
        }

        // ---------------- MOLOTOV ----------------
        if (wt == WeaponType.Molotov)
        {
            isMolotov.boolValue = true;

            EditorGUILayout.Space(6);
            EditorGUILayout.LabelField("Molotov Settings", EditorStyles.boldLabel);

            EditorGUILayout.PropertyField(fireEffectPrefab);
            EditorGUILayout.PropertyField(explosionRadius);
            EditorGUILayout.PropertyField(burnDamage);
            EditorGUILayout.PropertyField(burnDuration);
            EditorGUILayout.PropertyField(tickInterval);
        }
        else
        {
            isMolotov.boolValue = false;
        }

        // ---------------- AMMO & MAGAZINE ----------------
        EditorGUILayout.Space(8);
        EditorGUILayout.LabelField("Ammo & Magazine", EditorStyles.boldLabel);

        EditorGUILayout.PropertyField(ammoType);

        if (acceptedMagazines != null)
        {
            EditorGUILayout.PropertyField(
                acceptedMagazines,
                new GUIContent("Accepted Magazines"),
                true
            );
        }

        serializedObject.ApplyModifiedProperties();
    }
}
using UnityEngine;

public class WeaponDataHolder : MonoBehaviour
{
    public WeaponDefinition weaponData;
}
using UnityEngine;
using System.Collections.Generic;

[CreateAssetMenu(
    menuName = "Items/Weapon/Weapon Definition",
    fileName = "wpn_"
)]
public class WeaponDefinition : ScriptableObject
{
    [Header("Prefab")]
    public GameObject prefab;
    public WeaponType weaponType;

    [Header("Combat")]
    public int damage;
    public bool isAutomatic;
    public float fireRate = 2f;
    public float reloadTime = 1.5f;
    public float attackRange = 1.5f;

    [Header("Knockback")]
    public float knockbackForce = 6f;
    public float knockbackDuration = 0.18f;

    [Header("Shotgun")]
    public bool isShotgun;
    public int pelletsPerShot = 3;
    public float pelletSpreadAngle = 8f;
    public float shotgunCooldown = 2.5f;

    [Header("Sniper")]
    public bool isSniper;
    public float sniperCooldown = 3.0f;
    public int sniperPenetrationCount = 2;

    [Header("Projectile")]
    public GameObject projectilePrefab;

    [Header("Ammo & Magazine")]
    public AmmoTypeData ammoType;
    public List<MagazineType> acceptedMagazines = new();

    [Header("Throwable / Fire")]
    public bool isMolotov;
    public GameObject fireEffectPrefab;
    public float explosionRadius = 2.5f;
    public int burnDamage = 1;
    public float burnDuration = 5f;
    public float tickInterval = 1f;
}
using UnityEngine;

public class WeaponHolder : MonoBehaviour
{
    public WeaponDefinition weaponData;
}
// WeaponInventory.cs (DÜZELTİLMİŞ VE DOĞRU HALİ)

using UnityEngine;
using UnityEngine.UI;
using System.Collections.Generic;

public class WeaponInventory : MonoBehaviour
{
    // Bu referans artık doğrudan silahları yönetmek için değil,
    // yeni silahın verilerini merkezi ateş etme sistemine bildirmek için kullanılacak.
    public PlayerWeapon playerWeapon;
    public GameObject[] weaponPrefabs; // 0: Makineli, 1: Tabanca, 2: Yakın dövüş
    public Transform weaponHolder; // Silahların oluşturulacağı yer (firePoint yerine bu daha mantıklı)

    // Aktif silah objelerini bu dizide tutacağız.
    private GameObject[] weaponInstances;
    private int currentSlot = 1; // Başlangıç slotu

    // ... (crafting ile ilgili değişkenleriniz aynı kalabilir) ...
    public Text craftHintText;
    private HashSet<string> collectedParts = new HashSet<string>();
    private string[] requiredParts = new string[] {
        "Barrel", "Magazine", "Foregrip", "Grip", "Trigger", "TriggerGuard"
    };

    void Start()
    {
        // weaponInstances dizisini başlat
        weaponInstances = new GameObject[weaponPrefabs.Length];
        EquipSlot(currentSlot);

        if (craftHintText != null)
            craftHintText.gameObject.SetActive(false);
    }

    void Update()
    {
        // ... (Update içeriğiniz aynı kalabilir) ...
        if (Input.GetKeyDown(KeyCode.Alpha1)) EquipSlot(0);
        if (Input.GetKeyDown(KeyCode.Alpha2)) EquipSlot(1);
        if (Input.GetKeyDown(KeyCode.Alpha3)) EquipSlot(2);

        if (Input.GetKeyDown(KeyCode.C) && HasAllParts())
        {
            CraftNewWeapon();
        }
    }

    private void EquipSlot(int slotIndex)
    {
        // Geçersiz slot veya zaten o slot seçiliyse işlem yapma
        if (slotIndex < 0 || slotIndex >= weaponPrefabs.Length || slotIndex == currentSlot) return;

        // 1. Mevcut aktif silahı yok et (eğer varsa)
        if (weaponInstances[currentSlot] != null)
        {
            Destroy(weaponInstances[currentSlot]);
        }

        // 2. Yeni silahın prefab'ını al ve oluştur
        GameObject weaponPrefabToInstantiate = weaponPrefabs[slotIndex];
        if (weaponPrefabToInstantiate == null)
        {
            Debug.LogError($"Slot {slotIndex} için silah prefab'ı atanmamış!");
            return;
        }

        // Yeni silahı weaponHolder'ın altında oluştur
        GameObject newWeaponInstance = Instantiate(weaponPrefabToInstantiate, weaponHolder.position, weaponHolder.rotation, weaponHolder);

        // 3. Oluşturulan yeni silahı dizide sakla
        weaponInstances[slotIndex] = newWeaponInstance;
        currentSlot = slotIndex; // Mevcut slotu güncelle

        // 4. Merkezi ateş etme sistemini (PlayerWeapon) yeni silahın verileriyle yapılandır.
        // Bu satır sizin kodunuzda vardı, çok doğru bir yaklaşım.
        WeaponDataHolder dataHolder = newWeaponInstance.GetComponent<WeaponDataHolder>();
        if (dataHolder != null && playerWeapon != null)
        {
            // PlayerWeapon'ın weaponData'sını yeni silahınkiyle değiştiriyoruz.
            playerWeapon.weaponData = dataHolder.weaponData;
            // Not: Mermi ve şarjör mekaniği için burada PlayerWeapon'daki mermi sayısını da güncellemeniz gerekecek.
            // Bu kısım WeaponSlotManager'daki mantığa benziyor.
        }
    }

    // ... (Crafting fonksiyonlarınız aynı kalabilir) ...
    public void CollectPart(string partName) { /* ... */ }
    private bool HasAllParts() { /* ... */ return true; }
    private void CraftNewWeapon() { /* ... */ }
}
using UnityEngine;

[CreateAssetMenu(
    menuName = "Items/Weapon",
    fileName = "itm_wpn_"
)]
public class WeaponItemData : ItemData
{
    [Header("Weapon Link")]
    public WeaponType weaponType;
    public WeaponDefinition weaponDefinition;

    private void OnValidate()
    {
        category = ItemCategory.Weapon;
        stackable = false;
        maxStack = 1;
    }
}
using UnityEngine;

public class WeaponPart : MonoBehaviour
{
    public WeaponPartType partType;
}
public enum WeaponPartType
{
    Barrel,
    Magazine,
    Handguard,
    Grip,
    Trigger,
    TriggerGuard,
    Stone,
    Wood,
    ScrapMetal
}
using UnityEngine;
using UnityEngine.InputSystem;

public enum WeaponSlotType
{
    Pistol = 0,
    Rifle = 1,
    Melee = 2
}

public class WeaponSlotManager : MonoBehaviour
{
    public static WeaponSlotManager Instance;

    [Header("Player Weapon Handlers")]
    public PlayerWeapon pistolHandler;
    public PlayerWeapon rifleHandler;
    public PlayerWeapon meleeHandler;

    [Header("Equipped Weapons (ITEM)")]
    public WeaponItemData[] slots = new WeaponItemData[3];

    public PlayerWeapon ActiveWeapon { get; private set; }

    [Header("Active Slot")]
    public int activeSlotIndex = 0;

    private PlayerControls controls;

    // ----------------------------------------------------
    void Awake()
    {
        if (Instance != null) { Destroy(gameObject); return; }
        Instance = this;

        controls = new PlayerControls();
    }

    private void OnEnable()
    {
        controls.Gameplay.Weapon1.performed += _ => SwitchSlot(0);
        controls.Gameplay.Weapon2.performed += _ => SwitchSlot(1);
        controls.Gameplay.Weapon3.performed += _ => SwitchSlot(2);
        controls.Gameplay.Enable();
    }

    private void OnDisable()
    {
        controls.Gameplay.Disable();
    }

    // ----------------------------------------------------
    // SLOT BELÄ°RLEME
    // ----------------------------------------------------
    public WeaponSlotType GetSlotForWeapon(WeaponType weaponType)
    {
        switch (weaponType)
        {
            case WeaponType.Pistol:
                return WeaponSlotType.Pistol;

            case WeaponType.MachineGun:
            case WeaponType.Shotgun:
            case WeaponType.Sniper:
            case WeaponType.Bow:
                return WeaponSlotType.Rifle;

            case WeaponType.ThrowingSpear:
            case WeaponType.MeeleSword:
            case WeaponType.MeeleSpear:
                return WeaponSlotType.Melee;

            default:
                return WeaponSlotType.Rifle;
        }
    }

    // ----------------------------------------------------
    // DIÅ API (UI / Craft / Caravan)
    // ----------------------------------------------------
    public WeaponItemData GetWeaponItemInSlot(int slot)
    {
        return slots[slot];
    }

    public void EquipWeaponInSlot(WeaponItemData item, int slot)
    {
        slots[slot] = item;

        if (activeSlotIndex == slot)
            ApplyToHandler(slot);
    }

    public void EquipWeapon(WeaponItemData item)
    {
        int slot = (int)GetSlotForWeapon(item.weaponType);
        EquipWeaponInSlot(item, slot);
        SwitchSlot(slot);
    }

    // ----------------------------------------------------
    // SLOT DEÄÄ°ÅTÄ°R
    // ----------------------------------------------------
    public void SwitchSlot(int newSlot)
    {
        if (newSlot < 0 || newSlot > 2)
            return;

        activeSlotIndex = newSlot;
        ApplyToHandler(newSlot);
    }

    // ----------------------------------------------------
    // HANDLER AKTARIMI
    // ----------------------------------------------------
    private void ApplyToHandler(int slot)
    {
        pistolHandler.gameObject.SetActive(false);
        rifleHandler.gameObject.SetActive(false);
        meleeHandler.gameObject.SetActive(false);

        PlayerWeapon handler = GetHandler(slot);
        if (handler == null)
            return;

        handler.gameObject.SetActive(true);
        ActiveWeapon = handler;

        WeaponItemData item = slots[slot];
        if (item != null && item.weaponDefinition != null)
        {
            handler.SetWeapon(item.weaponDefinition);
        }
    }

    private PlayerWeapon GetHandler(int slot)
    {
        switch ((WeaponSlotType)slot)
        {
            case WeaponSlotType.Pistol: return pistolHandler;
            case WeaponSlotType.Rifle: return rifleHandler;
            case WeaponSlotType.Melee: return meleeHandler;
        }
        return null;
    }

    // ----------------------------------------------------
    // SAVE
    // ----------------------------------------------------
    public WeaponSlotSaveData GetSaveData()
    {
        WeaponSlotSaveData data = new WeaponSlotSaveData();

        for (int i = 0; i < 3; i++)
            data.equippedWeaponIDs[i] = slots[i] != null ? slots[i].itemID : "";

        data.activeSlotIndex = activeSlotIndex;
        return data;
    }

    // ----------------------------------------------------
    // LOAD
    // ----------------------------------------------------
    public void LoadData(WeaponSlotSaveData data)
    {
        for (int i = 0; i < 3; i++)
        {
            string id = data.equippedWeaponIDs[i];

            if (!string.IsNullOrEmpty(id))
                slots[i] = ItemDatabase.Get(id) as WeaponItemData;
            else
                slots[i] = null;
        }

        activeSlotIndex = Mathf.Clamp(data.activeSlotIndex, 0, 2);
        SwitchSlot(activeSlotIndex);
    }
}
public enum WeaponType
{
    Pistol,
    MachineGun,
    Shotgun,
    Sniper,
    Molotov,
    ThrowingSpear,
    Bow,
    MeeleSpear,
    MeeleSword
}

